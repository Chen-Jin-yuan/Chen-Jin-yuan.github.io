<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jysama.cn","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Re：从零开始的写博客生活">
<meta property="og:type" content="website">
<meta property="og:title" content="JySama">
<meta property="og:url" content="https://jysama.cn/index.html">
<meta property="og:site_name" content="JySama">
<meta property="og:description" content="Re：从零开始的写博客生活">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jysama.cn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>JySama</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JySama</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2023/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">计网相关技术</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-02-07 10:22:38 / 修改时间：18:44:15" itemprop="dateCreated datePublished" datetime="2023-02-07T10:22:38+08:00">2023-02-07</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h1><p>这部分简单学习一些目前比较新的计网相关的技术，不作特别深入，但尽可能保证介绍明白。</p>
<h1 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>kubernetes 简称 k8s，是一个容器自动化运维平台，可以高效管理容器集群。k8s 位于容器编排层，只管理容器，而不提供容器引擎来负责容器生命周期的管理，因此 k8s 需要借助docker 这类容器引擎才能工作。简单来说，容器提供应用级别的一个抽像去管理应用，而k8s 是提供应用级别集群的抽象去管理容器集群。</p>
<p>k8s 的用途有：跨主机编排容器、更充分地利用硬件资源来最大化地满足企业应用的需求、通过自动布局、自动重启、自动复制、自动伸缩实现应用的状态检查与自我修复、控制与自动化应用的部署与升级等等。在架构上，k8s 主要由 master 节点和 node 节点组成，master 管理 node 的功能实施：</p>
<ul>
<li>master 节点组件：<ul>
<li>(1) etcd：k8s 集中的状态存储，存储所有的集群状态数据；</li>
<li>(2) API server：k8s 的通讯接口和命令总线；</li>
<li>(3) scheduler：k8s 负责调度决策的组件，掌握着当前集群资源的使用情况；</li>
<li>(4) controller manager：通过 API server 监控集群的状态，确保集群实际状态和预期的一致。</li>
</ul>
</li>
<li>node 节点组件：<ul>
<li>(1) kubelet：资源管理，监 API server 上的事件；</li>
<li>(2) kube-proxy：管理 k8s 上面的服务和网络；</li>
<li>(3) docker：容器对象，负责实施应用功能。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="对比传统应用部署"><a href="#对比传统应用部署" class="headerlink" title="对比传统应用部署"></a>对比传统应用部署</h2><p>部署 kubernetes 应用与部署传统应用的不同之处：</p>
<ul>
<li>传统应用会部署在一个操作系统上，程序员开发程序面临的接口是操作系统的 api，并在单一主机上部署和运行程序。由于不同操作系统之间的 ABI（二进制接口），导致应用程序的移植面临巨大困难。而部署 kubernetes 应用则使用 k8s 集群对外提供的 api 接口，应用程序开发出来天然适应于运行在云平台之上，而非传统的单机应用程序。</li>
<li>部署 kubernetes 应用不需要考虑具体的环境。kubernetes 使用容器化解决方案，每个应用可以被打包成一个容器镜像，这便于管理、扩展和回收，也不用管在哪个机器执行，具体的环境是什么。而这些是部署传统应用需要考虑的东西。</li>
<li>由于部署 kubernetes 应用不需要考虑具体的环境，在应用开发与部署的过程中，应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构，这使得从研发到测试、生产能提供一致环境，能够实现服务的无缝迁移。</li>
<li>传统应用是运行在操作系统上的一个或多个进程，不管需不需要服务，应用程序都始终运行着。而 kubernetes 平时并不运行应用程序，而是等到有客户去访问服务时，才运行一个微服务。一旦访问完毕，应用程序的使命结束后将停止运行。直到再次被调用时，才再次运行。此时，应用程序变成了函数，也就是所谓的函数即服务。</li>
</ul>
<h1 id="container"><a href="#container" class="headerlink" title="container"></a>container</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><p>容器是一种沙盒技术，主要目的是为了将应用运行在其中，与外界隔离；及方便这个沙盒可以被转移到其它宿主机器。本质上，它是一个特殊的进程。通过名称空间（Namespace）、控制组（Control groups）、切根（chroot）技术把资源、文件、设备、状态和配置划分到一个独立的空间。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%AE%B9%E5%99%A81.png" alt="捕获">              </p>
<p>与虚拟机不同，容器不提供操作系统级虚拟化，从而降低了初始化容器的开销。在实际场景中，一台物理计算机可能会运行数百个容器。</p>
<p>Docker是最著名的容器平台。在docker的生命周期中，镜像和容器是最重要的两部分。其中镜像是文件，是一个只读的模板，一个独立的文件系统，里面包含运行容器所需的数据，可以用来创建新的容器；而容器是基于镜像创建的进程，容器中的进程依赖于镜像中的文件，容器具有写的功能，可以根据需要改写里面的软件、配置等，并可以保存为新的镜像。如果是用import方法生成，则是一个完全新的镜像。如果用的是commit方法生成的新的镜像，则新镜像与原来的镜像之间存在着继承关系。</p>
<h2 id="对比虚拟机"><a href="#对比虚拟机" class="headerlink" title="对比虚拟机"></a>对比虚拟机</h2><p>容器和虚拟机都是用于创建可在其中运行应用程序的隔离环境的技术。但是，它们有一些关键差异。容器和虚拟机之间的主要区别之一是它们的实现方式。容器是一个轻量级、独立的可执行包，它包含应用程序运行所需的所有内容，包括应用程序代码、库、依赖项和运行时。另一方面，虚拟机是一个成熟的独立操作系统，它运行在主机操作系统之上并虚拟化所有硬件资源。</p>
<p>另一个区别是提供的隔离级别。容器提供高级别的进程级隔离，这意味着每个容器运行自己的进程，并具有自己的文件系统和网络堆栈。但是，容器共享主机操作系统的内核，这意味着它们不提供与主机系统的完全隔离。另一方面，虚拟机提供与主机系统的完全隔离，因为它们有自己的内核和硬件虚拟化层。第三个区别是开销和资源要求。容器通常比虚拟机更轻量级，需要的资源更少，因为它们不需要虚拟化所有硬件资源。这使得它们的启动速度更快，运行效率更高。</p>
<p>总体而言，容器和虚拟机之间的主要区别在于它们的实现方式、它们提供的隔离级别以及开销和资源要求。</p>
<h1 id="vxlan"><a href="#vxlan" class="headerlink" title="vxlan"></a>vxlan</h1><h2 id="overlay"><a href="#overlay" class="headerlink" title="overlay"></a>overlay</h2><p>可以将覆盖网络（overlay）视为位于另一个网络之上的计算机网络。叠加网络中的所有节点都通过逻辑或虚拟链路相互连接，并且每个链路都对应于底层网络中的路径。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/overlay.png" alt="image"></p>
<h2 id="vxlan简介"><a href="#vxlan简介" class="headerlink" title="vxlan简介"></a>vxlan简介</h2><p>VXLAN 通常被描述为一种覆盖技术（也是一种隧道技术），因为它允许通过将以太网帧封装（隧道）到包含 IP 地址的 VXLAN 数据包中，从而在干预的第 2 层网络上延伸第 3 层连接。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/vxlan1.png" alt="image (1)"></p>
<p>每个协议标头中 VXLAN 数据包的关键字段包括：</p>
<ul>
<li>+ 外部 MAC 标头（14 字节，4 字节可选）— 包含源 VTEP（VXLAN 隧道端点）的 MAC 地址和下一跃点路由器的 MAC 地址。数据包路径上的每个路由器都会重写此标头，以便源地址是路由器的 MAC 地址，目标地址是下一跃点路由器的 MAC 地址。</li>
<li>+ 外部 IP 标头（20 字节）- 包含源和目标 VTEP 的 IP 地址。</li>
<li>+（外部）UDP 标头（8 字节）- 包含源和目标 UDP 端口：<ul>
<li>– 源 UDP 端口：VXLAN 协议在 UDP 数据包标头中重新利用此标准字段。协议不会将此字段用于源 UDP 端口，而是将其用作 VTEP 之间特定流的数字标识符。VXLAN 标准没有定义如何派生此数字，但源 VTEP 通常根据来自内部第 2 层数据包和原始帧的第 3 层或第 4 层标头的字段组合的哈希值来计算它。</li>
<li>– 目标 UDP 端口：VXLAN UDP 端口。互联网号码分配机构 （IANA） 将端口 4789 分配给 VXLAN。</li>
</ul>
</li>
<li>+ VXLAN 标头（8 字节）- 包含 24 位 VNI。</li>
<li>+ 原始以太网&#x2F;L2 帧 – 包含原始第 2 层以太网帧。</li>
</ul>
<p>总的来说，VXLAN 封装向原始以太网帧添加了 50 到 54 字节的额外标头信息。由于这可能导致以太网帧超过默认的 1514 字节 MTU，因此最佳做法是在整个网络中实现巨型帧。</p>
<p>并且，我们可以看到VXLAN数据包只不过是一个MAC-in-UDP封装的数据包。VXLAN 报头将添加到原始第 2 层帧，然后放置在 UDP-IP 数据包中。此封装允许 VXLAN 数据包通过第 2 层网络从第 3 层网络进行隧道传输。</p>
<h2 id="解决虚拟局域网问题"><a href="#解决虚拟局域网问题" class="headerlink" title="解决虚拟局域网问题"></a>解决虚拟局域网问题</h2><p>在两个虚拟局域网中的两台主机是无法互相ping通网络的，假设有两台虚拟机（相当于两个虚拟局域网），并且虚拟机中使用mininet创建主机节点，那么不同虚拟机中的节点不能互相ping通。</p>
<p>网络不可达的原因是：</p>
<ul>
<li>在物理host主机里，两台虚拟机相当于在一个小型局域网下，它们之间是可以进行网络通信的（本身可达，即overlay下层网络underlay可达，只要建立上层逻辑层即可实现互联）；</li>
<li>而继续在虚拟机中使用mininet创建host时，mininet相当于在每个虚拟机下又创建了小型局域网，此时这两个小型局域网又是虚拟机中的内网，mininet创建的主机相当于两个内网下的主机，当然是不能进行网络通信的。</li>
</ul>
<p>这时就可以利用VXLAN建立逻辑上的隧道，将两台虚拟机中的mininet互连。VXLAN在两个虚拟机上各自建立一个<strong>VTEP</strong>，所谓的VTEP（VXLAN Tunnel Endpoints，VXLAN隧道端点）就是VXLAN网络的边缘设备，是VXLAN隧道的起点和终点，VXLAN对用户原始数据帧的封装和解封装均在VTEP上进行。</p>
<p>有了VTEP后，mininet中的数据包就能通过VTEP转发到另一台虚拟机的隧道端点并在链路层转发。这本质上是由于底层的物理链路（underlay）本就是连通的，因此只要在两个mininet只要在逻辑上建立一条隧道（overlay），就能打破内网限制。</p>
<h2 id="WIRESHARK-抓包"><a href="#WIRESHARK-抓包" class="headerlink" title="WIRESHARK 抓包"></a>WIRESHARK 抓包</h2><p>使用WIRESHARK抓取VM1中host1 ping VM2中host2时发送的ICMP协议数据帧，可以看到包已经进行了VXLAN封装：</p>
<ul>
<li>最外层是源和目的VTEP的MAC地址；</li>
<li>往里一层是源和目的VTPE的IP地址，也就是虚拟机的IP地址；</li>
<li>接着是UDP首部，仅包含了端口号而不包含IP；</li>
<li>然后是VXLAN首部，包含24-bit的VNI；</li>
<li>最后是原始帧，从IP地址可以看到使用的是各自的私有地址。</li>
</ul>
<p>这次抓包显示了VTEP是如何工作的：将内部主机的报文进行VXLAN封装，通过配置的对端IP发送数据帧到对端VTEP上，对端的VTEP再进行VXLAN解包，再把原始的数据帧转发到内部主机。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/vxlan2.png" alt="image-20221112095122590"></p>
<h2 id="MTU相关问题"><a href="#MTU相关问题" class="headerlink" title="MTU相关问题"></a>MTU相关问题</h2><p>根据<em>VXLAN 7348 RFC</em>，VXLAN报文不建议分片，<strong>否则在接收端VTEP上会丢弃分片的报文</strong>。</p>
<img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/vxlan3.png" alt="image-20221111212853142" style="zoom:80%;" />

<p>MTU是单个IP数据包的最大值，而MSS通常是MTU<strong>减去40字节的TCP&#x2F;IP首部</strong>。VTEP会进行VXLAN封装，通常情况下是增加50字节的首部内容，如果使用默认的MSS，那么数据帧的大小就会再加上40字节的TCP&#x2F;IP首部和50字节的VXLAN首部。<strong>默认的MTU是1500字节</strong>，<strong>默认的MSS是1460字节</strong>，如果使用VXLAN技术，就需要将<strong>MSS调整为1410字节</strong>，否则报文会丢失。</p>
<p>因此在部署VXLAN网络前需要对MTU进行全局规划，有两种方式：</p>
<ul>
<li>方式一：修改应用层服务器发送报文的长度值，修改后的长度值加上VXLAN封装的50字节后，需保证在整个承载网中，均小于设备的MTU值。使用此方法，修改难度低，需要IT侧配合。这种方式是比较推荐的。</li>
<li>方式二：修改承载网中每一跳网络设备的MTU值，需保证MTU值大于收到的VXLAN报文长度，从而保证不分片。此方式常常受到约束：承载网络中设备众多、分布广泛，且涉及不同厂商，修改难度大；常常没有修改权限（他人资产，不可控）。</li>
</ul>
<h1 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h1><h2 id="eBPF的背景"><a href="#eBPF的背景" class="headerlink" title="eBPF的背景"></a>eBPF的背景</h2><p>eBPF 全称 extended Berkeley Packet Filter，中文意思是 <code>扩展的伯克利包过滤器</code>。一般来说，要向内核添加新功能，需要修改内核源代码或者编写 <code>内核模块</code> 来实现。而 eBPF 允许程序在不修改内核源代码，或添加额外的内核模块情况下运行。</p>
<h2 id="BPF"><a href="#BPF" class="headerlink" title="BPF"></a>BPF</h2><p>BPF（Berkeley Packet Filter ），中文翻译为伯克利包过滤器，是类 Unix 系统上数据链路层的一种原始接口，提供原始链路层封包的收发。BPF 在数据包过滤上引入了两大革新：</p>
<ul>
<li>一个新的虚拟机 (VM) 设计，可以有效地工作在基于寄存器结构的 CPU 之上；</li>
<li>应用程序使用缓存只复制与过滤数据包相关的数据，不会复制数据包的所有信息。这样可以最大程度地减少BPF 处理的数据；</li>
</ul>
<p>由于这些巨大的改进，所有的 Unix 系统都选择采用 BPF 作为网络数据包过滤技术，直到今天，许多 Unix 内核的派生系统中（包括 Linux 内核）仍使用该实现。</p>
<p>下面是tcpdump的运行架构。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/bpf1.png" alt="image-20200419215511484"></p>
<h2 id="eBPF介绍"><a href="#eBPF介绍" class="headerlink" title="eBPF介绍"></a>eBPF介绍</h2><p>2014 年初，Alexei Starovoitov 实现了 eBPF（extended Berkeley Packet Filter）。经过重新设计，eBPF 演进为一个通用执行引擎，可基于此开发性能分析工具、软件定义网络等诸多场景。</p>
<p><strong>eBPF 扩展到用户空间，这也成为了 BPF 技术的转折点</strong>。eBPF 不再局限于网络栈，已经成为内核顶级的子系统。eBPF 程序架构强调安全性和稳定性，看上去更像内核模块，但与内核模块不同，eBPF 程序不需要重新编译内核，并且可以确保 eBPF 程序运行完成，而不会造成系统的崩溃。</p>
<p>下面是ebpf的<strong>简单架构</strong>，作基础介绍。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/ebpf1.png" alt="bpf-basic-arch"></p>
<ul>
<li><strong>用户态</strong></li>
</ul>
<ol>
<li>用户编写 eBPF 程序，可以使用 eBPF 汇编或者 eBPF 特有的 C 语言来编写。</li>
<li>使用 LLVM&#x2F;CLang 编译器，将 eBPF 程序编译成 eBPF 字节码。</li>
<li>调用 <code>bpf()</code> 系统调用把 eBPF 字节码加载到内核。</li>
</ol>
<ul>
<li><strong>内核态</strong></li>
</ul>
<ol>
<li>当用户调用 <code>bpf()</code> 系统调用把 eBPF 字节码加载到内核时，内核先会对 eBPF 字节码进行安全验证。</li>
<li>使用 <code>JIT（Just In Time）</code>技术将 eBPF 字节编译成本地机器码（Native Code）。</li>
<li>然后根据 eBPF 程序的功能，将 eBPF 机器码挂载到内核的不同运行路径上（如用于跟踪内核运行状态的 eBPF 程序将会挂载在 <code>kprobes</code> 的运行路径上）。当内核运行到这些路径时，就会触发执行相应路径上的 eBPF 机器码。</li>
</ol>
<p>下面是ebpf的<strong>整体结构</strong>，这更为具体。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/ebpf2.png" alt="linux_ebpf_internals"></p>
<p>eBPF 分为用户空间程序和内核程序两部分：</p>
<ul>
<li>用户空间程序负责加载 BPF 字节码至内核，如需要也会负责读取内核回传的统计信息或者事件详情；</li>
<li>内核中的 BPF 字节码负责在内核中执行特定事件，如需要也会将执行的结果通过 maps 或者 perf-event 事件发送至用户空间；</li>
</ul>
<p>其中用户空间程序与内核 BPF 字节码程序可以使用 map 结构实现双向通信，这为内核中运行的 BPF 字节码程序提供了更加灵活的控制。</p>
<p>用户空间程序与内核中的 BPF 字节码交互的流程主要如下：</p>
<ol>
<li>可以使用 LLVM 或者 GCC 工具将编写的 BPF 代码程序编译成 BPF 字节码；</li>
<li>然后使用加载程序 Loader 将字节码加载至内核；内核使用验证器（verfier） 组件保证执行字节码的安全性，以避免对内核造成灾难，在确认字节码安全后将其加载对应的内核模块执行；BPF 观测技术相关的程序程序类型可能是 kprobes&#x2F;uprobes&#x2F;tracepoint&#x2F;perf_events 中的一个或多个，其中：<ul>
<li><strong>kprobes</strong>：实现内核中动态跟踪。 kprobes 可以跟踪到 Linux 内核中的函数入口或返回点，但是不是稳定 ABI 接口，可能会因为内核版本变化导致，导致跟踪失效。</li>
<li><strong>uprobes</strong>：用户级别的动态跟踪。与 kprobes 类似，只是跟踪的函数为用户程序中的函数。</li>
<li><strong>tracepoints</strong>：内核中静态跟踪。tracepoints 是内核开发人员维护的跟踪点，能够提供稳定的 ABI 接口，但是由于是研发人员维护，数量和场景可能受限。</li>
<li><strong>perf_events</strong>：定时采样和 PMC。</li>
</ul>
</li>
<li>内核中运行的 BPF 字节码程序可以使用两种方式将测量数据回传至用户空间<ul>
<li><strong>maps</strong> 方式可用于将内核中实现的统计摘要信息（比如测量延迟、堆栈信息）等回传至用户空间；</li>
<li><strong>perf-event</strong> 用于将内核采集的事件实时发送至用户空间，用户空间程序实时读取分析。</li>
</ul>
</li>
</ol>
<h2 id="eBPF-的限制"><a href="#eBPF-的限制" class="headerlink" title="eBPF 的限制"></a>eBPF 的限制</h2><p>eBPF 技术虽然强大，但是为了保证内核的处理安全和及时响应，内核中的 eBPF 技术也给予了诸多限制，当然随着技术的发展和演进，限制也在逐步放宽或者提供了对应的解决方案。</p>
<ul>
<li>eBPF 程序不能调用任意的内核参数，只限于内核模块中列出的 BPF Helper 函数，函数支持列表也随着内核的演进在不断增加。（todo 添加个数说明）</li>
<li>eBPF 程序不允许包含无法到达的指令，防止加载无效代码，延迟程序的终止。</li>
<li>eBPF 程序中循环次数限制且必须在有限时间内结束，这主要是用来防止在 kprobes 中插入任意的循环，导致锁住整个系统；解决办法包括展开循环，并为需要循环的常见用途添加辅助函数。Linux 5.3 在 BPF 中包含了对有界循环的支持，它有一个可验证的运行时间上限。</li>
</ul>
<h1 id="CNI插件"><a href="#CNI插件" class="headerlink" title="CNI插件"></a>CNI插件</h1><p>CNI的全称是 Container Network Interface，即容器网络的 API 接口。最早是由CoreOS发起的容器网络规范，是Kubernetes网络插件的基础。其基本思想为：Container Runtime在创建容器时，先创建好network namespace，然后调用CNI插件为这个netns配置网络，其后再启动容器内的进程。现已加入CNCF，成为CNCF主推的网络模型。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>容器网络的配置是一个复杂的过程，为了应对各式各样的需求，容器网络的解决方案也多种多样，例如有flannel，calico，kube-ovn，weave等。同时，容器平台&#x2F;运行时也是多样的，例如有Kubernetes，Openshift，rkt等。如果每种容器平台都要跟每种网络解决方案一一对接适配，这将是一项巨大且重复的工程。当然，聪明的程序员们肯定不会允许这样的事情发生。想要解决这个问题，我们需要一个<strong>抽象的接口层，将容器网络配置方案与容器平台方案解耦</strong>。</p>
<p>CNI（Container Network Interface）就是这样的一个接口层，它定义了一套接口标准，提供了规范文档以及一些标准实现。采用CNI规范来设置容器网络的容器平台不需要关注网络的设置的细节，只需要按CNI规范来调用CNI接口即可实现网络的设置。</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p>CNI插件负责将网络接口插入容器网络命名空间（例如，veth对的一端，bridge网桥），并在主机上进行任何必要的改变（例如将veth的另一端连接到网桥）。然后将IP分配给接口，并通过调用适当的IPAM插件来设置与“IP地址管理”部分一致的路由。</p>
<ul>
<li>将容器添加至网络</li>
<li>将容器从网络中删除</li>
<li>IP分配</li>
</ul>
<h1 id="DPU智能网卡"><a href="#DPU智能网卡" class="headerlink" title="DPU智能网卡"></a>DPU智能网卡</h1><blockquote>
<p> DPU（数据处理单元）</p>
</blockquote>
<h2 id="网卡发展"><a href="#网卡发展" class="headerlink" title="网卡发展"></a>网卡发展</h2><p>传统数据中心基于冯诺依曼架构，所有的数据都需要送到CPU进行处理。随着数据中心的高速发展，摩尔定律逐渐失效，CPU的增长速度无法满足数据的爆发式增长，CPU的处理速率已经不能满足数据处理的要求。计算架构从以CPU为中心的Onload模式，向以数据为中心的Offload模式转变，而给CPU减负的重任就落在了网卡（网络适配器）上，这也推动了网卡的高速发展；从服务器网卡的功能上看，可以分为三个阶段：</p>
<p><strong>阶段1：基础功能网卡</strong></p>
<p>基础功能网卡（即普通网卡）提供2x10G或2x25G带宽吞吐，具有较少的硬件卸载能力，主要是Checksum，LRO&#x2F;LSO等，支持SR-IOV，以及有限的多队列能力。在云平台虚拟化网络中，基础功能网卡向虚拟机（VM）提供网络接入的方式主要是有三种：由操作系统内核驱动接管网卡并向虚拟机（VM）分发网络流量；由OVS-DPDK接管网卡并向虚拟机（VM）分发网络流量；以及高性能场景下通过SR-IOV的方式向虚拟机（VM）提供网络接入能力。</p>
<p><strong>阶段2：硬件卸载网卡</strong></p>
<p>在这种背景下，SmartNIC（智能网卡）应运而生。SmartNIC 技术诞生的初衷是以比普通CPU低得多的成本实现对各种虚拟化功能的支持，如SRIOV，overlay encap&#x2F;decap，以及部分vSwitch处理逻辑的offload。在服务器侧引入智能网卡，将网络、存储、操作系统中不适合CPU处理的高性能数据处理功能<strong>卸载</strong>到硬件执行，提升数据处理能力，释放CPU算力。</p>
<p><strong>阶段3：DPU智能网卡</strong></p>
<p>传统智能网卡上没有CPU，需要Host CPU进行管理。传统智能网卡除了具备标准网卡的功能外，主要实现网络业务加速。随着网络速度的提高，传统智能网卡将消耗大量宝贵的CPU内核来进行流量的分类、跟踪和控制。</p>
<p>DPU的出现是为了解决数据中心中存在三个方面共五大问题：节点间：服务器数据交换效率低、数据传输可靠性低，节点内：数据中心模型执行效率低，I&#x2F;O切换效率低、服务器架构不灵活，网络系统：不安全。</p>
<p>DPU区别于SmartNIC最显著的特点，DPU<strong>本身构建了一个新的网络拓扑</strong>，而不是简单的数据处理卸载计算；DPU可以脱离host CPU存在，而SmartNIC不行。这个本质的区别就是DPU可以<strong>构建自己的总线系统</strong>，从而控制和管理其他设备，也就是一个真正意义上的中心芯片。</p>
<h2 id="传统智能网卡-vs-DPU智能网卡"><a href="#传统智能网卡-vs-DPU智能网卡" class="headerlink" title="传统智能网卡 vs DPU智能网卡"></a>传统智能网卡 vs DPU智能网卡</h2><p>SmartNIC实现了部分卸载，即<strong>只卸载数据面</strong>，控制面仍然在Host CPU处理。从总体上来说SmartNIC的卸载操作是一个系统内的协作。</p>
<p>DPU实现了<strong>完全的卸载</strong>，服务器的数据面和控制面都卸载运行在DPU内部的嵌入式CPU中。DPU实现包括软件卸载和硬件加速两个方面，即将负载从Host CPU卸载到DPU的嵌入式CPU中，同时将负载数据面通过DPU内部的其他类型硬件加速引擎，如协处理器、GPU、FPGA、DSA等来处理。从总体上来说，DPU是两个系统间的协作，把一个系统卸载到另一个运行实体，然后通过特定的接口交互。</p>
<h1 id="RDMA"><a href="#RDMA" class="headerlink" title="RDMA"></a>RDMA</h1><p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/55142557">RDMA技术详解（一）：RDMA概述 - 知乎 (zhihu.com)</a>、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1420687">来点硬核的：什么是RDMA？ - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<h2 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h2><p>RDMA(RemoteDirect Memory Access)技术全称远程直接内存访问，是为了解决网络传输中服务器端数据处理的延迟而产生的。它将<strong>数据直接从一台计算机的内存传输到另一台计算机内存</strong>，无需双方操作系统的介入。这允许高吞吐、低延迟的网络通信，尤其适合在大规模并行计算机集群中使用。</p>
<h2 id="传统TCP-x2F-IP通信模式"><a href="#传统TCP-x2F-IP通信模式" class="headerlink" title="传统TCP&#x2F;IP通信模式"></a>传统TCP&#x2F;IP通信模式</h2><ul>
<li>内核空间协议栈拷贝以及内核空间喝用户空间的上下文切换开销：</li>
</ul>
<p>传统的TCP&#x2F;IP网络通信，数据需要通过用户空间发送到远程机器的用户空间。数据发送方需要讲数据从用户应用空间Buffer复制到<strong>内核空间</strong>的Socket Buffer中。然后Kernel空间中添加数据包头，进行数据封装。通过一系列多层网络协议的数据包处理工作，这些协议包括传输控制协议（TCP）、用户数据报协议（UDP）、互联网协议（IP）以及互联网控制消息协议（ICMP）等，数据才被Push到NIC网卡中的Buffer进行网络传输。消息接受方接受从远程机器发送的数据包后，要将数据包从NIC buffer中复制数据到Socket Buffer。然后经过一些列的多层网络协议进行数据包的解析工作。解析后的数据被复制到相应位置的用户应用空间Buffer。这个时候再进行系统上下文切换，用户应用程序才被调用。以上就是传统的TCP&#x2F;IP协议层的工作。如今随着社会的发展，我们希望更快和更轻量级的网络通信。</p>
<hr>
<ul>
<li>当前以小消息的发送为主，处理开销占主导地位：</li>
</ul>
<p>当今随着计算机网络的发展。消息通信主要分为两类消息，一类是Large messages，在这类消息通信中，网络传输延迟占整个通信中的主导位置。还有一类消息是Small messages，在这类消息通信中，消息发送端和接受端的<strong>处理开销</strong>占整个通信的主导地位。然而在现实计算机网络中的通信场景中，主要是<strong>以发送小消息为主</strong>。所有说发送消息和接受消息的处理开销占整个通信的主导的地位。具体来说，处理开销指的是<strong>buffer管理、在不同内存空间中消息复制、以及消息发送完成后的系统中断</strong>。</p>
<hr>
<ul>
<li>瓶颈在于消息经过内核进行一系列移动和复制：</li>
</ul>
<p>传统的TPC&#x2F;IP存在的问题主要是指<strong>I&#x2F;O bottleneck瓶颈问题</strong>。在高速网络条件下与网络I&#x2F;O相关的主机处理的高开销限制了可以在机器之间发送的带宽。这里感兴趣的高额开销是数据<strong>移动</strong>操作和<strong>复制</strong>操作。具体来讲，主要是传统的TCP&#x2F;IP网络通信是通过内核发送消息。<strong>Messaging passing through kernel</strong>这种方式会导致很低的性能和很低的灵活性。性能低下的原因主要是由于网络通信通过内核传递，这种通信方式存在的很高的数据移动和数据复制的开销。并且现如今<strong>内存带宽性相较如CPU带宽和网络带宽有着很大的差异</strong>。很低的灵活性的原因主要是所有网络通信协议通过内核传递，这种方式很难去支持新的网络协议和新的消息通信协议以及发送和接收接口。</p>
<h2 id="DMA简介"><a href="#DMA简介" class="headerlink" title="DMA简介"></a>DMA简介</h2><p>DMA(直接内存访问)是一种能力，允许在计算机主板上的设备直接把数据发送到内存中去，数据搬运<strong>不需要CPU的参与</strong>。</p>
<p>传统内存访问需要通过CPU进行数据copy来移动数据，通过CPU将内存中的Buffer1移动到Buffer2中。DMA模式：可以同DMA Engine之间通过硬件将数据从Buffer1移动到Buffer2，而不需要操作系统CPU的参与，大大降低了CPU Copy的开销。</p>
<img src="https://pic1.zhimg.com/80/v2-d359453c9269146cd93de5eed43993c8_720w.webp" alt="img" style="zoom:80%;" />

<h2 id="RDMA简介"><a href="#RDMA简介" class="headerlink" title="RDMA简介"></a>RDMA简介</h2><p>RDMA是一种概念，在两个或者多个计算机进行通讯的时候使用DMA， 从一个主机的内存直接访问另一个主机的内存。</p>
<img src="https://pic3.zhimg.com/80/v2-f081e8fce13d8b00e5a786399d20ca06_720w.webp" alt="img" style="zoom:80%;" />

<p>在实现上，RDMA实际上是一种智能网卡与软件架构充分优化的远端内存直接高速访问技术，通过将RDMA协议<strong>固化于硬件(即网卡)<strong>上，以及支持</strong>Zero-copy</strong>和<strong>Kernel bypass</strong>这两种途径来达到其高性能的远程直接数据存取的目标。 使用RDMA的优势如下：</p>
<ul>
<li>零拷贝(Zero-copy) - 应用程序能够直接执行数据传输，在<strong>不涉及到网络软件栈</strong>的情况下。数据能够被直接发送到缓冲区或者能够直接从缓冲区里接收，而不需要被复制到网络层。</li>
<li>内核旁路(Kernel bypass) - 应用程序可以直接在用户态执行数据传输，<strong>不需要在内核态与用户态之间做上下文切换</strong>。</li>
<li>不需要CPU干预(No CPU involvement) - 应用程序可以访问远程主机内存而<strong>不消耗远程主机中的任何CPU</strong>。远程主机内存能够被读取而不需要远程主机上的进程（或CPU)参与。远程主机的CPU的缓存(cache)不会被访问的内存内容所填充。</li>
<li>消息基于事务(Message based transactions) - 数据被处理为<strong>离散消息</strong>而不是流，消除了应用程序将流切割为不同消息&#x2F;事务的需求。</li>
<li>支持分散&#x2F;聚合条目(Scatter&#x2F;gather entries support) - RDMA原生态支持分散&#x2F;聚合。也就是说，<strong>读取多个内存缓冲区</strong>然后<strong>作为一个流</strong>发出去或者<strong>接收一个流</strong>然后<strong>写入到多个内存缓冲区</strong>里去。</li>
</ul>
<p>在具体的远程内存读写中，RDMA操作用于读写操作的远程虚拟内存地址包含在RDMA消息中传送，远程应用程序要做的只是在其本地网卡中<strong>注册相应的内存缓冲区</strong>。远程节点的CPU除在<strong>连接建立、注册调用</strong>等之外，在整个RDMA数据传输过程中并不提供服务，因此没有带来任何负载。</p>
<h1 id="DPDK"><a href="#DPDK" class="headerlink" title="DPDK"></a>DPDK</h1><p>转自：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/347693559">DPDK的基本原理、学习路线总结 - 知乎 (zhihu.com)</a></p>
<h2 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h2><p>网络设备（路由器、交换机、媒体网关、SBC、PS网关等）需要在瞬间进行大量的报文收发，因此在传统的网络设备上，往往能够看到专门的NP（Network Process）处理器，有的用FPGA，有的用ASIC。这些专用器件通过内置的硬件电路（或通过编程形成的硬件电路）高效转发报文，只有需要对报文进行深度处理的时候才需要CPU干涉。</p>
<p>但在公有云、NFV等应用场景下，基础设施以CPU为运算核心，往往不具备专用的NP处理器，操作系统也以通用Linux为主，网络数据包的收发处理路径如下图所示：</p>
<img src="https://pic4.zhimg.com/80/v2-39d9c5742815718ffc3e616342c75c9b_720w.webp" alt="img" style="zoom:80%;" />

<p>在虚拟化环境中，路径则会更长：</p>
<img src="https://pic3.zhimg.com/80/v2-ee0175b746bbf5eed76de9f29bb4bbda_720w.webp" alt="img" style="zoom:80%;" />

<p>由于包处理任务存在<strong>内核态与用户态的切换</strong>，以及<strong>多次的内存拷贝</strong>，系统消耗变大，<strong>以CPU为核心的系统存在很大的处理瓶颈</strong>。为了提升在通用服务器（COTS）的数据包处理效能，Intel推出了服务于IA（Intel Architecture）系统的DPDK技术。</p>
<h2 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h2><p>DPDK是Data Plane Development Kit（数据平面开发套件）的缩写。简单说，DPDK应用程序运行在操作系统的User Space，利用自身提供的数据面库进行收发包处理，<strong>绕过了Linux内核态协议栈</strong>，以提升报文处理效率。</p>
<p>DPDK是一组lib库和工具包的集合。最简单的架构描述如下图所示：</p>
<img src="https://pic3.zhimg.com/80/v2-f4b703475096e19c669d6cfc7128311e_720w.webp" alt="img" style="zoom:80%;" />

<p>上图蓝色部分是DPDK的主要组件（更全面更权威的DPDK架构可以参考Intel官网），简单解释一下：</p>
<ol>
<li>PMD：Pool Mode Driver，轮询模式驱动，通过非中断，以及数据帧进出应用缓冲区内存的零拷贝机制，提高发送&#x2F;接受数据帧的效率</li>
<li>流分类：Flow Classification，为N元组匹配和LPM（最长前缀匹配）提供优化的查找算法</li>
<li>环队列：Ring Queue，针对单个或多个数据包生产者、单个数据包消费者的出入队列提供无锁机制，有效减少系统开销</li>
<li>MBUF缓冲区管理：分配内存创建缓冲区，并通过建立MBUF对象，封装实际数据帧，供应用程序使用</li>
<li>EAL：Environment Abstract Layer，环境抽象（适配）层，PMD初始化、CPU内核和DPDK线程配置&#x2F;绑定、设置HugePage大页内存等系统初始化</li>
</ol>
<p>总结一下DPDK的核心思想：</p>
<ol>
<li>用户态模式的PMD驱动，去除中断，避免内核态和用户态内存拷贝，减少系统开销，从而提升I&#x2F;O吞吐能力</li>
<li>用户态有一个好处，一旦程序崩溃，不至于导致内核完蛋，带来更高的健壮性</li>
<li>HugePage，通过更大的内存页（如1G内存页），减少TLB（Translation Lookaside Buffer，即快表） Miss，Miss对报文转发性能影响很大</li>
<li>多核设备上创建多线程，每个线程绑定到独立的物理核，减少线程调度的开销。同时每个线程对应着独立免锁队列，同样为了降低系统开销</li>
<li>向量指令集，提升CPU流水线效率，降低内存等待开销</li>
</ol>
<p>下图简单描述了DPDK的多队列和多线程机制：</p>
<img src="https://pic1.zhimg.com/80/v2-a986564eecfb3e670ee5a6c05a2557ac_720w.webp" alt="img" style="zoom:80%;" />

<p>DPDK将网卡接收队列分配给某个CPU核，该队列收到的报文都交给该核上的DPDK线程处理。存在两种方式将数据包发送到接收队列之上：</p>
<ol>
<li>RSS（Receive Side Scaling，接收方扩展）机制：根据关键字，比如根据UDP的四元组<srcIP><dstIP><srcPort><dstPort>进行哈希</li>
<li>Flow Director机制：可设定根据数据包某些信息进行精确匹配，分配到指定的队列与CPU核</li>
</ol>
<p>当网络数据包（帧）被网卡接收后，DPDK网卡驱动将其存储在一个高效缓冲区中，并在MBUF缓存中创建MBUF对象与实际网络包相连，对网络包的分析和处理都会基于该MBUF，必要的时候才会访问缓冲区中的实际网络包</p>
<img src="https://pic1.zhimg.com/80/v2-e3025ebe60021a3e34b2dd94615bf8c4_720w.webp" alt="img" style="zoom:80%;" />
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/12/18/orange%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95%E4%B8%8E%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/18/orange%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95%E4%B8%8E%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">orange-debug和日志记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-18 21:02:38 / 修改时间：21:10:52" itemprop="dateCreated datePublished" datetime="2022-12-18T21:02:38+08:00">2022-12-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>记录一些bug和修改以及日志</p>
</blockquote>
<hr>
<h1 id="部署问题"><a href="#部署问题" class="headerlink" title="部署问题"></a>部署问题</h1><h2 id="云服务器应用防火墙设置"><a href="#云服务器应用防火墙设置" class="headerlink" title="云服务器应用防火墙设置"></a>云服务器应用防火墙设置</h2><p>在服务器上部署需要先设置端口才能连接</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E8%AE%BE%E7%BD%AE%E7%AB%AF%E5%8F%A3.png" alt="image-20221028144759472"></p>
<hr>
<h2 id="客户端发布"><a href="#客户端发布" class="headerlink" title="客户端发布"></a>客户端发布</h2><ul>
<li>图标<ul>
<li>资源文件那添加资源，选icon，然后导入一个ico的文件即可</li>
</ul>
</li>
<li>vs选择release x64，然后生成即可。</li>
</ul>
<hr>
<h1 id="内网穿透-p2p文件发送"><a href="#内网穿透-p2p文件发送" class="headerlink" title="内网穿透-p2p文件发送"></a>内网穿透-p2p文件发送</h1><p>发文件时，客户端互相connect不上，listen端无所谓，发起connect的那方马上就发现无法连接就返回了。这是因为主机在内网的缘故。</p>
<h2 id="NAT与内网穿透"><a href="#NAT与内网穿透" class="headerlink" title="NAT与内网穿透"></a>NAT与内网穿透</h2><p>假设A打算发文件给B，那么服务器只将客户端B连接服务器使用的ip发给了A，对于内网用户来说，B的这个ip是<strong>路由器网关</strong>的ip，要进行NAT转换才能到内网主机，NAT就是网络地址转换的意思，因此需要进行内网穿透。</p>
<p>对于内网用户来说，服务器接收到一个ip和一个端口，如果是公网用户，则这个ip是主机ip，端口是主机进程使用的端口；如果是内网用户，则这个ip是网关的ip，端口是映射表中的端口，根据这个端口，网关能知道要发送给哪个主机中的哪个进程。NAT转换表的映射如下：</p>
<img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/NAT%E6%98%A0%E5%B0%84%E8%A1%A8.png" alt="img" style="zoom:67%;" />

<p>内网穿透（<code>Intranet penetration</code>）就是通过一个公网服务器，让内网主机去连接服务器，服务器就能获取两个内网主机的ip和端口（实际上是各自的网关的ip和映射表中的端口），然后两个内网主机就可以通信了。</p>
<h2 id="UDP打洞"><a href="#UDP打洞" class="headerlink" title="UDP打洞"></a>UDP打洞</h2><p>这实际上就是内网穿透最通常的实现方式，服务器如何获取内网主机网关的ip和端口呢，总是要通过连接或者发送信息。因为TCP开销比UDP大得多，所以一般来讲都是使用UDP来实现内网穿透，所以也叫UDP打洞（<code>UDP hole punching</code>）。</p>
<p>当然使用TCP也是可以的。</p>
<hr>
<p>测NAT类型，用miwifi.com测试，每次打开第一次都是端口限制圆锥形，然后之后都是完全圆锥形。这是软件的问题，不管怎么样，是cone类型即可。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/nattype2.png" alt="image-20221031110618667"></p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/nattype.png" alt="image-20221030210807715"></p>
<h2 id="客户端中的问题"><a href="#客户端中的问题" class="headerlink" title="客户端中的问题"></a>客户端中的问题</h2><p>原来我以为已经实现了内网穿透了…但刚开始没去细想，理解还是片面了，其实并没有实现。</p>
<p>注意这里的<strong>端口映射是映射到一个进程</strong>的，也就是说内网穿透实际上是<strong>进程（线程）与进程（线程）</strong>之间的互相穿透。</p>
<p>然而客户端只有主线程和接收线程连上了服务器，发送文件和接收文件的线程并没有！这两个线程才是真正需要p2p对端发送文件的，但<strong>由于接收文件线程是临时创建的，所以需要再内网穿透</strong>，因此要让接收文件线程也去连接服务器，让发送线程获取ip端口信息才行。回顾一下先前的设计：</p>
<ul>
<li>1）用户A发送sendfile请求，服务器发sendfilefrom给B</li>
<li>2）用户B发送acceptfile给服务器，并开始listen等待连接</li>
<li>3）服务器给A发一个sendfile accept + ip信息，A准备根据这个 ip 和sendfile port连接B（实际上该ip是B的网关ip，但是并没有端口映射到接收文件线程）<ul>
<li>A首先根据ip连接到网关</li>
<li>然后网关根据port查映射表</li>
<li>但由于B接收文件线程没有在网关中添加映射，首先网关肯定不能映射到该线程；并且网关需要查询的port也不一定就是sendfile port（因为网关添加映射是它自己添加的，port怎么样在添加前并不清楚）</li>
</ul>
</li>
</ul>
<p>因此需要B去连接服务器，一方面让网关添加映射，一方面让服务器获取网关自己添加的映射表中的端口。</p>
<p>简单的想法是直接让接收文件线程去TCP连接服务器，然后让其发送acceptfile命令，这里实现UDP打洞。</p>
<p>当用户B发送acceptfile的命令时，还是让命令主线程直接发送，接着让接收线程创建socket后直接向服务器的端口发一个信息。服务器在获取这个信息时，知道这个命令就是接收文件线程发过来的，就直接把ip和port发给发送文件线程。</p>
<p>更具体的实现是：</p>
<ul>
<li>首先服务器新建一个listen套接字(和服务器一起初始化)，这是因为另外两个套接字在连接时都会做一些后续动作（添加映射表和向epoll注册事件），这里并不需要，因为连接是一次性的。</li>
<li>然后当服务器收到acceptfile请求后，不像之前一下拼接ip就发回去了，而是调用recvfrom阻塞（如果客户端发的比较慢）等待或直接获取（如果客户端发得快）客户端sendto发送的信息（因为udp不确保正确，所以随便发就可以了），然后把ip和port拼接发给目标就可以了。</li>
<li>客户端直接创建完socket就sendto，不管服务器有没有收到，然后进行listen等待对端传输文件。</li>
</ul>
<p>注意这里的问题不能在用户较多并且同时使用acceptfile时区分是哪个用户，这也是UDP打洞的问题所在，除非再添加其他实现。这里不搞那么复杂。</p>
<hr>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>定义端口号为10000，在云服务器防火墙添加UDP规则。</p>
<p>UDP流程如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/UDP.png" alt="image-20221030200457821"></p>
<p>主要介绍两个函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> * buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr * src_addr, <span class="type">socklen_t</span> * addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">recvfrom: 用于接收数据</span></span><br><span class="line"><span class="comment">- sockfd：用于接收UDP数据的套接字；</span></span><br><span class="line"><span class="comment">- buf：保存接收数据的缓冲区地址；</span></span><br><span class="line"><span class="comment">- len：可接收的最大字节数（不能超过buf缓冲区的大小）；</span></span><br><span class="line"><span class="comment">- flags：可选项参数，若没有可传递0；</span></span><br><span class="line"><span class="comment">- src_addr：存有发送端地址信息的sockaddr结构体变量的地址；</span></span><br><span class="line"><span class="comment">- addrlen：保存参数 src_addr的结构体变量长度的变量地址值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">返回值：成功为发送的字节数，失败为<span class="number">-1</span>，失败原因存于errno</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sendto</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> * buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> sockaddr * dest_addr, <span class="type">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">sendto:用于发送数据</span></span><br><span class="line"><span class="comment">- sockfd：用于传输UDP数据的套接字；</span></span><br><span class="line"><span class="comment">- buf：保存待传输数据的缓冲区地址；</span></span><br><span class="line"><span class="comment">- len：带传输数据的长度（以字节计）；</span></span><br><span class="line"><span class="comment">- flags：可选项参数，若没有可传递0；</span></span><br><span class="line"><span class="comment">- dest_addr：存有目标地址信息的 sockaddr 结构体变量的地址；</span></span><br><span class="line"><span class="comment">- addrlen：传递给参数 dest_addr的地址值结构体变量的长度。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">返回值：成功为发送的字节数，失败为<span class="number">-1</span>，失败原因存于errno</span><br></pre></td></tr></table></figure>

<p>recvfrom相当于把accept的事情做了（保存了客户端地址端口），sendto相当于把connect的事情做了（用到了服务器的ip和port）</p>
<p>对于listen来说，该bind还是要bind，才能启动监听，但不用调用listen()函数。后面可以看到，创建socket的方式基本都是相同的，当创建一个套接字时，它被假设为一个主动套接字，也就是说，它是一个将调用connect连接的客户套接字。listen函数把一个未连接的套接字转换成一个被动套接字，指示内核应该接受指向该套接字的连接请求。</p>
<p>而UDP不是面向连接的，当然不用listen()了，创建出来的端口发送可接收。<strong>接收的话就要bind，仅发送就不用bind</strong>。bind的作用是，使得这个套接字的<strong>接收是从该端口接收的，发送是从该端口发送</strong>的（使得报文中的源端口是该端口）。所以一般客户端不用bind某个端口，交给系统从connect后选择，这样同样的代码可以避免bind同一个端口，否则每次都要改端口。而当需要<strong>收发端口统一</strong>时，请使用bind。</p>
<p>服务器端实现，初始化UDP监听端口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;create listen socket error, port-%d&quot;</span>,port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//端口复用，在bind前设置，否则bind时出错就晚了</span></span><br><span class="line">    <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;set socket setsockopt error !&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;bind port-%d error !&quot;</span>,port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//完事了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原来的acceptfile命令的处理基本长这样，需要在sendstr前把ip和端口拿到。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">acceptfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">        sendstr = <span class="string">&quot;@#sendfile accept &quot;</span>+myip;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加一个函数，放回ip和port的string。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];<span class="comment">//对数据不感兴趣</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;udp hole punching receive error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">        string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line">        <span class="built_in">LOG_DEBUG</span>(<span class="string">&quot;udp hole punching ip: %s, port: %s&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器差不多就完成了，下面是客户端的修改。客户端主要是在recvfile这个函数做修改，在函数开始前发送udp打洞信息即可，实现一个函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    sockfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (sockfd == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp socket error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;udp&quot;</span>;</span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(sockfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="linux-windows字符集问题"><a href="#linux-windows字符集问题" class="headerlink" title="linux-windows字符集问题"></a>linux-windows字符集问题</h1><p>linux和windows编码不一样，中文乱码</p>
<h1 id="一些奇妙的bug"><a href="#一些奇妙的bug" class="headerlink" title="一些奇妙的bug"></a>一些奇妙的bug</h1><h2 id="客户端退出问题"><a href="#客户端退出问题" class="headerlink" title="客户端退出问题"></a>客户端退出问题</h2><ul>
<li><p>客户端接收线程recv阻塞退出问题</p>
<ul>
<li><p>一开始很奇怪，exit后服务器关闭套接字，然后接收线程就出问题了，recv是-1然后退出一直循环。</p>
</li>
<li><p>这个问题是因为使用了<code>size_t recvbytes = recv(connfd, recvbuf, sizeof(recvbuf), 0);</code>其中size_t无法让返回值变成负数，因此判断-1失效，无法获取服务器已关闭的消息。</p>
</li>
<li><p>然后发现了更怪的问题，就是服务器只close主线程的套接字，接收线程的并没有管，为什么接收线程会退出呢？</p>
</li>
<li><p>查看socket的error字段，发现是10053，即主机主动关闭了连接。思考可能是主线程退出后关了些东西使得接收线程也失败了。检查发现主线程只关了自己的套接字，（一开始没有发现）再仔细看发现执行了<code>WSACleanup();</code>使得socket都退出了，这也难怪接收线程会直接退出。</p>
</li>
<li><p>然而这并不是什么不好的事情，因为本来接收线程recv阻塞也不好退出，现在刚好根据主线程退出，二者同时close掉套接字，然后服务器分别响应并close。分别响应的原因是，当客户端自己崩了的话也是二者同时close掉套接字，此时服务器也应该是分别响应的。</p>
</li>
</ul>
</li>
<li><p>注意客户端调用exit后会close自己的套接字，所以服务器可以直接根据close这个信息来exit_，不需要根据exit命令来操作；这样可以把客户端正常退出和异常退出的情况合起来。</p>
</li>
</ul>
<hr>
<h2 id="cout多线程安全问题"><a href="#cout多线程安全问题" class="headerlink" title="cout多线程安全问题"></a>cout多线程安全问题</h2><ul>
<li>cout多线程安全问题，这个在客户端里涉及。因为cout本身是流对象重载了&lt;&lt;函数，所以&lt;&lt;endl和前面的不是同个函数调用（flush同理），因此会被其他线程的cout挤掉，就导致输出混乱（主要是换行endl被挤掉了不好看）。解决方法是：<ul>
<li>换行符直接写到字符串里，但cout刷新缓冲不支持，可能不能及时输出，因为\n在cout中不会刷新，刷新时机：<ul>
<li>程序正常退出会刷新cout的缓冲区</li>
<li>一些输出操纵符可以帮助我们刷新，比如endl,flush,ends  代码实例： cout&lt;&lt;”hello”&lt;&lt;flush；由于重载函数，每个&lt;&lt;都可以被其他线程挤掉</li>
<li>将输入于输出绑定在一起，则输入会导致刷新输出的缓冲区 代码：cin.tie(&amp;cout)</li>
<li>也可以通过unitbuf操纵符设置流的内部状态，从而清空缓冲区</li>
</ul>
</li>
<li>使用<strong>printf</strong>，在printf中<strong>\n会刷新缓冲区</strong>，刷新时机<code>程序正常退出，输出字符带有‘/n’,调用函数fflush(stdout),发生标准输入</code>，但注意printf能打印的格式是有限制的，cout可以打印重载了&lt;&lt;运算符的对象。</li>
<li>c++20中出现了std::format，太新了先不用</li>
<li>也可以cout时加个互斥锁。。。</li>
</ul>
</li>
<li>解决方法就是在接收线程那cout尽量改为printf，主线程使用cout就不用改了（也比较多）。为什么说尽量，因为有的cout不用换行。</li>
</ul>
<hr>
<h2 id="服务器命令解析问题-gdb调试"><a href="#服务器命令解析问题-gdb调试" class="headerlink" title="服务器命令解析问题-gdb调试"></a>服务器命令解析问题-gdb调试</h2><p>在chatting的一方exit后服务器崩溃，出现<code>Segmentation fault (core dumped)</code>。需要用gdb查看core文件，首先<code>ulimit -c unlimited</code>，然后在Makefile编译选项加个<code>-g</code>（就是-o2那里）。</p>
<p><strong>不过我还是没产生core文件</strong>，直接<code>gdb server</code>，在gdb内运行程序（<code>start</code>），一直<code>n</code>或<code>next</code>跳转到start那行代码，然后复现bug，最终发现是命令解析出了问题：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/bug1.png" alt="image-20221028172207557"></p>
<p>唯一的可能是：因为chatting中要退出，所以要使用@，这说明要进一步检查@这一部分。</p>
<p>跟踪客户端的代码，对于@命令的解析是这样的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//首先看第一个字符是不是@，是的话去掉就好了</span></span><br><span class="line">    <span class="keyword">if</span> (cmdstr[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">        cmdstr = cmdstr.<span class="built_in">substr</span>(<span class="number">1</span>, cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//返回值是右值，外部vector会接收右值，调用移动构造</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到为了复用没有@的解析，把传进来的cmdstr的@去掉了，但是上层并没有去掉，直接发给服务器了，就出问题了。所以要么把发的去掉，要么收的时候去掉。这里使用引用的话会把换行也消了，所以打算修改服务器端的代码。</p>
<p>改完之后这个bug就解决了。</p>
<hr>
<h2 id="很小的失误都会导致崩溃"><a href="#很小的失误都会导致崩溃" class="headerlink" title="很小的失误都会导致崩溃"></a>很小的失误都会导致崩溃</h2><ul>
<li>用户1accept后服务器没有把用户1的名字发给用户2，只发了<code>@#chat accept</code>，导致用户2访vector越界。</li>
<li>用户1accept后忘记切换状态了。</li>
</ul>
<hr>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/bug2.png" alt="image-20221028232057720"></p>
<p>这个bug是客户端sendfile后，对端因为服务器发过来的filename是空导致取filename时vec越界崩溃。</p>
<p>检查发现是服务器在处理sendfile命令时获取文件名使用的：<code>find_last_of</code>，打成了<code>find_last_not_of</code>，这样总是找到最后一个位置，然后把filename变成空。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> pos = filename.<span class="built_in">find_last_of</span>(<span class="string">&quot;/\\&quot;</span>);<span class="comment">//把not去掉</span></span><br><span class="line"><span class="keyword">if</span> (pos != string::npos)</span><br><span class="line">    filename = filename.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//并且加一个保护，以防发了个文件夹过来，比如a/</span></span><br><span class="line"><span class="keyword">if</span>(filename == <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    sendstr = <span class="string">&quot;filename error, please break and check!&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(myconn2, sendstr.<span class="built_in">c_str</span>(), sendstr.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>相同ip会导致映射表冲刷。这是因为使用了交换机，发给服务器的ip是交换机的ip。</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><ul>
<li>2022-10-12：有个idea，开始设计</li>
<li>接下来两天：设计客户端状态机和初步完成代码，还有一堆烦人的课程作业</li>
<li>接下来五天：根据状态机边设计边实现若干业务处理函数，还有一堆烦人的课程作业</li>
<li>接下来大概三天：完善最后的逻辑补充，如一些特殊情况的思考，以及补充一些边写边想起来的命令（config那些），还有一堆烦人的课程作业</li>
<li>接下来四天：实现服务端的设计，复杂度主要在用户映射和逻辑处理的那块，还有一堆烦人的课程作业</li>
<li>2022-10-26：客户端和服务端都完成，由于代码在markdown中手写，有少量warning和error，迅速改完后已经能成功跑起来了<br>接下来两三天：测bug，还是有一些问题，内存越界啊cout多线程安全，都是小事（一查查半天hh），调试后能正确运行，还有一堆烦人的课程作业</li>
<li>2022-10-30：基于tcp的p2p文件传输无响应，猜测是内网无法连接，准备进行内网穿透的实现，从NAT的类型开始了解，进行了简单的udp打洞测试（基于c++）</li>
<li>2022-10-31：udp打洞逐渐深入，实现了逆向连接（NAT和公网客户端），由于网络资源不允许（大多数人使用校园网是对称型，这种无法穿透），还无法进行双NAT下的udp打洞内网穿透；测试了tcp逆向连接的完成（基于conntrack连接跟踪原理，穿透了防火墙），这个过程中发现了TCP同时打开的现象（双主动connect实现tcp连接建立）</li>
<li>2022-11-1：周二课多，没写代码。系统了解了TCP同时打开的原理，整理了一篇博客（技术讲解博客确实写得少）</li>
<li>接下来三天：这几天没怎么干，有一堆烦人的课程作业，然后周五考试，考完下午散了下心</li>
<li>2022-11-5：借助小薛的路由器（NAT是圆锥型，可以穿透）验证了udp打洞的内网穿透；但基于tcp的内网穿透一直无法实现。</li>
<li>接下来两天：打算用quic实现udp可靠文件传输。试着配msquic环境，然而微软这个文档写的真逆天，作者测试也不完全，网上也没有相关的配置博客，折磨了两天放弃了（win10的TLS1.3打开了也test失败）</li>
<li>接下来两天：事情多，课多以及写课程大作业…</li>
<li>2022-11-9：不打算用quic了，看了其他RDT的UDP，有UDT和RUDP，GitHub上看开源项目看了好久，不太热门的东西文档太烂了，而且接口也不写明白；还看了下别人实现的简单的RDT的UDP，写的太烂了。浪费一中午和一下午时间和一个傍晚的时间，急，项目被卡着快两周了。还是要整理下心情</li>
<li>2022-11-10：打算自己写一个RDT的UDP，并且不参考tcp而参考quic，当然只是简单实现。估计要写很久了，接下来事情好多。</li>
<li>2022-11-20：十天过去了，下半学期开始后好忙…</li>
<li>2022-11-27：终于完成了RDT的UDP实现，但还没融入到项目里，之后还要肝大作业，需要等寒假再完成了。</li>
<li>2022-12-18：大作业队友迟迟不干活，把项目整理完，项目开发到此为止。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/12/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%912/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%912/" class="post-title-link" itemprop="url">「orange」-server2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-18 21:02:35 / 修改时间：10:35:15" itemprop="dateCreated datePublished" datetime="2022-12-18T21:02:35+08:00">2022-12-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="任务分发-epoll"><a href="#任务分发-epoll" class="headerlink" title="任务分发-epoll"></a>任务分发-epoll</h1><ul>
<li>使用非阻塞的、ET模式的IO</li>
</ul>
<p>每次添加事件、修改事件、删除事件都是差不多的流程，可以封装一下，并且epollfd的create和close可以变成RAII的管理模式。</p>
<p>因为上层调用时，事件的类型是不一样的（读转读、读转写、写转写等），为了接口易用与通用，让上层传入events描述事件类型。events是一个uinit32_t，也即32位无符号整数类型。</p>
<p>封装很简单，只需要支持添加、修改、删除、调用epoll_wait、设置非阻塞（这个也让上层决定，默认非阻塞）即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Epoller.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> EPOLLER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EPOLLER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span> <span class="comment">//epoll操作</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>  <span class="comment">// fcntl()</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> <span class="comment">// close()</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Epoller</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> eventSize;</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> nonBlock;</span><br><span class="line">    <span class="type">int</span> epollFd;</span><br><span class="line">    </span><br><span class="line">    std::vector&lt;<span class="keyword">struct</span> epoll_event&gt; events;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Epoller</span>(<span class="type">const</span> <span class="type">int</span> eventsize = <span class="number">1024</span>, <span class="type">const</span> <span class="type">bool</span> ifNonBlock = <span class="literal">true</span>):</span><br><span class="line">    <span class="built_in">eventSize</span>(eventsize),<span class="built_in">nonBlock</span>(ifNonBlock),<span class="built_in">epollFd</span>(<span class="built_in">epoll_create</span>(<span class="number">5</span>)),<span class="built_in">events</span>(eventsize)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(epollFd&gt;=<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Epoller</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(epollFd);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">setFdNonblock</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="built_in">fcntl</span>(fd, F_SETFL, <span class="built_in">fcntl</span>(fd, F_GETFL, <span class="number">0</span>) | O_NONBLOCK);<span class="comment">//出错返回-1</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">addFd</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//如果需要设置非阻塞，根据布尔运算就会调用SetFdNonblock函数，如果返回不是-1就成功，是-1就返回false</span></span><br><span class="line">        <span class="keyword">if</span>(nonBlock &amp;&amp; (<span class="built_in">setFdNonblock</span>(fd)==<span class="number">-1</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        epoll_event ev = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        ev.data.fd = fd;<span class="comment">//关联fd</span></span><br><span class="line">        ev.events = events;<span class="comment">//上层设置好类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> == <span class="built_in">epoll_ctl</span>(epollFd, EPOLL_CTL_ADD, fd, &amp;ev);<span class="comment">//add，成功返回0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">modFd</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        epoll_event ev = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        ev.data.fd = fd;</span><br><span class="line">        ev.events = events;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> == <span class="built_in">epoll_ctl</span>(epollFd, EPOLL_CTL_MOD, fd, &amp;ev);<span class="comment">//mod</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">delFd</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> == <span class="built_in">epoll_ctl</span>(epollFd, EPOLL_CTL_DEL, fd, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//对于timeout：-1：永远等待；0：不等待直接返回，执行下面的代码；其他：在超时时间内没有事件发生，返回0，如果有事件发生立即返回</span></span><br><span class="line">    <span class="comment">//默认不等待</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">wait</span><span class="params">(<span class="type">int</span> timeoutMs = <span class="number">0</span>)</span> <span class="comment">//成功返回多少事件就绪，超时返回0，出错返回-1</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">epoll_wait</span>(epollFd, &amp;events[<span class="number">0</span>], eventSize, timeoutMs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getEventFd</span><span class="params">(<span class="type">size_t</span> i)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> events[i].data.fd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">uint32_t</span> <span class="title">getEvents</span><span class="params">(<span class="type">size_t</span> i)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> events[i].events;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>调用epoller伪代码：</p>
<p>简单说明一下异常事件：</p>
<ul>
<li>EPOLLRDHUP：对方调用close()正常断开连接，服务器会得知该信息；或者直接终止进程，操作系统会自动向服务器发FIN，也会得知。</li>
<li>EPOLLHUP：异常断开，当socket的一端认为对方发来了一个不存在的4元组请求的时候，会回复一个RST响应，在epoll上会响应为EPOLLHUP事件。<ul>
<li>RST：表示重置连接、复位连接。一般有两种场景：</li>
<li>对于客户端：当客户端向一个没有在listen的服务器端口发送的connect的时候，服务器会返回一个RST，因为服务器根本不知道这个4元组的存在。</li>
<li>对于服务器：当客户端的系统突然崩溃（kill pid或者正常关机不行的，因为操作系统会发送FIN给对方），这时服务器从4元组发到客户端的数据就发回一个RST。<ul>
<li>使用<strong>shutdown、close</strong>关闭套接字，发送的是FIN，<strong>不是RST</strong>。</li>
<li>套接字关闭前，使用<strong>sleep</strong>。对运行的程序<strong>Ctrl+C</strong>，会发送FIN，<strong>不是RST</strong>。</li>
<li>套接字关闭前，执行<strong>return、exit(0)、exit(1)<strong>，会发送FIN、</strong>不是RST</strong>。</li>
</ul>
</li>
<li>以上后两个是操作系统干的。</li>
</ul>
</li>
<li>EPOLLERR：上面两个异常事件都是服务器被动从客户端返回的（FIN或RST）信息得知的，EPOLLERR是服务器<strong>主动采取动作</strong>，如read和write时，发现对方出问题了，就出现这个异常。</li>
</ul>
<hr>
<p>关于两个监听端口：</p>
<ul>
<li>之前在客户端中简单描述为“两个监听线程”，本来想用两个线程、两个epoll池的。但实际上可以只在主线程里根据epoll响应两个端口上的连接请求</li>
<li>因此实际上两个监听端口都在主线程accept，通过epoll_wait判断是listenfd1还是listenfd2即可。</li>
<li>这是因为发送线程不会接收信息，它唯一的作用就是用于判断连接这个端口的是客户端的接收线程。那么两个监听端口就可以共用一个epoll池，因为epoll池响应到的connfd一定是listenfd1上的，就不需要两个epoll池分别响应connfd了。</li>
<li><strong>不过因为这样叫方便，还是叫做什么什么线程来区分这两个东西，但其实都在主线程。</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;epoller.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX_EVENT = <span class="number">20</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> timeout = <span class="number">0</span>;<span class="comment">//不阻塞</span></span><br><span class="line"><span class="function">unique_ptr&lt;Epoller&gt; <span class="title">epoller</span><span class="params">(<span class="number">1024</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span><span class="comment">//主进程</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">threadpool <span class="title">threadp</span><span class="params">(<span class="number">20</span>)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> eventCnt = epoller.<span class="built_in">wait</span>(timeout);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;eventCnt; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> fd = epoller.<span class="built_in">getEventFd</span>(i);</span><br><span class="line">            <span class="type">uint32_t</span> events = epoller.<span class="built_in">getEvents</span>(i)</span><br><span class="line">            <span class="comment">//处理epoll出错和对端关闭情况</span></span><br><span class="line">            <span class="keyword">if</span>(fd == listenfd1)<span class="comment">//注意有两个listen端口</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">listen_1</span>();<span class="comment">//把所有connect的都accept，ET模式要循环到底</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(fd == listenfd2)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">listen_2</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(events &amp; (EPOLLRDHUP | EPOLLHUP | EPOLLERR))<span class="comment">//异常事件</span></span><br><span class="line">            &#123;<span class="comment">//一般来讲，某个异常是客户端出问题，这样两个connfd都应该会异常，然后都关闭，</span></span><br><span class="line">                	<span class="comment">//所以不用根据一个把另一个同时关了，关这次的事件即可</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * 帮这个用户调exit_，删除表和让影响的对方退出，exit内会close套接字并删除事件</span></span><br><span class="line"><span class="comment">                * 这样用户直接exit_后，因为exit_内close了，就不会进入这里再exit_重复调用了</span></span><br><span class="line"><span class="comment">                * 而如果用户没有exit_直接关闭或崩溃，就帮忙exit_，总之就是只调用一次</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">if</span>(usermap.<span class="built_in">fvalue_conn1_ip</span>(fd) != <span class="string">&quot;&quot;</span>)<span class="comment">//如果是conn1</span></span><br><span class="line">                    <span class="built_in">exit_</span>(fd);<span class="comment">//nologin的话break_直接不会做什么事情</span></span><br><span class="line">                <span class="keyword">else</span><span class="comment">//conn2</span></span><br><span class="line">                &#123;</span><br><span class="line">                    epoller.<span class="built_in">delFd</span>(fd);<span class="comment">//从epoll内删除事件</span></span><br><span class="line">                    <span class="built_in">close</span>(fd);<span class="comment">//conn2直接close</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//其他处理</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(events &amp; EPOLLIN)<span class="comment">//处理读事件</span></span><br><span class="line">            &#123;</span><br><span class="line">                threadp.<span class="built_in">addTask</span>(<span class="built_in">bind</span>(task,fd));<span class="comment">//添加任务，该任务处理读与写</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//其他处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="recv处理"><a href="#recv处理" class="headerlink" title="recv处理"></a>recv处理</h2><p>task中的接收，只有recv才被epoll响应，send是直接工作的，所以不受ET影响，也不用重新注册</p>
<p>非阻塞情况下，recv返回大于0是字节数，返回等于<strong>0</strong>是网络断开了或copy出错，这是严重错误，不会设置errno；小于0（**-1**）是其他错误，保存在errno</p>
<p>注意：<strong>EPOLLHUP、EPOLLERR</strong>这两个在add和mod时不需要手动注册这两个事件，<strong>内核会自动添加</strong>这两个事件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> CONNEVENT = EPOLLONESHOT | EPOLLRDHUP | EPOLLET | EPOLLIN;</span><br><span class="line"><span class="function">string <span class="title">recv_str</span><span class="params">(<span class="type">int</span> conn1)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">256</span>];  </span><br><span class="line">    string recvstr;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//把接收缓冲清零</span></span><br><span class="line">        <span class="type">size_t</span> len = <span class="built_in">recv</span>(conn1, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">0</span>)<span class="comment">//copy出错或断开</span></span><br><span class="line">        &#123;</span><br><span class="line">            string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s [recv] error!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="type">uint32_t</span> connEvent = CONNEVENT;<span class="comment">//因为是oneshot，每次重新注册</span></span><br><span class="line">            epoller.<span class="built_in">modFd</span>(conn1, connEvent);<span class="comment">//重新设置，等下一次</span></span><br><span class="line">        	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;<span class="comment">//这次就不做了</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(errno == EAGAIN || errno == EWOULDBLOCK)<span class="comment">//说明读完了，两个errno是一样的意思</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">uint32_t</span> connEvent = CONNEVENT;<span class="comment">//因为是oneshot，每次重新注册</span></span><br><span class="line">                epoller.<span class="built_in">modFd</span>(conn1, connEvent);</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//正常结束</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(errno == EINTR)<span class="comment">//被中断了，重新读</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">//其他错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">                <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s [recv] error!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="type">uint32_t</span> connEvent = CONNEVENT;<span class="comment">//因为是oneshot，每次重新注册</span></span><br><span class="line">                epoller.<span class="built_in">modFd</span>(conn1, connEvent);<span class="comment">//重新设置，等下一次</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;<span class="comment">//这次就不做了</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//接收到了信息</span></span><br><span class="line">        &#123;</span><br><span class="line">            recvstr += <span class="built_in">string</span>(recvbuf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> recvstr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="listen处理"><a href="#listen处理" class="headerlink" title="listen处理"></a>listen处理</h2><p>简单一点的返回就accept返回-1就直接return了，但详细一点可以继续细分：</p>
<p>说明一下ECONNABORTED，这涉及TCP三次握手：</p>
<ul>
<li>首先客户端在connect时，发出第一次握手SYN</li>
<li>此时epoll中listenfd收到响应，进入accept处理，返回SYN+ACK第二次握手，并等待第三次握手</li>
<li>如果客户端返回ACK则accept成功，但如果客户端此时返回的是RST，就是这个异常事件了，但这个异常事件会被内核处理，上层直接跳过就好了。</li>
<li>前面说到RST是很偶然的情况，所以一般不进行处理也行。包括被系统中断其实也不常见。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//listen不用oneshot，所以不用重新注册</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">listen_1</span><span class="params">()</span><span class="comment">//accept一次是一个客户连接，ET模式下要连续accept把连接建立完</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">        <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line">        <span class="type">int</span> conn1 = <span class="built_in">accept</span>(listenfd1, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);</span><br><span class="line">    	<span class="comment">//成功返回非负数</span></span><br><span class="line">        <span class="keyword">if</span>(conn1 == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">//读完了就返回</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(errno == ECONNABORTED || errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;<span class="comment">//被中断了或客户端断开了就继续</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">LOG_DEBUG</span>(<span class="string">&quot;server accept error&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//向内核注册conn1</span></span><br><span class="line">        <span class="type">uint32_t</span> connEvent = CONNEVENT;</span><br><span class="line">        epoller.<span class="built_in">addFd</span>(conn1, connEvent);</span><br><span class="line">        </span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(client_addr.sin_addr));</span><br><span class="line">        usermap.<span class="built_in">ins_conn1_ip</span>(conn1,ip);<span class="comment">//添加映射</span></span><br><span class="line">        <span class="built_in">LOG_DEBUG</span>(<span class="string">&quot;server accept ip-%s&quot;</span>,ip.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">listen_2</span><span class="params">()</span><span class="comment">//accept一次是一个客户连接，ET模式下要连续accept把连接建立完</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">        <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line">        <span class="type">int</span> conn2 = <span class="built_in">accept</span>(listenfd2, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);</span><br><span class="line">    	<span class="comment">//成功返回非负数</span></span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">//读完了就返回</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(errno == ECONNABORTED || errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;<span class="comment">//被中断了或客户端断开了就继续</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">LOG_DEBUG</span>(<span class="string">&quot;server accept error&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//向内核注册conn2，注册是因为可能会有异常事件要处理</span></span><br><span class="line">        <span class="type">uint32_t</span> connEvent = CONNEVENT;</span><br><span class="line">        epoller.<span class="built_in">addFd</span>(conn2, connEvent);</span><br><span class="line">        </span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(client_addr.sin_addr));</span><br><span class="line">        usermap.<span class="built_in">ins_ip_conn2</span>(ip,conn2);<span class="comment">//添加映射</span></span><br><span class="line">        <span class="built_in">LOG_DEBUG</span>(<span class="string">&quot;server accept [2] ip-%s&quot;</span>,ip.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="初始化监听端口"><a href="#初始化监听端口" class="headerlink" title="初始化监听端口"></a>初始化监听端口</h2><p>命令主线程端口为9000，发送线程端口为8000</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> port1 = <span class="number">9000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> port2 = <span class="number">8000</span>;</span><br><span class="line"><span class="type">int</span> listenfd1;</span><br><span class="line"><span class="type">int</span> listenfd2;</span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> LISTENEVENT = EPOLLRDHUP | EPOLLET | EPOLLIN;</span><br><span class="line"><span class="comment">//因为accept是在主线程执行的，所以listenfd不需要oneshot，</span></span><br><span class="line"><span class="comment">//因为监听套接字在执行accept时主线程不会去调用wait，也就不会导致多线程竞争相同套接字</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_all_Socket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">init_one_Socket</span>(listenfd1,port1);</span><br><span class="line">    <span class="built_in">init_one_Socket</span>(listenfd2,port2);<span class="comment">//代码复用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_one_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_STREAM,IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;create listen socket error, port-%d&quot;</span>,port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//端口复用，在bind前设置，否则bind时出错就晚了</span></span><br><span class="line">    <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;set socket setsockopt error !&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;bind port-%d error !&quot;</span>,port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始监听，SOMAXCONN是系统给出的请求队列最大长度</span></span><br><span class="line">     <span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd,SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;listen port-%d error!&quot;</span>, port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint32_t</span> listenEvent = LISTENEVENT;</span><br><span class="line">    <span class="keyword">if</span>(!epoller.<span class="built_in">addFd</span>(listenfd, listenEvent))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;add listen to epoll error!&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;server listenning to port-%d&quot;</span>, port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明一下SO_REUSEADDR</p>
<ul>
<li><p>SO_REUSEADDR:</p>
</li>
<li><p>端口复用 </p>
</li>
<li><p>一般来说，一个端口释放后会等待一会之后才能再被使用，因为主动关闭会time_wait</p>
</li>
<li><p>SO_REUSEADDR只有针对time-wait连接，确保server重启成功的这一个作用</p>
</li>
<li><p>linux系统time-wait连接持续时间为1min。</p>
</li>
<li><p>SOL_SOCKET表示在套接字级别上设置选项</p>
</li>
<li><p>optval&#x3D;1：不等于0打开，等于0关闭</p>
</li>
<li><p>SO_REUSE<strong>ADDR</strong>是让端口释放后立即就可以被再次使用。</p>
</li>
<li><p>SO_REUSE<strong>PORT</strong>是让多个进程可以绑定相同端口，并发性更好，可扩展性强</p>
</li>
</ul>
<h1 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h1><p>之前的博客有完整的从头编写的步骤，可以完整地学习：<a href="https://jysama.cn/2022/09/28/websever%E6%A8%A1%E5%9D%97%E5%8C%96%E6%90%AD%E5%BB%BA/">WebServer模块单元测试 | JySama</a>，在<code>日志系统</code>部分。</p>
<h2 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BLOCKQUEUE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCKQUEUE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">blockqueue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::queue&lt;T&gt; que;</span><br><span class="line">    std::mutex mux;</span><br><span class="line">    std::condition_variable condprod;</span><br><span class="line">    std::condition_variable condcons;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">bool</span> isclose;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">blockqueue</span>(<span class="type">int</span> maxsize = <span class="number">1024</span>):<span class="built_in">size</span>(maxsize),<span class="built_in">isclose</span>(<span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(maxsize&gt;<span class="number">0</span>);<span class="comment">//初始化检查</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">blockqueue</span>()<span class="comment">//上层调用close即可</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">full</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T &amp;task)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(T&amp; task)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(T&amp; task, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> blockqueue&lt;T&gt;::<span class="built_in">empty</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这是日志系统调用的函数，阻塞队列的pop不能调用，否则会死锁</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> que.<span class="built_in">empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> blockqueue&lt;T&gt;::<span class="built_in">full</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这是日志系统调用的函数，阻塞队列的push不能调用，否则会死锁</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> que.<span class="built_in">size</span>()&gt;=size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> blockqueue&lt;T&gt;::<span class="built_in">push</span>(<span class="type">const</span> T &amp;task)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//插入元素，首先抢占互斥锁，但即使抢占了互斥锁也可能不能插入，队列可能是满的，这时要释放锁让消费者线程获得锁</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;<span class="comment">//要用条件变量，用unique锁</span></span><br><span class="line">    <span class="keyword">while</span>(que.<span class="built_in">size</span>()&gt;=size)<span class="comment">//避免虚假唤醒，notify_one一般不会导致虚假唤醒，但要随时最好准备。并且当要关闭时会notify_all</span></span><br><span class="line"> 		condprod.<span class="built_in">wait</span>(locker);<span class="comment">//等待唤醒</span></span><br><span class="line">    <span class="keyword">if</span>(isclose)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//不能插入元素</span></span><br><span class="line">    que.<span class="built_in">push</span>(task);<span class="comment">//插入元素</span></span><br><span class="line">    condcons.<span class="built_in">notify_one</span>();<span class="comment">//唤醒消费者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> blockqueue&lt;T&gt;::<span class="built_in">pop</span>(T&amp; task)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(que.<span class="built_in">empty</span>() <span class="keyword">and</span> !isclose)</span><br><span class="line">        condcons.<span class="built_in">wait</span>(locker);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(isclose)<span class="comment">//关闭的信号</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">    </span><br><span class="line">    task = que.<span class="built_in">front</span>();</span><br><span class="line">    que.<span class="built_in">pop</span>();</span><br><span class="line">    condprod.<span class="built_in">notify_one</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">bool</span> blockqueue&lt;T&gt;::<span class="built_in">pop</span>(T&amp; task, <span class="type">int</span> timeout)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(que.<span class="built_in">empty</span>() <span class="keyword">and</span> !isclose)<span class="comment">//为空就等待，等待过程中如果超时就返回</span></span><br><span class="line">        <span class="keyword">if</span>(condcons.<span class="built_in">wait_for</span>(locker,std::chrono::<span class="built_in">seconds</span>(timeout)) == std::cv_status::timeout)<span class="comment">//超时</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(isclose)<span class="comment">//关闭的信号</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    task = que.<span class="built_in">front</span>();</span><br><span class="line">    que.<span class="built_in">pop</span>();</span><br><span class="line">    condprod.<span class="built_in">notify_one</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> blockqueue&lt;T&gt;::<span class="built_in">close</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	* 当关闭时，我们的目标是要让所有的线程都退出，也就是不能被阻塞到push和pop里</span></span><br><span class="line"><span class="comment">    * 调用此函数的时机是，上层日志系统已经把任务都做完，然后关闭队列</span></span><br><span class="line"><span class="comment">    * 则调用这个函数后，所有想再次尝试push和pop的线程都不允许</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;<span class="comment">//要锁住，然后clear队列</span></span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    isclose = <span class="literal">true</span>;<span class="comment">//修改信号</span></span><br><span class="line">	<span class="comment">//唤醒所有线程</span></span><br><span class="line">    condprod.<span class="built_in">notify_all</span>();</span><br><span class="line">    condcons.<span class="built_in">notify_all</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="type">void</span> blockqueue&lt;T&gt;::<span class="built_in">clear</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//close已经锁住了，不用锁了</span></span><br><span class="line">    <span class="comment">//高效的方式，swap一个空队列</span></span><br><span class="line">    std::queue&lt;T&gt; empty;</span><br><span class="line">    std::<span class="built_in">swap</span>(empty, que);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="上层日志系统"><a href="#上层日志系统" class="headerlink" title="上层日志系统"></a>上层日志系统</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//头文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LOG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span>		<span class="comment">//opendir</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>         <span class="comment">//mkdir</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;blockqueue.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Log</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">Log</span>();<span class="comment">//单例模式构造函数私有，成员函数才能调用构造函数</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Log</span>(Log <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	Log&amp; <span class="keyword">operator</span>=(Log <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">Log</span>();<span class="comment">//关闭...//析构函数实际上和构造函数一样，可以private，因为本质上是成员函数调用</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Log* <span class="title">instance</span><span class="params">()</span></span>;<span class="comment">//单例</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//函数声明和定义，只能有一个使用默认参数，如果函数的声明和定义是分开的，那缺省函数不能在函数声明和定义中同时出现</span></span><br><span class="line">    <span class="comment">//默认参数在函数声明中提供，当又有声明又有定义时，定义中不允许默认参数（定义中的默认参数是无用的，必须传入参数才能找到匹配的函数）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> level=<span class="number">1</span>, <span class="type">const</span> <span class="type">char</span>* fpath = <span class="string">&quot;./log&quot;</span>,<span class="type">int</span> maxqueue_size=<span class="number">1024</span>,<span class="type">int</span> threadnum=<span class="number">1</span>)</span></span>;<span class="comment">//不能用构造函数传参，使用一个init传参初始化</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setlevel</span><span class="params">(<span class="type">int</span> level)</span></span>&#123;loglevel = level;&#125;<span class="comment">//修改level的接口，只允许主线程修改，因此不用互斥</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getlevel</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> loglevel;&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isopen</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> logisopen;&#125;<span class="comment">//看是否打开日志的接口</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createthread</span><span class="params">(<span class="type">int</span> threadnum)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">logthread</span><span class="params">()</span></span>;<span class="comment">//异步线程的回调函数，需要是staic，没有this隐藏参数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> <span class="type">char</span> *format,...)</span></span>;<span class="comment">//同步写，解耦</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">asyncwrite</span><span class="params">()</span></span>;<span class="comment">//互斥写，不用lambda表达式，因为要用到log类的变量，并修改它们</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">changefile</span><span class="params">(<span class="keyword">struct</span> tm *nowtime)</span></span>;<span class="comment">//write函数的解耦</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span>* <span class="built_in">gettime</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> maxlines = <span class="number">52000</span>;</span><br><span class="line">    FILE *logfp;</span><br><span class="line">    <span class="type">int</span> linecounts;</span><br><span class="line">    <span class="type">int</span> filenum;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* path;</span><br><span class="line">    <span class="type">int</span> logday;</span><br><span class="line">    <span class="type">bool</span> isasync;</span><br><span class="line">    <span class="type">bool</span> logisopen;</span><br><span class="line">    <span class="type">int</span> loglevel;</span><br><span class="line">    unique_ptr&lt;blockqueue&lt;string&gt;&gt; blockque;<span class="comment">//不用lambda表达式可以用uniqueptr，因为一个指针一起用。用指针是因为要根据队列长度动态构造</span></span><br><span class="line">    mutex mux;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们想用一个函数封装write函数，比如logoinfo调用level1的write，并且还要能判断loglevel支不支持</span></span><br><span class="line"><span class="comment">//但函数封装变参函数，为了传递可变参数，实际上还要修改write的实现，不如用宏来实现，使用##__VA_ARGS__传递可变参数，让编译器把宏替换为真实的函数</span></span><br><span class="line"><span class="comment">//##__VA_ARGS__的优点是，对于宏调用，如果format是一个字符串也即后面没有可变参数，## 操作将使预处理器（preprocessor）去除掉它前面的那个逗号。</span></span><br><span class="line"><span class="comment">//宏与类无关了，这里必须isopen了才能使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_BASE(level, format, ...) \</span></span><br><span class="line"><span class="meta">    do &#123;\</span></span><br><span class="line"><span class="meta">        Log* log = Log::instance();\</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (log-&gt;isopen() &amp;&amp; log-&gt;getlevel() &lt;= level) &#123;\</span></span><br><span class="line"><span class="meta">            log-&gt;write(level, format, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        &#125;\</span></span><br><span class="line"><span class="meta">    &#125; while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(format, ...) do &#123;LOG_BASE(0, format, ##__VA_ARGS__)&#125; while(0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(format, ...) do &#123;LOG_BASE(1, format, ##__VA_ARGS__)&#125; while(0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARN(format, ...) do &#123;LOG_BASE(2, format, ##__VA_ARGS__)&#125; while(0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(format, ...) do &#123;LOG_BASE(3, format, ##__VA_ARGS__)&#125; while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">Log* <span class="title">Log::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> Log instance;<span class="comment">//调用构造函数</span></span><br><span class="line">    <span class="keyword">return</span> &amp;instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">tm</span>* Log::<span class="built_in">gettime</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *nowtime;</span><br><span class="line">    <span class="type">time_t</span> t;</span><br><span class="line">    t = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    nowtime = <span class="built_in">localtime</span>(&amp;t);</span><br><span class="line">    <span class="keyword">return</span> nowtime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::changefile</span><span class="params">(<span class="keyword">struct</span> tm *nowtime)</span><span class="comment">//完成行数增加、判断文件切换</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接下来涉及行数的改写，以及文件的切换，要互斥。因为实际上一个线程切换文件即可，如果有线程在切换其他线程不可动</span></span><br><span class="line">    <span class="comment">//unique_lock&lt;mutex&gt; locker(mux);互斥交给上层，因为fputs也要互斥</span></span><br><span class="line">    linecounts++;<span class="comment">//先++，因为行数是从0开始的，++后刚好判断是不是满了，这个操作要互斥</span></span><br><span class="line">    <span class="keyword">if</span>(logday != nowtime-&gt;tm_mday || linecounts == maxlines)<span class="comment">//如果换了一天或行数满了</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> newname[<span class="number">48</span>];<span class="comment">//用snprintf，不能用string了</span></span><br><span class="line">        <span class="keyword">if</span>(logday != nowtime-&gt;tm_mday)<span class="comment">//如果是换了一天</span></span><br><span class="line">        &#123;</span><br><span class="line">            logday = nowtime-&gt;tm_mday;<span class="comment">//修改天</span></span><br><span class="line">            linecounts = <span class="number">0</span>;<span class="comment">//换文件了</span></span><br><span class="line">            filenum = <span class="number">0</span>;<span class="comment">//文件份数从0开始</span></span><br><span class="line">            <span class="comment">//为了格式化命名，要用format，这里用snprintf写入str</span></span><br><span class="line">            <span class="built_in">snprintf</span>(newname, <span class="number">48</span>, <span class="string">&quot;%s/%d-%02d-%02d_log%05d.txt&quot;</span>,<span class="comment">//补充一个前缀-文件夹</span></span><br><span class="line">                     path, nowtime-&gt;tm_year+<span class="number">1900</span>, nowtime-&gt;tm_mon+<span class="number">1</span>, nowtime-&gt;tm_mday, filenum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//行数满了</span></span><br><span class="line">        &#123;</span><br><span class="line">            linecounts = <span class="number">0</span>;</span><br><span class="line">            filenum++;</span><br><span class="line">            <span class="built_in">snprintf</span>(newname, <span class="number">48</span>, <span class="string">&quot;%s/%d-%02d-%02d_log%05d.txt&quot;</span>,</span><br><span class="line">                     path, nowtime-&gt;tm_year+<span class="number">1900</span>, nowtime-&gt;tm_mon+<span class="number">1</span>, nowtime-&gt;tm_mday, filenum);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">fflush</span>(logfp);<span class="comment">//在关闭文件前要把文件缓存区的内容写完</span></span><br><span class="line">        <span class="built_in">fclose</span>(logfp);</span><br><span class="line">        logfp = <span class="built_in">fopen</span>(newname,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">        <span class="built_in">assert</span>(logfp != <span class="literal">nullptr</span>);<span class="comment">//创建失败报错</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//locker.unlock();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::write</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> <span class="type">char</span> *format,...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化时间</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *nowtime = <span class="built_in">gettime</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//-----------------根据传入的信息整理成一行日志-------------------------</span></span><br><span class="line">    <span class="type">char</span> infobuffer[<span class="number">128</span>];<span class="comment">//一般一行日志没那么长，128足够了</span></span><br><span class="line">    <span class="type">char</span> timebuffer[<span class="number">36</span>];<span class="comment">//时间头</span></span><br><span class="line">    string allinfo;</span><br><span class="line">    <span class="comment">//分级</span></span><br><span class="line">    <span class="keyword">switch</span>(level)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            allinfo += <span class="string">&quot;[debug]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            allinfo += <span class="string">&quot;[info]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            allinfo += <span class="string">&quot;[warning]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            allinfo += <span class="string">&quot;[error]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            allinfo += <span class="string">&quot;[info]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//添加时间信息</span></span><br><span class="line">    <span class="built_in">snprintf</span>(timebuffer,<span class="number">36</span>, <span class="string">&quot;%d-%02d-%02d_%02d:%02d:%02d：&quot;</span>,</span><br><span class="line">             nowtime-&gt;tm_year+<span class="number">1900</span>, nowtime-&gt;tm_mon+<span class="number">1</span>, nowtime-&gt;tm_mday,</span><br><span class="line">            nowtime-&gt;tm_hour,nowtime-&gt;tm_min,nowtime-&gt;tm_sec);<span class="comment">//只精确到秒，更具体的信息交给内容体现</span></span><br><span class="line">    </span><br><span class="line">    allinfo += <span class="built_in">string</span>(timebuffer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//写内容</span></span><br><span class="line">    va_list vaList;</span><br><span class="line">    <span class="built_in">va_start</span>(vaList,format);</span><br><span class="line">    <span class="built_in">vsnprintf</span>(infobuffer,<span class="number">128</span>,format,vaList);</span><br><span class="line">    <span class="built_in">va_end</span>(vaList);</span><br><span class="line">    </span><br><span class="line">    allinfo += <span class="built_in">string</span>(infobuffer)+<span class="string">&quot;\n&quot;</span>;<span class="comment">//注意换个行</span></span><br><span class="line">    <span class="comment">//----------------------------------------------------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//分异步还是同步，要不要切换文件交给异步线程判断 </span></span><br><span class="line">    <span class="keyword">if</span>(isasync &amp;&amp; !blockque-&gt;<span class="built_in">full</span>())</span><br><span class="line">    	blockque-&gt;<span class="built_in">push</span>(allinfo);<span class="comment">//异步直接插入</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//在写之前看要不要创建新文件</span></span><br><span class="line">    	<span class="comment">//如果当前日期变了，一般来说判断day就可以了；或是行数已满，就换一个文件</span></span><br><span class="line">        </span><br><span class="line">        lock_guard&lt;mutex&gt; <span class="built_in">locker</span>(mux);<span class="comment">//互斥</span></span><br><span class="line">        <span class="built_in">changefile</span>(nowtime);<span class="comment">//直接交给该函数完成</span></span><br><span class="line">        <span class="built_in">fputs</span>(allinfo.<span class="built_in">c_str</span>(),logfp);<span class="comment">//操作文件缓冲区，也要互斥</span></span><br><span class="line">        <span class="built_in">fflush</span>(logfp);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Log::<span class="built_in">Log</span>()<span class="comment">//初始化一部分变量</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//初始行数为-1，因为是先++然后判断再写入，初始为0的话，第一份文件会少一行，</span></span><br><span class="line">    <span class="comment">//比如最大行为2，初始为0；则++，写入；++就换文件了，只写了一行，所以初始要是-1。换文件后置为0</span></span><br><span class="line">    <span class="comment">//因为换文件后没++了，写了一行，就是正确的</span></span><br><span class="line">    linecounts = <span class="number">-1</span>;</span><br><span class="line">    filenum = <span class="number">0</span>;</span><br><span class="line">    isasync = <span class="literal">false</span>;</span><br><span class="line">    blockque = <span class="literal">nullptr</span>;</span><br><span class="line">    logday = <span class="number">0</span>;</span><br><span class="line">    logfp = <span class="literal">nullptr</span>;</span><br><span class="line">    logisopen = <span class="literal">false</span>;<span class="comment">//init才算打开</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    logisopen = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(isasync)<span class="comment">//异步的话要让线程退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(!blockque-&gt;<span class="built_in">empty</span>());<span class="comment">//等待工作完成</span></span><br><span class="line">        </span><br><span class="line">        blockque-&gt;<span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(logfp)<span class="comment">//如果打开了文件要关闭</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//由于其他线程可能正在使用，因此要等待互斥锁</span></span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">        <span class="built_in">fflush</span>(logfp);<span class="comment">//刷新缓冲区</span></span><br><span class="line">        <span class="built_in">fclose</span>(logfp);</span><br><span class="line">        logfp = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Log::~<span class="built_in">Log</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::logthread</span><span class="params">()</span><span class="comment">//异步线程回调函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Log::<span class="built_in">instance</span>()-&gt;<span class="built_in">asyncwrite</span>();<span class="comment">//调用类成员函数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//等级越低允许记录的权限越低，fpath是文件夹，文件名内部设置</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::init</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> <span class="type">char</span>* fpath,<span class="type">int</span> maxqueue_size,<span class="type">int</span> threadnum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(logisopen == <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//只允许init一次</span></span><br><span class="line">    logisopen = <span class="literal">true</span>;</span><br><span class="line">    loglevel = level;</span><br><span class="line">    <span class="keyword">if</span>(maxqueue_size&gt;<span class="number">0</span>)<span class="comment">//有阻塞队列则异步</span></span><br><span class="line">    &#123;</span><br><span class="line">        isasync = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//创建阻塞队列</span></span><br><span class="line">        unique_ptr&lt;blockqueue&lt;string&gt;&gt; <span class="built_in">que</span>(<span class="keyword">new</span> <span class="built_in">blockqueue</span>&lt;string&gt;(maxqueue_size));</span><br><span class="line">        blockque = <span class="built_in">move</span>(que);<span class="comment">//移动赋值</span></span><br><span class="line">        <span class="built_in">createthread</span>(threadnum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        isasync = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化时间</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *nowtime = <span class="built_in">gettime</span>();    </span><br><span class="line">    logday = nowtime-&gt;tm_mday;</span><br><span class="line">    path = fpath;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> filename[<span class="number">48</span>];<span class="comment">//用snprintf，不能用string了</span></span><br><span class="line">    <span class="built_in">snprintf</span>(filename, <span class="number">48</span>, <span class="string">&quot;%s/%d-%02d-%02d_log%05d.txt&quot;</span>,<span class="comment">//补充一个前缀-文件夹</span></span><br><span class="line">             path, nowtime-&gt;tm_year+<span class="number">1900</span>, nowtime-&gt;tm_mon+<span class="number">1</span>, nowtime-&gt;tm_mday, filenum);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初步打开文件，没有文件夹就创建文件夹</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">opendir</span>(path) == <span class="literal">NULL</span>)<span class="comment">//如果文件夹不存在</span></span><br><span class="line">        <span class="built_in">mkdir</span>(path,<span class="number">0777</span>);<span class="comment">//0777是最大的访问权</span></span><br><span class="line"></span><br><span class="line">    logfp = <span class="built_in">fopen</span>(filename,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">	<span class="built_in">assert</span>(logfp!=<span class="literal">nullptr</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::asyncwrite</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str;</span><br><span class="line">    <span class="keyword">while</span>(blockque-&gt;<span class="built_in">pop</span>(str))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">tm</span>* nowtime = <span class="built_in">gettime</span>();</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;<span class="comment">//互斥</span></span><br><span class="line">        <span class="built_in">changefile</span>(nowtime);<span class="comment">//每写一行判断要不要换文件</span></span><br><span class="line">        <span class="built_in">fputs</span>(str.<span class="built_in">c_str</span>(),logfp);</span><br><span class="line">        <span class="built_in">fflush</span>(logfp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Log::createthread</span><span class="params">(<span class="type">int</span> threadnum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;threadnum;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">thread</span>(logthread).<span class="built_in">detach</span>();<span class="comment">//因为内部函数采用单例调用，logthread不用传入this指针</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="聊天记录存储"><a href="#聊天记录存储" class="headerlink" title="聊天记录存储"></a>聊天记录存储</h1><p>有了日志系统，要不要也设置一个聊天记录系统呢？实际上聊天记录要比日志系统简单很多，因为日志系统要把多个线程的日志记录写到一个文件，而聊天记录的存储实际上只是单线程记录的。因为设置了oneshot，在一次响应的过程中不会被其他线程响应，因此一个user的聊天记录存储工作就在这个线程里。</p>
<p>其次，聊天记录是同步的还是异步的，这也需要考量一番。我习惯把日志系统设置为异步的，是因为日志系统可以看成“汇聚所有应写的日志”，放入阻塞队列里用工作线程慢慢写入日志即可，这里面还有一个要点就是写入的文件在一段时间永远是同一个。</p>
<p>而聊天记录不同，一个user的聊天记录应该保存在一个文件里（目前先只考虑一个文件，而不考虑文件行数过多切换文件的情况），这样多个user在操作时就有多个文件的打开关闭。这样子用一个阻塞队列把这些记录汇集起来从逻辑上来说是有点奇怪的：</p>
<ul>
<li>一方面工作线程在获取阻塞队列的信息时把文件切换来切换去</li>
<li>一方面这个系统（如果真设计出来）保存的行数信息、天数信息都没什么用。</li>
<li>以及，因为聊天记录的字节大小不像一般的log记录那么精简，如果用阻塞队列很可能会有一段延时，导致记录的时间不对</li>
</ul>
<p>因此，聊天记录同步存储即可，就在task内完成记录，因为task本身就是一个线程，这也该是线程完成的事情。并且每次只需要userid即可知道写哪个文件，所以实际上写一个函数即可。</p>
<p>每记录一次都打开、关闭文件，而不是当用户时登录时打开文件并记录映射，等用户退出时关闭文件，因为经验不足还无法预知用户会干什么事情以及退出代码写的对不对，所以先这样。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">msg_log</span><span class="params">(string userid, string&amp; msglog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string filename = userid+<span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">    FILE *fp = <span class="built_in">fopen</span>(filename.<span class="built_in">c_str</span>(),<span class="string">&quot;a&quot;</span>);<span class="comment">//不用互斥，同时间只有一个线程操作</span></span><br><span class="line">    <span class="keyword">if</span>(fp == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//初始化时间</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *nowtime;</span><br><span class="line">    <span class="type">time_t</span> t;</span><br><span class="line">    t = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    nowtime = <span class="built_in">localtime</span>(&amp;t);</span><br><span class="line">    <span class="type">char</span> timebuffer[<span class="number">36</span>];<span class="comment">//时间头</span></span><br><span class="line">    <span class="comment">//添加时间信息</span></span><br><span class="line">    <span class="built_in">snprintf</span>(timebuffer,<span class="number">36</span>, <span class="string">&quot;%d-%02d-%02d_%02d:%02d:%02d：&quot;</span>,</span><br><span class="line">             nowtime-&gt;tm_year+<span class="number">1900</span>, nowtime-&gt;tm_mon+<span class="number">1</span>, nowtime-&gt;tm_mday,</span><br><span class="line">            nowtime-&gt;tm_hour,nowtime-&gt;tm_min,nowtime-&gt;tm_sec);<span class="comment">//只精确到秒，更具体的信息交给内容体现</span></span><br><span class="line">    string allmsg = <span class="built_in">string</span>(timebuffer)+msglog;</span><br><span class="line">    <span class="built_in">fputs</span>(allmsg.<span class="built_in">c_str</span>(),fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="退出函数"><a href="#退出函数" class="headerlink" title="退出函数"></a>退出函数</h1><p>写一个退出函数，在服务器开启时用一个线程接收退出信号</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个退出密码</span></span><br><span class="line"><span class="type">const</span> string exitpwd = <span class="string">&quot;jysama&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deal_close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="type">const</span> string exitstr = <span class="string">&quot;exit -p&quot;</span>+exitpwd+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string quitstr = <span class="string">&quot;quit -p&quot;</span>+exitpwd+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(buf, <span class="built_in">sizeof</span>(buf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(buf,exitstr.<span class="built_in">c_str</span>())==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(buf,quitstr.<span class="built_in">c_str</span>())==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">bzero</span>(buf,<span class="built_in">sizeof</span>(buf));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//close all</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="顶层"><a href="#顶层" class="headerlink" title="顶层"></a>顶层</h1><p>所有工作已经完成，现在进行封装。</p>
<p>比较复杂，不放代码了。。。</p>
<h2 id="数据库建立"><a href="#数据库建立" class="headerlink" title="数据库建立"></a>数据库建立</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 建立yourdb库</span><br><span class="line">create database yourdb;</span><br><span class="line"></span><br><span class="line">// 创建user表</span><br><span class="line">USE yourdb;</span><br><span class="line">CREATE TABLE user(</span><br><span class="line">    userid char(50) NULL,</span><br><span class="line">    password char(50) NULL</span><br><span class="line">)ENGINE=InnoDB;</span><br></pre></td></tr></table></figure>

<h2 id="makefile"><a href="#makefile" class="headerlink" title="makefile"></a>makefile</h2><p>g++ -o：</p>
<p><code>-O</code>: 同时减少代码的长度和执行时间，其效果等价于 <code>-O1</code></p>
<p><code>-O0</code>: 表示不做优化</p>
<p><code>-O1</code>: 表示默认优化</p>
<p><code>-O2</code>: 告诉 g++ 产生尽可能小和尽可能快的代码。除了完成<code>-O1</code> 的优化之外，还进行一些额外的调整工作，如指令调整等</p>
<p><code>-O3</code>: 包括循环展开和其他一些与处理性相关的优化工作，选项将使编译的速度比 <code>-O</code> 慢，但通常产生的代码执行速度会更快。</p>
<hr>
<p>g++ -Wall：<code>-Wall</code> 打印警告信息</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">目标...: 依赖...</span><br><span class="line">    命令1</span><br><span class="line">    命令2</span><br><span class="line">    ...</span><br><span class="line">注意每条命令前必须有且仅有一个 tab 保持缩进，这是语法要求。</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">CFLAGS = -std=c++14 -O2 -Wall</span><br><span class="line">TARGET = server</span><br><span class="line">OBJS = global_variables.cpp log.cpp usermap.cpp sqlconnpool.cpp udp_hole_punch.cpp server.cpp main.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">server: <span class="variable">$(OBJS)</span></span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$(OBJS)</span> -o <span class="variable">$(TARGET)</span> -lpthread -lmysqlclient</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>激动人心的时刻到了，因为一直是在markdown手写的，没有编写边测试，所以也不知道有多少错。</p>
<hr>
<p>没什么大的bug，接下来还有一些问题要调。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">「orange」-server</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-18 21:02:33 / 修改时间：17:33:31" itemprop="dateCreated datePublished" datetime="2022-12-18T21:02:33+08:00">2022-12-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="顶层设计"><a href="#顶层设计" class="headerlink" title="顶层设计"></a>顶层设计</h1><ul>
<li>映射表（补：实际上可以用结构体减少映射，不过不够灵活）</li>
<li>线程池、任务</li>
<li>日志系统</li>
<li>聊天日志</li>
<li>同步非阻塞IO</li>
</ul>
<p>为方便描述，我们做如下约定：</p>
<ul>
<li>客户端主线程是命令行线程，另一个线程叫做接收线程</li>
<li>服务器主线程是接收命令线程，也叫命令线程，它只进行消息中转，命令解析与返回由线程池处理。该线程监听的端口由客户端主线程连接。</li>
<li>服务器另一个监听线程叫发送线程，监听的端口由客户端接收线程连接（这样服务器就能知道客户端两个连接分别属于哪个线程），信息的发送由线程池处理。</li>
</ul>
<h1 id="映射表"><a href="#映射表" class="headerlink" title="映射表"></a>映射表</h1><p>考虑一下用户在服务器里的映射信息：</p>
<ul>
<li>在连接的时候，服务器会获得套接字描述符connfd和客户端对应的ip地址和端口号；当客户端后续发信息过来时，epoll会得知事件，同时获取的是用户的套接字信息，因此用connfd会比较多。然后，用户有两个线程会与服务器的两个监听线程连接，唯一能得知这两个套接字是一个用户的方法就是使用ip。由此我们大概能设计如下映射：<ul>
<li>0）套接字1-&gt;ip地址：这个映射是通过客户端主线程连接到服务器命令线程；</li>
<li>1）ip地址-&gt;套接字2：这个映射是客户端接收线程连接到服务器发送线程，因为连接时间不可知，因此把映射保存下来；</li>
<li>2）套接字1-&gt;套接字2：这个映射通过上面的映射获取，套接字1找到ip然后找到套接字2，这样就建立好了服务器与客户端之间的映射，即能快速找到客户端两个套接字。<ul>
<li>本质上因为不知道套接字1先建立还是套接字2先建立，所以不能获得套接字1的映射就立马去找套接字2，最稳健的时机是用户登录时建立两个套接字之间的映射，因为用户能登录说明两个连接都建立完成，并且此时是阻塞返回的，消息发到主线程，不需要立即使用套接字2。</li>
</ul>
</li>
</ul>
</li>
<li>下面建立其他相关的映射：<ul>
<li>3）套接字1-&gt;sid：最初的sid是用户登录时的userid，因此这个映射在登录时建立，setsid可以更改。</li>
<li>4）套接字1-&gt;sname：最初的sname是用户登录时的userid，因此这个映射在登录时建立，setsname可以更改。这两个映射是为了一些请求命令需要让对方得知自己的sid和sname，能快速获取。</li>
<li>5）sid-&gt;套接字2：许多命令都是通过指定sid发送到对方的接收线程，这个映射在登录时建立。</li>
<li>6）sid-&gt;sname：通过搜索sid获取sname。</li>
<li>7）sid-&gt;客户状态：accept之类的命令通过sid检索对方状态。</li>
<li>8）套接字1-&gt;客户状态：本机的命令有时也需要与客户状态交互。</li>
</ul>
</li>
<li>chatting双方映射，在聊天的双方经常通过自己的套接字1发送到对方的套接字2，因此要建立该表。accept时服务器可以获取自己的套接字1和对方sid，此时可以建立：<ul>
<li>9）[本机套接字1]-&gt;[对方套接字2]，这个通过对方sid-&gt;套接字2获取。</li>
<li>[对方套接字1]-&gt;[本机套接字2]，这个通过本机套接字1-&gt;本机套接字2获取，对方的套接字1通过套接字2搜索映射表获取套接字1，这一步耗点时间，因为对方得知accept也需要时间，不会那么快发消息，所以可以搜索建立。</li>
<li>注意上面两个表本质是一样的，用一个表存储。</li>
</ul>
</li>
<li>补充：<ul>
<li>10）conn2-&gt;user：获取user</li>
<li>11）conn1-&gt;user：获取user</li>
<li>12）conn1_req_peer2：conn1发起chat或send请求，就在这个表记录对方的端口，这样conn1break时才能知道要向谁break</li>
</ul>
</li>
</ul>
<p>映射表也许还有很多，现在也无法想到底。由于映射表挺多的，可以使用一个类封装，像客户端的请求表一样。但是这个类包含了许多的表，设计就有多种方案了。在讨论这些方案之前，我们可以想到，这些表的操作肯定需要一些互斥处理。对于同一个表，插入查找删除肯定是需要互斥的，但是两个不同的表之间需要互斥吗？不需要，并且如果这被需要的话可能会严重损耗性能，因此一个表就对应一个互斥锁。现在我们来讨论表类的设计：</p>
<ul>
<li>第一种，小封装，直接暴露这些表，插入查找删除都由外部执行。评价是这个方案肯定是<strong>不行</strong>的，接口太难用了。</li>
<li>第二种，完全封装，但每个表配对一个函数，外部调用相应的函数执行。评价是<strong>代码冗余</strong>，<strong>代码重复</strong>，并且无法全部做到函数重载，接口质量太差了。</li>
<li>第三种，完全封装，使用模板编写函数，插入查找删除统一使用。但问题是无法得知对哪个表操作，或许可以使用一个顶层映射表，表id-&gt;表。但实际上这行不通，因为表的参数类型是不同的，并且这也无法通过模板来解决。<ul>
<li>可能使用函数模板通过传入表id操作不同的表吗？已尝试，这行不通，可以看我的博客<a href="https://jysama.cn/2022/10/22/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%98/">函数模板问题 | JySama</a>。</li>
</ul>
</li>
</ul>
<p>讨论到现在，实际上发现没什么值得封装的了。。。因此直接不封装好了，设计大概是这样子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//映射表</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_ip;<span class="comment">//id0，套接字1-&gt;ip，以下都用这样的命名方式</span></span><br><span class="line">unordered_map&lt;string, <span class="type">int</span>&gt; ip_conn2;<span class="comment">//id1</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_2;<span class="comment">//id2</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sid;<span class="comment">//id3	</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sname;<span class="comment">//id4</span></span><br><span class="line">unordered_map&lt;string, <span class="type">int</span>&gt; sid_conn2;<span class="comment">//id5</span></span><br><span class="line">unordered_map&lt;string, string&gt; sid_sname;<span class="comment">//id6</span></span><br><span class="line">unordered_map&lt;string, clientState&gt; sid_state;<span class="comment">//id7</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, clientState&gt; conn1_state;<span class="comment">//id8</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_peer2;<span class="comment">//id9</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn2_user;<span class="comment">//id10</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_user;<span class="comment">//id11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//每个表的互斥锁</span></span><br><span class="line">mutex mux_conn1_ip;</span><br><span class="line">mutex mux_ip_conn2;</span><br><span class="line">mutex mux_conn1_2;</span><br><span class="line">mutex mux_conn1_sid;</span><br><span class="line">mutex mux_conn1_sname;</span><br><span class="line">mutex mux_sid_conn2;</span><br><span class="line">mutex mux_sid_sname;</span><br><span class="line">mutex mux_sid_state;</span><br><span class="line">mutex mux_conn1_state;</span><br><span class="line">mutex mux_conn1_peer2;</span><br><span class="line">mutex mux_conn2_user;</span><br><span class="line">mutex mux_conn1_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入，包括直接修改</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">map[key] = value</span><br><span class="line">    </span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line">lock_guard&lt;mutex&gt; <span class="built_in">locker</span>(mux);</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">find</span>(key);</span><br><span class="line"><span class="keyword">if</span> (iter == map.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	map.<span class="built_in">erase</span>(iter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过key找value</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (iter == map.<span class="built_in">end</span>())<span class="comment">//这里返回是因为之前想写函数模板，直接调用就进行错误处理等</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">T2</span>();<span class="comment">//string的空构造是空字符串，int的空构造是0，clientState的空构造是noLogin</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过value找key</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">begin</span>();</span><br><span class="line"><span class="keyword">for</span> (; iter != map.<span class="built_in">end</span>(); iter++)</span><br><span class="line">	<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">		<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (iter == map.end())，否则一定找不到</span></span><br><span class="line"><span class="comment">////这里返回是因为之前想写函数模板，直接调用就进行错误处理等</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">T1</span>();<span class="comment">//string的空构造是空字符串，int的空构造是0，clientState的空构造是noLogin</span></span><br></pre></td></tr></table></figure>

<hr>
<p>写了后面一些内容，发现映射表使用太频繁了，因为没有封装，导致代码极速膨胀（因为每个操作都要互斥，一行语句会因为调用互斥加锁解锁展开成三四行），所以还是打算封装，每个表都配一系列函数好了，代码很多…不过后面调用就舒服很多。注：后面有些补充的表不会填上来。</p>
<p>state_c.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> STATE_C_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATE_C_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端状态机</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>usermap.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMAP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMAP_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;state_c.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserMap</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//映射表</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_ip;<span class="comment">//id0，套接字1-&gt;ip，以下都用这样的命名方式</span></span><br><span class="line">	unordered_map&lt;string, <span class="type">int</span>&gt; ip_conn2;<span class="comment">//id1</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_2;<span class="comment">//id2</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sid;<span class="comment">//id3	</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sname;<span class="comment">//id4</span></span><br><span class="line">	unordered_map&lt;string, <span class="type">int</span>&gt; sid_conn2;<span class="comment">//id5</span></span><br><span class="line">	unordered_map&lt;string, string&gt; sid_sname;<span class="comment">//id6</span></span><br><span class="line">	unordered_map&lt;string, clientState&gt; sid_state;<span class="comment">//id7</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, clientState&gt; conn1_state;<span class="comment">//id8</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_peer2;<span class="comment">//id9</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn2_user;<span class="comment">//id10</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_user;<span class="comment">//id11</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//每个表的互斥锁</span></span><br><span class="line">	mutex mux_conn1_ip;</span><br><span class="line">	mutex mux_ip_conn2;</span><br><span class="line">	mutex mux_conn1_2;</span><br><span class="line">	mutex mux_conn1_sid;</span><br><span class="line">	mutex mux_conn1_sname;</span><br><span class="line">	mutex mux_sid_conn2;</span><br><span class="line">	mutex mux_sid_sname;</span><br><span class="line">	mutex mux_sid_state;</span><br><span class="line">	mutex mux_conn1_state;</span><br><span class="line">	mutex mux_conn1_peer2;</span><br><span class="line">	mutex mux_conn2_user;</span><br><span class="line">	mutex mux_conn1_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//-----------------------------------------------------0</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_ip</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="comment">//不会通过ip找conn1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------1</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_ip_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_ip_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_ip_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="comment">//不会通过conn2找ip</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------2</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fkey_conn1_2</span><span class="params">(<span class="type">int</span> value)</span></span>;<span class="comment">//通过2找1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------3</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_sid</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fkey_conn1_sid</span><span class="params">(string value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------4</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_sname</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------5</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_sid_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fkey_sid_conn2</span><span class="params">(<span class="type">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------6</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_sname</span><span class="params">(string key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_sname</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_sid_sname</span><span class="params">(string key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------7</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_state</span><span class="params">(string key, clientState value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_state</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">clientState <span class="title">fvalue_sid_state</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------8</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_state</span><span class="params">(<span class="type">int</span> key, clientState value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">clientState <span class="title">fvalue_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="comment">//不可能通过state找key</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//-----------------------------------------------------9</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_peer2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------10</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn2_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------11</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermap.h&quot;</span></span></span><br><span class="line"><span class="comment">//---------------------------------------0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_ip</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	conn1_ip[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_ip.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_ip.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_ip.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_ip.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_ip.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//---------------------------------------1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_ip_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	ip_conn2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_ip_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = ip_conn2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == ip_conn2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip_conn2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_ip_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = ip_conn2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == ip_conn2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-----------------------------------------------------2</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	conn1_2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fkey_conn1_2</span><span class="params">(<span class="type">int</span> value)</span><span class="comment">//通过2找1</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != conn1_2.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------3</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_sid</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	conn1_sid[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sid.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_sid.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sid.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fkey_conn1_sid</span><span class="params">(string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != conn1_sid.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------4</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_sname</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	conn1_sname[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sname.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sname.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_sname.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sname.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sname.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------5</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	sid_conn2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_conn2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_conn2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_sid_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_conn2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fkey_sid_conn2</span><span class="params">(<span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != sid_conn2.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------6</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_sname</span><span class="params">(string key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	sid_sname[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_sname</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, string&gt;::iterator iter = sid_sname.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_sname.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_sname.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_sid_sname</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, string&gt;::iterator iter = sid_sname.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_sname.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------7</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_state</span><span class="params">(string key, clientState value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	sid_state[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_state</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, clientState&gt;::iterator iter = sid_state.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_state.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_state.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">clientState <span class="title">UserMap::fvalue_sid_state</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, clientState&gt;::iterator iter = sid_state.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_state.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> clientState::noLogin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------8</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_state</span><span class="params">(<span class="type">int</span> key, clientState value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	conn1_state[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, clientState&gt;::iterator iter = conn1_state.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_state.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_state.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">clientState <span class="title">UserMap::fvalue_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, clientState&gt;::iterator iter = conn1_state.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_state.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> clientState::noLogin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------9</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_peer2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	conn1_peer2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_peer2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_peer2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_peer2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_peer2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_peer2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------10</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn2_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	conn2_user[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn2_user.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn2_user.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn2_user.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn2_user.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn2_user.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------11</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	conn1_user[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_user.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_user.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_user.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_user.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_user.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用测试：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermap.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UserMap usermap;</span><br><span class="line">	usermap.<span class="built_in">ins_conn1_2</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(<span class="number">1</span>);</span><br><span class="line">	cout &lt;&lt; conn2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ip == <span class="string">&quot;&quot;</span>)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	usermap.<span class="built_in">ins_conn1_ip</span>(<span class="number">1</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">	ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(<span class="number">1</span>);</span><br><span class="line">	cout &lt;&lt; ip &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	clientState state = usermap.<span class="built_in">fvalue_conn1_state</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line">	usermap.<span class="built_in">ins_conn1_state</span>(<span class="number">1</span>,clientState::isChatting);</span><br><span class="line">	state = usermap.<span class="built_in">fvalue_conn1_state</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注册登录"><a href="#注册登录" class="headerlink" title="注册登录"></a>注册登录</h1><p>这里假设搞定了日志系统和数据库连接池先，数据库连接池代码放在这后面，然后把注册登录的处理函数写了（大概在markdown写一下，有bug后面再改）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">verify</span><span class="params">(<span class="type">int</span> conn1, <span class="type">int</span> isLogin, string userid, string password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MYSQL* sql;</span><br><span class="line">	<span class="function">SqlRAII <span class="title">myconn</span><span class="params">(&amp;sql,sqlpool,<span class="number">0</span>)</span></span>;<span class="comment">//获取一个sql连接句柄，0表示超时时间</span></span><br><span class="line">    string sendstr = <span class="string">&quot;Server busy!&quot;</span>;<span class="comment">//默认</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(sql==<span class="literal">nullptr</span>)<span class="comment">//如果没拿到，即超时了</span></span><br><span class="line">	&#123;</span><br><span class="line">    	<span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_FIELD *fields = <span class="literal">nullptr</span>;</span><br><span class="line">    	MYSQL_RES *res = <span class="literal">nullptr</span>;</span><br><span class="line">        string order = <span class="string">&quot;SELECT userid, password FROM user WHERE userid=&#x27;&quot;</span>+userid+<span class="string">&quot;&#x27;&quot;</span>;<span class="comment">//命令不用加分号</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//要么没有，要么只能查出一个</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(sql, order.<span class="built_in">c_str</span>())) <span class="comment">//执行语句，成功返回0，错误返回非0</span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">LOG_DEBUG</span>( <span class="string">&quot;Select error: %s&quot;</span>,order.<span class="built_in">c_str</span>());</span><br><span class="line">        	<span class="built_in">mysql_free_result</span>(res);<span class="comment">//错误的话释放结果集（无论成功与否，查询后总是释放）</span></span><br><span class="line">            <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送server busy</span></span><br><span class="line">        	<span class="keyword">return</span>; </span><br><span class="line">    	&#125;</span><br><span class="line">        res = <span class="built_in">mysql_store_result</span>(sql);<span class="comment">//完整的结果集</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res)) <span class="comment">//遍历行，没有对应的表项就进不来，进来就只有一行</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">string <span class="title">passwd</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">            <span class="comment">// 能select到说明又对应的username，看是登录还是注册</span></span><br><span class="line">        	<span class="keyword">if</span>(isLogin)<span class="comment">//登录</span></span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="keyword">if</span>(password == passwd) <span class="comment">//登录成功</span></span><br><span class="line">                &#123; </span><br><span class="line">                    sendstr = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">                    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">                    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login successfully with password: %s ip: %s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                    <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//添加映射</span></span><br><span class="line">                    <span class="built_in">login_addmap</span>(conn1,userid);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            	<span class="keyword">else</span> <span class="comment">//登录失败，这种情况是密码错误</span></span><br><span class="line">                &#123;</span><br><span class="line">                	sendstr = <span class="string">&quot;password error！&quot;</span>;</span><br><span class="line">                	<span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">                    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login unsuccessfully with password: %s ip: %s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                    <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            	&#125;</span><br><span class="line">        	&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">else</span><span class="comment">//注册，说明userid被使用了</span></span><br><span class="line">            &#123;</span><br><span class="line">                sendstr = <span class="string">&quot;the user id [&quot;</span>+userid+<span class="string">&quot;] is already in use&quot;</span>;</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">LOG_INFO</span>(<span class="string">&quot;register unsuccessfully, [%s] is already in use&quot;</span>,userid.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">mysql_free_result</span>(res);<span class="comment">//释放结果集使用的内存</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//现在处理没有查找到的情况</span></span><br><span class="line">        <span class="keyword">if</span>(isLogin)<span class="comment">//登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            sendstr = <span class="string">&quot;user id [&quot;</span>+userid+<span class="string">&quot;] not found&quot;</span>;</span><br><span class="line">            <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login but id not found&quot;</span>,userid.<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//注册，这种情况可以注册</span></span><br><span class="line">        &#123;</span><br><span class="line">            string order_insert = <span class="string">&quot;INSERT INTO user(userid, password) VALUES(&#x27;&quot;</span>+userid+<span class="string">&quot;&#x27;,&#x27;&quot;</span>+password+<span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(sql, order_insert.<span class="built_in">c_str</span>())) </span><br><span class="line">            &#123; </span><br><span class="line">            	<span class="built_in">LOG_DEBUG</span>( <span class="string">&quot;Insert error: %s&quot;</span>,order_insert.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送server busy</span></span><br><span class="line">            	<span class="keyword">return</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sendstr = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">				</span><br><span class="line">                string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">            	<span class="built_in">LOG_INFO</span>(<span class="string">&quot;register successfully with id: [%s] password: [%s] ip:%s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">login_addmap</span><span class="params">(<span class="type">int</span> conn1,string userid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);            </span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_ip_conn2</span>(ip);</span><br><span class="line">   	</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_2</span>(conn1,conn2);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sid</span>(conn1,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sname</span>(conn1,userid);</span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_sid_conn2</span>(userid,conn2);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(userid,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(userid,clientState::cmdLine);</span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);</span><br><span class="line">    usermap.<span class="built_in">ins_conn2_user</span>(conn2,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_user</span>(conn1,userid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><p>在之前的博客已经介绍过了，这里再介绍以下吧：</p>
<p>头文件<code>#include &lt;mysql/mysql.h&gt;</code></p>
<p>数据库的一个连接句柄的初始化有三步</p>
<ul>
<li>定义一个sql指针：<code>MYSQL *sql = nullptr;</code></li>
<li>用这个指针初始化一个sql结构体，返回一个指向这个结构体的指针：<code>sql = mysql_init(sql);</code></li>
<li>init后就connect，连接数据库，返回一个可用连接<code>sql = mysql_real_connect(sql, host,user, pwd,dbName, port, unix_socket, client_flag);</code><ul>
<li>host是主机名或IP，如果“host”是NULL或字符串”localhost”，连接将被视为与本地主机的连接。</li>
<li>如果unix_socket不是NULL，该字符串描述了应使用的套接字或命名管道。注意，“host”参数决定了连接的类型。</li>
<li>client_flag的值通常为0，其他标志可以实现特定的功能</li>
</ul>
</li>
</ul>
<p>然后这个sql句柄就可以用来执行语句了，最后在不使用的时候还需要调用<code>mysql_close(sql);</code>释放连接。并且，为了避免在使用库完成应用程序后发生内存泄漏(例如，在关闭与服务器的连接之后)，可以显式调用mysql_library_end()。这样可以执行内存 Management 以清理和释放库使用的资源。</p>
<p>上面就是一个连接的建立，对于多个连接，我们可以把多个连接初始化后放入一个队列里，这样就构成了一个连接池。对于这样一个共享的连接池，就需要互斥操作。而这一个队列又和阻塞队列不同，队列是可能空的但不可能会因为满而阻塞——可用的连接是一定的，push回去不会多。在阻塞队列中使用了两个条件变量管理了空&#x2F;满缓冲区的阻塞，这里只需要管理空，也即pop操作的阻塞。可以用一个条件变量，也可以用一个信号量。条件变量可以做超时处理，因此用条件变量（信号量就使用<code>sem_post(&amp;semId_)、sem_wait(&amp;semId_)、sem_init(&amp;semId_, 0, MAX_CONN_)</code>）。</p>
<p>当上层需要登录或注册时，会尝试获取一个连接，然后使用完后释放连接。这里的问题是，当没有连接可用时，是阻塞等待还是直接返回错误。或许使用折中会好一点，即用cond.wait_for()阻塞一段时间。当释放一个连接后就尝试唤醒一个阻塞的线程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SQLCONNPOOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQLCONNPOOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sqlconnpool</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    mutex mux;</span><br><span class="line">    condition_variable cond;</span><br><span class="line">    queue&lt;MYSQL*&gt; connque;</span><br><span class="line">    <span class="type">int</span> maxconn;</span><br><span class="line">    <span class="type">int</span> freecount;</span><br><span class="line">    <span class="built_in">Sqlconnpool</span>();</span><br><span class="line">    ~<span class="built_in">Sqlconnpool</span>()&#123;&#125;<span class="comment">//析构函数实际上和构造函数一样，可以private，因为本质上是成员函数调用</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Sqlconnpool</span>(<span class="type">const</span> Sqlconnpool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Sqlconnpool&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Sqlconnpool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Sqlconnpool*  <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">MYSQL* <span class="title">getconn</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">freeconn</span><span class="params">(MYSQL* conn)</span></span>;</span><br><span class="line">    <span class="comment">//无法使用构造函数传参，用init，默认参数写声明中</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host,<span class="type">int</span> port,<span class="type">const</span> <span class="type">char</span>* user,<span class="type">const</span> <span class="type">char</span>* pwd,<span class="type">const</span> <span class="type">char</span>* dbname,<span class="type">int</span> connsize=<span class="number">20</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">conncount</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sqlconnpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">Sqlconnpool::<span class="built_in">Sqlconnpool</span>()</span><br><span class="line">&#123;</span><br><span class="line">    maxconn = <span class="number">0</span>;</span><br><span class="line">    freecount = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Sqlconnpool* <span class="title">Sqlconnpool::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> Sqlconnpool instance;</span><br><span class="line">    <span class="keyword">return</span> &amp;instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MYSQL* <span class="title">Sqlconnpool::getconn</span><span class="params">(<span class="type">int</span> timeout = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(timeout&gt;=<span class="number">0</span>);<span class="comment">//</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(connque.<span class="built_in">empty</span>())</span><br><span class="line">        <span class="keyword">if</span>(cond.<span class="built_in">wait_for</span>(locker, chrono::<span class="built_in">seconds</span>(timeout)) == std::cv_status::timeout)<span class="comment">//超时</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;Sqlconnpool busy&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">    MYSQL* sql = connque.<span class="built_in">front</span>();</span><br><span class="line">    connque.<span class="built_in">pop</span>();</span><br><span class="line">    freecount--;</span><br><span class="line">    <span class="keyword">return</span> sql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::freeconn</span><span class="params">(MYSQL* conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(conn);<span class="comment">//防止放入nullptr</span></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    connque.<span class="built_in">push</span>(conn);</span><br><span class="line">    freecount++;</span><br><span class="line">    cond.<span class="built_in">notify_one</span>();<span class="comment">//唤醒一个get线程</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Sqlconnpool::conncount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> maxconn-freecount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::init</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host,<span class="type">int</span> port,<span class="type">const</span> <span class="type">char</span>* user,<span class="type">const</span> <span class="type">char</span>* pwd,<span class="type">const</span> <span class="type">char</span>* dbname,<span class="type">int</span> connsize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(connsize&gt;<span class="number">0</span>);</span><br><span class="line">    maxconn = connsize;</span><br><span class="line">    freecount = connsize;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;maxconn;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//三步初始化</span></span><br><span class="line">        MYSQL* sql = <span class="literal">nullptr</span>;</span><br><span class="line">        sql = <span class="built_in">mysql_init</span>(sql);</span><br><span class="line">        <span class="keyword">if</span>(!sql)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;sql number %d init error&quot;</span>,i);</span><br><span class="line">            <span class="built_in">assert</span>(sql);<span class="comment">//终止报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        sql = <span class="built_in">mysql_real_connect</span>(sql,host,user,pwd,dbname,port,<span class="literal">nullptr</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!sql)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;sql number %d connect error&quot;</span>,i);</span><br><span class="line">            <span class="built_in">assert</span>(sql);<span class="comment">//终止报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        connque.<span class="built_in">push</span>(sql);<span class="comment">//放入的一定不是nullptr</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(freecount != maxconn)<span class="comment">//必须要等待所有连接都放回来，直接close再执行查询程序会崩溃</span></span><br><span class="line">        cond.<span class="built_in">wait</span>(locker);<span class="comment">//每放回一个连接唤醒一次，然后判断</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(!connque.<span class="built_in">empty</span>())<span class="comment">//逐个关闭连接</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mysql_close</span>(connque.<span class="built_in">front</span>());</span><br><span class="line">        connque.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">mysql_library_end</span>();<span class="comment">//释放库的资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SQLRAII_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQLRAII_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sqlconnpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlRAII</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MYSQL* conn;<span class="comment">//保存连接好的sql</span></span><br><span class="line">    Sqlconnpool* connpool;<span class="comment">//保存连接池</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SqlRAII</span>(MYSQL** sql,Sqlconnpool* sqlpool,<span class="type">int</span> timeout = <span class="number">0</span>)<span class="comment">//传入sql指针的地址，即&amp;sql，获取连接后传出去</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(sqlpool);<span class="comment">//必须先建好连接池</span></span><br><span class="line">        </span><br><span class="line">        *sql = sqlpool-&gt;<span class="built_in">getconn</span>(timeout);<span class="comment">//可能会超时</span></span><br><span class="line">        <span class="comment">//为了用户自行getconn和使用sqlraii的统一，这里统一让用户在上层处理sql为nullptr的情况</span></span><br><span class="line">        conn = *sql;</span><br><span class="line">        connpool = sqlpool;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">SqlRAII</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(conn)<span class="comment">//有连接就释放</span></span><br><span class="line">        	connpool-&gt;<span class="built_in">freeconn</span>(conn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h1 id="信息接收处理"><a href="#信息接收处理" class="headerlink" title="信息接收处理"></a>信息接收处理</h1><ul>
<li>对于聊天信息，只需要判断第一个字符是不是”~”即可，是的话通过映射表发送给对方</li>
<li>对于命令信息，客户端进行了很多处理了，发送过来的命令一定是正确的且不带@，且首尾没有空格，服务器需要做的就是再解析成向量形式</li>
<li>从客户端发来的信息都带有一个换行符，这是为了服务器刚好能使用客户端的解析函数，我们接着约定，服务器发给客户端的信息都不带有换行符。这样比如发来的聊天信息就要记得去尾部换行符。</li>
</ul>
<p>命令的映射如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;choosefile&quot;</span>,<span class="number">16</span>&#125;,<span class="comment">//服务器没有re命令，但是多了一个choosefile，通告选择的文件号码</span></span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;myresource&quot;</span>,<span class="number">19</span>&#125;,<span class="comment">//这个也不用</span></span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>工作函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">task</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//epoll响应conn1，指定工作函数从conn1处接收</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收，ET模式下要一次接收完，该函数在下篇博客epoll中作出。</span></span><br><span class="line">    string recvstr = <span class="built_in">recv_str</span>(conn1); </span><br><span class="line">    <span class="keyword">if</span>(recvstr == <span class="string">&quot;&quot;</span>)<span class="comment">//接收出错了</span></span><br><span class="line">    	<span class="keyword">return</span>;<span class="comment">//不给用户发错误信息，可能对方断开了，发过去有危险</span></span><br><span class="line">    <span class="keyword">if</span>(recvstr[<span class="number">0</span>]==<span class="string">&#x27;~&#x27;</span>)<span class="comment">//聊天内容</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">chatmsg</span>(conn1,recvstr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//命令</span></span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(recvstr);</span><br><span class="line">        <span class="type">int</span> cmdvalue = cmdmap[cmdvec[<span class="number">0</span>]];<span class="comment">//客户端处理后命令一定存在</span></span><br><span class="line">        <span class="keyword">switch</span>(cmdvalue)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">verify</span>(conn1, <span class="number">0</span>, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">verify</span>(conn1, <span class="number">1</span>, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">search</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">chat</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">accept</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="built_in">reject</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="built_in">break_</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="built_in">send_</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="built_in">sendfile</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="built_in">acceptfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="built_in">rejectfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="built_in">getfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="built_in">acceptget</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="built_in">rejectget</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="built_in">setsid</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="built_in">setsname</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="built_in">choosefile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="built_in">exit</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="built_in">hisir</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="built_in">oyasumi</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这两句见下一篇博客</span></span><br><span class="line">    <span class="type">uint32_t</span> connEvent = CONNEVENT;<span class="comment">//因为是oneshot，每次重新注册</span></span><br><span class="line">    epoller.<span class="built_in">modFd</span>(conn1, connEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析命令函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//返回值是右值，外部vector会接收右值，调用移动构造</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="命令工作函数"><a href="#命令工作函数" class="headerlink" title="命令工作函数"></a>命令工作函数</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">chatmsg</span><span class="params">(<span class="type">int</span> conn1, string&amp; recvstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_peer2</span>(conn1);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s chatmsg error, can&#x27;t find peer!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line"></span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//获取发送方名字</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send [msg] to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="comment">//还要记录myuser的聊天日志</span></span><br><span class="line">    recvstr = recvstr.<span class="built_in">substr</span>(<span class="number">1</span>,recvstr.<span class="built_in">size</span>()<span class="number">-2</span>);<span class="comment">//去~和去\n</span></span><br><span class="line">    recvstr = mysname+<span class="string">&quot;: &quot;</span>+recvstr;</span><br><span class="line">    <span class="built_in">send</span>(conn2,recvstr.<span class="built_in">c_str</span>(),recvstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//记录日志，在下一篇博客中已完成该函数</span></span><br><span class="line">    <span class="comment">//前面的recvstr已经记录了发送方名字和发送内容，然后文件名包含了发送者id，因此再补上接收者id即可</span></span><br><span class="line">    recvstr = recvstr + <span class="string">&quot; [&quot;</span>+peeruser+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">msg_log</span>(myuser,recvstr))</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s open log falied!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">search</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    string sname = usermap.<span class="built_in">fvalue_sid_sname</span>(sid);</span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [search] sid-%s&quot;</span>,myuser.<span class="built_in">c_str</span>(),sid.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span>(sname == <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isChatting)</span><br><span class="line">        sendstr = <span class="string">&quot;sid-[&quot;</span>+sid+<span class="string">&quot;]sname-[&quot;</span>+sname+<span class="string">&quot;]state-is chatting&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sendstr = <span class="string">&quot;sid-[&quot;</span>+sid+<span class="string">&quot;]sname-[&quot;</span>+sname+<span class="string">&quot;]state-isn&#x27;t chatting&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isChatting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer is chatting, you may wait for a long time...&quot;</span>;</span><br><span class="line">    	<span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;@#chatfrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [chat] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">accept_</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#chat accept&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isChatting);<span class="comment">//修改自己状态为chatting</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isChatting);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::isChatting);<span class="comment">//修改对方状态为chatting</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::isChatting);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        usermap.<span class="built_in">ins_conn1_peer2</span>(conn1,conn2);</span><br><span class="line">        usermap.<span class="built_in">ins_conn1_peer2</span>(peerconn1,myconn2);</span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [accept] the chat requestion for %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//对方已经退出了，或在accept到服务器前break了，或其他情况，让accept方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reject</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#chat reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [reject] the chat requestion for %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">break_</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//加下划线为了避免和break关键字重合，这里不close，在epoll里close</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_conn1_state</span>(conn1);<span class="comment">//获取自己状态</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_req_peer2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);<span class="comment">//修改自己状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//没有请求就不用管，否则要删除对方的请求表</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);<span class="comment">//删请求</span></span><br><span class="line">        sendstr = <span class="string">&quot;@#break &quot;</span>+mysid;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from waiting&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(state == clientState::cmdLine)<span class="comment">//在break到达前acceptfile了，让对方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//没有请求就不用管，reject会把请求删掉，这与accept区分开来</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);<span class="comment">//删请求</span></span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from cmdLine&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(state == clientState::isChatting)<span class="comment">//正在通信，或在break到达前accept了</span></span><br><span class="line">    &#123;</span><br><span class="line">        conn2 = usermap.<span class="built_in">fvalue_conn1_peer2</span>(conn1);<span class="comment">//找到正在通信的对方</span></span><br><span class="line">       </span><br><span class="line">        string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);<span class="comment">//修改自己状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from chatting&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//一般不会，可能有没考虑到的情况吧</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//让对方也退出</span></span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        string sid = usermap.<span class="built_in">fvalue_conn1_sid</span>(peerconn1);<span class="comment">//获取对方sid，修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//删除通信的映射</span></span><br><span class="line">        usermap.<span class="built_in">del_conn1_peer2</span>(conn1);</span><br><span class="line">        usermap.<span class="built_in">del_conn1_peer2</span>(peerconn1);</span><br><span class="line">        </span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">send_</span><span class="params">(<span class="type">int</span> conn1, string sid, string&amp; msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;sid-[&quot;</span>+mysid+<span class="string">&quot;] sname-[&quot;</span>+mysname+<span class="string">&quot;] send: &quot;</span>+msg;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [send] message to %s: %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>(),msg.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sendfile</span><span class="params">(<span class="type">int</span> conn1, string sid, string filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> pos = filename.<span class="built_in">find_last_not_of</span>(<span class="string">&quot;/&quot;</span>);<span class="comment">//发过来可能是完整路径，要把路径删掉</span></span><br><span class="line">    <span class="keyword">if</span>(pos != string::npos)</span><br><span class="line">    	filename = filename.<span class="built_in">substr</span>(pos+<span class="number">1</span>);</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendstr = <span class="string">&quot;@#sendfilefrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname+<span class="string">&quot; &quot;</span>+filename;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [sendfile] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">acceptfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">        sendstr = <span class="string">&quot;@#sendfile accept &quot;</span>+myip;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line"></span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [acceptfile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//对方已经退出了，或在accept到服务器前break了，或其他情况，让accept方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rejectfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#sendfile reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s  [rejectfile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">getfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendstr = <span class="string">&quot;@#getfilefrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [getfile] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">acceptget</span><span class="params">(<span class="type">int</span> conn1, string sid, string&amp; src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#getfile accept &quot;</span>+src;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line"></span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [acceptget] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于getfile不用管</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rejectget</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#getfile reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [rejectget] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">choosefile</span><span class="params">(<span class="type">int</span> conn1, string number)</span><span class="comment">//服务器没有re命令，但是多了一个choosefile，通告选择的文件号码</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_req_peer2</span>(conn1);<span class="comment">//从getfile请求里获取对方的套接字</span></span><br><span class="line">    <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//意外情况...</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;[choosefile] can&#x27;t find the file-sender&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">    string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);<span class="comment">//告知对方（发送方）本地ip地址</span></span><br><span class="line">    sendstr = <span class="string">&quot;@#choosefile &quot;</span>+number+<span class="string">&quot; &quot;</span>+myip;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [choosefile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setsid</span><span class="params">(<span class="type">int</span> conn1, string&amp; newsid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string oldsid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//先获取旧的sid</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(oldsid == newsid)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;Your old sid and new sid are the same&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> check = usermap.<span class="built_in">fvalue_sid_conn2</span>(newsid);<span class="comment">//查看是否已有该sid</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(check != <span class="number">-1</span>)<span class="comment">//该sid已注册</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The newsid [&quot;</span>+newsid+<span class="string">&quot;] has been used, setsid failed&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//有些表sid是当key的，这里的修改原则是删除-&gt;重新插入</span></span><br><span class="line">    string sname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//获取sname，为了改sid_sname表</span></span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(oldsid);<span class="comment">//获取state，为了改sid_state表</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(oldsid);<span class="comment">//获取conn2，为了改sid_conn2表</span></span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sid</span>(conn1,newsid);<span class="comment">//修改</span></span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">del_sid_sname</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(newsid,sname);<span class="comment">//插入</span></span><br><span class="line">    usermap.<span class="built_in">del_sid_state</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(newsid,state);<span class="comment">//插入</span></span><br><span class="line">    usermap.<span class="built_in">del_sid_conn2</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_conn2</span>(newsid,conn2);<span class="comment">//插入</span></span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;setsid successfullly, new sid is [&quot;</span>+newsid+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [setsid] from %s to [%s]&quot;</span>,myuser.<span class="built_in">c_str</span>(),oldsid.<span class="built_in">c_str</span>(),newsid.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setsname</span><span class="params">(<span class="type">int</span> conn1, string&amp; newsname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string oldsname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//先获取旧的sname</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(oldsname == newsname)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;Your old sname and new sname are the same&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string sid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sname</span>(conn1,newsname);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(sid,newsname);</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;setsname successfullly, new sname is [&quot;</span>+newsname+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [setsname] from %s to [%s]&quot;</span>,myuser.<span class="built_in">c_str</span>(),oldsname.<span class="built_in">c_str</span>(),newsname.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">exit_</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//退出相当于break+clean map+close</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">break_</span>(conn1);<span class="comment">//调用break，让会影响到的对方退出</span></span><br><span class="line">    <span class="comment">//break是没有关系的，因为如果普通情况下exit，请求表映射是空，那么break不会做事情</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [exit]&quot;</span>,myuser.<span class="built_in">c_str</span>());<span class="comment">//删之前记录一下</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cleanmap</span>(conn1);<span class="comment">//删表</span></span><br><span class="line">    epoller.<span class="built_in">delFd</span>(conn1);<span class="comment">//从epoll内删除事件</span></span><br><span class="line">    <span class="built_in">close</span>(conn1);<span class="comment">//关套接字</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cleanmap</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//删表，oyasumi和exit都可以使用</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//13个表都删了</span></span><br><span class="line">    usermap.<span class="built_in">del_conn1_ip</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_ip_conn2</span>(myip);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_2</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_sid</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_sid_conn2</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_sid_sname</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_sid_state</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_state</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_peer2</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn2_user</span>(conn2);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_user</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数库random"><a href="#随机数库random" class="headerlink" title="随机数库random"></a>随机数库random</h2><p>在命令<code>hisir</code>和<code>oyasumi</code>中，服务器会返回一句话，这句话实际上是随机的。理论上，设置一个全局变量每次调用命令就加一，这样在多个用户调用的情况下就能做到对单个用户来说比较随机了。</p>
<p>但是还是用点相对来说高级的东西，c语言的rand和srand就不用了，我们来学一下c++11新实现的库<code>&lt;random&gt;</code>。使用方法很简单：</p>
<ul>
<li>实例化一个随机数引擎</li>
<li>实例化一个统计分布（可选）</li>
<li>分布对象调用引擎对象即可返回随机数</li>
</ul>
<h3 id="伪随机数引擎"><a href="#伪随机数引擎" class="headerlink" title="伪随机数引擎"></a>伪随机数引擎</h3><p>random库提供了三种常用的随机数生成引擎，都以模版类的方式定义。分别是：</p>
<ul>
<li>linear_congruential_engine：线性同余生成引擎，是最常用也是速度最快的，但随机效果一般</li>
<li>mersenne_twister_engine：梅森旋转算法，随机效果最好。比较慢，占用存储空间较大，但是在参数设置合理的情况下，可生成最长的不重复序列，且具有良好的频谱特征。</li>
<li>subtract_with_carry_engine：滞后Fibonacci算法。速度最快，占用存储空间较大，频谱特性有时不佳。</li>
<li>default_random_engine：就是线性同余引擎，参考<a target="_blank" rel="noopener" href="https://cplusplus.com/reference/random/default_random_engine/">https://cplusplus.com/reference/random/default_random_engine/</a></li>
</ul>
<p>所有生成器引擎，或者经过adapter修饰后的类实例，都提供如下接口供使用</p>
<ul>
<li>min：返回最小值，静态函数</li>
<li>max：返回最大值，静态函数</li>
<li>seed：设置随机数生成的种子</li>
<li>operator()：产生随机数</li>
<li>void discard (unsigned long long z)：调用z次operator()函数</li>
</ul>
<p>另外，都定义了输入输出操作符和关系运算的非成员函数。随机数引擎接收一个整数作为种子，<strong>不提供就会使用默认值</strong>。</p>
<p>使用大概像这样子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> min,max;</span><br><span class="line"><span class="comment">//定义上下边界</span></span><br><span class="line"> </span><br><span class="line">default_random_engine e;</span><br><span class="line"><span class="comment">//创建引擎</span></span><br><span class="line"> </span><br><span class="line"><span class="function">uniform_int_distribution&lt;<span class="type">unsigned</span>&gt; <span class="title">u</span><span class="params">(min,max)</span></span>;</span><br><span class="line"><span class="comment">//创建取值范围</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> randNum=<span class="built_in">u</span>(e);</span><br><span class="line"><span class="comment">//获取伪随机数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以直接用引擎</span></span><br><span class="line"><span class="type">int</span> randNum=<span class="built_in">e</span>();</span><br></pre></td></tr></table></figure>

<h3 id="预定义算法"><a href="#预定义算法" class="headerlink" title="预定义算法"></a>预定义算法</h3><p>定义了算法的最佳实践，避免了参数的选择，可以直接选择引擎，即不用使用上面的引擎然后设置一些参数，可以直接用算法。</p>
<p>算法包括minstd_rand0、minstd_rand、mt19937（32位）、mt19937_64（产生64位随机数）、ranlux24_base、ranlux48_base等。 <code>mt19937</code>是目前 C++ 标准中最实用的引擎</p>
<h3 id="分布"><a href="#分布" class="headerlink" title="分布"></a>分布</h3><p>分布用于进一步加载引擎，使随机数具有分布性质，提供的分布有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//均匀分布：</span></span><br><span class="line">uniform_int_distribution           <span class="comment">//整数均匀分布</span></span><br><span class="line">uniform_real_distribution         <span class="comment">//浮点数均匀分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//伯努利类型分布</span></span><br><span class="line">bernoulli_distribution     <span class="comment">//伯努利分布</span></span><br><span class="line">binomial_distribution      <span class="comment">//二项分布</span></span><br><span class="line">geometry_distribution     <span class="comment">//几何分布</span></span><br><span class="line">negative_biomial_distribution   <span class="comment">//负二项分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rate-based distributions: </span></span><br><span class="line">poisson_distribution  <span class="comment">//泊松分布</span></span><br><span class="line">exponential_distribution <span class="comment">//指数分布</span></span><br><span class="line">gamma_distribution <span class="comment">//伽马分布</span></span><br><span class="line"> weibull_distribution <span class="comment">//威布尔分布</span></span><br><span class="line">extreme_value_distribution <span class="comment">//极值分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//正态分布相关：</span></span><br><span class="line">normal_distribution         <span class="comment">//正态分布</span></span><br><span class="line">chi_squared_distribution <span class="comment">//卡方分布</span></span><br><span class="line">cauchy_distribution        <span class="comment">//柯西分布</span></span><br><span class="line">fisher_f_distribution       <span class="comment">//费歇尔F分布</span></span><br><span class="line">student_t_distribution  <span class="comment">// t分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//分段分布相关：</span></span><br><span class="line">discrete_distribution <span class="comment">//离散分布</span></span><br><span class="line">piecewise_constant_distribution <span class="comment">//分段常数分布</span></span><br><span class="line">piecewise_linear_distribution <span class="comment">//分段线性分布</span></span><br></pre></td></tr></table></figure>

<h3 id="random-device"><a href="#random-device" class="headerlink" title="random_device"></a>random_device</h3><p><code>区别与其他生成算法的伪随机数，通过硬件生成真正的不确定随机数（如果硬件不支持，标准也允许使用伪随机生成方法实现此函数），返回一个unsigned int，通常作为前述引擎的seeds。</code></p>
<p>前面使用分布加载引擎后，如果不设置种子，每次运行的随机数序列都是一样的，因为：引擎使用默认值-&gt;引擎序列相同-&gt;分布产生的序列相同。</p>
<p>因此如果要每次运行都产生不一样的序列，就要用种子，以往的做法可以用time(NULL)，但这实际上是个糟糕的做法。这就可以用到random_device。</p>
<p>random_device一般只用来作为其他伪随机数算法的种子，参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiading/p/11653911.html">C++11随机数的正确打开方式 - 别再闹了 - 博客园 (cnblogs.com)</a>。大概就是说：</p>
<ul>
<li>random_device最大最小值不可以改</li>
<li>linux下是用熵池获取随机数的，当熵池用尽后，许多random_device的具体实现的性能会急速下降</li>
<li>多次调用random_device要花费比其他伪随机数算法更多的时间。在Linux中，每次调用random_device都需要读urandom这个文件再关闭，而在WIndom中我们需要调用操作系统的API，再销毁实例化对象，这个时间花费显然比设置好种子就能一直产生的其他伪随机数算法要慢得多。</li>
</ul>
<p>而作为种子：只调用一次，用于给引擎一个随机的初始值就完成了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> min = <span class="number">0</span>,max = <span class="number">100</span>;</span><br><span class="line">    random_device seed;<span class="comment">//硬件生成随机数种子</span></span><br><span class="line">    <span class="function">ranlux48 <span class="title">engine</span><span class="params">(seed())</span></span>;<span class="comment">//利用种子生成随机数引擎</span></span><br><span class="line">    <span class="function">uniform_int_distribution&lt;<span class="type">int</span>&gt; <span class="title">distrib</span><span class="params">(min, max)</span></span>;<span class="comment">//设置随机数范围，并为均匀分布</span></span><br><span class="line">    <span class="type">int</span> random = <span class="built_in">distrib</span>(engine);<span class="comment">//随机数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数考量"><a href="#随机数考量" class="headerlink" title="随机数考量"></a>随机数考量</h2><p>前面大概熟悉了一下随机数的生成，但还没想好用户怎么用随机数，是所有用户共享一个随机数分布呢？还是用户来了就创建分布对象然后只生成一个数字呢？还是一个用户对应一个分布对象呢？</p>
<ul>
<li>简单点就可以用第二种，因为这两个命令用的频率应该很少，缺点是多次调用hisir的话，随机得不够均匀；并且这种方法更耗时、耗内存，为了生成单个数字而完整地实例化了一个分布对象。</li>
<li>第一种的话也简单点，从统计的角度上看，这对于全体用户是均匀分布，但用户体验好肯定是对于单个用户来说均匀分布一些。</li>
<li>第三种貌似比较折中，但是就需要多一个映射表，挺麻烦的，映射表已经不想改了，否决否决。</li>
</ul>
<p>基本上是决定用第一种共享的方式，加一个互斥锁访问。因为如果从概率角度上看，每个用户访问时，每个随机数的概率都是相同的（均匀分布），这对用户来说就也都是均匀的了。当然，我也没研究底层的实现是基于统计的还是基于概率的。不过已经足够了。</p>
<p>严格来说，全局的方式都<strong>不用随机数种子</strong>，因为一直运行的话，也就不会有相同的序列了。因为有互斥锁，封装一下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Randint</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    mutex mux;<span class="comment">//因为引擎有序的关系，要互斥</span></span><br><span class="line">    random_device seed;<span class="comment">//硬件生成随机数种子</span></span><br><span class="line">    ranlux48 engine;<span class="comment">//利用种子生成随机数引擎</span></span><br><span class="line">    uniform_int_distribution&lt;<span class="type">int</span>&gt; distrib;<span class="comment">//设置随机数范围，并为均匀分布</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//hisir语录和oyasumi语录大小可能不一样，所以对应不一样的随即器</span></span><br><span class="line">    <span class="built_in">Randint</span>(<span class="type">int</span> min, <span class="type">int</span> max) :<span class="built_in">engine</span>(<span class="built_in">seed</span>()), <span class="built_in">distrib</span>(min, max)&#123;&#125;<span class="comment">//初始列表构造</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">distrib</span>(engine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span><span class="comment">//测试</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Randint <span class="title">rand_of_hisir</span><span class="params">(<span class="number">0</span>, <span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        cout &lt;&lt; <span class="built_in">rand_of_hisir</span>() &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>可以使用多个对象变成一个vector形式的随机化对象池，不过从分布来看没什么意义，因此就分别对两个命令各使用一个对象即可。</p>
<h2 id="语录对象"><a href="#语录对象" class="headerlink" title="语录对象"></a>语录对象</h2><p>语录对象使用const的<code>vector&lt;string&gt;</code>，通过下标访问，不用互斥。形式如下，具体就不在博客里放了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> vector&lt;string&gt; hisir_sentence = [...];</span><br><span class="line"><span class="type">const</span> vector&lt;string&gt; oyasumi_sentence = [...];</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">hisir</span><span class="params">(<span class="type">int</span> conn1, string&amp; msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr = hisir_sentence[<span class="built_in">rand_of_hisir</span>()];</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [hisir]: %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),msg.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">oyasumi</span><span class="params">(<span class="type">int</span> conn1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr = oyasumi_sentence[<span class="built_in">rand_of_oyasumi</span>()];</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">break_</span>(conn1);<span class="comment">//调用break，让会影响到的对方退出</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [oyasumi]~&quot;</span>,myuser.<span class="built_in">c_str</span>());<span class="comment">//删之前记录一下</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cleanmap</span>(conn1);<span class="comment">//删表</span></span><br><span class="line">    <span class="built_in">close</span>(conn1);<span class="comment">//关套接字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h1><p>线程池就是传入task工作，可以参考之前的博客：<a href="https://jysama.cn/2022/09/28/websever%E6%A8%A1%E5%9D%97%E5%8C%96%E6%90%AD%E5%BB%BA/">WebServer模块单元测试 | JySama</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//threadpool.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> THREADPOOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADPOOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span><span class="comment">//使用assert函数</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadpool</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">pool</span><span class="comment">//封装三个资源</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::mutex mtx;<span class="comment">//互斥锁</span></span><br><span class="line">        std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; taskQueue;<span class="comment">//任务队列，无参数的function，调用时不用传参</span></span><br><span class="line">        std::condition_variable cond;<span class="comment">//条件变量</span></span><br><span class="line">        <span class="type">bool</span> isclose = <span class="literal">false</span>;<span class="comment">//默认值是false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    std::shared_ptr&lt;pool&gt; pool_;<span class="comment">//共享指针，pool_是一个指针指向pool结构体，这个指针用于线程池操作资源</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadpool</span>(<span class="type">int</span> threadnum = <span class="number">8</span>):<span class="built_in">pool_</span>(std::<span class="built_in">make_shared</span>&lt;pool&gt;())<span class="comment">//以make_shared的方式new一个对象给pool_指针</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(threadnum &gt; <span class="number">0</span>);<span class="comment">//没有线程就报错</span></span><br><span class="line">    	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;threadnum;i++)<span class="comment">//创建线程池</span></span><br><span class="line">    		std::<span class="built_in">thread</span>([<span class="type">pool_t</span> = pool_]&#123;<span class="comment">//现在要按值捕获，相当于拷贝构造共享指针，计数+1，且指向相同内容</span></span><br><span class="line">    			std::unique_lock&lt;std::mutex&gt; <span class="built_in">locker</span>(<span class="type">pool_t</span>-&gt;mtx);<span class="comment">//定义一个locker对象，现在已经锁住了</span></span><br><span class="line">                 <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">if</span>(!<span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">empty</span>())<span class="comment">//如果有任务</span></span><br><span class="line">                     &#123;</span><br><span class="line">                         <span class="keyword">auto</span> task = <span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">front</span>();</span><br><span class="line">                         <span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">pop</span>();</span><br><span class="line">                         locker.<span class="built_in">unlock</span>();</span><br><span class="line">                       	 <span class="comment">//解锁后再执行</span></span><br><span class="line">                         <span class="built_in">task</span>();</span><br><span class="line">                         <span class="comment">//执行完了，进入下一轮循环，注意要锁住</span></span><br><span class="line">                         locker.<span class="built_in">lock</span>();<span class="comment">//抢占锁</span></span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">else</span> <span class="keyword">if</span>(<span class="type">pool_t</span>-&gt;isclose)</span><br><span class="line">                         <span class="keyword">break</span>;</span><br><span class="line">                     <span class="keyword">else</span><span class="comment">//如果没有任务</span></span><br><span class="line">                         <span class="type">pool_t</span>-&gt;cond.<span class="built_in">wait</span>(locker);<span class="comment">//解锁并等待，唤醒后会抢占互斥锁</span></span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;).<span class="built_in">detach</span>();<span class="comment">//把thread分离，不用手动join，结束自动回收</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addTask</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(pool_-&gt;mtx)</span></span>;<span class="comment">//定义一个locker对象</span></span><br><span class="line">        pool_-&gt;taskQueue.<span class="built_in">emplace</span>(task);<span class="comment">//这种方式，使用emplace和push没啥区别，task本身就是临时对象</span></span><br><span class="line">        <span class="comment">//如果要真正使用到emplace调用构造函数，还要配合std::forward完美转发，此时无论构造函数是不是explicit（不能隐式转换），都可以正常工作</span></span><br><span class="line">        pool_-&gt;cond.<span class="built_in">notify_one</span>();<span class="comment">//插入一个元素唤醒一个线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pool_-&gt;isclose = <span class="literal">true</span>;</span><br><span class="line">        pool_-&gt;cond.<span class="built_in">notify_all</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">threadpool</span>()<span class="comment">//析构函数</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h1 id="工作函数补充——内网穿透"><a href="#工作函数补充——内网穿透" class="headerlink" title="工作函数补充——内网穿透"></a>工作函数补充——内网穿透</h1><p>于2022&#x2F;12补充</p>
<p>当进行文件传输时，公网服务器在工作线程里顺便实现内网穿透（基于udp）服务即可，该部分的工作在这篇博客：<a href="https://jysama.cn/2022/11/26/udp_hole_punching/">UDP hole punching | JySama</a>。为了封装到项目中，使用命名空间。</p>
<p>为了简单，不考虑高并发的情况，默认连续的两个向服务器请求的内网主机就是要进行内网穿透的主机。</p>
<p>udp_hole_punch.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UDP_HOLE_PUNCHING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HOLE_PUNCHING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">namespace</span> UDP_HP</span><br><span class="line">&#123;    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span>;</span><br><span class="line">    <span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span>;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">(<span class="type">int</span>&amp; listenudp)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>udp_hole_punch.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;udp_hole_punch.h&quot;</span></span></span><br><span class="line"><span class="keyword">namespace</span> UDP_HP</span><br><span class="line">&#123;    </span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">        <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>,port);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">        socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">        socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Port reused</span></span><br><span class="line">        <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(listenfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//bind</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(listenfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;</span><br><span class="line">        <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">        <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">            string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line"></span><br><span class="line">            string host = <span class="built_in">string</span>(recvbuf);</span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;udp hole punching  NAT ip: %s, port: %s; host:%s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>(),host.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port+<span class="string">&quot; &quot;</span>+host;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        str = str + <span class="string">&quot; &quot;</span>;<span class="comment">//add a space</span></span><br><span class="line">        vector&lt;string&gt; res;</span><br><span class="line">        <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="type">size_t</span> pos1;</span><br><span class="line">        <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">        &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">            <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                pos1++;</span><br><span class="line">            pos = pos1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;<span class="comment">//move rvalue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">(<span class="type">int</span>&amp; listenudp)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">        string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">        <span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        vector&lt;string&gt; host1 = <span class="built_in">parse</span>(ip_port1);</span><br><span class="line">        vector&lt;string&gt; host2 = <span class="built_in">parse</span>(ip_port2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//The server sends back using a NAT ip</span></span><br><span class="line">        string ip1 = host1[<span class="number">0</span>];</span><br><span class="line">        string port1 = host1[<span class="number">1</span>];</span><br><span class="line">        string ip2 = host2[<span class="number">0</span>];</span><br><span class="line">        string port2 = host2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;</span><br><span class="line">        socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));</span><br><span class="line">        <span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;</span><br><span class="line">        socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));</span><br><span class="line">        <span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ip1 != ip2) <span class="comment">//Different intranets</span></span><br><span class="line">        &#123;</span><br><span class="line">            ip_port1 = ip1 + <span class="string">&quot; &quot;</span> + port1;</span><br><span class="line">            ip_port2 = ip2 + <span class="string">&quot; &quot;</span> + port2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//In the same NAT</span></span><br><span class="line">        &#123;</span><br><span class="line">            ip_port1 = host1[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host1[<span class="number">3</span>];</span><br><span class="line">            ip_port2 = host2[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host2[<span class="number">3</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">                      ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">            <span class="comment">//exit(1);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                         ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">            <span class="comment">//exit(1);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="下一阶段"><a href="#下一阶段" class="headerlink" title="下一阶段"></a>下一阶段</h1><p>现在可以进入下一阶段了，见下一篇博客（这篇字数多太卡了）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/12/18/orange--%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/18/orange--%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">「orange」</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-18 21:02:29 / 修改时间：21:03:07" itemprop="dateCreated datePublished" datetime="2022-12-18T21:02:29+08:00">2022-12-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这应该是我自己从头开始自己思考、自己设计、自己写代码的第一个项目了。</p>
<p>想做个小聊天软件，以命令行为主，我喜欢这种风格。不过因为是命令行交互，为了支持更多功能，所以整个客户端程序就变成了一个巨大的状态机，设计起来有些困难。</p>
<p>难点在于要单缓冲区多线程，一个输出输入缓冲（黑框框）要键入命令、接收随时可能到来的输出；并且用户可能输入一些不对应状态的命令，这也需要处理；最后还必须处理网络时延的问题。</p>
<p>项目代码链接：<a target="_blank" rel="noopener" href="https://github.com/Chen-Jin-yuan/orange">Chen-Jin-yuan&#x2F;orange (github.com)</a></p>
<h1 id="设计分析"><a href="#设计分析" class="headerlink" title="设计分析"></a>设计分析</h1><ul>
<li>单reactor多线程模式</li>
<li>主要有三种功能<ul>
<li>命令：客户端<strong>向服务器发送命令进行交互</strong>，命令行状态下直接输入，在其他状态下使用@字符：@cmd</li>
<li>聊天：客户之间能进行文字聊天通信，数据通信路径为<strong>客户-&gt;服务器-&gt;客户</strong>，这样服务器可以记录聊天数据<ul>
<li>需要<strong>注册登录</strong>，有一个唯一的登录id，链接到数据库；</li>
<li>登录后可以设置**标识字符串sid(search id)**，以及标识用户名sname。sid用于其他客户寻找本用户，即建立一个临时的会话（好玩的地方），sid在同一时间不能相同；标识用户名可任意，通信时显示。</li>
</ul>
</li>
<li>文件传输：进行p2p的文件传输<ul>
<li>用户A可以通过命令获取用户B的文件资源表（resource文件夹下放置可传输的文件），经用户B同意后可以传输</li>
<li>用户A也可以主动发送文件给用户B，用户B同意后可接收</li>
</ul>
</li>
</ul>
</li>
<li>调用主要以命令为主，本质是一台状态机，难点在于用户输入只有一个缓冲，状态不能交叉影响</li>
</ul>
<h2 id="命令系统"><a href="#命令系统" class="headerlink" title="命令系统"></a>命令系统</h2><p>这里设计命令系统，用户在普通情况下是一个命令行输入，即<code>cmd&gt; </code>，这里为了清楚标识，命令关键字以**@**标识。</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">@register [userID] [password] [password again]</td>
<td align="center">注册一个账号，用户名和密码不能含空格，用户名不能重</td>
</tr>
<tr>
<td align="center">@login [userID] [password]</td>
<td align="center">登录账号</td>
</tr>
<tr>
<td align="center">@search [sid]</td>
<td align="center">搜索某个sid，若存在则返回对方sname和是否在chat的信息；对方不会知道有用户搜索ta</td>
</tr>
<tr>
<td align="center">@chat [sid]</td>
<td align="center">准备进入chat状态，描述较长见表格后</td>
</tr>
<tr>
<td align="center">@accept [sid]</td>
<td align="center">接受某个sid，收到chat请求后会维护更新本地客户端的一个请求表，需要存在该sid</td>
</tr>
<tr>
<td align="center">@reject [sid]</td>
<td align="center">拒绝某个sid，收到chat请求后会维护更新本地客户端的一个请求表，需要存在该sid</td>
</tr>
<tr>
<td align="center">@break</td>
<td align="center">退出状态，进入命令行状态，描述较长见表格后</td>
</tr>
<tr>
<td align="center">@send [sid] [msg]</td>
<td align="center">直接向某个sid（若存在）发送一条信息，对方会得知sid和sname</td>
</tr>
<tr>
<td align="center">@sendfile [sid] [path]</td>
<td align="center">直接向某个sid（若存在）发送一条文件发送信息，对方会得知sid和sname和文件名，进入等待</td>
</tr>
<tr>
<td align="center">@acceptfile [sid]</td>
<td align="center">接收某sid发送的文件，返回接收信息</td>
</tr>
<tr>
<td align="center">@rejectfile [sid]</td>
<td align="center">拒绝某sid发送的文件，返回拒绝信息</td>
</tr>
<tr>
<td align="center">@getfile [sid]</td>
<td align="center">请求获取对方的文件资源表，对方会得知sid和sname，进入等待</td>
</tr>
<tr>
<td align="center">@acceptget [sid]</td>
<td align="center">同意对方获取资源，返回接受信息，等待对方选择文件</td>
</tr>
<tr>
<td align="center">@rejectget [sid]</td>
<td align="center">拒绝对方获取资源，返回拒绝信息</td>
</tr>
<tr>
<td align="center">@setsid [newsid]</td>
<td align="center">设置sid，不设置默认用登录的userID</td>
</tr>
<tr>
<td align="center">@setsname [newsname]</td>
<td align="center">设置sname，不设置默认用登录的userID</td>
</tr>
<tr>
<td align="center">@re</td>
<td align="center">重复上一条命令</td>
</tr>
<tr>
<td align="center">@exit</td>
<td align="center">退出</td>
</tr>
<tr>
<td align="center">@hisir [msg]</td>
<td align="center">向服务器说点事情，会得到服务器返回的一句话</td>
</tr>
<tr>
<td align="center">@oyasumi</td>
<td align="center">退出，向服务器说晚安</td>
</tr>
</tbody></table>
<ul>
<li>@chat：直接与某个sid用户通信，如果没有该sid会返回错误信息1；否则对方会接收到请求，获得你的sid和sname，并选择是否接受。若拒绝则返回拒绝信息；若接受则进入chat状态。用户在调用chat命令后，会进入等待状态（等待对方接受）</li>
<li>@break：<ul>
<li>退出等待状态，这会告知对方已经不请求chat了，同时删除对方的请求表中的sid，返回命令行状态</li>
<li>退出chat状态，这会告知对方已经断开chat了，返回命令行状态</li>
<li>退出发送文件等待状态，和chat一样</li>
<li>退出获取文件资源表的等待状态</li>
</ul>
</li>
<li>@sendfile：调用break可以退出等待；若对方接收，会开辟一个发送文件线程；若对方拒绝，直接退出等待</li>
<li>@getfile：若对方同意，则可以开始选择文件</li>
</ul>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>我们先随意写一些功能函数，最后封装起来，一些全局变量最后会变成类成员变量，请不用担心。</p>
<h2 id="命令解析"><a href="#命令解析" class="headerlink" title="命令解析"></a>命令解析</h2><p>首先解析命令，从命令行读入字符串然后分析。命令解析在本地完成，不发送给服务器，这样能降低出错的可能并降低服务器的复杂度。</p>
<p>下面是一个解析命令的demo</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span><span class="comment">//string.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;re&quot;</span>,<span class="number">16</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉string首尾空格</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">trim</span><span class="params">(string&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \t&quot;</span>));<span class="comment">//首次出现不匹配空格的位置</span></span><br><span class="line">        s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \t&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，cmdstr首位空格都去掉了</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">128</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;cmd&gt; &quot;</span>;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">string <span class="title">cmdstr</span><span class="params">(cmdbuf)</span></span>;</span><br><span class="line">        <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cmd&gt; &quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查找命令</span></span><br><span class="line">        <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cmd&gt; &quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">        <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                    <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                    <span class="built_in">strcpy_s</span>(cmdbuf,<span class="built_in">strlen</span>(cmdtmp)+<span class="number">1</span>,cmdtmp);</span><br><span class="line">                    reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cmd&gt; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcpy_s</span>(cmdtmp,<span class="built_in">strlen</span>(cmdbuf)+<span class="number">1</span>,cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;cmd&gt; &quot;</span>;</span><br><span class="line">            reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="连接服务器"><a href="#连接服务器" class="headerlink" title="连接服务器"></a>连接服务器</h2><p>在客户端打开初始化时自动连接服务器，然后返回一个连接套接字描述符，允许收发信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define MYPORT 8000</span></span><br><span class="line"><span class="comment">//const char* SERVER_IP = &quot;192.168.248.131&quot;;</span></span><br><span class="line"><span class="comment">//ip和port以参数形式传入</span></span><br><span class="line"><span class="comment">//INVALID_SOCKET（~0）和SOCKET_ERROR（-1）都是-1</span></span><br><span class="line"><span class="function">SOCKET <span class="title">connect_S</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span><span class="comment">//返回连接句柄</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//初始化WSA</span></span><br><span class="line">	WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">	WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">	<span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	SOCKET connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	<span class="keyword">if</span> (connfd == INVALID_SOCKET)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;socket error !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义sockaddr_in</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">	socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">	socketaddr.sin_port = <span class="built_in">htons</span>(MYPORT);<span class="comment">//服务器端口，自己连接后的端口是os分配的，由进程选择一个端口去连服务器</span></span><br><span class="line">	<span class="comment">//socketaddr.sin_addr.s_addr = inet_addr(SERVER_IP);  ///服务器ip</span></span><br><span class="line">	<span class="comment">//inet_addr最好换成inet_aton()，不会冤枉0.0.0.0和255.255.255.255</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">in_addr</span> inaddr;</span><br><span class="line">	<span class="built_in">inet_pton</span>(AF_INET, SERVER_IP, &amp;inaddr);<span class="comment">//windows下相当于inet_aton的函数，多了第一个参数表明是ipv4还是ipv6</span></span><br><span class="line">	socketaddr.sin_addr = inaddr;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;connecting to ip-&quot;</span> &lt;&lt; SERVER_IP &lt;&lt; <span class="string">&quot; port-&quot;</span> &lt;&lt; MYPORT &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">///连接服务器，成功返回0，错误返回-1。返回的描述符connfd，该socket包含了服务器ip、port，自己ip、port，可用于发送和接收数据</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;connect fail !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> SOCKET_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;connect to server successfully!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意该函数还没有</span></span><br><span class="line"><span class="comment">closesocket(connfd);和WSACleanup();</span></span><br><span class="line"><span class="comment">我们写一个关闭函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//调用多少次connect_S，就要调用多少次close_S</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_S</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设计状态机"><a href="#设计状态机" class="headerlink" title="设计状态机"></a>设计状态机</h2><p>为了简化设计，有一些状态是显式状态，有一些状态是隐式状态。什么是显式和隐式呢？显式状态比如说在命令行和在chat时输入的响应是不一样的，这是全局的；隐式状态比如说一些等待状态，这些等待是阻塞的，局部的，就不需要显式切换状态。简单来说，</p>
<ul>
<li>显式状态：<ul>
<li>未登录状态：可注册、登录，其他命令都是ban的；登录后进入命令行状态；</li>
<li>命令行状态：不可注册登录，其他可使用；chat后进入等待状态阻塞，对方接受后进入chat状态，否则返回命令行状态；</li>
<li>chat状态：此状态下的输入都发送给对端，除非使用@标识命令，比如使用@break退出chat状态；</li>
<li>等待状态：所有等待状态下，可以输入@break返回命令行状态。</li>
</ul>
</li>
<li>隐式状态：<ul>
<li>请求获取等待状态：等待对方响应，响应后进入命令行状态（拒绝）或选择文件状态（接受）；</li>
<li>选择文件状态：等待用户输入文件序号；</li>
<li>chat等待状态：等待对方响应；</li>
<li>发送文件等待状态：等待对方响应，响应后进入命令行状态；</li>
<li>等待文件被获取状态：允许对方获取资源，等待对方选择文件。</li>
</ul>
</li>
</ul>
<p>状态使用枚举类，c++编程风格惯用法提出使用<strong>enum class</strong>代替enum和namespace，可以参考<a href="https://jysama.cn/2022/08/06/c++%E6%83%AF%E7%94%A8%E6%B3%95/">c++编程风格惯用法 | JySama</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用例子</span></span><br><span class="line">clientState state;<span class="comment">//定义一个枚举类型变量</span></span><br><span class="line"><span class="keyword">if</span>(state == clientState::noLogin <span class="keyword">and</span> loginsuccess)</span><br><span class="line">    state = clientState::cmdLine;</span><br></pre></td></tr></table></figure>

<h2 id="状态机实现–重写run"><a href="#状态机实现–重写run" class="headerlink" title="状态机实现–重写run()"></a>状态机实现–重写run()</h2><p>对于不同状态，我们希望输出的提示符不同，比如前面都是<code>cmd&gt; </code>，现在希望根据状态进行改变。一种方法是打印提示符时判断状态，太麻烦了；一种方法是把提示符看做变量，更改状态时就更改提示符。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">命令行状态：<span class="string">&quot;cmd&gt; &quot;</span></span><br><span class="line">等待状态：<span class="string">&quot;waiting&gt; &quot;</span></span><br><span class="line">chat状态：<span class="string">&quot;chatting with [sname]&gt; &quot;</span></span><br><span class="line">未登录状态：<span class="string">&quot;need login&gt; &quot;</span></span><br><span class="line"></span><br><span class="line">unordered_map&lt;clientState,string&gt; promptMap = </span><br><span class="line">&#123;</span><br><span class="line">    &#123;clientState::noLogin,<span class="string">&quot;need login&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::cmdLine,<span class="string">&quot;cmd&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::isChatting,<span class="string">&quot;chatting with &quot;</span>&#125;,<span class="comment">//进入chat状态要根据对方的sname来拼接</span></span><br><span class="line">    &#123;clientState::isWaiting,<span class="string">&quot;waiting&gt; &quot;</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果没有登录而调用ban掉的命令，我们就打印一句错误信息</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state == clientState::noLogin)</span><br><span class="line">&#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果已经登录还调用注册和登录命令，就打印一句错误信息</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state != clientState::noLogin)</span><br><span class="line">&#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;error&gt; Signed in yet!&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些错误信息，我们可以在case语句里面加，但太臃肿了，我们进行一层封装</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkCmd</span><span class="params">(<span class="type">int</span> cmdvalue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最开始只考虑是否登录</span></span><br><span class="line">    <span class="keyword">if</span>(cmdvalue==<span class="number">0</span>||cmdvalue==<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(state != clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Have signed in yet!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(state == clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果正在等待，只允许break</span></span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting &amp;&amp; cmdvalue!= <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; Only break or @break can input because you are waiting for something!&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span><span class="comment">//string.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;re&quot;</span>,<span class="number">16</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">unordered_map&lt;clientState, string&gt; promptMap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;clientState::noLogin,<span class="string">&quot;need login&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::cmdLine,<span class="string">&quot;cmd&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::isChatting,<span class="string">&quot;chatting with &quot;</span>&#125;,<span class="comment">//进入chat状态要根据对方的sname来拼接</span></span><br><span class="line">    &#123;clientState::isWaiting,<span class="string">&quot;waiting&gt; &quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉string首尾空格</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">trim</span><span class="params">(string&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \t&quot;</span>));<span class="comment">//首次出现不匹配空格的位置</span></span><br><span class="line">        s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \t&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，cmdstr首位空格都去掉了</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">clientState state = clientState::noLogin;</span><br><span class="line">string prompt = promptMap[state];</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkCmd</span><span class="params">(<span class="type">int</span> cmdvalue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最开始只考虑是否登录</span></span><br><span class="line">    <span class="keyword">if</span> (cmdvalue == <span class="number">0</span> || cmdvalue == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state != clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Have signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果正在等待，只允许break</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isWaiting &amp;&amp; cmdvalue != <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; Only break or @break can input because you are waiting for something!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">128</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    cout &lt;&lt; prompt;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">string <span class="title">cmdstr</span><span class="params">(cmdbuf)</span></span>;</span><br><span class="line">        <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查找命令</span></span><br><span class="line">        <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="comment">//send...waiting</span></span><br><span class="line">                state = clientState::isWaiting;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="comment">//send...waiting</span></span><br><span class="line">                state = clientState::isWaiting;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="comment">//send...waiting</span></span><br><span class="line">                state = clientState::isWaiting;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="comment">//send...waiting</span></span><br><span class="line">                state = clientState::isWaiting;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                    <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                    <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                    reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">            <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//做处理</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">            reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理"><a href="#处理" class="headerlink" title="处理@"></a>处理@</h2><p>我们对命令的解析还没有包含@形式，实际上@只有在chatting状态下才被必须，其他情况下只需要简单的把@去掉即可，即检测到第一个字符的@的话就把@去掉。</p>
<p>而在chatting状态下，我们依旧从fgets里接收输入，如果第一个字符是@，我们判定为输入命令，这样才有一系列的操作（解析命令、进行switch等等）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>]!=<span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//send...</span></span><br><span class="line">    cout &lt;&lt; prompt;</span><br><span class="line">&#125;    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">else</span><span class="comment">//否则一定是命令</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//解析命令</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，对于解析命令函数，就可以这样改写：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//首先看第一个字符是不是@，是的话去掉就好了</span></span><br><span class="line">    <span class="keyword">if</span>(cmdstr[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">        cmdstr = cmdstr.<span class="built_in">substr</span>(<span class="number">1</span>,cmdstr.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还没有处理chatting的状态转换，因为这涉及服务器发回确认，现在我们在chat命令那使用Sleep()函数阻塞一段时间，表示等待同意。demo可以这样改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span><span class="comment">//string.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span><span class="comment">//Sleep()</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">string chatSname = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;re&quot;</span>,<span class="number">16</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">unordered_map&lt;clientState, string&gt; promptMap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;clientState::noLogin,<span class="string">&quot;need login&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::cmdLine,<span class="string">&quot;cmd&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::isChatting,<span class="string">&quot;chatting with &quot;</span>&#125;,<span class="comment">//进入chat状态要根据对方的sname来拼接</span></span><br><span class="line">    &#123;clientState::isWaiting,<span class="string">&quot;waiting&gt; &quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉string首尾空格</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">trim</span><span class="params">(string&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \t&quot;</span>));<span class="comment">//首次出现不匹配空格的位置</span></span><br><span class="line">        s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \t&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，cmdstr首位空格都去掉了</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//首先看第一个字符是不是@，是的话去掉就好了</span></span><br><span class="line">    <span class="keyword">if</span> (cmdstr[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">        cmdstr = cmdstr.<span class="built_in">substr</span>(<span class="number">1</span>, cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">clientState state = clientState::noLogin;</span><br><span class="line">string prompt = promptMap[state];</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkCmd</span><span class="params">(<span class="type">int</span> cmdvalue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最开始只考虑是否登录</span></span><br><span class="line">    <span class="keyword">if</span> (cmdvalue == <span class="number">0</span> || cmdvalue == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state != clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Have signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//如果正在chatting，不允许再chat</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdvalue == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; You are chatting with &quot;</span>&lt;&lt;chatSname&lt;&lt;<span class="string">&quot;! You can break to chat with other.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果正在等待，只允许break</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isWaiting &amp;&amp; cmdvalue != <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; Only break or @break can input because you are waiting for something!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">128</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    cout &lt;&lt; prompt;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;send something...&quot;</span> &lt;&lt; endl;<span class="comment">//test</span></span><br><span class="line">            cout &lt;&lt; prompt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//剩下的内容都是else的</span></span><br><span class="line">        &#123;</span><br><span class="line">            string <span class="built_in">cmdstr</span>(cmdbuf);</span><br><span class="line">            <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查找命令</span></span><br><span class="line">            <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">                cout &lt;&lt; prompt;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">Sleep</span>(<span class="number">3000</span>);<span class="comment">//阻塞3秒，假装等待连接</span></span><br><span class="line">                    state = clientState::isChatting;</span><br><span class="line">                    <span class="comment">//chatSname = ...</span></span><br><span class="line">                    prompt = promptMap[state] + chatSname+<span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                        <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                        <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                        reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接收处理"><a href="#接收处理" class="headerlink" title="接收处理"></a>接收处理</h2><p>在基础设计时，已经降低了交互的复杂度，比如我们使用accept命令来回复，而不是直接根据请求键入其他东西，在接下来的考虑中，你会得到更深刻的理解。尽管我们仍然有许多命令没处理完，但在处理它们之前，要讨论怎么从服务器接收返回的数据，这是个很值得深思的问题。</p>
<p>对于发送命令来说，我们在本地解析了命令就可以直接发送给服务器，服务器根据前面设计的命令解析（只有少许不同，让服务器区分发送的是命令还是聊天内容）就可以解析完成，因此对于客户端来说，重点是处理接收，困难就在于：<strong>用户只有一个输出缓冲区和一个输入缓冲区！</strong></p>
<ul>
<li>一种方式是：让用户在调用需要服务器交互的命令后阻塞，等待接收，然后对接收内容进行处理。比如当login、register后，等待服务器返回成功和失败信息即可，理论上所有的命令都可以用这种方式来实现；</li>
<li>上面的方式没有考虑一个问题，就是<strong>当别的客户发来一条信息时，实际上本地客户端并不一定去recv</strong>。比如本地用户还在干别的事情就有别的用户发一个send或get请求过来，这个请求经由服务器再发送到本地客户端，直到下次本地客户调用阻塞命令才会进行接收。另外在chat的时候实际上也不知道什么时候该recv。一方面时延很久，一方面无法区分返回的命令。这是两个很严重的问题。</li>
<li>额外接收线程：我们还是对问题简化<ul>
<li>直接与服务器交互的命令，就直接阻塞等待接收（因为必须等待处理）；</li>
<li>与其他用户的交互，这会导致信息不知道什么时候发送过来，就另外用一个线程去接收，这个线程使用另外一个套接字（线程的port也会不一样），发送给哪个套接字交给服务器判断就好了。</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>看起来问题已经解决了，但如果服务器只有一个监听端口，会使得复杂度过大。服务器是可以监听多个端口的，那么可以让服务器用两个监听线程。这两个监听线程刚好可以把两种套接字区分开来。</li>
<li>由于有两个监听线程，导致我们不得不再考虑：什么信息该发送到哪个端口？这个问题产生的原因是，两个监听线程得到的连接套接字可以要交互。比如chat，当用户1发送一条消息时，实际上是在我们的主线程（接收stdin解析命令线程）发送的，如果走的是监听1（接收命令的线程），那么要想把这条消息发送给用户2，就要从监听2那里获取用户2的接收信息套接字，再发送。这使得问题复杂化，可能需要考虑共享变量互斥的问题。因此我们不得不考虑发送什么到哪里的问题。</li>
<li>好吧，其实这个问题不用考虑：“接收线程允许发送命令吗？”这是不太允许的，因为它要一直recv，你可能会说用非阻塞的recv，但这又使得问题走向另一个复杂的地方。我们可以断言：<strong>所有的命令，都要发送给服务器的接收命令的线程！</strong>至于命令或是回复的转交，不得不通过另一个连接来执行。</li>
</ul>
<hr>
<p>现在来完成接收线程要做的事情，先封装到一个函数里，这里首先要连接服务器，还记得前面写的connect_S函数吗：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define MYPORT 8000</span></span><br><span class="line"><span class="comment">//const char* SERVER_IP = &quot;192.168.248.131&quot;;</span></span><br><span class="line"><span class="comment">//ip和port以参数形式传入</span></span><br><span class="line"><span class="comment">//INVALID_SOCKET（~0）和SOCKET_ERROR（-1）都是-1</span></span><br><span class="line"><span class="function">SOCKET <span class="title">connect_S</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span><span class="comment">//返回连接句柄</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//初始化WSA</span></span><br><span class="line">	WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">	WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">	<span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	SOCKET connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	<span class="keyword">if</span> (connfd == INVALID_SOCKET)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;socket error !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义sockaddr_in</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">	socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">	socketaddr.sin_port = <span class="built_in">htons</span>(MYPORT);<span class="comment">//服务器端口，自己连接后的端口是os分配的，由进程选择一个端口去连服务器</span></span><br><span class="line">	<span class="comment">//socketaddr.sin_addr.s_addr = inet_addr(SERVER_IP);  ///服务器ip</span></span><br><span class="line">	<span class="comment">//inet_addr最好换成inet_aton()，不会冤枉0.0.0.0和255.255.255.255</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">in_addr</span> inaddr;</span><br><span class="line">	<span class="built_in">inet_pton</span>(AF_INET, SERVER_IP, &amp;inaddr);<span class="comment">//windows下相当于inet_aton的函数，多了第一个参数表明是ipv4还是ipv6</span></span><br><span class="line">	socketaddr.sin_addr = inaddr;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;connecting to ip-&quot;</span> &lt;&lt; SERVER_IP &lt;&lt; <span class="string">&quot; port-&quot;</span> &lt;&lt; MYPORT &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">///连接服务器，成功返回0，错误返回-1。返回的描述符connfd，该socket包含了服务器ip、port，自己ip、port，可用于发送和接收数据</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == SOCKET_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cerr &lt;&lt; <span class="string">&quot;connect fail !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> SOCKET_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;connect to server successfully!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意该函数还没有</span></span><br><span class="line"><span class="comment">closesocket(connfd);和WSACleanup();</span></span><br><span class="line"><span class="comment">我们写一个关闭函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//调用多少次connect_S，就要调用多少次close_S</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_S</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们的接收线程的工作函数的工作逻辑就更清楚了：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvThread</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP,MYPORT);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span>(connfd==INVALID_SOCKET || connfd==SOCKET_ERROR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//--------------------------工作-----------------------------</span></span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf,<span class="number">0</span>,<span class="built_in">sizeof</span>(recvbuf));<span class="comment">//每次都将buffer清空，防止被上次写入的结果影响</span></span><br><span class="line">        <span class="type">size_t</span> recvbytes = <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf),<span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">        <span class="comment">//异常结束时，退出</span></span><br><span class="line">        <span class="keyword">if</span>(recvbytes&lt;=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout&lt;&lt;<span class="string">&quot;The receiving thread exits!&quot;</span>&lt;&lt;endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        cout&lt;&lt;recvbuf&lt;&lt;endl;<span class="comment">//endl可以刷新缓冲</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收线程的工作大概就是这些，只是简单的打印，因为我们把复杂度交给服务器了。不过，我们考虑下主线程和接收线程之间的关系——它们共享输出缓冲。因此会发生一种情况，在主线程打印出来的提示符会被顶掉，尽管用户仍然可以在主线程输入，但会让用户感觉“坏掉了”，大概像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmd&gt; something....recv&gt; .....................</span><br><span class="line">here enter other</span><br></pre></td></tr></table></figure>

<p>因此，除了打印前需要换行，还需要在打印后把提示符再打印出来：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cout&lt;&lt;endl&lt;&lt;recvbuf&lt;&lt;endl&lt;&lt;prompt;</span><br></pre></td></tr></table></figure>

<p>然后加入线程，需要头文件<code>&lt;thread&gt;</code>和<code>&lt;functional&gt;</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">thread</span>(<span class="built_in">bind</span>(recvThread, SERVER_IP, MYPORT)).<span class="built_in">detach</span>();</span><br></pre></td></tr></table></figure>

<p>阶段性测试的demo如下，我们把接收线程相关的函数都放在main函数前面，因为已经相当臃肿了，等处理完一并封装。注意这里面有<code>&lt;windows.h&gt;</code>和<code>&lt;WinSock2.h&gt;</code>，后者一定要在前者前include。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">“winsock2.h”定义了_WINSOCKAPI_，原意是不要编译&#x27;&#x27;winsock.h&quot;。</span><br><span class="line">如果&quot;windows.h&quot;在“winsock2.h”前面，那么会先include “winsock.h”编译，后再“winsock2.h”时遇到了重定义。</span><br><span class="line">所以先include “winsock2.h”再include &quot;windows.h&quot;就可以避开这些重定义。</span><br></pre></td></tr></table></figure>

<p>同时，我们进行一点优化，以往打印提示符时没有刷新缓冲区，现在我们把刷新缓冲加上，否则可能会堵住显得卡，像这样<code>cout &lt;&lt; prompt &lt;&lt; flush;</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span><span class="comment">//string.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span><span class="comment">//Sleep()</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">string chatSname = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;re&quot;</span>,<span class="number">16</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">unordered_map&lt;clientState, string&gt; promptMap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;clientState::noLogin,<span class="string">&quot;need login&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::cmdLine,<span class="string">&quot;cmd&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::isChatting,<span class="string">&quot;chatting with &quot;</span>&#125;,<span class="comment">//进入chat状态要根据对方的sname来拼接</span></span><br><span class="line">    &#123;clientState::isWaiting,<span class="string">&quot;waiting&gt; &quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉string首尾空格</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">trim</span><span class="params">(string&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \t&quot;</span>));<span class="comment">//首次出现不匹配空格的位置</span></span><br><span class="line">        s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \t&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，cmdstr首位空格都去掉了</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//首先看第一个字符是不是@，是的话去掉就好了</span></span><br><span class="line">    <span class="keyword">if</span> (cmdstr[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">        cmdstr = cmdstr.<span class="built_in">substr</span>(<span class="number">1</span>, cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">clientState state = clientState::noLogin;</span><br><span class="line">string prompt = promptMap[state];</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkCmd</span><span class="params">(<span class="type">int</span> cmdvalue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最开始只考虑是否登录</span></span><br><span class="line">    <span class="keyword">if</span> (cmdvalue == <span class="number">0</span> || cmdvalue == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state != clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Have signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果正在chatting，不允许再chat</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdvalue == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; You are chatting with &quot;</span> &lt;&lt; chatSname &lt;&lt; <span class="string">&quot;! You can break to chat with other.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果正在等待，只允许break</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isWaiting &amp;&amp; cmdvalue != <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; Only break or @break can input because you are waiting for something!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">128</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;send something...&quot;</span> &lt;&lt; endl;<span class="comment">//test</span></span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//剩下的内容都是else的</span></span><br><span class="line">        &#123;</span><br><span class="line">            string <span class="built_in">cmdstr</span>(cmdbuf);</span><br><span class="line">            <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查找命令</span></span><br><span class="line">            <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">Sleep</span>(<span class="number">3000</span>);<span class="comment">//阻塞3秒，假装等待连接</span></span><br><span class="line">                    state = clientState::isChatting;</span><br><span class="line">                    <span class="comment">//chatSname = ...</span></span><br><span class="line">                    prompt = promptMap[state] + chatSname + <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                        <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                        <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                        reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;test&gt; &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; cmdvec[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">SOCKET <span class="title">connect_S</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span><span class="comment">//返回连接句柄</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建套接字</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;socket error !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(MYPORT);<span class="comment">//服务器端口，自己连接后的端口是os分配的，由进程选择一个端口去连服务器</span></span><br><span class="line">    <span class="comment">//socketaddr.sin_addr.s_addr = inet_addr(SERVER_IP);  ///服务器ip</span></span><br><span class="line">    <span class="comment">//inet_addr最好换成inet_aton()，不会冤枉0.0.0.0和255.255.255.255</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> inaddr;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVER_IP, &amp;inaddr);<span class="comment">//windows下相当于inet_aton的函数，多了第一个参数表明是ipv4还是ipv6</span></span><br><span class="line">    socketaddr.sin_addr = inaddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///连接服务器，成功返回0，错误返回-1。返回的描述符connfd，该socket包含了服务器ip、port，自己ip、port，可用于发送和接收数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connect fail !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> SOCKET_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意该函数还没有</span></span><br><span class="line"><span class="comment">closesocket(connfd);和WSACleanup();</span></span><br><span class="line"><span class="comment">我们写一个关闭函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//调用多少次connect_S，就要调用多少次close_S</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_S</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvThread</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP, MYPORT);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------工作-----------------------------</span></span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)<span class="comment">//后面会设置exitflag</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//每次都将buffer清空，防止被上次写入的结果影响</span></span><br><span class="line">        <span class="type">size_t</span> recvbytes = <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">        <span class="comment">//异常结束时，退出</span></span><br><span class="line">        <span class="keyword">if</span> (recvbytes &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl  &lt;&lt; <span class="string">&quot;The receiving thread exits!&quot;</span> &lt;&lt; endl &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; recvbuf &lt;&lt; endl &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;192.168.248.131&quot;</span>;</span><br><span class="line"><span class="type">int</span> MYPORT = <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">thread</span>(<span class="built_in">bind</span>(recvThread, SERVER_IP, MYPORT)).<span class="built_in">detach</span>();</span><br><span class="line">    <span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单写一个linux服务器发送数据测试，有了这台服务器，我们之后就可以模拟响应往下做了，尽管我们现在是手动在服务器上发送数据。</p>
<p>服务器发送exit就可以退出，接收线程也会因此退出，我们现在可以先放着，不去管它。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span><span class="comment">//cerr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> myport 8000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_STREAM,IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(myport);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line">    			<span class="comment">//因为路由的关系，从客户端来的IP包只可能到达其中一个网卡。指定了网卡地址的话，必须从相应的地址进入才能连接到port</span></span><br><span class="line">    			<span class="comment">//#define    INADDR_ANY        ((in_addr_t) 0x00000000)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr&lt;&lt;<span class="string">&quot;bind&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//cerr不经过缓冲而直接输出，一般用于迅速输出出错信息，是标准错误，默认情况下被关联到标准输出流，但它不被缓冲.</span></span><br><span class="line">        <span class="comment">//也就说错误消息可以直接发送到显示器，而无需等到缓冲区或者新的换行符时，才被显示。</span></span><br><span class="line">    &#125;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;listen socket port: &quot;</span>&lt;&lt;myport&lt;&lt;std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//开始监听</span></span><br><span class="line">     <span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd,SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr&lt;&lt;<span class="string">&quot;listen&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;wating for conn...&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> conn = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);<span class="comment">//阻塞，等待连接，成功则创建连接套接字conn描述这个用户</span></span><br><span class="line">    <span class="keyword">if</span>(conn==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr&lt;&lt;<span class="string">&quot;connect&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果队列中没有等待的连接，套接字也没有被标记为Non-blocking，accept()会阻塞调用函数直到连接出现；</span></span><br><span class="line"><span class="comment">    如果套接字被标记为Non-blocking，队列中也没有等待的连接，accept()返回错误EAGAIN或EWOULDBLOCK。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;conn successfully: port-&quot;</span>&lt;&lt;<span class="built_in">ntohs</span>(client_addr.sin_port)&lt;&lt;<span class="string">&quot; ip-&quot;</span>&lt;&lt;<span class="built_in">inet_ntoa</span>(client_addr.sin_addr)&lt;&lt;std::endl&lt;&lt;std::endl;</span><br><span class="line">        <span class="type">char</span> sendbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">//gets:从标准输入 stdin 读取一行，并把它存储在 str 所指向的字符串中。当读取到换行符时停止</span></span><br><span class="line">    <span class="comment">//如果成功，该函数返回 str。如果发生错误或者到达文件末尾时还未读取任何字符，则返回 NULL。</span></span><br><span class="line">    <span class="comment">//等价于fgets(sendbuf, sizeof(sendbuf), stdin)</span></span><br><span class="line">    </span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;send&gt; &quot;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(sendbuf, <span class="built_in">sizeof</span>(sendbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;send to client: &quot;</span>&lt;&lt;sendbuf;<span class="comment">//不用换行fgets包含了\n</span></span><br><span class="line">        <span class="built_in">send</span>(conn, sendbuf, <span class="built_in">strlen</span>(sendbuf)<span class="number">-1</span>,<span class="number">0</span>); <span class="comment">///\n is ignored</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sendbuf,<span class="string">&quot;exit\n&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">bzero</span>(sendbuf,<span class="built_in">sizeof</span>(sendbuf));</span><br><span class="line"></span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;send&gt; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(conn);</span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="命令发送与接收"><a href="#命令发送与接收" class="headerlink" title="命令发送与接收"></a>命令发送与接收</h2><p>现在我们来处理主线程的命令发送，基本上就是处理run方法，不过注意，在main调用run前，我们先进行连接，然后把套接字传给run()，大概像这样子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP, MYPORT);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line">    </span><br><span class="line">	<span class="built_in">run</span>(connfd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们对run函数作修改，注意一个前提，进入switch内的else的部分，都是可以进行执行的正确的命令，这些命令可以发送给服务器。我们对这些部分进行send和recv处理。关于recv，在主线程中是阻塞我们的输入的，但是当我们在waiting时，还是能够输入break来退出等待（这是必要的），这就不能阻塞了，因此对于waiting的这部分，接收放到接收线程处理。</p>
<p>为什么说break是必要的呢？我们实际上可以认为服务器是不会让用户等（或者说等太久）的，但对等方是可能让本地用户等很久的（可能由于意外、可能由于心理道德），这就需要允许用户自主退出，尽管这会增加许多复杂度。</p>
<hr>
<p>对于那些要接收回复的命令，我们在此探讨一下它们要接收什么。</p>
<ul>
<li>register<ul>
<li>注册正确还是错误：success | failure</li>
<li>如果是success，在本地处理并返回注册正确的信息；</li>
<li>如果是failure，在本地处理并返回注册失败的信息，由于我们判断了密码相不相同了，这必然是用户ID已被使用了；</li>
</ul>
</li>
<li>login<ul>
<li>如果是success，在本地处理并返回登录成功的信息，并进入命令行；</li>
<li>如果是failure，可能是密码错了或者根本没有用户ID，这时服务器不返回failure，而是返回相关的错误信息，直接打印即可；</li>
</ul>
</li>
<li>search<ul>
<li>如果是failure，本地处理并返回不存在该sid</li>
<li>否则成功，服务器直接发回sname和是否在chat的信息，直接打印</li>
</ul>
</li>
<li>chat<ul>
<li>服务器返回对方是否接受的信息，为了区别格式（命令与命令之间，命令与聊天信息之间），服务器会发送这样的信息：”@#chat accept”、”@#chat reject”</li>
<li>然后会进行状态的更新</li>
</ul>
</li>
<li>accept<ul>
<li>暂不考虑交互，但可能因为时延影响，后续也许涉及交互的认证</li>
</ul>
</li>
<li>reject<ul>
<li>与accept一样</li>
</ul>
</li>
<li>break<ul>
<li>与accept一样</li>
</ul>
</li>
<li>send<ul>
<li>这里降低复杂度，如果对方sid不存在也不返回消息，所以需要用户先search</li>
</ul>
</li>
<li>sendfile<ul>
<li>服务器返回对方是否接受的信息，为了区别格式，服务器会发送这样的信息：”@#sendfile accept”、”@#sendfile reject”</li>
</ul>
</li>
<li>acceptfile<ul>
<li>与accept一样</li>
</ul>
</li>
<li>rejectfile<ul>
<li>与accept一样</li>
</ul>
</li>
<li>getfile<ul>
<li>当对方acceptget时，会给本地用户一个资源表，因此服务器发回来的就是这样一个资源表。</li>
<li>那么服务器返回的消息像这样：”@#getfile reject”、”@#getfile accept resource_list”</li>
</ul>
</li>
<li>acceptget<ul>
<li>不阻塞直接可以做别的事，即一定允许发送，接收线程处理对方选择，服务器返回这样一条信息：”@#choosefile [number]”</li>
</ul>
</li>
<li>rejectget<ul>
<li>与accept一样</li>
</ul>
</li>
<li>setsid<ul>
<li>返回成功和失败信息，直接打印</li>
</ul>
</li>
<li>setsname<ul>
<li>返回成功和失败信息，直接打印</li>
</ul>
</li>
<li>re<ul>
<li>不返回</li>
</ul>
</li>
<li>exit<ul>
<li>不返回</li>
</ul>
</li>
<li>hisir<ul>
<li>返回一句话，直接打印</li>
</ul>
</li>
<li>oyasumi<ul>
<li>会返回一句晚安消息（随机选择），然后打印</li>
</ul>
</li>
</ul>
<p>有些返回是直接打印的，而有些返回需要进行解析，比如login；而那些accept之类的，因为主线程是在waiting状态，那就让接收线程解析。</p>
<p>当用户在选择文件时，要键入输入，为了不和主线程的输入冲突，我们就在主线程输入。为了不增加状态（比如目前在选择文件状态），我们只需要增加一个选择文件flag就好了，如果是true的话表明这个输入用于选择文件。发送的命令是：choosefile  [number]，下面的run先不对此做修改</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> chooseflag = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isNumber</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf)</span><span class="comment">//判断字符传是否为数字</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;buf[i]!=<span class="string">&#x27;\n&#x27;</span>;i++)<span class="comment">//以\n结尾</span></span><br><span class="line">        <span class="keyword">if</span>(buf[i]&lt;<span class="string">&#x27;0&#x27;</span>||buf[i]&gt;<span class="string">&#x27;9&#x27;</span>)<span class="comment">//每个字符都要是数字</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">string chattarg = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//一个汉字两字节，可能需要更大的buf</span></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">256</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> exitflag = <span class="literal">false</span>;<span class="comment">//函数退出信号</span></span><br><span class="line">    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(chooseflag)<span class="comment">//如果在选择文件。接收线程会把这个flag改成true，并且打印提示符enter file number&gt; </span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isNumber</span>(cmdbuf))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//要进行数字的范围判断，用stoi</span></span><br><span class="line">                <span class="type">int</span> num = <span class="built_in">stoi</span>(cmdbuf);</span><br><span class="line">                <span class="keyword">if</span>(num&gt;fileNumber || num&lt;<span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                	cerr &lt;&lt; <span class="string">&quot;Please enter a number in the range！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                	<span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                	cout &lt;&lt; prompt&lt;&lt; flush;</span><br><span class="line">                	<span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">sizeof</span>(cmdbuf),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            	<span class="comment">//...还需要用一个线程来接收</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;Downloading...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                chooseflag = <span class="literal">false</span>;</span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Please enter a number！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt&lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">sizeof</span>(cmdbuf),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//剩下的内容都是else的</span></span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//把接收缓冲清零</span></span><br><span class="line">            <span class="function">string <span class="title">cmdstr</span><span class="params">(cmdbuf)</span></span>;</span><br><span class="line">            <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查找命令</span></span><br><span class="line">            <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;The registration is successful and you can log in!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Registration failed, please try a different ID!&quot;</span> &lt;&lt; endl;</span><br><span class="line">						</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的              </span></span><br><span class="line">                 </span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Login successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                        state = clientState::cmdLine;</span><br><span class="line">                    	prompt = promptMap[state];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;faliure&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;sid does not exist!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    </span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    chattarg = cmdvec[<span class="number">1</span>];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">      				</span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Sleep(3000);//阻塞3秒，假装等待连接</span></span><br><span class="line"><span class="comment">                    state = clientState::isChatting;</span></span><br><span class="line"><span class="comment">                    //chatSname = ...</span></span><br><span class="line"><span class="comment">                    prompt = promptMap[state] + chatSname + &quot;&gt; &quot;;</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，break也需要发送，这样服务器才能知道用户从某请求的等待中退出了</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//...还需要用一个线程来接收，文件名通过请求表维护</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//需要接收响应，因为sid是全局唯一的，可能设置失败！</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//这里接收响应是为了增加用户体验，服务器返回一个成功信息</span></span><br><span class="line">                    <span class="comment">//因为设置相对频率较少，这不是什么很大的负担</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                        <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                        <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                        reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，或许需要告知服务器退出，先这样</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;The client now exits!&quot;</span> &lt;&lt;endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt;endl;</span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//是否退出</span></span><br><span class="line">            <span class="keyword">if</span>(exitflag)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解析接收命令"><a href="#解析接收命令" class="headerlink" title="解析接收命令"></a>解析接收命令</h3><p>进一步丰富接收线程的接收函数，可以借助前面的解析函数parse</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fileNumber = <span class="number">0</span>;<span class="comment">//全局变量，用于对方acceptget后选择文件的最大数量</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>,string&gt; getResourceMap;</span><br><span class="line"><span class="comment">//解析命令，返回解析成不成功，失败则false</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">parseRecv</span><span class="params">(string cmdrecv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最后加一个空格，这样能解析成功</span></span><br><span class="line">    cmdrecv += <span class="string">&quot; &quot;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdrecv.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdrecv.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdrecv[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(res.<span class="built_in">size</span>()&lt;<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; endl &lt;&lt;<span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(res[<span class="number">0</span>] == <span class="string">&quot;chat&quot;</span> &amp;&amp; state == clientState::isWaiting)<span class="comment">//必须还在等待</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer agrees to chat!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::isChatting;</span><br><span class="line">            prompt = promptMap[state]+ chattarg+<span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer disagrees to chat!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt;<span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">0</span>] == <span class="string">&quot;sendfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer agrees to receive file!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">            <span class="comment">//开线程</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer disagrees to receive file!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt;<span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">0</span>] == <span class="string">&quot;getfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span> &amp;&amp; res[<span class="number">2</span>] == <span class="string">&quot;none&quot;</span>)<span class="comment">//如果没有资源但同意了，第三个参数就是none</span></span><br><span class="line">        &#123;       </span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer has no resources!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            chooseflag = <span class="literal">true</span>;</span><br><span class="line">            prompt = <span class="string">&quot;enter the number of file&gt; &quot;</span>;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer agrees to getfile!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            getResourceMap.<span class="built_in">clear</span>();<span class="comment">//清空</span></span><br><span class="line">            fileNumber = <span class="number">0</span>;<span class="comment">//重置</span></span><br><span class="line">            string resolist;<span class="comment">//打印信息</span></span><br><span class="line">            <span class="comment">//假设对方发送的文件资源表是[1] some.txt [2] some2.txt，即空格分隔的成对的</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;res.<span class="built_in">size</span>();i+=<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                fileNumber++;</span><br><span class="line">                getResourceMap[fileNumber] = res[i+<span class="number">1</span>];</span><br><span class="line">                resolist += res[i]+<span class="string">&quot;\t&quot;</span>+res[i+<span class="number">1</span>]+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cout &lt;&lt; resolist &lt;&lt;flush;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer doesn&#x27;t allow you to get the resource!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt;<span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(res[<span class="number">0</span>] == <span class="string">&quot;choosefile&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">stoi</span>(res[<span class="number">1</span>]);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt;<span class="string">&quot;The peer requested the [&quot;</span>+res[<span class="number">1</span>]+<span class="string">&quot;] file!&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="comment">//开一个线程发送</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvThread</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP, MYPORT);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------工作-----------------------------</span></span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)<span class="comment">//后面会设置exitflag</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//每次都将buffer清空，防止被上次写入的结果影响</span></span><br><span class="line">        <span class="type">size_t</span> recvbytes = <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">        <span class="comment">//异常结束时，退出</span></span><br><span class="line">        <span class="keyword">if</span> (recvbytes &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl  &lt;&lt; <span class="string">&quot;The receiving thread exits!&quot;</span> &lt;&lt; endl &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">if</span>(recvbytes &gt;= <span class="number">3</span> &amp;&amp; recvbuf[<span class="number">0</span>]==<span class="string">&#x27;@&#x27;</span> &amp;&amp; recvbuf[<span class="number">1</span>]==<span class="string">&#x27;#&#x27;</span>)<span class="comment">//这种情况下要解析命令</span></span><br><span class="line">        &#123;</span><br><span class="line">            string cmdrecv = recvbuf;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">parseRecv</span>(cmdrecv.<span class="built_in">substr</span>(<span class="number">2</span>,cmdrecv.<span class="built_in">size</span>()<span class="number">-2</span>)))</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;<span class="comment">//失败就不打印刷新</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//其他信息直接输出</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;	</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>需要两个服务器来模拟输入输出，代码不贴了（感觉没人能follow到这…写着写着发现太抽象了）。</p>
<p>不过测试发现挺好的，测了好久关了忘记截图了，不想再测了，因为手敲服务器的响应有点麻烦。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span><span class="comment">//string.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span><span class="comment">//Sleep()</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">string chatSname = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="type">int</span> fileNumber = <span class="number">0</span>;<span class="comment">//全局变量，用于对方acceptget后选择文件的最大数量</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; getResourceMap;</span><br><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;re&quot;</span>,<span class="number">16</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">unordered_map&lt;clientState, string&gt; promptMap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;clientState::noLogin,<span class="string">&quot;need login&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::cmdLine,<span class="string">&quot;cmd&gt; &quot;</span>&#125;,</span><br><span class="line">    &#123;clientState::isChatting,<span class="string">&quot;chatting with &quot;</span>&#125;,<span class="comment">//进入chat状态要根据对方的sname来拼接</span></span><br><span class="line">    &#123;clientState::isWaiting,<span class="string">&quot;waiting&gt; &quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉string首尾空格</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">trim</span><span class="params">(string&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \t&quot;</span>));<span class="comment">//首次出现不匹配空格的位置</span></span><br><span class="line">        s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \t&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，cmdstr首位空格都去掉了</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//首先看第一个字符是不是@，是的话去掉就好了</span></span><br><span class="line">    <span class="keyword">if</span> (cmdstr[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">        cmdstr = cmdstr.<span class="built_in">substr</span>(<span class="number">1</span>, cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">clientState state = clientState::noLogin;</span><br><span class="line">string prompt = promptMap[state];</span><br><span class="line">string chattarg = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="type">bool</span> chooseflag = <span class="literal">false</span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkCmd</span><span class="params">(<span class="type">int</span> cmdvalue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最开始只考虑是否登录</span></span><br><span class="line">    <span class="keyword">if</span> (cmdvalue == <span class="number">0</span> || cmdvalue == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state != clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Have signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; Not signed in yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果正在chatting，不允许再chat</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdvalue == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; You are chatting with &quot;</span> &lt;&lt; chatSname &lt;&lt; <span class="string">&quot;! You can break to chat with other.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果正在等待，只允许break</span></span><br><span class="line">    <span class="keyword">if</span> (state == clientState::isWaiting &amp;&amp; cmdvalue != <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;error&gt; Only break or @break can input because you are waiting for something!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isNumber</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf)</span><span class="comment">//判断字符传是否为数字</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; buf[i] != <span class="string">&#x27;\n&#x27;</span>; i++)<span class="comment">//以\n结尾</span></span><br><span class="line">        <span class="keyword">if</span> (buf[i] &lt; <span class="string">&#x27;0&#x27;</span> || buf[i]&gt;<span class="string">&#x27;9&#x27;</span>)<span class="comment">//每个字符都要是数字</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//一个汉字两字节，可能需要更大的buf</span></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">256</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> exitflag = <span class="literal">false</span>;<span class="comment">//函数退出信号</span></span><br><span class="line">    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (chooseflag)<span class="comment">//如果在选择文件。接收线程会把这个flag改成true，并且打印提示符enter file number&gt; </span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isNumber</span>(cmdbuf))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//要进行数字的范围判断，用stoi</span></span><br><span class="line">                <span class="type">int</span> num = <span class="built_in">stoi</span>(cmdbuf);</span><br><span class="line">                <span class="keyword">if</span> (num &gt; fileNumber || num &lt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;Please enter a number in the range！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                <span class="comment">//...还需要用一个线程来接收</span></span><br><span class="line"></span><br><span class="line">                chooseflag = <span class="literal">false</span>;</span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Please enter a number！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//剩下的内容都是else的</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//把接收缓冲清零</span></span><br><span class="line">            <span class="function">string <span class="title">cmdstr</span><span class="params">(cmdbuf)</span></span>;</span><br><span class="line">            <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查找命令</span></span><br><span class="line">            <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;The registration is successful and you can log in!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Registration failed, please try a different ID!&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的              </span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Login successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                        state = clientState::cmdLine;</span><br><span class="line">                        prompt = promptMap[state];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;faliure&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;sid does not exist!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line"></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    chattarg = cmdvec[<span class="number">1</span>];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Sleep(3000);//阻塞3秒，假装等待连接</span></span><br><span class="line"><span class="comment">                    state = clientState::isChatting;</span></span><br><span class="line"><span class="comment">                    //chatSname = ...</span></span><br><span class="line"><span class="comment">                    prompt = promptMap[state] + chatSname + &quot;&gt; &quot;;</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，break也需要发送，这样服务器才能知道用户从某请求的等待中退出了</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//...还需要用一个线程来接收，文件名通过请求表维护</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//需要接收响应，因为sid是全局唯一的，可能设置失败！</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//这里接收响应是为了增加用户体验，服务器返回一个成功信息</span></span><br><span class="line">                    <span class="comment">//因为设置相对频率较少，这不是什么很大的负担</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                        <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                        <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                        reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，或许需要告知服务器退出，先这样</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;The client now exits!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//是否退出</span></span><br><span class="line">            <span class="keyword">if</span> (exitflag)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">SOCKET <span class="title">connect_S</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span><span class="comment">//返回连接句柄</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建套接字</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;socket error !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(MYPORT);<span class="comment">//服务器端口，自己连接后的端口是os分配的，由进程选择一个端口去连服务器</span></span><br><span class="line">    <span class="comment">//socketaddr.sin_addr.s_addr = inet_addr(SERVER_IP);  ///服务器ip</span></span><br><span class="line">    <span class="comment">//inet_addr最好换成inet_aton()，不会冤枉0.0.0.0和255.255.255.255</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> inaddr;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, SERVER_IP, &amp;inaddr);<span class="comment">//windows下相当于inet_aton的函数，多了第一个参数表明是ipv4还是ipv6</span></span><br><span class="line">    socketaddr.sin_addr = inaddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///连接服务器，成功返回0，错误返回-1。返回的描述符connfd，该socket包含了服务器ip、port，自己ip、port，可用于发送和接收数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(connfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connect fail !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> SOCKET_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意该函数还没有</span></span><br><span class="line"><span class="comment">closesocket(connfd);和WSACleanup();</span></span><br><span class="line"><span class="comment">我们写一个关闭函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//调用多少次connect_S，就要调用多少次close_S</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_S</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，返回解析成不成功，失败则false</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">parseRecv</span><span class="params">(string cmdrecv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最后加一个空格，这样能解析成功</span></span><br><span class="line">    cmdrecv += <span class="string">&quot; &quot;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdrecv.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdrecv.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdrecv[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="built_in">size</span>() &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;chat&quot;</span> &amp;&amp; state == clientState::isWaiting)<span class="comment">//必须还在等待</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to chat!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::isChatting;</span><br><span class="line">            prompt = promptMap[state] + chattarg + <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer disagrees to chat!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;sendfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to receive file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">            <span class="comment">//开线程</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer disagrees to receive file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;getfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span> &amp;&amp; res[<span class="number">2</span>] == <span class="string">&quot;none&quot;</span>)<span class="comment">//如果没有资源但同意了，第三个参数就是none</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer has no resources!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            chooseflag = <span class="literal">true</span>;</span><br><span class="line">            prompt = <span class="string">&quot;enter the number of file&gt; &quot;</span>;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to getfile!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            getResourceMap.<span class="built_in">clear</span>();<span class="comment">//清空</span></span><br><span class="line">            fileNumber = <span class="number">0</span>;<span class="comment">//重置</span></span><br><span class="line">            string resolist;<span class="comment">//打印信息</span></span><br><span class="line">            <span class="comment">//假设对方发送的文件资源表是[1] some.txt [2] some2.txt，即空格分隔的成对的</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; res.<span class="built_in">size</span>(); i += <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                fileNumber++;</span><br><span class="line">                getResourceMap[fileNumber] = res[i + <span class="number">1</span>];</span><br><span class="line">                resolist += res[i] + <span class="string">&quot;\t&quot;</span> + res[i + <span class="number">1</span>] + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cout &lt;&lt; resolist &lt;&lt; flush;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer doesn&#x27;t allow you to get the resource!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;choosefile&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">stoi</span>(res[<span class="number">1</span>]);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer requested the [&quot;</span> + res[<span class="number">1</span>] + <span class="string">&quot;] file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="comment">//开一个线程发送</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvThread</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* SERVER_IP, <span class="type">int</span> MYPORT)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP, MYPORT);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------工作-----------------------------</span></span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)<span class="comment">//后面会设置exitflag</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//每次都将buffer清空，防止被上次写入的结果影响</span></span><br><span class="line">        <span class="type">size_t</span> recvbytes = <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">        <span class="comment">//异常结束时，退出</span></span><br><span class="line">        <span class="keyword">if</span> (recvbytes &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The receiving thread exits!&quot;</span> &lt;&lt; endl &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recvbytes &gt;= <span class="number">3</span> &amp;&amp; recvbuf[<span class="number">0</span>] == <span class="string">&#x27;@&#x27;</span> &amp;&amp; recvbuf[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>)<span class="comment">//这种情况下要解析命令</span></span><br><span class="line">        &#123;</span><br><span class="line">            string cmdrecv = recvbuf;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">parseRecv</span>(cmdrecv.<span class="built_in">substr</span>(<span class="number">2</span>, cmdrecv.<span class="built_in">size</span>() - <span class="number">2</span>)))</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;<span class="comment">//失败就不打印刷新</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//其他信息直接输出</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;192.168.248.131&quot;</span>;</span><br><span class="line"><span class="type">int</span> MYPORT = <span class="number">8000</span>;</span><br><span class="line"><span class="type">int</span> MYPORT2 = <span class="number">9000</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">thread</span>(<span class="built_in">bind</span>(recvThread, SERVER_IP, MYPORT)).<span class="built_in">detach</span>();</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(SERVER_IP, MYPORT2);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="built_in">run</span>(connfd);</span><br><span class="line">    <span class="comment">//退出</span></span><br><span class="line">    <span class="built_in">close_S</span>(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求表设计"><a href="#请求表设计" class="headerlink" title="请求表设计"></a>请求表设计</h2><p>前面提到，我们总要考虑用户“无故”输入“无效”命令的情况（往最坏的情况上考虑），当用户没有被请求时，用户可能输入accept和reject这类命令，此时是无效的。为了快速响应以及降低服务器的复杂度，我们将这类无效命令在本地判断，因此需要一个请求表维护到来的请求（chat、sendfile、getfile）。</p>
<ul>
<li>当接收线程接收到一个请求时，继续解析以获得sid。比如对方发送一个chat sid时，服务器的命令接收端会得到请求方的sid等信息，然后把命令发给该sid的接收线程，格式像这样：@#chatfrom [sid] [sname]。只需要把该sid获取然后添加到请求表内即可。对于getfile：@#getfilefrom [sid] [sname]；对于sendfile：@#sendfilefrom [sid] [sname] [filename]</li>
<li>当用户accept时，查表，只有存在才允许把该命令发送到服务器，然后服务器会发一个@#chat accept给对方，就完成了。reject同理。并且accept和reject后，都要把请求表内对应的表项删除。</li>
<li>当对方请求到来时，本地会更新请求表添加表项；然而对方用户可能在等待状态break，这时要通知本地对方取消请求并删除请求表项。但是在前面我们对用户的break命令仅仅只是发送了一个break命令，我们还需要做更多的处理。<ul>
<li>我们选择在服务器端处理，服务器是可以得知用户在什么状态的。在noLogin状态不允许break；cmdLine状态下，break是无效的。服务器真正要区分的是用户在waiting还是在chatting。因此，当用户在cmdLine调用break时，不做处理。</li>
<li>当用户发送chat、sendfile、getfile后，服务器在转发信息时标记用户进入waiting状态。注意我们的设计，在waiting时只能break或等待，因此用户在同一时间最多只允许有一个请求。一旦用户在waiting时发送一个break，服务器在接收后会把用户标记回cmdLine状态，并且服务器还需要知道这个break发回给谁，因此服务器在标记用户进入wating时还必须添加<strong>用户之间的映射</strong>，通过这个映射把@#break [sid]发过去，并随后把这个映射删除。一旦对方接收到这个回复，就从请求表中把该sid对应的表项删除。</li>
<li>如果accept了一个chatting请求，服务器会标记双方进入chatting状态。此时如果某一方break，服务器通过映射找到另一方，发一个@#break now，对方接收后从chatting状态退出即可。</li>
<li>我们再考虑两种情况：<ul>
<li>当用户在waiting状态下break，服务器标记用户回到cmdLine，而对方还没有接收到这个消息就accept了，由于用户已经回到cmdLine状态了，这个accept是失效的，因此服务器通过cmdLine状态得知这一事件，向accept一方发回一个@#break now，让其退回命令行状态（如果是chatting的话）并打印”the peers break before you accept”。如果是reject就不管</li>
<li>当用户在waiting状态下break，服务器还没标记用户回到cmdLine，对方就发了accept，此时由于服务器发现用户还在waiting，就把accept转过去了，但用户已经回到命令行了。在接收线程里，如果用户不在等待状态则accept是无效的，因此只用考虑向accept发送处理。服务器把accept转过去后，标记的用户的状态要么返回cmdLine（sendfile这些被accept就标记为cmdLine），要么进入chatting状态。然后服务器又收到break信息，前面说到在chatting状态收到break，服务器发一个@#break now。则如果accept方目前在chatting，也可以退出；否则用户应该在cmdLine状态，这样收到@#break now，给accept方打印一个信息”the peers break before you accept”。</li>
</ul>
</li>
</ul>
</li>
<li>因为用户最多一个请求，则**三个请求命令可以共用一个请求表，映射如下：[sid] [cmd]，如 123-&gt;”sendfile”**。</li>
</ul>
<p>至此，我们知道了请求表的设计和接收线程该如何修改。</p>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请求表封装</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//对于chat和getfile命令，只存储sid和命令关键字，对于sendfile，还需要存储文件的名称，</span></span><br><span class="line"><span class="comment">//如sendfilesome.txt，因为sendfile是8个字节，所以很容易解析文件名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReqTable</span><span class="comment">//主线程和接收线程都需要互斥操作</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	unordered_map&lt;string, string&gt; reqTable;</span><br><span class="line">	<span class="keyword">using</span> iterator = unordered_map&lt;string, string&gt;::iterator;</span><br><span class="line">	string filename;</span><br><span class="line">    mutex reqTableMux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ReqTable</span>()&#123;&#125;</span><br><span class="line">	~<span class="built_in">ReqTable</span>()&#123;&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">insertReq</span><span class="params">(string sid,string cmd)</span></span>;<span class="comment">//插入表项</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">deleteReq</span><span class="params">(string sid)</span></span>;<span class="comment">//删除表项</span></span><br><span class="line">	<span class="function">string <span class="title">checkReq</span><span class="params">(string sid)</span></span>;<span class="comment">//查找并删除，如果是sendfile，让用户调用getName函数获取</span></span><br><span class="line">	<span class="function">string <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> filename; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span><span class="comment">//打印表项，后续或许可以加一个打印请求表的命令，现在用作测试</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> ite = reqTable.<span class="built_in">begin</span>(); ite != reqTable.<span class="built_in">end</span>(); ite++)</span><br><span class="line">			cout &lt;&lt; ite-&gt;first &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; ite-&gt;second &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReqTable::insertReq</span><span class="params">(string sid, string cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(reqTableMux)</span></span>;</span><br><span class="line">	reqTable[sid] = cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReqTable::deleteReq</span><span class="params">(string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(reqTableMux)</span></span>;</span><br><span class="line">	iterator iter = reqTable.<span class="built_in">find</span>(sid);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == reqTable.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		reqTable.<span class="built_in">erase</span>(iter);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">ReqTable::checkReq</span><span class="params">(string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(reqTableMux)</span></span>;</span><br><span class="line">	iterator iter = reqTable.<span class="built_in">find</span>(sid);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == reqTable.<span class="built_in">end</span>())<span class="comment">//不存在则返回空，交由上层处理</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		string cmd = iter-&gt;second;</span><br><span class="line">		<span class="keyword">if</span> (cmd.<span class="built_in">size</span>() &gt;= <span class="number">8</span>)<span class="comment">//这种情况是sendfile，设置filename</span></span><br><span class="line">		&#123;</span><br><span class="line">			filename = cmd.<span class="built_in">substr</span>(<span class="number">8</span>);</span><br><span class="line">			cmd = <span class="string">&quot;sendfile&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//查找完不能删除，还不能删除，因为可能accept不对应，要保留</span></span><br><span class="line">		<span class="comment">//reqTable.erase(iter);</span></span><br><span class="line">		<span class="keyword">return</span> cmd;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//测试</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ReqTable reqTable;</span><br><span class="line">	reqTable.<span class="built_in">insertReq</span>(<span class="string">&quot;123&quot;</span>, <span class="string">&quot;chat&quot;</span>);</span><br><span class="line">	reqTable.<span class="built_in">insertReq</span>(<span class="string">&quot;456&quot;</span>, <span class="string">&quot;sendfilea.txt&quot;</span>);</span><br><span class="line">	reqTable.<span class="built_in">insertReq</span>(<span class="string">&quot;789&quot;</span>, <span class="string">&quot;getfile&quot;</span>);</span><br><span class="line">	reqTable.<span class="built_in">print</span>();</span><br><span class="line">	</span><br><span class="line">	cout &lt;&lt; reqTable.<span class="built_in">checkReq</span>(<span class="string">&quot;789&quot;</span>) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断后获取文件</span></span><br><span class="line">	<span class="keyword">if</span> (reqTable.<span class="built_in">checkReq</span>(<span class="string">&quot;456&quot;</span>) == <span class="string">&quot;sendfile&quot;</span>)</span><br><span class="line">		cout &lt;&lt; reqTable.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	reqTable.<span class="built_in">deleteReq</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">	cout &lt;&lt; reqTable.<span class="built_in">checkReq</span>(<span class="string">&quot;123&quot;</span>) &lt;&lt; endl;</span><br><span class="line">	reqTable.<span class="built_in">deleteReq</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再修改一下接收线程的解析命令函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">ReqTable reqTable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析命令，返回解析成不成功，失败则false</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">parseRecv</span><span class="params">(string cmdrecv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//最后加一个空格，这样能解析成功</span></span><br><span class="line">    cmdrecv += <span class="string">&quot; &quot;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdrecv.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdrecv.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdrecv[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="built_in">size</span>() &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;chat&quot;</span> &amp;&amp; state == clientState::isWaiting)<span class="comment">//必须还在等待</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to chat!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::isChatting;</span><br><span class="line">            prompt = promptMap[state] + chattarg + <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer disagrees to chat!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;sendfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to receive file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">            <span class="comment">//开线程发送</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer disagrees to receive file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;getfile&quot;</span> &amp;&amp; state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span> &amp;&amp; res[<span class="number">2</span>] == <span class="string">&quot;none&quot;</span>)<span class="comment">//如果没有资源但同意了，第三个参数就是none</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer has no resources!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;accept&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            chooseflag = <span class="literal">true</span>;</span><br><span class="line">            prompt = <span class="string">&quot;enter the number of file&gt; &quot;</span>;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer agrees to getfile!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            getResourceMap.<span class="built_in">clear</span>();<span class="comment">//清空</span></span><br><span class="line">            fileNumber = <span class="number">0</span>;<span class="comment">//重置</span></span><br><span class="line">            string resolist;<span class="comment">//打印信息</span></span><br><span class="line">            <span class="comment">//假设对方发送的文件资源表是[1] some.txt [2] some2.txt，即空格分隔的成对的</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; res.<span class="built_in">size</span>(); i += <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                fileNumber++;</span><br><span class="line">                getResourceMap[fileNumber] = res[i + <span class="number">1</span>];</span><br><span class="line">                resolist += res[i] + <span class="string">&quot;\t&quot;</span> + res[i + <span class="number">1</span>] + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cout &lt;&lt; resolist &lt;&lt; flush;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">1</span>] == <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer doesn&#x27;t allow you to get the resource!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            state = clientState::cmdLine;</span><br><span class="line">            prompt = promptMap[state];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; endl &lt;&lt; <span class="string">&quot;An error command was received in the receThread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;choosefile&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">stoi</span>(res[<span class="number">1</span>]);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peer requested the [&quot;</span> + res[<span class="number">1</span>] + <span class="string">&quot;] file!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="comment">//开一个线程发送</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//-----------------------------请求表相关命令----------------------------------------</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;chatfrom&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reqTable.<span class="built_in">insertReq</span>(res[<span class="number">1</span>], <span class="string">&quot;chat&quot;</span>);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;Receive a chat request from &quot;</span> &lt;&lt; res[<span class="number">2</span>] &lt;&lt;<span class="string">&quot; -sid:&quot;</span> &lt;&lt; res[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;sendfilefrom&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string req = <span class="string">&quot;sendfile&quot;</span>+res[<span class="number">3</span>];</span><br><span class="line">        reqTable.<span class="built_in">insertReq</span>(res[<span class="number">1</span>],req);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;Receive a sendfile request from &quot;</span> &lt;&lt; res[<span class="number">2</span>] &lt;&lt;<span class="string">&quot; -sid: &quot;</span> &lt;&lt; res[<span class="number">1</span>] &lt;&lt;<span class="string">&quot; -file name: &quot;</span> &lt;&lt; res[<span class="number">3</span>] &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;getfilefrom&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reqTable.<span class="built_in">insertReq</span>(res[<span class="number">1</span>], <span class="string">&quot;getfile&quot;</span>);</span><br><span class="line">        cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;Receive a getfile request from &quot;</span> &lt;&lt; res[<span class="number">2</span>] &lt;&lt;<span class="string">&quot; -sid:&quot;</span> &lt;&lt; res[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//----break-----</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res[<span class="number">0</span>] == <span class="string">&quot;break&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(res[<span class="number">1</span>] == <span class="string">&quot;now&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(state == clientState::isChatting)<span class="comment">//进入虚假chatting，让其退出</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peers break before you accept!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">            	prompt = promptMap[state];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span><span class="comment">//进入接收或发送</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;The peers break before you accept!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="comment">//要让接收或发送线程退出</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span><span class="comment">//这种情况是break [sid]，用户sid撤回请求</span></span><br><span class="line">            reqTable.<span class="built_in">deleteReq</span>(res[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在对accept那些命令进行更改，即修改run函数，这里把整个run都弄下来，分开弄到时候合在一起也麻烦，这里还改一下choosefile的发送</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//一个汉字两字节，可能需要更大的buf</span></span><br><span class="line">    <span class="type">char</span> cmdbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cmdtmp[<span class="number">256</span>] = <span class="string">&quot;no cmd&quot;</span>;</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">256</span>];</span><br><span class="line">    <span class="type">bool</span> reflag = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> exitflag = <span class="literal">false</span>;<span class="comment">//函数退出信号</span></span><br><span class="line">    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">    <span class="comment">//根据bool或运算顺序，如果用上一次的结果（reflag==true），就不接收字符</span></span><br><span class="line">    <span class="keyword">while</span> (reflag || <span class="built_in">fgets</span>(cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), stdin) != <span class="literal">NULL</span>)<span class="comment">//gets已不被编译器支持，不太安全</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (chooseflag)<span class="comment">//如果在选择文件。接收线程会把这个flag改成true，并且打印提示符enter file number&gt; </span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isNumber</span>(cmdbuf))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//要进行数字的范围判断，用stoi</span></span><br><span class="line">                <span class="type">int</span> num = <span class="built_in">stoi</span>(cmdbuf);</span><br><span class="line">                <span class="keyword">if</span> (num &gt; fileNumber || num &lt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;Please enter a number in the range！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                    cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                string choosecmd = <span class="string">&quot;choosefile &quot;</span> + <span class="built_in">string</span>(cmdbuf);<span class="comment">//拼接命令</span></span><br><span class="line">                <span class="built_in">send</span>(connfd, choosecmd.<span class="built_in">c_str</span>(), choosecmd.<span class="built_in">size</span>(), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                <span class="comment">//...还需要用一个线程来接收</span></span><br><span class="line"></span><br><span class="line">                chooseflag = <span class="literal">false</span>;</span><br><span class="line">                state = clientState::cmdLine;</span><br><span class="line">                prompt = promptMap[state];</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Please enter a number！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">sizeof</span>(cmdbuf), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//剩下的内容都是else的</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));<span class="comment">//把接收缓冲清零</span></span><br><span class="line">            <span class="function">string <span class="title">cmdstr</span><span class="params">(cmdbuf)</span></span>;</span><br><span class="line">            <span class="built_in">trim</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdstr == <span class="string">&quot;\n&quot;</span>)<span class="comment">//不管怎么样都有个换行，仅有一个换行就不管</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(cmdstr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查找命令</span></span><br><span class="line">            <span class="keyword">auto</span> iter = cmdmap.<span class="built_in">find</span>(cmdvec[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (iter == cmdmap.<span class="built_in">end</span>())<span class="comment">//命令错误</span></span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;Wrong command, your command parsed is: &quot;</span> &lt;&lt; cmdvec[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> cmdvalue = iter-&gt;second;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">checkCmd</span>(cmdvalue))<span class="comment">//如果命令与状态不匹配</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//因为可能是调用了re（连续两次login）会导致错误，这里错误要让用户重新输入，否则会崩溃（cmdbuf是空）</span></span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (cmdvalue)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">4</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [register] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmdvec[<span class="number">2</span>] != cmdvec[<span class="number">3</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The passwords entered twice are not equal!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;The registration is successful and you can log in!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Registration failed, please try a different ID!&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [login] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的              </span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;Login successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                        state = clientState::cmdLine;</span><br><span class="line">                        prompt = promptMap[state];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [search] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;faliure&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;sid does not exist!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [chat] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line"></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    chattarg = cmdvec[<span class="number">1</span>];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input break or @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Sleep(3000);//阻塞3秒，假装等待连接</span></span><br><span class="line"><span class="comment">                    state = clientState::isChatting;</span></span><br><span class="line"><span class="comment">                    //chatSname = ...</span></span><br><span class="line"><span class="comment">                    prompt = promptMap[state] + chatSname + &quot;&gt; &quot;;</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [accept] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//发送cmdstr就不用做头尾空格去除</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;chat&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a chat request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [reject] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;chat&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a chat request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [break] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，break也需要发送，这样服务器才能知道用户从某请求的等待中退出了</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::cmdLine;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [send] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [sendfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;sendfile&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                        string filename = reqTable.<span class="built_in">getName</span>();</span><br><span class="line">                        <span class="comment">//...还需要用一个线程来接收，文件名通过请求表维护</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a sendfile request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;sendfile&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a sendfile request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [getfile] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//send...waiting</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    state = clientState::isWaiting;</span><br><span class="line">                    prompt = promptMap[state];</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;waiting&gt; Waiting for a response, you can input @break to back to command line...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [acceptget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="comment">//响应在接收线程处理！</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;getfile&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//还要发资源列表</span></span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a getfile request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [rejectget] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span>(reqTable.<span class="built_in">checkReq</span>(cmdvec[<span class="number">1</span>]) == <span class="string">&quot;getfile&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                        reqTable.<span class="built_in">deleteReq</span>(cmdvec[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; &quot;</span>&lt;&lt;cmdvec[<span class="number">1</span>]&lt;&lt;<span class="string">&quot; did not send a getfile request!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsid] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//需要接收响应，因为sid是全局唯一的，可能设置失败！</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [setsname] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="comment">//这里接收响应是为了增加用户体验，服务器返回一个成功信息</span></span><br><span class="line">                    <span class="comment">//因为设置相对频率较少，这不是什么很大的负担</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [re] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    reflag = <span class="literal">false</span>;<span class="comment">//虽然是re，但是命令有问题</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//即使是错误命令也存，用户可能头铁...就想再试一次</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmdtmp, <span class="string">&quot;no cmd&quot;</span>))<span class="comment">//如果还没有命令</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;error&gt; No command yet!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; <span class="string">&quot;reEX&gt; &quot;</span> &lt;&lt; cmdtmp;<span class="comment">//不用换行，cmdtmp自然有个&#x27;\n&#x27;</span></span><br><span class="line">                        <span class="comment">//strcpy已不可用，不指定长度不安全。使用strlen要+1，因为长度不包含结束符，要补上去</span></span><br><span class="line">                        <span class="built_in">strcpy_s</span>(cmdbuf, <span class="built_in">strlen</span>(cmdtmp) + <span class="number">1</span>, cmdtmp);</span><br><span class="line">                        reflag = <span class="literal">true</span>;<span class="comment">//表明不必把cmdbuf置零</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [exit] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理，或许需要告知服务器退出，先这样</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;The client now exits!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [hisir] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [oyasumi] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//做处理</span></span><br><span class="line">                    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">                    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的</span></span><br><span class="line">                    cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">                    exitflag = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//是否退出</span></span><br><span class="line">            <span class="keyword">if</span> (exitflag)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdvalue == <span class="number">16</span> &amp;&amp; reflag)<span class="comment">//如果是re且成功的话就不用cmd，不用cmdbuf置零</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmdvalue == <span class="number">16</span>)<span class="comment">//虽然是re但失败了，不能保存re</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">strcpy_s</span>(cmdtmp, <span class="built_in">strlen</span>(cmdbuf) + <span class="number">1</span>, cmdbuf);<span class="comment">//暂存上一次命令，方便re调用，如果上一次是re的话，不更新</span></span><br><span class="line">                <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">                cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">                reflag = <span class="literal">false</span>;<span class="comment">//上一次不是re自然置false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这就改完了，先不测试了，稍后就封装起来，代码量上来了有点难受。但还是等基本完成后再一并把封装好的代码放上来。</p>
<h2 id="资源列表生成"><a href="#资源列表生成" class="headerlink" title="资源列表生成"></a>资源列表生成</h2><p>前面提到的资源列表字符串的格式，这里最后有没有空格都没关系：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//假设对方发送的文件资源表是[1] some.txt [2] some2.txt，即空格分隔的成对的</span></span><br></pre></td></tr></table></figure>

<p>我们允许用户指定目录，也允许使用默认的目录，具体的：</p>
<ul>
<li>在本地目录有个配置文件config.txt，里面允许配置resource_path[空格]路径（这是新增内容）</li>
<li>如果没有找到这个文件，就使用默认路径.&#x2F;resource；如果找到了就更换为该路径</li>
<li>然后找到该文件夹，如果没有则资源列表为空；否则遍历文件，生成资源列表，既生成map也生成能直接发送的字符串。</li>
</ul>
<p>首先有个读配置的函数，以及判断是否存在文件夹的函数；然后用windows.h的api去遍历文件名。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">FindFirstFile</span><span class="params">(LPCTSTR lpFileName,LPWIN32_FIND_DATA lpFindFileData)</span></span>;</span><br><span class="line"><span class="comment">//LPWIN32_FIND_DATA描述文件属性，如只读只写，这里获取名字</span></span><br><span class="line"><span class="comment">//lpFileName为/结尾的路径加通配符，比如这里遍历所有文件，就在路径后面添加了*，代表任意文件</span></span><br><span class="line"><span class="comment">//如果调用成功返回一个句柄，可用来做为FindNextFile或FindClose参数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FindNextFileA</span><span class="params">(HANDLE hFindFile,LPWIN32_FIND_DATAA lpFindFileData)</span></span>;</span><br><span class="line"><span class="comment">//继续对 FindFirstFile、FindFirstFileEx 或 FindFirstFileTransacted 函数的上一次调用中的文件搜索。</span></span><br><span class="line"></span><br><span class="line">FindFirstFileA的返回值为HANDLE,即句柄，可与宏INVALID_HANDLE_VALUE进行比较，相等则说明失败，这个宏实际上就是<span class="number">-1</span></span><br><span class="line">这里因为已经判断了文件夹是否存在，不用比较</span><br><span class="line">FindNextFileA的返回值为<span class="literal">true</span>则匹配成功，为<span class="literal">false</span>则匹配失败,直接退出循环</span><br></pre></td></tr></table></figure>

<p>函数和测试代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span><span class="comment">//getline</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span><span class="comment">//文件流</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span><span class="comment">//哈希map</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//假设有很多配置，这里生成一个配置映射</span></span><br><span class="line">unordered_map&lt;string, string&gt; config_map;<span class="comment">//映射表</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; myresource_map;</span><br><span class="line">string myresource_str;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setConfig</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* configfile = <span class="string">&quot;./config.txt&quot;</span>;</span><br><span class="line">    <span class="function">ifstream <span class="title">cfgFile</span><span class="params">(configfile, ios::in)</span></span>;</span><br><span class="line"></span><br><span class="line">    string line;</span><br><span class="line">    <span class="keyword">if</span> (cfgFile.<span class="built_in">is_open</span>())<span class="comment">//如果可以打开，则获取参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(cfgFile, line)) <span class="comment">//逐行读取，直到结束</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> pos = line.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);<span class="comment">//找到空格位置</span></span><br><span class="line">            string key = line.<span class="built_in">substr</span>(<span class="number">0</span>, pos);<span class="comment">//获取子串</span></span><br><span class="line">            string value = line.<span class="built_in">substr</span>(pos + <span class="number">1</span>, line.<span class="built_in">size</span>() - pos - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (value.<span class="built_in">size</span>() != <span class="number">0</span>)<span class="comment">//如果确实配置了</span></span><br><span class="line">            &#123;</span><br><span class="line">                config_map[key] = value;<span class="comment">//添加映射表项</span></span><br><span class="line">                <span class="comment">//输出配置</span></span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;configuration of [&quot;</span> &lt;&lt; key &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; <span class="string">&quot; is &quot;</span> &lt;&lt; value &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config_map.<span class="built_in">find</span>(<span class="string">&quot;resource_path&quot;</span>) == config_map.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            config_map[<span class="string">&quot;resource_path&quot;</span>] = <span class="string">&quot;./resource&quot;</span>;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;default configuration of [resource_path]&quot;</span> &lt;&lt; <span class="string">&quot; is &quot;</span> &lt;&lt; <span class="string">&quot;./resource&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        cfgFile.<span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没打开就默认</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        config_map[<span class="string">&quot;resource_path&quot;</span>] = <span class="string">&quot;./resource&quot;</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;default configuration of [resource_path]&quot;</span> &lt;&lt; <span class="string">&quot; is &quot;</span> &lt;&lt; <span class="string">&quot;./resource&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断文件夹是否存在</span></span><br><span class="line"><span class="comment">//DWORD d = GetFileAttributesA(const char* filename); #include &lt;windows.h&gt; 为windows系统函数，判断文件目录是否存在</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">dirExists</span><span class="params">(<span class="type">const</span> std::string&amp; dirpath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD ftyp = <span class="built_in">GetFileAttributesA</span>(dirpath.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (ftyp == INVALID_FILE_ATTRIBUTES)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">//something is wrong with your path!  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ftyp &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;   <span class="comment">// this is a directory!  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;    <span class="comment">// this is not a directory!  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入config_map[&quot;resource_path&quot;]，完整文件路径为config_map[&quot;resource_path&quot;]+&#x27;/&#x27;+myresoure_map[i]</span></span><br><span class="line"><span class="comment">//设置发送字符串myresource_str 以及映射表myresoure_map</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">genResource</span><span class="params">(string dirpath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">dirExists</span>(dirpath))</span><br><span class="line">    &#123;</span><br><span class="line">        myresource_str = <span class="string">&quot;&quot;</span>;<span class="comment">//没有文件夹</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    WIN32_FIND_DATAA fileInfo;</span><br><span class="line">    dirpath = dirpath + <span class="string">&quot;/*&quot;</span>;<span class="comment">//通配符匹配所有的文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通常，最初的两次搜索得到的文件名为：&quot;.&quot; 、&quot;..&quot;，分别代表当前目录和上级目录，这里过滤掉&quot;.&quot;然后进while过滤&quot;..&quot;</span></span><br><span class="line">    HANDLE hFile = <span class="built_in">FindFirstFileA</span>(dirpath.<span class="built_in">c_str</span>(), &amp;fileInfo);<span class="comment">//现在定位到&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        myresource_str = <span class="string">&quot;&quot;</span>;<span class="comment">//出错</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">FindNextFileA</span>(hFile, &amp;fileInfo);<span class="comment">//现在定位到&quot;..&quot;</span></span><br><span class="line">    <span class="type">int</span> index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">FindNextFileA</span>(hFile, &amp;fileInfo))<span class="comment">//再把&quot;..&quot;过滤掉</span></span><br><span class="line">    &#123;</span><br><span class="line">        myresource_str += <span class="string">&quot;[&quot;</span> + <span class="built_in">to_string</span>(index) + <span class="string">&quot;] &quot;</span> + fileInfo.cFileName + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        myresource_map[index++] = fileInfo.cFileName;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">FindClose</span>(hFile);<span class="comment">//关闭</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setConfig</span>();</span><br><span class="line">    <span class="built_in">genResource</span>(config_map[<span class="string">&quot;resource_path&quot;</span>]);</span><br><span class="line">    cout &lt;&lt; myresource_str &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h2><p>我们有时候还需要文件的发送和接收，这在另一个线程进行，下面再梳理一下这些场景：</p>
<ul>
<li>当sendfile后收到一个accept时，准备发送</li>
<li>当使用一个acceptfile时，如果成功则准备接收</li>
<li>当acceptget后收到一个choosefile返回命令时，准备发送</li>
<li>当chooseflag为true时，输入选择的数字或准备接收</li>
</ul>
<p>我们还没有定义线程的端口（ip服务器是知道的），这需要在命令里发送，我们先明确一下主被动关系：</p>
<ul>
<li>使用sendfile时，对方可能会拒绝；因此让对方acceptfile时把默认端口发来，对方进入listen，本地去connect发送</li>
<li>使用getfile时，对方可能会拒绝；当对方acceptget时本地进入choose状态（目前还没设置能退出的命令，当如果对方资源列表为空是不会发过来的），choose后对方收到就会发文件过来，所以choose时把默认端口发去，本地进入listen，对方去connect。</li>
</ul>
<p>因此需要两个端口号，一个用于acceptfile时开启监听接收，一个用于choose后开启监听接收。</p>
<p>因为对应关系明确，所以如果<strong>固定了端口就不需要在命令里再发送了</strong>，因为对方也知道；当然也允许用户自己选择端口号（通过配置），这里先不实现，给定：</p>
<ul>
<li>sendfile的端口是14242</li>
<li>getfile的端口是14243</li>
</ul>
<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送函数，从调用者获得ip和端口和文件名</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//FILE等操作</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> buffSize  102400</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* filelog = <span class="string">&quot;fileLog.txt&quot;</span>;<span class="comment">//记录收发文件信息</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sendfile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port, std::string filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(server_ip, port);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[buffSize];</span><br><span class="line">    <span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(sendbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------打开文件------------------------------------------------------</span></span><br><span class="line">    FILE* fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filename.<span class="built_in">c_str</span>(), <span class="string">&quot;rb&quot;</span>) != <span class="number">0</span>)<span class="comment">//要以二进制形式读写，这样兼容文件格式</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::chrono::system_clock::time_point time1 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">size_t</span> nSend = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> totalSend = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> nRead = <span class="built_in">fread</span>(sendbuf, <span class="number">1</span>, buffSize, fp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ferror</span>(fp) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to read file &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nSend = <span class="built_in">send</span>(connfd, sendbuf, <span class="built_in">int</span>(nRead), <span class="number">0</span>);<span class="comment">//发送nRead个字节</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nSend == SOCKET_ERROR)<span class="comment">//网络断开或copy出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;the connection to server has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        totalSend += nSend;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">feof</span>(fp))<span class="comment">//读了，发完，再判断是否到达末尾</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    std::chrono::system_clock::time_point time2 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">int</span> MB = <span class="built_in">int</span>(totalSend / (<span class="number">1024</span> * <span class="number">1024</span>));</span><br><span class="line">    <span class="type">int</span> ms = <span class="built_in">int</span>(std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(time2 - time1).<span class="built_in">count</span>());</span><br><span class="line">    std::string result = <span class="string">&quot;send [&quot;</span> + filename + <span class="string">&quot;] [&quot;</span> + std::<span class="built_in">to_string</span>(totalSend) + <span class="string">&quot;] bytes (&quot;</span> + std::<span class="built_in">to_string</span>(MB) + <span class="string">&quot; MB) cost [&quot;</span> + std::<span class="built_in">to_string</span>(ms) + <span class="string">&quot;] ms\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filelog, <span class="string">&quot;a&quot;</span>) != <span class="number">0</span>)<span class="comment">//写result</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fwrite</span>(result.<span class="built_in">c_str</span>(), <span class="number">1</span>, result.<span class="built_in">size</span>(), fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvfile</span><span class="params">(<span class="type">const</span> <span class="type">int</span> port, std::string filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    SOCKET listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;bind error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//cerr不经过缓冲而直接输出，一般用于迅速输出出错信息，是标准错误，默认情况下被关联到标准输出流，但它不被缓冲.</span></span><br><span class="line">        <span class="comment">//也就说错误消息可以直接发送到显示器，而无需等到缓冲区或者新的换行符时，才被显示。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始监听</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;listen error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line">    <span class="type">char</span> recvbuf[buffSize];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line"></span><br><span class="line">    SOCKET conn = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);<span class="comment">//阻塞，等待连接，成功则创建连接套接字conn描述这个用户</span></span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connect&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果队列中没有等待的连接，套接字也没有被标记为Non-blocking，accept()会阻塞调用函数直到连接出现；</span></span><br><span class="line"><span class="comment">    如果套接字被标记为Non-blocking，队列中也没有等待的连接，accept()返回错误EAGAIN或EWOULDBLOCK。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------打开文件------------------------------------------------------</span></span><br><span class="line">    FILE* fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filename.<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>) != <span class="number">0</span>)<span class="comment">//要以二进制形式读写，这样兼容文件格式</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::chrono::system_clock::time_point time1 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> totalRecv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nRecv = <span class="built_in">recv</span>(conn, recvbuf, buffSize, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nRecv == SOCKET_ERROR)<span class="comment">//copy出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;connection to client has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nRecv == <span class="number">0</span>)<span class="comment">//这种情况是对端close了，此时返回0。可能是意外close，也可能是发送完毕了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        totalRecv += nRecv;</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> nWrite = <span class="built_in">fwrite</span>(recvbuf, <span class="number">1</span>, nRecv, fp);<span class="comment">//写文件</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nWrite != nRecv || <span class="built_in">ferror</span>(fp) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to write file&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    std::chrono::system_clock::time_point time2 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">int</span> MB = totalRecv / (<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> ms = <span class="built_in">int</span>(std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(time2 - time1).<span class="built_in">count</span>());</span><br><span class="line">    std::string result = <span class="string">&quot;recv [&quot;</span> + filename + <span class="string">&quot;] [&quot;</span> + std::<span class="built_in">to_string</span>(totalRecv) + <span class="string">&quot;] bytes (&quot;</span> + std::<span class="built_in">to_string</span>(MB) + <span class="string">&quot; MB) cost [&quot;</span> + std::<span class="built_in">to_string</span>(ms) + <span class="string">&quot;] ms\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filelog, <span class="string">&quot;a&quot;</span>) != <span class="number">0</span>)<span class="comment">//写result</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fwrite</span>(result.<span class="built_in">c_str</span>(), <span class="number">1</span>, result.<span class="built_in">size</span>(), fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(conn);</span><br><span class="line">    <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>现在要思考一下线程如何维护，这里主要是设计前面提到的@#break now命令，即本地用户break后没来得及通知对方，对方就accept了。因为我们设计的是让accept方发送，所以实际上接收后break now命令后只需要把acceptfile后产生的listen线程关掉就好了。</p>
<p>因为只设计监听一个端口，因此sendfile和getfile各自在同一时间只能接收一个文件（用线程池不方便管理，并且消耗的资源太多了；如果accept一个连接新开一个线程，对于文件名是不方便传参的，除非用线程池取任务，这些任务绑定好了参数，目前先不支持吧）。</p>
<p>然后这些线程不能用join，否则会在线程切换时阻塞（比如上一个文件下载完下载另一个要join，但其实不知道下载完没，就可能会阻塞），但不用join又无法释放线程资源；所以用deatch，这就需要给主线程提供是否在运行的信息，设置全局变量<code>isRecvingGf和isRecvingSf</code>即可。因为同一时间只有一个线程改写该全局变量，所以不用互斥。</p>
<p>然后，我们还要考虑虚假acceptfile的情况，这时本地会开一个listen，如果不关掉下一个文件接收就无法bind端口，因此收到break now后，就用本地的一个连接去访问，让其accept，然后判断是本地的“127.0.0.1”就直接退出（实测可以）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sendfile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port, std::string filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器</span></span><br><span class="line">    SOCKET connfd = <span class="built_in">connect_S</span>(server_ip, port);<span class="comment">//获取套接字</span></span><br><span class="line">    <span class="keyword">if</span> (connfd == INVALID_SOCKET || connfd == SOCKET_ERROR)</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//连接失败退出，错误由connect_S函数输出</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[buffSize];</span><br><span class="line">    <span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(sendbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------打开文件------------------------------------------------------</span></span><br><span class="line">    FILE* fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filename.<span class="built_in">c_str</span>(), <span class="string">&quot;rb&quot;</span>) != <span class="number">0</span>)<span class="comment">//要以二进制形式读写，这样兼容文件格式</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::chrono::system_clock::time_point time1 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">size_t</span> nSend = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> totalSend = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> nRead = <span class="built_in">fread</span>(sendbuf, <span class="number">1</span>, buffSize, fp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ferror</span>(fp) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to read file &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nSend = <span class="built_in">send</span>(connfd, sendbuf, <span class="built_in">int</span>(nRead), <span class="number">0</span>);<span class="comment">//发送nRead个字节</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nSend == SOCKET_ERROR)<span class="comment">//网络断开或copy出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;the connection to server has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        totalSend += nSend;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">feof</span>(fp))<span class="comment">//读了，发完，再判断是否到达末尾</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    std::chrono::system_clock::time_point time2 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">int</span> MB = <span class="built_in">int</span>(totalSend / (<span class="number">1024</span> * <span class="number">1024</span>));</span><br><span class="line">    <span class="type">int</span> ms = <span class="built_in">int</span>(std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(time2 - time1).<span class="built_in">count</span>());</span><br><span class="line">    std::string result = <span class="string">&quot;send [&quot;</span> + filename + <span class="string">&quot;] [&quot;</span> + std::<span class="built_in">to_string</span>(totalSend) + <span class="string">&quot;] bytes (&quot;</span> + std::<span class="built_in">to_string</span>(MB) + <span class="string">&quot; MB) cost [&quot;</span> + std::<span class="built_in">to_string</span>(ms) + <span class="string">&quot;] ms\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filelog, <span class="string">&quot;a&quot;</span>) != <span class="number">0</span>)<span class="comment">//写result</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fwrite</span>(result.<span class="built_in">c_str</span>(), <span class="number">1</span>, result.<span class="built_in">size</span>(), fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(connfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recvfile</span><span class="params">(<span class="type">const</span> <span class="type">int</span> port, std::string filename ,<span class="type">int</span> flag)</span><span class="comment">//这个filename是完整路径</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">        isRecvingGf = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        isRecvingSf = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    SOCKET listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;bind error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//cerr不经过缓冲而直接输出，一般用于迅速输出出错信息，是标准错误，默认情况下被关联到标准输出流，但它不被缓冲.</span></span><br><span class="line">        <span class="comment">//也就说错误消息可以直接发送到显示器，而无需等到缓冲区或者新的换行符时，才被显示。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始监听</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;listen error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line">    <span class="type">char</span> recvbuf[buffSize];</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line"></span><br><span class="line">    SOCKET conn = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);<span class="comment">//阻塞，等待连接，成功则创建连接套接字conn描述这个用户</span></span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connect error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果队列中没有等待的连接，套接字也没有被标记为Non-blocking，accept()会阻塞调用函数直到连接出现；</span></span><br><span class="line"><span class="comment">    如果套接字被标记为Non-blocking，队列中也没有等待的连接，accept()返回错误EAGAIN或EWOULDBLOCK。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">    <span class="built_in">inet_ntop</span>(AF_INET, &amp;client_addr.sin_addr, ip, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ip, <span class="string">&quot;127.0.0.1&quot;</span>) == <span class="number">0</span>)<span class="comment">//用于跳出假连接</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------打开文件------------------------------------------------------</span></span><br><span class="line">    FILE* fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filename.<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>) != <span class="number">0</span>)<span class="comment">//要以二进制形式读写，这样兼容文件格式</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::chrono::system_clock::time_point time1 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> totalRecv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nRecv = <span class="built_in">recv</span>(conn, recvbuf, buffSize, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (nRecv == SOCKET_ERROR)<span class="comment">//copy出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;connection to client has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">                isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nRecv == <span class="number">0</span>)<span class="comment">//这种情况是对端close了，此时返回0。可能是意外close，也可能是发送完毕了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        totalRecv += nRecv;</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> nWrite = <span class="built_in">fwrite</span>(recvbuf, <span class="number">1</span>, nRecv, fp);<span class="comment">//写文件</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nWrite != nRecv || <span class="built_in">ferror</span>(fp) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;failed to write file&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">                isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    std::chrono::system_clock::time_point time2 = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">int</span> MB = totalRecv / (<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="type">int</span> ms = <span class="built_in">int</span>(std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(time2 - time1).<span class="built_in">count</span>());</span><br><span class="line">    std::string result = <span class="string">&quot;recv [&quot;</span> + filename + <span class="string">&quot;] [&quot;</span> + std::<span class="built_in">to_string</span>(totalRecv) + <span class="string">&quot;] bytes (&quot;</span> + std::<span class="built_in">to_string</span>(MB) + <span class="string">&quot; MB) cost [&quot;</span> + std::<span class="built_in">to_string</span>(ms) + <span class="string">&quot;] ms\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fopen_s</span>(&amp;fp, filelog, <span class="string">&quot;a&quot;</span>) != <span class="number">0</span>)<span class="comment">//写result</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;cannot open file &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">            isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fwrite</span>(result.<span class="built_in">c_str</span>(), <span class="number">1</span>, result.<span class="built_in">size</span>(), fp);</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(conn);</span><br><span class="line">    <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag)<span class="comment">//1是getfile</span></span><br><span class="line">        isRecvingGf = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        isRecvingSf = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>现在消息都能发给服务器了，但是服务器不知道是聊天信息还是命令信息…所以，我们给聊天信息加一个关键字符，一方面我们改的代码少，一方面由于命令没有这个关键字符，所以只要有就能判定为聊天信息，不会冲突。这个关键字符是~，加在内容前面。</p>
<p>本来是这样的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            <span class="built_in">send</span>(connfd, cmdbuf, <span class="built_in">strlen</span>(cmdbuf), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>现在是这样的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (state == clientState::isChatting &amp;&amp; cmdbuf[<span class="number">0</span>] != <span class="string">&#x27;@&#x27;</span>)<span class="comment">//如果在chatting，并且输入第一个不是@，判定为聊天内容直接发送</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//send...</span></span><br><span class="line">            string charstr = <span class="string">&quot;~&quot;</span> + <span class="built_in">string</span>(cmdbuf);</span><br><span class="line">            <span class="built_in">send</span>(connfd, charstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(charstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">            <span class="built_in">memset</span>(cmdbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(cmdbuf));</span><br><span class="line">            cout &lt;&lt; prompt &lt;&lt; flush;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>加两个小功能</p>
<ul>
<li>自动登录，在配置文件里写是user_id和user_password</li>
<li>加一个打印自己的资源列表的命令（意识到这是蛮必要的）。myresource-&gt;19。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Client::autoLogin</span><span class="params">(SOCKET connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config_map.<span class="built_in">find</span>(<span class="string">&quot;user_id&quot;</span>) == config_map.<span class="built_in">end</span>() || config_map.<span class="built_in">find</span>(<span class="string">&quot;user_password&quot;</span>) == config_map.<span class="built_in">end</span>())</span><br><span class="line">        <span class="keyword">return</span>;<span class="comment">//如果有一个没填就不管</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Login  automatically......&quot;</span> &lt;&lt; endl;</span><br><span class="line">    string cmdstr = <span class="string">&quot;login &quot;</span> + config_map[<span class="string">&quot;user_id&quot;</span>] + <span class="string">&quot; &quot;</span> + config_map[<span class="string">&quot;user_password&quot;</span>] + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">send</span>(connfd, cmdstr.<span class="built_in">c_str</span>(), <span class="built_in">int</span>(cmdstr.<span class="built_in">size</span>()), <span class="number">0</span>);<span class="comment">//发送</span></span><br><span class="line">    <span class="built_in">recv</span>(connfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);<span class="comment">//同步接收，是阻塞的              </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recvbuf, <span class="string">&quot;success&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Login successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        state = clientState::cmdLine;</span><br><span class="line">        prompt = promptMap[state];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; recvbuf &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//run里面添加命令</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">19</span>:</span><br><span class="line">	<span class="keyword">if</span> (cmdvec.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;error&gt; The number of parameters for [myresource] is wrong!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        	<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//只要打印就好了</span></span><br><span class="line">        string myresolist;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> index = <span class="number">1</span>; index &lt; myresource_map.<span class="built_in">size</span>(); index += <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            myresolist += <span class="string">&quot;[&quot;</span> + <span class="built_in">to_string</span>(index) + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;\t&quot;</span> + myresource_map[index] + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; myresolist &lt;&lt; flush;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>现在，客户端差不多可以收尾了。</p>
<p>服务器的设计在下一章博客，封装好的代码也会放出来。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/11/26/RDT_base_on_UDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/26/RDT_base_on_UDP/" class="post-title-link" itemprop="url">RDT base on UDP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-26 19:45:26 / 修改时间：19:57:41" itemprop="dateCreated datePublished" datetime="2022-11-26T19:45:26+08:00">2022-11-26</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h1><p>项目代码和测试代码和结果在GitHub上：<a target="_blank" rel="noopener" href="https://github.com/Chen-Jin-yuan/RDT-base-on-UDP">Chen-Jin-yuan&#x2F;RDT-base-on-UDP (github.com)</a></p>
<p>实现的功能如下：</p>
<ul>
<li>重新设计的报文头部；</li>
<li>两次握手（only 1 RTT）；</li>
<li>基于ID标识（参考Quic协议）；</li>
<li>乱序确认，number递增（参考Quic协议）；</li>
<li>超时重传，基于number采样rtt（参考Quic协议）；</li>
<li>使用offset标识流而非number（参考Quic协议）；</li>
<li>基于maxoffset进行流量控制（参考Quic协议）；</li>
<li>基于心跳检测确认双方存活与退出。</li>
</ul>
<p>Quic：<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc9000">RFC 9000 - QUIC: A UDP-Based Multiplexed and Secure Transport (ietf.org)</a></p>
<p>在不同内网的P2P通信可以达到2MB&#x2F;s的速度，如果<code>UDPSEGSIZE</code>设置得大即一次发送的报文很大，可以达到10MB&#x2F;s，但在高丢包率情况下会有意外情况。如果在相同内网中可以设置大一些。</p>
<p>因为平时比较忙，项目设计时分了好几段时间来做，所以有些地方思路会断开，代码也会有不足的地方，欢迎评论。</p>
<h1 id="报文"><a href="#报文" class="headerlink" title="报文"></a>报文</h1><h2 id="报文生成（编辑器）"><a href="#报文生成（编辑器）" class="headerlink" title="报文生成（编辑器）"></a>报文生成（编辑器）</h2><p>读入的文件数据buffer添加头部信息，形成新的buffer。</p>
<h3 id="报文结构"><a href="#报文结构" class="headerlink" title="报文结构"></a>报文结构</h3><p>最好32bits对齐</p>
<ul>
<li>编号，递增</li>
<li>报文内容长度，字节数，一个报文大小最好不要超过MTU（1500Bytes）</li>
<li>使用offset标识数据流<ul>
<li>这个offset是字节尾部还是头部合适呢？这涉及到两种排序的方案<ul>
<li>使用头部的话，因为头部+len就是偏移的尾部，也即下一个偏移的初始。这样我们在写入文件时要找连续的offset，头部+len就能得到下一个包的头部offset，这样可以用哈希表来找（哈希offest-&gt;报文结构）</li>
<li>如果只有尾部的话实际上只能排序，然后判断下一个是不是连起来的（offset-len是否等于当前的offset），这样就用链表，每次放入（直接放入buffer）都是排序插入链表。</li>
</ul>
</li>
</ul>
</li>
<li>ID：这个ID是目标的ID</li>
<li>tag：包含ack、syn、fin、rst四位。bitset：<a target="_blank" rel="noopener" href="http://c.biancheng.net/view/406.html">C++ bitset类详解 (biancheng.net)</a></li>
<li>接收方窗口大小</li>
<li>暂存…</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyUdpSeg</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> num_type = <span class="type">unsigned</span> <span class="type">int</span>; <span class="comment">//32bits</span></span><br><span class="line">    <span class="keyword">using</span> off_type = <span class="type">size_t</span>; <span class="comment">//64bits or 32bits</span></span><br><span class="line">    <span class="keyword">using</span> win_type = <span class="type">size_t</span>; <span class="comment">//64bits or 32bits</span></span><br><span class="line">    <span class="keyword">using</span> len_type = <span class="type">unsigned</span> <span class="type">short</span>; <span class="comment">//16bits</span></span><br><span class="line">    <span class="keyword">using</span> id_type = <span class="type">unsigned</span> <span class="type">short</span>; <span class="comment">//16bits</span></span><br><span class="line">    <span class="keyword">using</span> tag_type = bitset&lt;<span class="number">8</span>&gt;; <span class="comment">//8bits，?|?|?|?|ack|syn|fin|rst</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> maxHeadSize;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>: <span class="comment">//data members</span></span><br><span class="line">    num_type number;</span><br><span class="line">    off_type offset;</span><br><span class="line">    len_type length;</span><br><span class="line">    win_type window;</span><br><span class="line">    id_type id;</span><br><span class="line">    tag_type tag;</span><br><span class="line">    <span class="comment">//save...</span></span><br><span class="line">    string data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//Constructor 1: Construct class objects based on data</span></span><br><span class="line">    <span class="built_in">MyUdpSeg</span>(<span class="type">const</span> <span class="type">char</span>* buf, num_type Number, off_type Offset,</span><br><span class="line">        len_type Length, tag_type Tag, win_type Window = <span class="number">0</span>, id_type Id = <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Constructor 2: Construct class objects based on the complete UDP packet segment(string)</span></span><br><span class="line">    <span class="built_in">MyUdpSeg</span>(string&amp; udpSeg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Constructor 3: Retransmit, adjust the number</span></span><br><span class="line">    <span class="built_in">MyUdpSeg</span>(MyUdpSeg&amp; udpSeg, num_type Number);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Copy constructor </span></span><br><span class="line">    <span class="built_in">MyUdpSeg</span>(<span class="type">const</span> MyUdpSeg&amp; udpSeg);</span><br><span class="line">    <span class="comment">//Move constructor </span></span><br><span class="line">    <span class="built_in">MyUdpSeg</span>(MyUdpSeg&amp;&amp; udpSeg) <span class="keyword">noexcept</span>;</span><br><span class="line">    <span class="comment">//operator=, copy-swap</span></span><br><span class="line">    MyUdpSeg&amp; <span class="keyword">operator</span>=(MyUdpSeg udpSeg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//parse the string</span></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string&amp; str)</span></span>;</span><br><span class="line">    <span class="comment">//swap for copy-swap</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(MyUdpSeg&amp; udpSeg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//convert to string to send data</span></span><br><span class="line">    <span class="function">string <span class="title">seg_to_string</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//return a default obj</span></span><br><span class="line">    <span class="function"><span class="type">static</span> MyUdpSeg <span class="title">initSeg</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//read members only</span></span><br><span class="line">    <span class="function">num_type <span class="title">getNumber</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> number; &#125;</span><br><span class="line">    <span class="function">off_type <span class="title">getOffset</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> offset; &#125;</span><br><span class="line">    <span class="function">len_type <span class="title">getLength</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> length; &#125;</span><br><span class="line">    <span class="function">win_type <span class="title">getWindow</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> window; &#125;</span><br><span class="line">    <span class="function">id_type <span class="title">getId</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getTag</span><span class="params">(<span class="type">size_t</span> i)</span> </span>&#123; <span class="keyword">return</span> tag[i]; &#125;</span><br><span class="line">    <span class="function">string&amp; <span class="title">getData</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* The headers are converted to a string to send</span></span><br><span class="line"><span class="comment">* The maximum number of digits in 32-bit decimal is 10 digits: 4,294,967,296</span></span><br><span class="line"><span class="comment">* The maximum number of digits in 64-bit decimal is 20 digits: 18,446,744,073,709,551,616</span></span><br><span class="line"><span class="comment">* The maximum number of digits in 16-bit decimal is 5  digits: 65,536</span></span><br><span class="line"><span class="comment">* There are 8 bits of identification</span></span><br><span class="line"><span class="comment">* There are also 6 spaces</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> MyUdpSeg::maxHeadSize = <span class="number">10</span> + <span class="number">20</span> + <span class="number">20</span> + <span class="number">5</span> + <span class="number">5</span> + <span class="number">8</span> + <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Constructor 1: Construct class objects based on data</span></span><br><span class="line">MyUdpSeg::<span class="built_in">MyUdpSeg</span>(<span class="type">const</span> <span class="type">char</span>* buf, num_type Number, off_type Offset,</span><br><span class="line">    len_type Length, tag_type Tag, win_type Window, id_type Id) :</span><br><span class="line">    <span class="built_in">data</span>(buf), <span class="built_in">number</span>(Number), <span class="built_in">offset</span>(Offset), <span class="built_in">window</span>(Window),</span><br><span class="line">    <span class="built_in">length</span>(Length), <span class="built_in">id</span>(Id), <span class="built_in">tag</span>(Tag)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Constructor 2: Construct class objects based on the complete UDP packet segment(string)</span></span><br><span class="line">MyUdpSeg::<span class="built_in">MyUdpSeg</span>(string&amp; udpSeg)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;string&gt; vec = <span class="built_in">parse</span>(udpSeg);</span><br><span class="line">    <span class="comment">// error packet segment</span></span><br><span class="line">    <span class="keyword">if</span> (vec.<span class="built_in">size</span>() &lt; <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        length = <span class="number">0</span>; <span class="comment">//Indicates that this is a useless package</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * have not string to unsigned int or size_t function</span></span><br><span class="line"><span class="comment">    * but string to unsigned long is satisfiable</span></span><br><span class="line"><span class="comment">    * just make sure it doesn&#x27;t overflow</span></span><br><span class="line"><span class="comment">    * use forced transformation to ignore warnings</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    number = <span class="built_in">num_type</span>(<span class="built_in">stoul</span>(vec[<span class="number">0</span>]));</span><br><span class="line">    offset = <span class="built_in">off_type</span>(<span class="built_in">stoul</span>(vec[<span class="number">1</span>]));</span><br><span class="line">    window = <span class="built_in">win_type</span>(<span class="built_in">stoul</span>(vec[<span class="number">2</span>]));</span><br><span class="line">    length = <span class="built_in">len_type</span>(<span class="built_in">stoul</span>(vec[<span class="number">3</span>]));</span><br><span class="line">    id = <span class="built_in">id_type</span>(<span class="built_in">stoul</span>(vec[<span class="number">4</span>]));</span><br><span class="line">    tag = <span class="built_in">tag_type</span>(vec[<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">if</span> (vec.<span class="built_in">size</span>() &gt; <span class="number">6</span>) <span class="comment">//if arry data. ACK may not carry data</span></span><br><span class="line">        data = vec[<span class="number">6</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Constructor 3: Retransmit, adjust the number</span></span><br><span class="line">MyUdpSeg::<span class="built_in">MyUdpSeg</span>(MyUdpSeg&amp; udpSeg, num_type Number) :</span><br><span class="line">    <span class="built_in">data</span>(udpSeg.data), <span class="built_in">number</span>(Number), <span class="built_in">offset</span>(udpSeg.offset), <span class="built_in">window</span>(udpSeg.window),</span><br><span class="line">    <span class="built_in">length</span>(udpSeg.length), <span class="built_in">id</span>(udpSeg.id), <span class="built_in">tag</span>(udpSeg.tag)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Copy constructor </span></span><br><span class="line">MyUdpSeg::<span class="built_in">MyUdpSeg</span>(<span class="type">const</span> MyUdpSeg&amp; udpSeg) :</span><br><span class="line">    <span class="built_in">data</span>(udpSeg.data), <span class="built_in">number</span>(udpSeg.number), <span class="built_in">offset</span>(udpSeg.offset), <span class="built_in">window</span>(udpSeg.window),</span><br><span class="line">    <span class="built_in">length</span>(udpSeg.length), <span class="built_in">id</span>(udpSeg.id), <span class="built_in">tag</span>(udpSeg.tag)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Move constructor </span></span><br><span class="line">MyUdpSeg::<span class="built_in">MyUdpSeg</span>(MyUdpSeg&amp;&amp; udpSeg) <span class="keyword">noexcept</span> :</span><br><span class="line">    <span class="built_in">data</span>(udpSeg.data), <span class="built_in">number</span>(udpSeg.number), <span class="built_in">offset</span>(udpSeg.offset), <span class="built_in">window</span>(udpSeg.window),</span><br><span class="line">    <span class="built_in">length</span>(udpSeg.length), <span class="built_in">id</span>(udpSeg.id), <span class="built_in">tag</span>(udpSeg.tag)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//operator=, copy-swap</span></span><br><span class="line">MyUdpSeg&amp; MyUdpSeg::<span class="keyword">operator</span>=(MyUdpSeg udpSeg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">swap</span>(udpSeg);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//swap for copy-swap</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyUdpSeg::swap</span><span class="params">(MyUdpSeg&amp; udpSeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> std::swap;</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;number, udpSeg.number);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;offset, udpSeg.offset);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;length, udpSeg.length);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;window, udpSeg.window);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;id, udpSeg.id);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;tag, udpSeg.tag);</span><br><span class="line">    <span class="built_in">swap</span>(<span class="keyword">this</span>-&gt;data, udpSeg.data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//parse the string</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">MyUdpSeg::parse</span><span class="params">(string&amp; str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Note that there are also spaces in the data, so parse up to six times</span></span><br><span class="line">    <span class="comment">//Data should not be sliced</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> spaceNum = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    str = str + <span class="string">&quot; &quot;</span>; <span class="comment">//add an space</span></span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (spaceNum-- == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Get complete data</span></span><br><span class="line">    string data = str.<span class="built_in">substr</span>(pos);</span><br><span class="line">    <span class="keyword">if</span> (data != <span class="string">&quot;&quot;</span>)</span><br><span class="line">        res.<span class="built_in">push_back</span>(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res; <span class="comment">//move construction</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//convert to string to send data</span></span><br><span class="line"><span class="function">string <span class="title">MyUdpSeg::seg_to_string</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string res;</span><br><span class="line">    res += <span class="built_in">to_string</span>(number) + <span class="string">&quot; &quot;</span>;</span><br><span class="line">    res += <span class="built_in">to_string</span>(offset) + <span class="string">&quot; &quot;</span>;</span><br><span class="line">    res += <span class="built_in">to_string</span>(window) + <span class="string">&quot; &quot;</span>;</span><br><span class="line">    res += <span class="built_in">to_string</span>(length) + <span class="string">&quot; &quot;</span>;</span><br><span class="line">    res += <span class="built_in">to_string</span>(id) + <span class="string">&quot; &quot;</span>;</span><br><span class="line">    res += tag.<span class="built_in">to_string</span>() + <span class="string">&quot; &quot;</span>; <span class="comment">//std::bitset::to_string()</span></span><br><span class="line">    res += data;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MyUdpSeg <span class="title">MyUdpSeg::initSeg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">MyUdpSeg</span>(<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, MyUdpSeg::<span class="built_in">tag_type</span>(), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ACK"><a href="#ACK" class="headerlink" title="ACK"></a>ACK</h3><p>返回ACK报文，并通告可用窗口边界</p>
<ul>
<li>ACK会告知接收方的可用窗口边界，如果有ACK通告更小的边界，发送方忽略它们</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MyUdpSeg <span class="title">sendAck</span><span class="params">(MyUdpSeg::num_type number, MyUdpSeg::off_type offset, MyUdpSeg::win_type window,</span></span></span><br><span class="line"><span class="params"><span class="function">    MyUdpSeg::id_type id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyUdpSeg::tag_type tag;</span><br><span class="line">    tag.<span class="built_in">set</span>(<span class="number">3</span>, <span class="number">1</span>); <span class="comment">//set ack from 0 to 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">MyUdpSeg</span>(<span class="string">&quot;&quot;</span>, number, offset, <span class="number">0</span>, tag, window, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h1><p>这部分主要考虑定时怎么设计，即如何得知超时。</p>
<p>简单的想法是，用链表维护定时器。对于超时的定时器，我们在定时器维护一个编号，告知发送窗口设置重发即可。</p>
<p>对于排序，有两种手段，一种是在插入节点时候按时间从小到大排序，这样检测就能从头检测知道第一个没超时就停下；一种是直接插入，检测超时是遍历所有节点。</p>
<p>显然在这个场景下，插入是频繁的，可能插入很多个节点才检测一次超时，因此使用直接插入要好得多。</p>
<hr>
<p>定时器节点内容是：</p>
<ul>
<li>包的编号</li>
<li>记录的时间信息</li>
<li>offset（补充）</li>
<li>是否重传过（补充）</li>
</ul>
<p>整体用一个STL list，可以用find函数（注意list本身没有find函数），list的remove必须是节点相等，则可以用remove_if；这时可以用algorithm头文件的remove函数，使用重载&#x3D;&#x3D;，但是时间是O(n)。对于timer来说，编号不可能重复，因此用find()+list.erase()即可。</p>
<p>收到ACK时要删除定时器中的对应的包的节点，采样RTT就在此时。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//timer node</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timerNode</span></span><br><span class="line">&#123;</span><br><span class="line">    MyUdpSeg::num_type number; <span class="comment">//segment number</span></span><br><span class="line">    chrono::system_clock::time_point time; <span class="comment">//start time</span></span><br><span class="line">    <span class="built_in">timerNode</span>(MyUdpSeg::num_type Number):<span class="built_in">number</span>(Number),<span class="built_in">time</span>(chrono::system_clock::<span class="built_in">now</span>())&#123;&#125;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(MyUdpSeg::num_type Number) &#123; <span class="keyword">return</span> number == Number; &#125; <span class="comment">//for find() function or remove()</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//use example</span></span><br><span class="line"><span class="keyword">using</span> timerIter = list&lt;timerNode&gt;::iterator;</span><br><span class="line">list&lt;timerNode&gt; timerList;</span><br><span class="line"><span class="keyword">for</span> (MyUdpSeg::num_type i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</span><br><span class="line">    timerList.<span class="built_in">push_back</span>(<span class="built_in">timerNode</span>(i));</span><br><span class="line">timerIter iter = <span class="built_in">find</span>(timerList.<span class="built_in">begin</span>(),timerList.<span class="built_in">end</span>(),<span class="number">19</span>); <span class="comment">//O(n)</span></span><br><span class="line">chrono::system_clock::time_point nowtime = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">cout &lt;&lt; (*iter).number &lt;&lt; endl;</span><br><span class="line">cout &lt;&lt; chrono::<span class="built_in">duration_cast</span>&lt;chrono::milliseconds&gt;(nowtime - (*iter).time).<span class="built_in">count</span>() &lt;&lt; endl;</span><br><span class="line">timerList.<span class="built_in">erase</span>(iter); <span class="comment">//O(1)</span></span><br><span class="line">iter = <span class="built_in">find</span>(timerList.<span class="built_in">begin</span>(), timerList.<span class="built_in">end</span>(), <span class="number">19</span>);</span><br><span class="line"><span class="keyword">if</span> (iter == timerList.<span class="built_in">end</span>())</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;remove 19&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="built_in">remove</span>(timerList.<span class="built_in">begin</span>(), timerList.<span class="built_in">end</span>(), <span class="number">1</span>);</span><br><span class="line">iter = <span class="built_in">find</span>(timerList.<span class="built_in">begin</span>(), timerList.<span class="built_in">end</span>(), <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (iter == timerList.<span class="built_in">end</span>())</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;remove 1&quot;</span> &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<p>为了支持插入的时候排序以及其他功能，设计一个类封装。（发现using node_type &#x3D; struct timerNode有问题，要去掉struct）</p>
<ul>
<li>允许插入节点</li>
<li>处理超时事件，遍历链表，找出每个超时的节点<ul>
<li>对于这些节点，需要重传，因此要返回所有结点的包的编号；重传的包的节点插入交给上层</li>
<li>尽管这些节点需要重传，但是还是需要保留的，因为原始包超时后重传了，但可能原始包的ack随后就到了，这时要用原始包来采样RTT。而对于重传的包的定时器就可以根据offset删除了，因为不需要再处理超时任务了，同时也不采样这些RTT。</li>
<li>所以还要根据offset删除所有节点，这就要<strong>加一个offset</strong>。</li>
</ul>
</li>
<li>当收到一个ack时，根据number删除节点，并返回计算的RTT；然后这个number可能有重传的包的定时器，根据offset一并删了，因为这个数据流offset已经不被需要了。</li>
<li>还要注意，如果一个包重传了而不更改记录的时间（为了计算RTT）的话，那么下次检测这个节点肯定会再被重传，因为包的编号不一样的，可能会重传两个甚至更多相同的数据包；因此要<strong>加一个flag</strong>，一旦检测出一次超时了，下次就不会再报超时事件了，留下的作用是采样RTT。</li>
</ul>
<p>重新设计和封装如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timerNode</span></span><br><span class="line">&#123;</span><br><span class="line">    MyUdpSeg::num_type number; <span class="comment">//segment number</span></span><br><span class="line">    MyUdpSeg::off_type offset; <span class="comment">//data offset</span></span><br><span class="line">    chrono::system_clock::time_point time; <span class="comment">//start time</span></span><br><span class="line">    <span class="type">bool</span> timeout; <span class="comment">//timeout flag</span></span><br><span class="line">    <span class="built_in">timerNode</span>(MyUdpSeg::num_type Number, MyUdpSeg::off_type Offset) :</span><br><span class="line">        <span class="built_in">number</span>(Number), <span class="built_in">offset</span>(Offset),<span class="built_in">time</span>(chrono::system_clock::<span class="built_in">now</span>()), <span class="built_in">timeout</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="built_in">timerNode</span>(<span class="type">const</span> timerNode&amp; node) :</span><br><span class="line">        <span class="built_in">number</span>(node.number), <span class="built_in">offset</span>(node.offset),<span class="built_in">time</span>(node.time), <span class="built_in">timeout</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(MyUdpSeg::num_type Number) &#123; <span class="keyword">return</span> number == Number; &#125; <span class="comment">//for find() function or remove()</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimerList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> node_type = timerNode;</span><br><span class="line">    <span class="keyword">using</span> rtt_type = <span class="type">unsigned</span> <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">using</span> rto_type = <span class="type">double</span>;</span><br><span class="line">    <span class="keyword">using</span> timerIter = list&lt;node_type&gt;::iterator;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    list&lt;node_type&gt; timerList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TimerList</span>()&#123;&#125;</span><br><span class="line">    ~<span class="built_in">TimerList</span>()&#123;&#125;</span><br><span class="line">    <span class="comment">//insert by node</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insertTimer</span><span class="params">(<span class="type">const</span> node_type&amp; node)</span></span>;</span><br><span class="line">    <span class="comment">//insert by number</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insertTimer</span><span class="params">(MyUdpSeg::num_type Number, MyUdpSeg::off_type Offset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//delete by number, return RTT/ms</span></span><br><span class="line">    <span class="function">rtt_type <span class="title">deleteTimer</span><span class="params">(MyUdpSeg::num_type Number)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//deal with timeout packets, return numbers</span></span><br><span class="line">    <span class="function">vector&lt;MyUdpSeg::num_type&gt; <span class="title">tick</span><span class="params">(rto_type RTO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//return size</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> timerList.<span class="built_in">size</span>(); &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//delete all by offset, call by &quot;rtt_type deleteTimer(MyUdpSeg::num_type Number);&quot;</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteTimer_</span><span class="params">(MyUdpSeg::off_type Offset)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TimerList::insertTimer</span><span class="params">(<span class="type">const</span> node_type&amp; node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    timerList.<span class="built_in">push_back</span>(node); <span class="comment">// call move or copy constructor function, not need to construct</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TimerList::insertTimer</span><span class="params">(MyUdpSeg::num_type Number, MyUdpSeg::off_type Offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    timerList.<span class="built_in">emplace_back</span>(Number, Offset); <span class="comment">//call constructor function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TimerList::rtt_type <span class="title">TimerList::deleteTimer</span><span class="params">(MyUdpSeg::num_type Number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//find the node</span></span><br><span class="line">    timerIter iter = <span class="built_in">find</span>(timerList.<span class="built_in">begin</span>(), timerList.<span class="built_in">end</span>(), Number); <span class="comment">//O(n)</span></span><br><span class="line">    <span class="keyword">if</span> (iter == timerList.<span class="built_in">end</span>()) <span class="comment">//not found</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//zero used to error detect</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sample RTT</span></span><br><span class="line">    chrono::system_clock::time_point nowtime = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    rtt_type RTT = <span class="built_in">rtt_type</span>(chrono::<span class="built_in">duration_cast</span>&lt;chrono::milliseconds&gt;(nowtime - (*iter).time).<span class="built_in">count</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//get offset</span></span><br><span class="line">    MyUdpSeg::off_type offset = (*iter).offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//delete</span></span><br><span class="line">    timerList.<span class="built_in">erase</span>(iter); <span class="comment">//O(1)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//delete node with the same offset</span></span><br><span class="line">    <span class="built_in">deleteTimer_</span>(offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TimerList::deleteTimer_</span><span class="params">(MyUdpSeg::off_type Offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (timerIter iter = timerList.<span class="built_in">begin</span>(); iter != timerList.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*iter).offset == Offset)</span><br><span class="line">            iter = timerList.<span class="built_in">erase</span>(iter); <span class="comment">//erase return next iterator</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            iter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;MyUdpSeg::num_type&gt; <span class="title">TimerList::tick</span><span class="params">(rto_type RTO)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (RTO &lt;= <span class="number">0</span>) <span class="keyword">return</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    vector&lt;MyUdpSeg::num_type&gt; number_retrans;</span><br><span class="line">    <span class="keyword">for</span> (timerIter iter = timerList.<span class="built_in">begin</span>(); iter != timerList.<span class="built_in">end</span>(); iter++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*iter).timeout == <span class="literal">true</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            chrono::system_clock::time_point nowtime = chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">            rtt_type interval = <span class="built_in">rtt_type</span>(chrono::<span class="built_in">duration_cast</span>&lt;chrono::milliseconds&gt;(nowtime - (*iter).time).<span class="built_in">count</span>());</span><br><span class="line">            <span class="keyword">if</span> (interval &gt; RTO) <span class="comment">//need to retransmit</span></span><br><span class="line">            &#123;</span><br><span class="line">                number_retrans.<span class="built_in">push_back</span>((*iter).number);</span><br><span class="line">                (*iter).timeout = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> number_retrans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="缓冲（窗口）"><a href="#缓冲（窗口）" class="headerlink" title="缓冲（窗口）"></a>缓冲（窗口）</h1><p>用于建立接收窗口和发送窗口，并维护它们的发送与接收</p>
<p>TCP的缓冲区是一个双向链表，所以这里也使用双向链表，这插入和删除上还是很方便的。</p>
<p>对于缓冲区节点，收到一个ack时，可以知道编号，删除该节点和定时器并计算RTT；问题是可能有重传的包，编号是不一样的，此时用offset找所有重传的包，找到就删了，因为这个包是否收到已经不重要了（RTT也不采样这个）。</p>
<p>而节点只能重载一个operator&#x3D;&#x3D;（因为offset和number参数类型可能是一样的，重载失败），前面要find编号，可以重载编号。然后因为要根据offset删所有重传的包，这时就要多实现一个函数，然后用remove_if了。这个函数在remove_if内传参是传入节点，我们还要一个参数offset，所以要用函数对象bind。（当然也可以遍历链表自己删，定时器用的是自己遍历的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto bindFunc1 = bind(lambda,std::placeholders::_1,std::placeholders::_2);</span><br></pre></td></tr></table></figure>

<hr>
<p>对于发送和接收窗口来说，通用的设计如下：</p>
<p>链表的设计是：STL list。</p>
<p>节点的设计是：</p>
<ul>
<li>有一个报文对象<code>MyUdpSeg</code></li>
<li>flag标识这个节点发过了没</li>
</ul>
<p>类的设计是：</p>
<ul>
<li>有添加和删除节点的功能</li>
<li>有查找节点并返回其引用的功能</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buffer node</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bufferNode</span></span><br><span class="line">&#123;</span><br><span class="line">    MyUdpSeg udpSeg; <span class="comment">//segment object</span></span><br><span class="line">    <span class="type">bool</span> isSent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Constructor 1: construct by lvalue</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp; UdpSeg) :<span class="built_in">udpSeg</span>(UdpSeg), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//Constructor 2: construct by rvalue </span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp;&amp; UdpSeg) <span class="keyword">noexcept</span> :<span class="built_in">udpSeg</span>(UdpSeg), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//Constructor 3: Retransmit, adjust the number</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp; UdpSeg, MyUdpSeg::num_type Number) :<span class="built_in">udpSeg</span>(UdpSeg, Number), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//copy constructor</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(<span class="type">const</span> bufferNode&amp; node):<span class="built_in">udpSeg</span>(node.udpSeg),<span class="built_in">isSent</span>(node.isSent)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(MyUdpSeg::num_type Number) &#123; <span class="keyword">return</span> udpSeg.<span class="built_in">getNumber</span>() == Number; &#125; <span class="comment">//for find() function</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lambda for remove_if</span></span><br><span class="line"><span class="keyword">auto</span> pred_lambda = [](bufferNode&amp; bufNode, MyUdpSeg::off_type offset) -&gt; <span class="type">bool</span> <span class="comment">// &quot;-&gt; bool&quot; is omittable</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">return</span> bufNode.udpSeg.<span class="built_in">getOffset</span>() == offset; </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">auto</span> pred = <span class="built_in">bind</span>(pred_lambda,std::placeholders::_1, myOffset);</span><br><span class="line"></span><br><span class="line"><span class="comment">//the simplified form is as follows</span></span><br><span class="line"><span class="keyword">auto</span> pred = <span class="built_in">bind</span>([](bufferNode&amp; bufNode, MyUdpSeg::off_type offset) &#123; <span class="comment">//lambda</span></span><br><span class="line">    <span class="keyword">return</span> bufNode.udpSeg.<span class="built_in">getOffset</span>() == offset; &#125;,</span><br><span class="line">    placeholders::_1, myOffset); <span class="comment">//parameters</span></span><br></pre></td></tr></table></figure>

<p>类的设计如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buffer node</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bufferNode</span></span><br><span class="line">&#123;</span><br><span class="line">    MyUdpSeg udpSeg; <span class="comment">//segment object</span></span><br><span class="line">    <span class="type">bool</span> isSent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Constructor 1: construct by lvalue</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp; UdpSeg) :<span class="built_in">udpSeg</span>(UdpSeg), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//Constructor 2: construct by rvalue </span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp;&amp; UdpSeg) <span class="keyword">noexcept</span> :<span class="built_in">udpSeg</span>(UdpSeg), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line">    <span class="comment">//Constructor 3: Retransmit, adjust the number</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(MyUdpSeg&amp; UdpSeg, MyUdpSeg::num_type Number) :<span class="built_in">udpSeg</span>(UdpSeg, Number), <span class="built_in">isSent</span>(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//copy constructor</span></span><br><span class="line">    <span class="built_in">bufferNode</span>(<span class="type">const</span> bufferNode&amp; node):<span class="built_in">udpSeg</span>(node.udpSeg),<span class="built_in">isSent</span>(node.isSent)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(MyUdpSeg::num_type Number) &#123; <span class="keyword">return</span> udpSeg.<span class="built_in">getNumber</span>() == Number; &#125; <span class="comment">//for find() function</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> node_type = bufferNode;</span><br><span class="line">    <span class="keyword">using</span> bufferIter = list&lt;node_type&gt;::iterator;</span><br><span class="line">    <span class="keyword">using</span> node_return_type = pair&lt;node_type&amp;, <span class="type">bool</span>&gt;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    list&lt;node_type&gt; bufferList;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BufferList</span>()&#123;&#125;</span><br><span class="line">    ~<span class="built_in">BufferList</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//insert node</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insertNode</span><span class="params">(MyUdpSeg&amp;&amp; UdpSeg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg, MyUdpSeg::num_type Number)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sortInsertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg)</span></span>; <span class="comment">//insert sorted by offset(used by recvbuf)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//delete by number</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteNode</span><span class="params">(MyUdpSeg::num_type Number)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get node by number, return pair: reference、bool (to check node)</span></span><br><span class="line">    <span class="function">node_return_type <span class="title">getNode</span><span class="params">(MyUdpSeg::num_type Number)</span></span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Note for getNode function:</span></span><br><span class="line"><span class="comment">    * For each return value, initialize it with a new variable</span></span><br><span class="line"><span class="comment">    * Do not assign a value to pair again after initialization, it will act on the initialized node</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//return size</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> bufferList.<span class="built_in">size</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">bufferIter <span class="title">begin</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> bufferList.<span class="built_in">begin</span>(); &#125;</span><br><span class="line">    <span class="function">bufferIter <span class="title">end</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> bufferList.<span class="built_in">end</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteFront</span><span class="params">()</span> </span>&#123; bufferList.<span class="built_in">erase</span>(<span class="built_in">begin</span>()); &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//return a default node to ues getNode function</span></span><br><span class="line">    <span class="function"><span class="type">static</span> node_type <span class="title">initNode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteNode_</span><span class="params">(MyUdpSeg::off_type Offset)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::insertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bufferList.<span class="built_in">emplace_back</span>(UdpSeg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::insertNode</span><span class="params">(MyUdpSeg&amp;&amp; UdpSeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bufferList.<span class="built_in">emplace_back</span>(<span class="built_in">move</span>(UdpSeg));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::insertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg, MyUdpSeg::num_type Number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bufferList.<span class="built_in">emplace_back</span>(UdpSeg, Number);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::sortInsertNode</span><span class="params">(MyUdpSeg&amp; UdpSeg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyUdpSeg::off_type offset = UdpSeg.<span class="built_in">getOffset</span>();</span><br><span class="line">    bufferIter iter = bufferList.<span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">for</span> (; iter != bufferList.<span class="built_in">end</span>(); iter++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*iter).udpSeg.<span class="built_in">getOffset</span>() &lt; offset)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((*iter).udpSeg.<span class="built_in">getOffset</span>() == offset) <span class="comment">//A package with the same data</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bufferList.<span class="built_in">insert</span>(iter,UdpSeg);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::deleteNode</span><span class="params">(MyUdpSeg::num_type Number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//find the node</span></span><br><span class="line">    bufferIter iter = <span class="built_in">find</span>(bufferList.<span class="built_in">begin</span>(), bufferList.<span class="built_in">end</span>(), Number); <span class="comment">//O(n)</span></span><br><span class="line">    <span class="keyword">if</span> (iter == bufferList.<span class="built_in">end</span>()) <span class="comment">//not found</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;no delete&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">//do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="comment">//get offset</span></span><br><span class="line">    MyUdpSeg::off_type offset = (*iter).udpSeg.<span class="built_in">getOffset</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//remove</span></span><br><span class="line">    bufferList.<span class="built_in">erase</span>(iter); <span class="comment">//O(1)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//remove all nodes with the same offset</span></span><br><span class="line">    <span class="built_in">deleteNode_</span>(offset);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BufferList::deleteNode_</span><span class="params">(MyUdpSeg::off_type Offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bufferList.<span class="built_in">remove_if</span>(<span class="built_in">bind</span>([](bufferNode&amp; bufNode, MyUdpSeg::off_type offset) &#123;</span><br><span class="line">        <span class="keyword">return</span> bufNode.udpSeg.<span class="built_in">getOffset</span>() == offset; &#125;,</span><br><span class="line">        placeholders::_1, Offset));</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BufferList::node_return_type <span class="title">BufferList::getNode</span><span class="params">(MyUdpSeg::num_type Number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//find the node</span></span><br><span class="line">    bufferIter iter = <span class="built_in">find</span>(bufferList.<span class="built_in">begin</span>(), bufferList.<span class="built_in">end</span>(), Number); <span class="comment">//O(n)</span></span><br><span class="line">    <span class="keyword">if</span> (iter == bufferList.<span class="built_in">end</span>()) <span class="comment">//not found</span></span><br><span class="line">    &#123;</span><br><span class="line">        node_type node = <span class="built_in">initNode</span>(); <span class="comment">//must check bool value firstly, node may be inexistent </span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">node_return_type</span>(node, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">node_return_type</span>(*iter,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BufferList::node_type <span class="title">BufferList::initNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">node_type</span>(MyUdpSeg::<span class="built_in">initSeg</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发送窗口"><a href="#发送窗口" class="headerlink" title="发送窗口"></a>发送窗口</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>发送窗口里有缓冲链表对象和定时器链表对象</li>
<li>加载数据<ul>
<li>将传入的数据封装成节点放到缓冲链表里（支持普通发送）</li>
<li>读取文件流，如果直到把缓冲链表对象读满（支持文件发送）</li>
</ul>
</li>
<li>发送数据，标记为已发送，并注册定时器；最后一个数据进行标记，发送结束</li>
<li>根据定时器tick后需要重发的包编号向量，重新插入新的节点数据。</li>
<li>收到ack，删除节点（及其重传的节点）</li>
<li>握手，syn；发送完毕是fin</li>
</ul>
<p>能发一条消息也能发文件，因此要解耦。对于加载数据来说用一个goOn来指示，文件读完就goOn为false否则为true即需要继续发；对于自行调用发送信息也是如此，指示即可；默认为false。</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><ul>
<li><p>递增的number序列</p>
</li>
<li><p>数据偏移量offset</p>
</li>
<li><p>window的大小，窗口能发送的字节数，窗口更新：</p>
<ul>
<li>因为是最多能发送的字节数，所以包括重传在内的所有包都不能太多，因此<code>bufferList.size()* SegDataSize &lt; window</code>才允许继续发；</li>
<li>更新时最开始想使用<code>window = MyUdpSeg::win_type(offset) + Window</code>，Window是接收窗口传来的还能接收的字节数<code>recvWindow-maxOffset</code>，用这个来更新是因为当一切正常时，offset和maxOffset是相等的，这个更新符合直觉。但是这样更新的话，window只会越来越大，肯定是错误的。</li>
<li>后来打算用<code>window = MyUdpSeg::win_type(bufferList.size() * SegDataSize) + Window</code>，因为结合前面的判断，能新发送的字节数就是Window这么多，也符合直觉。但这可能导致重传的包很多也能继续发，导致越来越堵。</li>
<li>因此再定义一个maxWindow，这个和接收窗口的大小一样，<code>window = min(updateWindow, maxWindow)</code>，即如果已经很满了就不增大了。</li>
</ul>
</li>
<li><p>动态更新的RTO</p>
</li>
</ul>
<h2 id="接收窗口"><a href="#接收窗口" class="headerlink" title="接收窗口"></a>接收窗口</h2><h3 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h3><ul>
<li>接收窗口有缓冲链表对象</li>
<li>接收数据<ul>
<li>把收到的一个数据包放入缓冲链表，注意插入链表要按offset排序插入</li>
<li>发送ack和当前的剩余窗口</li>
</ul>
</li>
<li>写入数据，检测到一连串的offset超过阈值就写入；<ul>
<li>写入后更新窗口</li>
<li>如果最后一个数据包里有结束标记，就通知关闭窗口，然后进行关闭挥手</li>
</ul>
</li>
<li>握手，syn+ack；接收完毕是fin+ack</li>
</ul>
<h3 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h3><ul>
<li>最大offset偏移</li>
<li>window的大小，最大能接收的字节数</li>
</ul>
<h1 id="退出（基于心跳检测）"><a href="#退出（基于心跳检测）" class="headerlink" title="退出（基于心跳检测）"></a>退出（基于心跳检测）</h1><p>如何沟通退出呢，当接收会话得知自己接收完了会返回true，如果此时就退出了，那么发送会话可能因为ack丢了而无法退出也无法检测，因为udp是无连接的，对端close了也不会通知。</p>
<p>需要一个可靠的措施，它不会像tcp一样复杂，确保接收器不需要定时器来重传某些包。</p>
<p>这里的考量是，发送器为了确保对方存活，用一个额外的线程去进行心跳检测，下面是一般的心跳检测步骤：</p>
<ul>
<li>1.客户端每隔一个时间间隔发生一个探测包给服务器（秒级别的较长一段时间）</li>
<li>2.客户端发包时启动一个超时定时器</li>
<li>3.服务器端接收到检测包，应该回应一个包</li>
<li>4.如果客户机收到服务器的应答包，则说明服务器正常，删除超时定时器</li>
<li>5.如果客户端的超时定时器超时，依然没有收到应答包，则说明服务器挂了</li>
</ul>
<p>这里的心跳检测主要是用于<strong>保活</strong>，但我这里是为了退出，可以直接复用接收器发回的ack包，发送器也不需要再进行发送包，就检测最近一次接收ack到当前时间的间隔即可，间隔多长结束呢，这里感觉好一点是4个rto（2个rto太容易发生了）。</p>
<p>接收器也是如此，但是接收器没有rto。所以接收器和发送器都约定好用1秒钟。<strong>发送方退出的时候就是检测到没有接收方响应的时候</strong>，此时接收方可能已经接受完文件退出、或者出错。<strong>接收方退出的时候是处理完所有数据的时候，这不需要心跳检测；也可能在心跳检测发现发送方出错时退出。</strong>因此<strong>发送方退出情况只用一种、接收方退出有两种（或的关系）</strong>。</p>
<ul>
<li>在开始时握手阶段，因为双方开启的时候不是同步的，所以一开始握手检测时间要长一些（10~30s），这里设置为30s。当发送方成功从握手退出时（此时收到了syn+ack），可以修改为1s的心跳；而接收方收到syn时，还不能直接修改，因为可能丢包，要等第一个不是握手包到来才修改为1s。</li>
<li>当接收方认为对方退出时，自己还不能退出，因为可能数据接收完整但是还没写完。这里的逻辑是：写完一次后收到后面的包，然后也许等了许久（别管为什么，只是也许）导致超时才再次准备写，但这次写之前因为超时了所以没去写。这时只需要再执行一次写数据的任务即可，如果完整就可以一次写完；如果是其他情况也没什么损失。</li>
</ul>
<p>因为用到一些线程，要加锁。这里面发送器线程之间共享sendOver和lastAckTime，用一个互斥锁即可。</p>
<h1 id="UDP会话"><a href="#UDP会话" class="headerlink" title="UDP会话"></a>UDP会话</h1><p>socket需要设置成非阻塞，否则<strong>recvfrom可能无法退出</strong>。<strong>sendto不管怎么样都不会阻塞</strong>，因为sendto没有缓冲区，不需要拷贝：</p>
<p><strong>send 和 sendto 函数在 UDP 层没有概念上的输出缓冲区（总要拷贝数据，但这个缓冲区和TCP的缓冲区在概念上不同），在 TCP 层有输出缓冲区，recv 和recvfrom 无论在 UDP 层还是 TCP 层都有接收缓冲区。</strong></p>
<p>更详细的介绍是：</p>
<ul>
<li>udp sendto 函数，它的作用和tcp一样，是拷贝到缓冲区，但是请注意udp栈底层实现的原理是：</li>
<li>针对每个udp包如果目前有物理连路带宽可以发送，那么立即发送；如果没有，那么直接丢弃该udp包 </li>
<li>这个过程是非常非常快的，而且因为是在内核态执行，因此优先级高于普通操作</li>
<li>从这个意义上来说，sendto函数根本不会阻塞，事实上也不会阻塞，因为只有2个结果：立即发送出去，或者直接丢包</li>
</ul>
<p>总结一下就是：UDP不可靠，它不必保存应用程序的数据拷贝，因此<strong>无需真正的发送缓冲区</strong>（应用进程的数据在沿协议栈往下传递，以某种形式拷贝到内核缓冲区，然而数据链路层在送出数据之后将丢弃该拷贝）。</p>
<h2 id="发送器"><a href="#发送器" class="headerlink" title="发送器"></a>发送器</h2><p>发送文件：</p>
<ul>
<li>首先建立一个发送窗口，窗口中有多个buffer；并且打开文件（fp）；</li>
<li>每个buffer依次读取文件，然后编辑成报文后发送；</li>
<li>等待ACK，更新发送窗口；</li>
<li>如果发送窗口可用，继续读取文件、发送</li>
</ul>
<p>这里的问题是，整个流程是串行的吗？需要思考的是发送文件和接收ACK是怎么个交流法。</p>
<ul>
<li>如果是串行的，那么每次把发送窗口发完，然后等待ACK；这里的问题是一旦有一个ACK来了，是不继续等直接更新窗口（这样更新太频繁了）还是继续等（要等多少个呢？）没更新发送窗口时，假设数据不会发送，那么等ACK就可以一直等待直到发送窗口能增大一个阈值为止。这里的问题是实际上有数据需要重传，如果窗口一直没更新就会导致数据重传不了，这是致命的问题。</li>
<li>因此需要两个线程，一个维护发送一个维护接收，它们动态更新发送窗口</li>
</ul>
<h2 id="接收器"><a href="#接收器" class="headerlink" title="接收器"></a>接收器</h2><p>接收文件：</p>
<ul>
<li>首先建立一个接收窗口，这里文件名由于在主项目里能根据服务器得到，所以这里不设置udp交流得到文件名，然后打开文件</li>
<li>对于收到的每个包，返回一个ack确认，这样可以乱序确认，可以做到tcp中sack的优化（TCP乱序确认就不能快速重传）。接收的是一个char的buffer，要进行解析恢复成报文的数据结构。</li>
<li>写入文件，要按序写，所以从接收窗口左边界对连续的包进行检测，找到连续的段就写入（基于quic的话是1&#x2F;2的最大窗口再写入），然后更新窗口。</li>
</ul>
<p>还是那个问题，流程是否是串行的？</p>
<ul>
<li>首先要一直接收，接收到就发一个ack这个没问题。但是如果接收到一个包就检测能不能写入文件就太慢了，会导致ack延迟太多。</li>
<li>所以另开一个线程不断检测能否写入文件和更新窗口。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/11/26/udp_hole_punching/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/26/udp_hole_punching/" class="post-title-link" itemprop="url">UDP hole punching</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-26 18:18:15" itemprop="dateCreated datePublished" datetime="2022-11-26T18:18:15+08:00">2022-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-12-18 15:30:23" itemprop="dateModified" datetime="2022-12-18T15:30:23+08:00">2022-12-18</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p> 使用udp打洞实现内网穿透</p>
</blockquote>
<p>做项目的时候发现需要进行udp打洞，这里进行简单的验证</p>
<p>因为是测试，代码就先写在一个cpp文件里了，最后再封装。</p>
<p>github项目连接：<a target="_blank" rel="noopener" href="https://github.com/Chen-Jin-yuan/UDP-hole-punching">Chen-Jin-yuan&#x2F;UDP-hole-punching (github.com)</a></p>
<hr>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><p>公网环境：ubuntu 20.04 LTS，g++</p>
<p>本地环境：win10，vs2022，网络利用nattypetest测试cone类型。</p>
<ul>
<li>首先进行udp收发测试</li>
<li>初次尝试udp打洞失败，思考可能与NAT类型有关，因为校园网和手机热点都是对称型，难以穿透；而如果两台内网机器连同一个wifi的话，可能会因为NAT回环而被丢弃，但是又没有其他网络可以连，错误的可能很多，先尝试逆向连接。</li>
<li>进行<strong>逆向连接</strong>测试，成功。</li>
<li>进行<strong>NAT回环测试</strong>（客户端A、B在同一个内网下，A向NAT发往B的包被丢弃），成功，并修改服务器逻辑，当双方在一个NAT内时，发的是主机ip（私有ip）和绑定的端口（不是NAT中的端口）。</li>
<li>逆向连接成功后进行tcp连接，失败，与conntrack连接跟踪有关，可能被防火墙根据协议号阻拦了。</li>
<li>根据连接跟踪，使用tcp打洞打穿NAT和防火墙，实现tcp的逆向连接。</li>
<li>tcp的内网穿透失败，防火墙有诸多限制。</li>
<li><strong>udp打洞测试成功，成功内网穿透了两个NAT。</strong></li>
<li><strong>整理代码与封装，并有使用示例。</strong></li>
</ul>
<h1 id="简单的收发测试"><a href="#简单的收发测试" class="headerlink" title="简单的收发测试"></a>简单的收发测试</h1><p>Linux服务器端server.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>,port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//端口复用，在bind前设置</span></span><br><span class="line">    <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">        string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line">        <span class="comment">//区分client1和client2</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf,<span class="string">&quot;client1&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching client1 ip: %s, port: %s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>());</span><br><span class="line">        	<span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(recvbuf,<span class="string">&quot;client2&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching client2 ip: %s, port: %s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>());</span><br><span class="line">        	<span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> listenudp;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(listenudp , port);</span><br><span class="line">    string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    <span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port1.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip1 = ip_port1.<span class="built_in">substr</span>(<span class="number">0</span>,pos1);</span><br><span class="line">    string port1 = ip_port1.<span class="built_in">substr</span>(pos1+<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> pos2 = ip_port2.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip2 = ip_port2.<span class="built_in">substr</span>(<span class="number">0</span>,pos2);</span><br><span class="line">    string port2 = ip_port2.<span class="built_in">substr</span>(pos2+<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//对着发，ipport1发给addr2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">                     ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                     ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>windows客户端client.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，</span></span><br><span class="line"><span class="comment">    recvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;client1&quot;</span>;<span class="comment">//client1或client2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">10000</span>;<span class="comment">//同一台机器的话要改一下</span></span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, port);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 1 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">getchar</span>();<span class="comment">//阻塞</span></span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>云服务器里运行server.cpp</p>
<p>本机使用vs2022，先release一份exe文件，然后改端口和client1还是client2的信息，在debug模式再运行一个程序，就可以做到两台主机了。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/upd%E6%94%B6%E5%8F%91%E6%B5%8B%E8%AF%95.png" alt="image-20221030221930721"></p>
<p>使用另一台电脑运行程序，绑定端口10000，另一台电脑连不同的网，结果如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/udp%E6%94%B6%E5%8F%91%E6%B5%8B%E8%AF%952.png" alt="image-20221030223259010"></p>
<hr>
<p>现在产生p2p发送，发送端添加如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getchar</span>();<span class="comment">//阻塞</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面向对方发信息</span></span><br><span class="line"><span class="comment">//定义sockaddr_in</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line"><span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line"><span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">closesocket</span>(udpfd);</span><br></pre></td></tr></table></figure>

<p>接收端把getchar去掉，添加如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//client2接收信息</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line"><span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"><span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line"><span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;recv: %s&quot;</span>, recvbuf);</span><br><span class="line"><span class="built_in">getchar</span>();<span class="comment">//阻塞</span></span><br></pre></td></tr></table></figure>

<p>结果是发不过去，接收端没有收到一直在阻塞。这需要进一步去思考。可能是NAT类型问题，也可能是NAT回环问题（注：经后面测试，发现是NAT回环问题）</p>
<h1 id="逆向连接-Connection-reversal"><a href="#逆向连接-Connection-reversal" class="headerlink" title="逆向连接-Connection reversal"></a>逆向连接-Connection reversal</h1><p>这种方法在两个端点中有一个不存在中间件（如NAT）的时候有效。例如，Client A在NAT之后而Client B拥有全局IP地址，如图所示：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E9%80%86%E5%90%91%E8%BF%9E%E6%8E%A5.png" alt="img"></p>
<p>Client A内网地址为10.0.0.1，使用TCP，端口为1234。A和Server S建立了一个连接，Server的IP地址为18.181.0.31，监听1235端口。NAT A给Client A分配了TCP端口62000，地址为NAT的公网IP地址155.99.25.11，作为Client A对外当前会话的临时IP和端口。因此Server S认为Client A就是155.99.25.11:62000。而Client B由于有公网地址，所以对Server S来说Client B就是138.76.29.7:1234。</p>
<p>当Client B想要主动发起对Client A的P2P连接时，需要指定目的地址及端口为155.99.25.11:62000。由于NAT工作的原理问题，NAT A会拒绝将收到的对Client A的请求转发给Client A。拒绝该请求主要有如下原因：</p>
<ol>
<li><p>NAT A没有映射过62000端口，NAT A不知道该请求是给谁的</p>
</li>
<li><p>NAT A映射过62000端口，但是需要首先从Client A发起请求，然后才能转发应答（限制锥形NAT的保护）</p>
</li>
</ol>
<p>在直接连接Client A失败之后，Client B可以通过Server S向Client A中继一个连接请求，从而从Client A方向“逆向“地建立起Client A- Client B之间的点对点连接（因为Client A连接到了Server S）。</p>
<p>很多当前的P2P系统都实现了这种技术，但其局限性也是很明显的，只有当其中一方有公网IP时连接才能建立。越来越多的情况下，通信的双方都在NAT之后，因此就要用到打洞技术了。</p>
<hr>
<p>现在我们假设公网服务器有一个clientB，本地主机clientA在内网里，我们的目标是实现B发送udp请求能连接到A。</p>
<ul>
<li>首先通过服务器分发对方的IP和port</li>
<li>然后clientA向clientB发送信息（正常情况下能收到），此时NAT A已经建立了NAT A-&gt;clientB的映射，表示信任B</li>
<li>现在B可以先A发送信息了，NAT A会转发到A</li>
</ul>
<p>注意B是否接收A的消息是无关紧要，为了验证，这里本地客户端B接收并打印出来。实际上不需要接收，A发的这个包只是告诉NAT A：“我要发的目的ip和端口是被我信任的，它可以发包给我，不要丢弃这个ip和端口发来的信息”。</p>
<p>先写一个在公网云服务器运行的clientB，先接收然后发送：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span>&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;client2&quot;</span>;<span class="comment">//client1或client2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> udpfd;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">22222</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, port);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(udpfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 2 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getchar();//阻塞</span></span><br><span class="line">    <span class="comment">//先接收A发送的消息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>,recvbuf);</span><br><span class="line">    <span class="comment">//发送消息，一直发</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    	<span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    	&#123;</span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本地客户端如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，r</span></span><br><span class="line"><span class="comment">    ecvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;client1&quot;</span>;<span class="comment">//client1或client2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">22222</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, port);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 1 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//下面向对方发信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello!!&quot;</span>;</span><br><span class="line">    res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">        <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">        res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">        <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">            <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>, recvbuf);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h2><p>如图，公网clientB成功发送udp包到内网clientA</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E9%80%86%E5%90%91%E8%BF%9E%E6%8E%A52.png" alt="image-20221031125624691"></p>
<hr>
<p>现在，我们不让A发送给B，B也不阻塞接收，而是一直发送信息给A。</p>
<p>注意，必须等NAT A中的映射自然删除（大概几分钟的存活时间），没删除前B仍然可以直接发给A。</p>
<p>删除后，B就无法发送给A了，A一直在阻塞，因为B发送的消息给NAT A丢弃了，即保护了A。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E9%80%86%E5%90%91%E8%BF%9E%E6%8E%A53.png" alt="image-20221031130440814"></p>
<h1 id="NAT回环-环回"><a href="#NAT回环-环回" class="headerlink" title="NAT回环(环回)"></a>NAT回环(环回)</h1><p>现在我们处理同一个局域网的问题，有些NAT对同一个局域网的信息会丢弃，这时服务器根据ip判断是否是一个局域网，是的话把客户端本机的ip和port发送回去即可。</p>
<p>客户端：</p>
<p>下面是一个获取本机ip的函数，一般取最后一个即可，然后把ip和端口发给服务器。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//获取主机名</span></span><br><span class="line">    <span class="comment">//根据主机名获取主机信息列表，有多个ip（网卡）</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//需要禁用c4996警报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;<span class="comment">//转型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; addr &lt;&lt; endl;</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送包：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>];<span class="comment">//取最后一个</span></span><br><span class="line">    string myip_port = myip +<span class="string">&quot; &quot;</span>+<span class="built_in">to_string</span>(myport);</span><br><span class="line">    <span class="comment">//现在发送信息是本机ip</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(),myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>服务器端：</p>
<p>服务器不再接收”client1”或”client2”，而是接收客户端本机的ip和port，接收后判断NAT的ip是否相同，如果相同就是同一个局域网。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">        string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line">        </span><br><span class="line">        string host = <span class="built_in">string</span>(recvbuf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching  NAT ip: %s, port: %s; host:%s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>(),host.<span class="built_in">c_str</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port+<span class="string">&quot; &quot;</span>+host;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于有空格分隔，这里用个解析函数解析两个ip-port</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span><span class="comment">//解析函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    str = str + <span class="string">&quot; &quot;</span>;<span class="comment">//最后补个空格</span></span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//返回值是右值，外部vector会接收右值，调用移动构造</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在main里：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line"><span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">vector&lt;string&gt; host1 = <span class="built_in">parse</span>(ip_port1);</span><br><span class="line">vector&lt;string&gt; host2 = <span class="built_in">parse</span>(ip_port2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器发回去的还是使用NAT ip</span></span><br><span class="line">string ip1 = host1[<span class="number">0</span>];</span><br><span class="line">string port1 = host1[<span class="number">1</span>];</span><br><span class="line">string ip2 = host2[<span class="number">0</span>];</span><br><span class="line">string port2 = host2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义sockaddr_in</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));<span class="comment">//字节序转换</span></span><br><span class="line"><span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义sockaddr_in</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));<span class="comment">//字节序转换</span></span><br><span class="line"><span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//但是发送的数据不一样了</span></span><br><span class="line"><span class="comment">//对着发，ipport1发给addr2</span></span><br><span class="line"><span class="keyword">if</span>(ip1 != ip2)<span class="comment">//不同的内网</span></span><br><span class="line">&#123;</span><br><span class="line">    ip_port1 = ip1 + <span class="string">&quot; &quot;</span> + port1;</span><br><span class="line">    ip_port2 = ip2 + <span class="string">&quot; &quot;</span> + port2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span><span class="comment">//在同一个NAT里</span></span><br><span class="line">&#123;</span><br><span class="line">    ip_port1 = host1[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host1[<span class="number">3</span>];</span><br><span class="line">    ip_port2 = host2[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host2[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">              ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line"><span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                 ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line"><span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果-2"><a href="#结果-2" class="headerlink" title="结果"></a>结果</h2><p>在主机上跑两个程序，像逆向连接一样，A先B发送一个包，然后B就可以一直向A发包了。</p>
<p>当然这里服务器判断两个主机都在内网里，所以返回它们本地的ip和各自绑定的端口（这个端口不是NAT映射中的端口），此时这两个主机能互相发包。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/NAT%E5%9B%9E%E7%8E%AF.png" alt="image-20221031150918382"></p>
<p>下面修改服务器代码，不管怎么样都返回NAT的ip和port，这时客户端A发给NAT发现目标就是自己内网里的机器，就直接丢弃了，因此B不会收到A的hello!</p>
<p>这个例子就说明了有些NAT不支持回环。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/NAT%E5%9B%9E%E7%8E%AF3.png" alt="image-20221031151655791"></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>完整的源码再放一下：</p>
<p>服务器端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>,port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//端口复用，在bind前设置，否则bind时出错就晚了</span></span><br><span class="line">    <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//完事了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">        string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line">        </span><br><span class="line">        string host = <span class="built_in">string</span>(recvbuf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching  NAT ip: %s, port: %s; host:%s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>(),host.<span class="built_in">c_str</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port+<span class="string">&quot; &quot;</span>+host;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span><span class="comment">//解析函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    str = str + <span class="string">&quot; &quot;</span>;<span class="comment">//最后补个空格</span></span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//返回值是右值，外部vector会接收右值，调用移动构造</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> listenudp;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(listenudp , port);</span><br><span class="line">    string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    <span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    vector&lt;string&gt; host1 = <span class="built_in">parse</span>(ip_port1);</span><br><span class="line">    vector&lt;string&gt; host2 = <span class="built_in">parse</span>(ip_port2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务器发回去的还是使用NAT ip</span></span><br><span class="line">    string ip1 = host1[<span class="number">0</span>];</span><br><span class="line">    string port1 = host1[<span class="number">1</span>];</span><br><span class="line">    string ip2 = host2[<span class="number">0</span>];</span><br><span class="line">    string port2 = host2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//但是发送的数据不一样了</span></span><br><span class="line">    <span class="comment">//对着发，ipport1发给addr2</span></span><br><span class="line">    <span class="keyword">if</span>(ip1 != ip2)<span class="comment">//不同的内网</span></span><br><span class="line">    &#123;</span><br><span class="line">        ip_port1 = ip1 + <span class="string">&quot; &quot;</span> + port1;</span><br><span class="line">        ip_port2 = ip2 + <span class="string">&quot; &quot;</span> + port2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//在同一个NAT里</span></span><br><span class="line">    &#123;</span><br><span class="line">        ip_port1 = host1[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host1[<span class="number">3</span>];</span><br><span class="line">        ip_port2 = host2[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host2[<span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">                  ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                     ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端1</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> myport = <span class="number">22222</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，r</span></span><br><span class="line"><span class="comment">    ecvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//获取主机名</span></span><br><span class="line">    <span class="comment">//根据主机名获取主机信息列表，有多个ip（网卡）</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//需要禁用c4996警报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;<span class="comment">//转型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; addr &lt;&lt; endl;</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>];<span class="comment">//取最后一个</span></span><br><span class="line">    string myip_port = myip +<span class="string">&quot; &quot;</span>+<span class="built_in">to_string</span>(myport);</span><br><span class="line">    <span class="comment">//现在发送信息是本机ip</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(),myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line">    </span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, myport);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 1 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//下面向对方发信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello!!&quot;</span>;</span><br><span class="line">    res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">        <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">        <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">        res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">        <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">            <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>, recvbuf);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端2，相对于客户端1只修改了绑定的port和接收发送的逻辑。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> myport = <span class="number">11111</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，r</span></span><br><span class="line"><span class="comment">    ecvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//获取主机名</span></span><br><span class="line">    <span class="comment">//根据主机名获取主机信息列表，有多个ip（网卡）</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//需要禁用c4996警报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;<span class="comment">//转型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; addr &lt;&lt; endl;</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>];<span class="comment">//取最后一个</span></span><br><span class="line">    string myip_port = myip + <span class="string">&quot; &quot;</span> + <span class="built_in">to_string</span>(myport);</span><br><span class="line">    <span class="comment">//现在发送信息是本机ip</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(), myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line"></span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, myport);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 2 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息，一直发</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="逆向连接后进行tcp连接"><a href="#逆向连接后进行tcp连接" class="headerlink" title="逆向连接后进行tcp连接"></a>逆向连接后进行tcp连接</h1><p>因为还没有找到合适的网络来测试udp的内网穿透（大多都是校园网，对称型无法处理），所以先等几天，然后开始测试如何逆向连接后，进行p2p的tcp连接。</p>
<p>目前的想法是，当逆向连接完成后，将原来的udp套接字关闭，创建tcp套接字，然后绑定相同的端口（因为NAT记录的端口）。</p>
<ul>
<li>首先公网客户端接收内网客户端的udp信息，逆向连接完成（可以不接收，内网客户端发送即可，为了验证这里还是接收）</li>
<li>公网客户端发个udp给内网客户端，作为验证</li>
<li>接着两个客户端创建tcp套接字并且都绑定原来的端口（udp套接字可以不关闭，tcp和udp可以共用端口，所以可同时初始化）</li>
<li>内网客户端进入listen状态，阻塞在accept</li>
<li>公网客户端connect内网客户端，tcp连接建立</li>
</ul>
<hr>
<p>公网客户端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span>&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;client2&quot;</span>;<span class="comment">//client1或client2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_tcp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//初始化一个端口</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> udpfd;</span><br><span class="line">    <span class="type">int</span> tcpfd;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">22222</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, port);</span><br><span class="line">    <span class="built_in">init_tcp_Socket</span>(tcpfd,port);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(udpfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 2 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getchar();//阻塞</span></span><br><span class="line">    <span class="comment">//先接收A发送的消息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>,recvbuf);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line">    </span><br><span class="line">    res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;connect fail !\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;connect to server successfully!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">send</span>(tcpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(udpfd);</span><br><span class="line">    <span class="built_in">close</span>(tcpfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内网客户端</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> myport = <span class="number">22222</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，r</span></span><br><span class="line"><span class="comment">    ecvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//获取主机名</span></span><br><span class="line">    <span class="comment">//根据主机名获取主机信息列表，有多个ip（网卡）</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//需要禁用c4996警报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;<span class="comment">//转型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; addr &lt;&lt; endl;</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>];<span class="comment">//取最后一个</span></span><br><span class="line">    string myip_port = myip + <span class="string">&quot; &quot;</span> + <span class="built_in">to_string</span>(myport);</span><br><span class="line">    <span class="comment">//现在发送信息是本机ip</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(), myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_tcp_Socket</span><span class="params">(SOCKET&amp; tcpfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    tcpfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;bind error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//cerr不经过缓冲而直接输出，一般用于迅速输出出错信息，是标准错误，默认情况下被关联到标准输出流，但它不被缓冲.</span></span><br><span class="line">        <span class="comment">//也就说错误消息可以直接发送到显示器，而无需等到缓冲区或者新的换行符时，才被显示。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始监听</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(tcpfd, SOMAXCONN) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;listen error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line"></span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    SOCKET tcpfd;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, myport);</span><br><span class="line">    <span class="built_in">init_tcp_Socket</span>(tcpfd, myport);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv from server...\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 1 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面向对方发信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello!!&quot;</span>;</span><br><span class="line">    res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;send...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>, recvbuf);</span><br><span class="line">    <span class="comment">//准备接收连接</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> client_addr;<span class="comment">//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client_addr);<span class="comment">//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line">    SOCKET conn = <span class="built_in">accept</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);<span class="comment">//阻塞，等待连接，成功则创建连接套接字conn描述这个用户</span></span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connect error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(tcpfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> nRecv = <span class="built_in">recv</span>(conn, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nRecv == SOCKET_ERROR)<span class="comment">//copy出错</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connection to client has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">closesocket</span>(tcpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>, recvbuf);</span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">closesocket</span>(tcpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果-3"><a href="#结果-3" class="headerlink" title="结果"></a>结果</h2><p>连接失败，双方阻塞在connect和accept处，connect的syn包根本到达不了内网机器（反向测试：内网可以connect外网）。为什么udp可以而tcp就不可以了呢？这两个协议的差异就是，我们在发udp之前，先用内网向外网发了udp；而tcp包是直接从外网发到内网的，这可能导致了问题。</p>
<h1 id="连接跟踪"><a href="#连接跟踪" class="headerlink" title="连接跟踪"></a>连接跟踪</h1><p>tcp连接失败也许是因为<strong>conntrack（连接跟踪）</strong>，在防火墙、内核（linux）中会跟踪连接，这个连接不是专门指tcp连接。连接跟踪可以让Netfilter（框架）知道某个特定连接的状态，运行连接跟踪的防火墙称作带有状态机制的防火墙，这种防火墙更安全。连接跟踪的信息一般是五元组，当然针对不同协议和特殊修改也有四元组和七元组：</p>
<ul>
<li>四元组：源IP地址、目的IP地址、源端口、目的端口</li>
<li>五元组：源IP地址、目的IP地址、<strong>协议号</strong>、源端口、目的端口</li>
<li>七元组：源IP地址、目的IP地址、协议号、源端口、目的端口，服务类型以及接口索引</li>
</ul>
<p>可以看到，五元组中不仅有ip、端口，还有协议号这一内容，这标识了是tcp还是udp等等。在各种过滤机制下，连接跟踪会发挥作用。</p>
<p>当然我们的内网客户端是Windows下的，Windows下的防火墙是如何写的并不能知道（没开源），但我们可以大概看一下防火墙高级设置：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/Windows%E9%98%B2%E7%81%AB%E5%A2%99.png" alt="image-20221101084903251"></p>
<p>在入站规则中，可以看到除了地址端口，还有协议。借助连接跟踪的想法，我们猜测：</p>
<ul>
<li>假如通过udp打洞后，NAT不检测协议，而允许把tcp包转发到主机上，那么主机的防火墙就会把包丢弃。</li>
<li>因为NAT是基于地址端口的，从<strong>理论上</strong>说端口限制锥形只要报文源、目的地址端口匹配即可；但也只是理论，<strong>不排除NAT也会把tcp拦下来</strong>。</li>
</ul>
<p>因此可以得出简单的结论：内网穿透时，使用udp打洞后只能打出一条udp的隧道；要打出tcp隧道，就要让某个内网客户端先发tcp的包。也就是说：<strong>在基于NAT的情况下，内网穿透只要打穿地址和端口；而在基于防火墙的情况下，内网穿透还要打穿特定协议的隧道</strong>。</p>
<hr>
<h2 id="TCP打洞"><a href="#TCP打洞" class="headerlink" title="TCP打洞"></a>TCP打洞</h2><p>我们可以重新设计：</p>
<ul>
<li>首先服务器通知双方端口和ip</li>
<li>不进行udp打洞，直接发tcp包。这里的实现是：<strong>双方同时进行connect</strong>，利用connect在内核的重传机制（syn是会重传的），第一个tcp包会给对方NAT丢掉（因为没有udp打洞），因为有重传机制不会马上就返回错误。然后对方能进行connect过来（本地防火墙和NAT都允许入站了），本地发现在connect也就建立连接了。同时进行connect建立tcp连接可以参考我为此研究后写的博客：<a href="https://jysama.cn/2022/11/01/TCP%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80/">TCP同时打开-深度剖析 | JySama</a></li>
</ul>
<p>这里面：</p>
<ul>
<li><strong>服务器通知双方的NAT地址和端口是必要的</strong>，否则对方根本不知道网关的地址；其次，如果不通知端口，对方只能请求到预设端口，但是NAT中端口映射不一定相同，会给NAT丢弃</li>
<li><strong>udp、tcp套接字绑定端口也是必要的</strong>，这主要是为了<strong>udp和tcp端口同步</strong>。因为<ul>
<li>回环时，服务器发回去的是客户端通告的“我要绑定的端口”，然后双方根据这个通告的端口要连接。</li>
<li>没有回环时，使用的是NAT的端口，这只需要让udp套接字（与服务器交互）和tcp套接字（p2p交互）绑定在一个端口上即可，因为服务器发回的是NAT是建立了udp的端口，如果tcp套接字使用了不同的端口，那么在NAT上就重新建立了一条映射，这时请求udp端口的tcp连接肯定失败了，因为tcp的syn经过服务器发的端口到了udp的套接字。</li>
</ul>
</li>
<li>如果udp和tcp不绑定端口的话，当使用udp时，内核分配一个端口；使用tcp时connect时，又分配一个端口，可能就导致端口不一致了。</li>
</ul>
<p><strong>关于connect的建立机制，而不用listen-accept，这个还需要更详细地研究。</strong>（注：已研究透彻，为此写了一篇博客：<a href="https://jysama.cn/2022/11/01/TCP%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80/">TCP同时打开-深度剖析 | JySama</a>）</p>
<blockquote>
<ul>
<li>目前是1对1传输文件，不涉及1对多的p2p，互相connect即可。</li>
<li>如果是1对多，那么tcp的一个端口要connect多个对端，只用设置端口可重用即可<code>SO_REUSEADDR</code>，将多个套接字绑定到一个端口。这里不做研究</li>
</ul>
</blockquote>
<p>外网客户端：取消了udp打洞</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span>&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;client2&quot;</span>;<span class="comment">//client1或client2</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_tcp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//初始化一个端口</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> udpfd;</span><br><span class="line">    <span class="type">int</span> tcpfd;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">22222</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, port);</span><br><span class="line">    <span class="built_in">init_tcp_Socket</span>(tcpfd,port);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(udpfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 2 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getchar();//阻塞</span></span><br><span class="line">    <span class="comment">//先接收A发送的消息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    <span class="comment">//res = recvfrom(udpfd, recvbuf, 128, 0, (struct sockaddr*)&amp;server, &amp;addr_len);</span></span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//printf(&quot;recv: %s\n&quot;,recvbuf);</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//res = sendto(udpfd, sendbuf, strlen(sendbuf), 0, (struct sockaddr*)&amp;gateway, sizeof(gateway));</span></span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//printf(&quot;send...\n&quot;);</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;connect fail !\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;connect to server successfully!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">send</span>(tcpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(udpfd);</span><br><span class="line">    <span class="built_in">close</span>(tcpfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内网客户端：取消了udp打洞</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span><span class="comment">//除了inet_pton</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span><span class="comment">//inet_pton，inet_ntop（获取ip）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)<span class="comment">//链接dll</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;101.34.2.129&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> udpPORT3 = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> myport = <span class="number">22222</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//初始化WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;<span class="comment">//WSADATA结构体变量的地址值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><br><span class="line">    <span class="comment">//成功时会返回0，失败时返回非零的错误代码值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//windows下有bug</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在 Windows 中，如果主机 A 使用 UDP 套接字并调用 sendto() 向主机 B 发送内容，</span></span><br><span class="line"><span class="comment">    但 B 没有绑定(bind)任何端口，因此 B 不会收到消息，并且然后宿主A调用recvfrom()接收一些消息，r</span></span><br><span class="line"><span class="comment">    ecvfrom()会失败，WSAGetLastError()会返回10054。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这是 Windows 的错误。如果UDP socket在发送消息后recv一个ICMP(port unreachable)消息，</span></span><br><span class="line"><span class="comment">    这个错误会被存储，下次调用recvfrom()会返回这个错误。</span></span><br><span class="line"><span class="comment">    可以使用下面代码禁用错误</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//获取主机名</span></span><br><span class="line">    <span class="comment">//根据主机名获取主机信息列表，有多个ip（网卡）</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//需要禁用c4996警报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;<span class="comment">//转型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        <span class="comment">//cout &lt;&lt; addr &lt;&lt; endl;</span></span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udp_hole_punching</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> port)</span><span class="comment">//向服务器发送udp</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送数据，最后的len不用传地址，因为是告知，不用修改</span></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>];<span class="comment">//取最后一个</span></span><br><span class="line">    string myip_port = myip + <span class="string">&quot; &quot;</span> + <span class="built_in">to_string</span>(myport);</span><br><span class="line">    <span class="comment">//现在发送信息是本机ip</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(), myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_tcp_Socket</span><span class="params">(SOCKET&amp; tcpfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//定义socketfd，它要绑定监听的网卡地址和端口</span></span><br><span class="line">    tcpfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<span class="comment">//第三个参数写0也可以，这里表示创建tcp套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);<span class="comment">//字节序转换</span></span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//INADDR_ANY表示监听所有网卡地址，0.0.0.0；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字和地址端口信息，sockaddr_in转成sockaddr</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;bind error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//cerr不经过缓冲而直接输出，一般用于迅速输出出错信息，是标准错误，默认情况下被关联到标准输出流，但它不被缓冲.</span></span><br><span class="line">        <span class="comment">//也就说错误消息可以直接发送到显示器，而无需等到缓冲区或者新的换行符时，才被显示。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line"></span><br><span class="line">    SOCKET udpfd;</span><br><span class="line">    SOCKET tcpfd;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(udpfd, myport);</span><br><span class="line">    <span class="built_in">init_tcp_Socket</span>(tcpfd, myport);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udp_hole_punching</span>(udpfd, SERVER_IP, udpPORT3))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发完就接收信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;<span class="comment">//表示网关</span></span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv from server...\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string ip = ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string portx = ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client 1 recv: ip: %s, port: %s\n&quot;</span>, ip.<span class="built_in">c_str</span>(), portx.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面向对方发信息</span></span><br><span class="line">    <span class="comment">//定义sockaddr_in</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;<span class="comment">//告知要发送的目标ip及端口</span></span><br><span class="line">    gateway.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(portx));<span class="comment">//字节序转换</span></span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello!!&quot;</span>;</span><br><span class="line">    <span class="comment">//res = sendto(udpfd, sendbuf, strlen(sendbuf), 0, (struct sockaddr*)&amp;gateway, sizeof(gateway));</span></span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//printf(&quot;send...\n&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    <span class="comment">//len要传地址，因为要保存写入结构体的长度</span></span><br><span class="line">    <span class="comment">//res = recvfrom(udpfd, recvbuf, 128, 0, (struct sockaddr*)&amp;server, &amp;addr_len);</span></span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf(&quot;recv: %s\n&quot;, recvbuf);</span></span><br><span class="line">    <span class="comment">//准备接收连接</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(tcpfd, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway)) == <span class="number">-1</span>)<span class="comment">//先发个tcp连接包</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect fail !\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始监听</span></span><br><span class="line">    <span class="comment">//if (listen(tcpfd, SOMAXCONN) == -1)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">     <span class="comment">//   printf(&quot;listen error %d!\n&quot;, WSAGetLastError());</span></span><br><span class="line">     <span class="comment">//   return 0;</span></span><br><span class="line">   <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">///客户端套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct sockaddr_in client_addr;//获取客户的地址和端口号，连接后的不分配新端口</span></span><br><span class="line"><span class="comment">    socklen_t len = sizeof(client_addr);//socklen_t 相当于 int，但使用int必须强制转型告知编译器</span></span><br><span class="line"><span class="comment">    SOCKET conn = accept(tcpfd, (struct sockaddr*)&amp;client_addr, &amp;len);//阻塞，等待连接，成功则创建连接套接字conn描述这个用户</span></span><br><span class="line"><span class="comment">    if (conn == -1)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        std::cerr &lt;&lt; &quot;connect error&quot; &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">        closesocket(tcpfd);</span></span><br><span class="line"><span class="comment">        return 0;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line">    <span class="type">int</span> nRecv = <span class="built_in">recv</span>(tcpfd, recvbuf, <span class="built_in">sizeof</span>(recvbuf), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nRecv == SOCKET_ERROR)<span class="comment">//copy出错</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;connection to client has been failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">        <span class="built_in">closesocket</span>(tcpfd);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv: %s\n&quot;</span>, recvbuf);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">    <span class="built_in">closesocket</span>(tcpfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有udp打洞的tcp连接：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E9%80%86%E5%90%91%E8%BF%9E%E6%8E%A5tcp%E8%BF%9E%E6%8E%A5.png" alt="image-20221101000011682"></p>
<p>无udp打洞的tcp连接：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E6%97%A0udp%E6%89%93%E6%B4%9Etcp%E8%BF%9E%E6%8E%A5.png" alt="image-20221101091010430"></p>
<h1 id="补充：已利用udp打洞成功穿透两个NAT"><a href="#补充：已利用udp打洞成功穿透两个NAT" class="headerlink" title="补充：已利用udp打洞成功穿透两个NAT"></a>补充：已利用udp打洞成功穿透两个NAT</h1><p>代码用NAT回环的代码即可。对方是另一个大学的寝室网络，接了路由器不是校园网，所以是圆锥型的NAT，可以成功。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/udp%E6%88%90%E5%8A%9F%E6%89%93%E6%B4%9E.png" alt="image-20221105114055816"></p>
<h1 id="代码整理（封装）"><a href="#代码整理（封装）" class="headerlink" title="代码整理（封装）"></a>代码整理（封装）</h1><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>头文件<code>udp_hole_punch.h</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UDP_HOLE_PUNCH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HOLE_PUNCH_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Using UDP requires disabling errors</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_UDP_CONNRESET _WSAIOW(IOC_VENDOR, 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable: 4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span>; <span class="comment">//init WSA</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initUdpSocket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span>; <span class="comment">//init blocking socket</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span>; <span class="comment">//get host private ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//send udp segment to server</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">notifyServer</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort, <span class="type">const</span> <span class="type">int</span> myPort)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//send one or more messages to the other party(punch a hole)</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udpHolePunch</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* gateway_ip, <span class="type">const</span> <span class="type">int</span> gatewayPort)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//active, receiver</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udpPunchSide</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort , <span class="type">const</span> <span class="type">int</span> myPort)</span></span>;</span><br><span class="line"><span class="comment">//passive, sender, return gateway ip and port</span></span><br><span class="line"><span class="function">pair&lt;string,<span class="type">int</span>&gt; <span class="title">udpPunchedSide</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort, <span class="type">const</span> <span class="type">int</span> myPort)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;udp_hole_punch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//init WSA</span></span><br><span class="line">    WORD sockVersion = <span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;WSAStartup() error!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//blocking socket</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initUdpSocket</span><span class="params">(SOCKET&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_UDP); <span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span> (listenfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//bind port</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind port-%d error !\n&quot;</span>, port);</span><br><span class="line">        <span class="built_in">closesocket</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Using UDP requires disabling errors</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If sending a datagram using the sendto function results in an &quot;ICMP port unreachable&quot; response and the select function is set for readfds,</span></span><br><span class="line"><span class="comment">    * the program returns 1 and the subsequent call to the recvfrom function does not work with a WSAECONNRESET (10054) error response.</span></span><br><span class="line"><span class="comment">    * In Microsoft Windows NT 4.0, this situation causes the select function to block or time out.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    BOOL bEnalbeConnRestError = FALSE;</span><br><span class="line">    DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WSAIoctl</span>(listenfd, SIO_UDP_CONNRESET, &amp;bEnalbeConnRestError, <span class="built_in">sizeof</span>(bEnalbeConnRestError), \</span><br><span class="line">        <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwBytesReturned, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">getIpList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;string&gt; result;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> getNameRet = <span class="built_in">gethostname</span>(name, <span class="built_in">sizeof</span>(name));<span class="comment">//get host name</span></span><br><span class="line">    <span class="comment">//get private ip list</span></span><br><span class="line">    hostent* host = <span class="built_in">gethostbyname</span>(name);<span class="comment">//need to disable c4996 error</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == host)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    in_addr* pAddr = (in_addr*)*host-&gt;h_addr_list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; host-&gt;h_addr_list[i] != <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ip[<span class="number">20</span>] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;pAddr[i], ip, <span class="number">16</span>);</span><br><span class="line">        string addr = ip;</span><br><span class="line">        result.<span class="built_in">push_back</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//send udp segment to server</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">notifyServer</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort , <span class="type">const</span> <span class="type">int</span> myPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(serverPort);</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, server_ip, &amp;socketaddr.sin_addr);</span><br><span class="line"></span><br><span class="line">    vector&lt;string&gt; myipList = <span class="built_in">getIpList</span>();</span><br><span class="line">    string myip = myipList[myipList.<span class="built_in">size</span>() - <span class="number">1</span>]; <span class="comment">//send the last one </span></span><br><span class="line">    string myip_port = myip + <span class="string">&quot; &quot;</span> + <span class="built_in">to_string</span>(myPort);</span><br><span class="line">    <span class="comment">//send the private ip</span></span><br><span class="line">    <span class="type">size_t</span> res = <span class="built_in">sendto</span>(udpfd, myip_port.<span class="built_in">c_str</span>(), myip_port.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr, <span class="built_in">sizeof</span>(socketaddr));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//send one or more messages to the other party(punch a hole)</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udpHolePunch</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* gateway_ip, <span class="type">const</span> <span class="type">int</span> gatewayPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;</span><br><span class="line">    gateway.sin_family = AF_INET;</span><br><span class="line">    gateway.sin_port = <span class="built_in">htons</span>(gatewayPort);</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, gateway_ip, &amp;gateway.sin_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> sendbuf[<span class="number">10</span>] = <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">    <span class="comment">//send two messages</span></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error1!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res = <span class="built_in">sendto</span>(udpfd, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;gateway, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error2!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">udpPunchSide</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort, <span class="type">const</span> <span class="type">int</span> myPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">initUdpSocket</span>(udpfd, myPort);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//send message to server</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">notifyServer</span>(udpfd, server_ip, serverPort, myPort))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//recvfrom server</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;</span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv from server error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string gateway_ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = gateway_ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string gateway_ip = gateway_ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string gateway_port = gateway_ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client recv: ip: %s, port: %s\n&quot;</span>, gateway_ip.<span class="built_in">c_str</span>(), gateway_port.<span class="built_in">c_str</span>()); <span class="comment">//debug</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">udpHolePunch</span>(udpfd, gateway_ip.<span class="built_in">c_str</span>(), <span class="built_in">stoi</span>(gateway_port)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punch error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">pair&lt;string, <span class="type">int</span>&gt; <span class="title">udpPunchedSide</span><span class="params">(SOCKET&amp; udpfd, <span class="type">const</span> <span class="type">char</span>* server_ip, <span class="type">const</span> <span class="type">int</span> serverPort, <span class="type">const</span> <span class="type">int</span> myPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">initSocket</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">initUdpSocket</span>(udpfd, myPort);</span><br><span class="line">    pair&lt;string, <span class="type">int</span>&gt; pairRes;</span><br><span class="line">    pairRes.first = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    pairRes.second = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//send message to server</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">notifyServer</span>(udpfd, server_ip, serverPort, myPort))</span><br><span class="line">        <span class="keyword">return</span> pairRes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//recvfrom server</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;</span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(server);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> res = <span class="built_in">recvfrom</span>(udpfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;server, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span> (res == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;recv from server error %d!\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> pairRes;</span><br><span class="line">    &#125;</span><br><span class="line">    string gateway_ip_port = recvbuf;</span><br><span class="line">    <span class="type">size_t</span> pos1 = gateway_ip_port.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    string gateway_ip = gateway_ip_port.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">    string gateway_port = gateway_ip_port.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;client recv: ip: %s, port: %s\n&quot;</span>, gateway_ip.<span class="built_in">c_str</span>(), gateway_port.<span class="built_in">c_str</span>()); <span class="comment">//debug</span></span><br><span class="line">    pairRes.first = gateway_ip;</span><br><span class="line">    pairRes.second = <span class="built_in">stoi</span>(gateway_port);</span><br><span class="line">    <span class="keyword">return</span> pairRes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端调用示例"><a href="#客户端调用示例" class="headerlink" title="客户端调用示例"></a>客户端调用示例</h2><p>main函数调用，接收方主动打洞，发送方不打洞。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;udp_hole_punch.h&quot;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;a.b.c.d&quot;</span>; <span class="comment">//your server</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> SERVERUDPPORT = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MYPORT = <span class="number">22222</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SOCKET udpfd;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">udpPunchSide</span>(udpfd, SERVER_IP, SERVERUDPPORT, MYPORT))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">		<span class="built_in">WSACleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//do other thing...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//end</span></span><br><span class="line">	<span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">	<span class="built_in">WSACleanup</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;udp_hole_punch.h&quot;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* SERVER_IP = <span class="string">&quot;a.b.c.d&quot;</span>; <span class="comment">//your server</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> SERVERUDPPORT = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MYPORT = <span class="number">22222</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SOCKET udpfd;</span><br><span class="line">	pair&lt;string, <span class="type">int</span>&gt; gateway = <span class="built_in">udpPunchedSide</span>(udpfd, SERVER_IP, SERVERUDPPORT, MYPORT);</span><br><span class="line">	<span class="keyword">if</span> (gateway.first == <span class="string">&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">		<span class="built_in">WSACleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>* gateway_ip = gateway.first.<span class="built_in">c_str</span>();</span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> gateway_port = gateway.second;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//do other thing...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//end</span></span><br><span class="line">	<span class="built_in">closesocket</span>(udpfd);</span><br><span class="line">	<span class="built_in">WSACleanup</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>,port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">    socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Port reused</span></span><br><span class="line">    <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//bind</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;</span><br><span class="line">    <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">    <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">        string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line">        </span><br><span class="line">        string host = <span class="built_in">string</span>(recvbuf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp hole punching  NAT ip: %s, port: %s; host:%s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>(),host.<span class="built_in">c_str</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port+<span class="string">&quot; &quot;</span>+host;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    str = str + <span class="string">&quot; &quot;</span>;<span class="comment">//add a space</span></span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//move rvalue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> listenudp;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> port = <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">init_udp_Socket</span>(listenudp , port);</span><br><span class="line">    string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">    <span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    vector&lt;string&gt; host1 = <span class="built_in">parse</span>(ip_port1);</span><br><span class="line">    vector&lt;string&gt; host2 = <span class="built_in">parse</span>(ip_port2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The server sends back using a NAT ip</span></span><br><span class="line">    string ip1 = host1[<span class="number">0</span>];</span><br><span class="line">    string port1 = host1[<span class="number">1</span>];</span><br><span class="line">    string ip2 = host2[<span class="number">0</span>];</span><br><span class="line">    string port2 = host2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;</span><br><span class="line">    socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;</span><br><span class="line">    socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">    socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ip1 != ip2) <span class="comment">//Different intranets</span></span><br><span class="line">    &#123;</span><br><span class="line">        ip_port1 = ip1 + <span class="string">&quot; &quot;</span> + port1;</span><br><span class="line">        ip_port2 = ip2 + <span class="string">&quot; &quot;</span> + port2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//In the same NAT</span></span><br><span class="line">    &#123;</span><br><span class="line">        ip_port1 = host1[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host1[<span class="number">3</span>];</span><br><span class="line">        ip_port2 = host2[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host2[<span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">                  ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                     ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/11/01/TCP%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/01/TCP%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80/" class="post-title-link" itemprop="url">TCP同时打开-深度剖析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-01 21:14:05 / 修改时间：23:09:56" itemprop="dateCreated datePublished" datetime="2022-11-01T21:14:05+08:00">2022-11-01</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在socket的编程中偶然发现了两端同时connect可以不经过listen-accept而建立tcp连接，然后去找了许多资料，发现这个现象叫<code>同时打开</code>，下面就来具体研究这个连接的建立情况。</p>
<p><strong>同时打开需要去连接对方的端口，因此客户在connect之前需要bind一个端口。</strong></p>
<p>参考资料：</p>
<ul>
<li>1）<a target="_blank" rel="noopener" href="https://blog.csdn.net/dog250/article/details/80518481">(33条消息) 关于TCP同时打开-无需Listener的TCP连接建立过程_dog250的博客-CSDN博客</a></li>
<li>2）<a target="_blank" rel="noopener" href="http://t.zoukankan.com/wanpengcoder-p-11751246.html">TCP连接建立 之 同时打开 - 走看看 (zoukankan.com)</a></li>
<li>3）<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011130578/article/details/44408713">(33条消息) 3.4 同时打开_Remy1119的博客-CSDN博客</a></li>
<li>4）<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/422385138">动图图解！没有accept，能建立TCP连接吗？ - 知乎 (zhihu.com)</a></li>
<li>5）<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/506042622">一道腾讯面试题目：没有listen，能否建立TCP连接 - 知乎 (zhihu.com)</a></li>
<li>6）<a target="_blank" rel="noopener" href="https://juejin.cn/post/6977340098287239198">TCP的握手（三次、同时）与挥手（四次、同时）理解 - 掘金 (juejin.cn)</a></li>
</ul>
<p>在参考资料的基础上，整理了整个逻辑，并补充了序列号确认的流程和能同步的原因，以及syn丢包时能成功建立的原因。</p>
<h1 id="connect与accept"><a href="#connect与accept" class="headerlink" title="connect与accept"></a>connect与accept</h1><p>我从tcp正常的建立说起。</p>
<p>在简单的服务器-客户端模型中，服务器在执行<code>listen()</code>方法之后还会执行一个<code>accept()</code>方法，并阻塞等待客户端连接。客户端在创建socket后可以调用<code>connect()</code>方法来连接服务器。这个过程中，TCP的三次握手究竟什么时候完成呢?</p>
<p>在<strong>参考资料4</strong>中，作者在执行accept前进行sleep等待，让客户端直接去connect并抓包。作者的抓包结果如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%801.jpg" alt="img"></p>
<p>从抓包结果看来，就算不执行accept()方法，三次握手照常进行，并顺利建立连接。</p>
<hr>
<p>从listen开始说起，在服务器执行listen方法后，就会进入监听（LISTEN)状态，内核会为每个处于监听状态的socket分配两个队列：半连接队列和全连接队列。相信这两个队列大家也不陌生了。</p>
<ul>
<li><strong>半连接队列（SYN队列）</strong>，服务端收到<strong>第一次握手</strong>后，会将<code>socket</code>加入到这个队列中，队列内的<code>socket</code>都处于<code>SYN_RECV</code> 状态。然后发回syn+ack执行第二次握手。</li>
<li><strong>全连接队列（ACCEPT队列）</strong>，在服务端收到<strong>第三次握手</strong>后，会将半连接队列的<code>socket</code>取出，放到全连接队列中。队列里的<code>socket</code>都处于 <code>ESTABLISHED</code>状态。这里面的连接，就<strong>等着服务端执行accept()后被取出了。</strong></li>
</ul>
<p>这就是说，<strong>accept实际上只是从全连接队列取出一条连接</strong>，不参与TCP三次握手的过程。</p>
<p>这两个队列将详细点，<strong>全连接队列（icsk_accept_queue）是个链表</strong>，而<strong>半连接队列（syn_table）是个哈希表</strong>。</p>
<img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97%E5%8D%8A%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97.jpg" alt="img" style="zoom: 50%;" />

<p>这是因为全连接队列只需要把头部的连接给accept即可，维护一个线性结构就可以了。</p>
<p>而半连接队列中的连接都不是完整的连接，在等待第三次握手的到来。当第三次握手到来时，要根据IP端口来看是哪个socket，这就需要哈希表查找。这样，两个队列是时间复杂度都是O(1)。</p>
<p><strong>参考资料4</strong>还谈到了这两个队列满了会怎么样，不是本文重点，有兴趣的朋友可以去看看。</p>
<ul>
<li>全连接队列满了，再来第三次握手也会丢弃，此时如果<code>tcp_abort_on_overflow=1</code>，还会直接发<code>RST</code>给客户端。</li>
<li>半连接队列满了，可能是因为受到了<code>SYN Flood</code>攻击，可以设置<code>tcp_syncookies</code>，绕开半连接队列。</li>
</ul>
<h1 id="connect是如何保存socket信息的"><a href="#connect是如何保存socket信息的" class="headerlink" title="connect是如何保存socket信息的"></a>connect是如何保存socket信息的</h1><p>当服务端回复syn+ack时，客户端实际上也没有处于listen状态的套接字，<strong>没有半连接队列和全连接队列</strong>，但却可以完成三次握手。这意味着，客户端进行connect调用后，该<strong>套接字一定被加入到某个表</strong>中，并可以被匹配到。</p>
<p>跟踪内核源码可以看到当调用connect时，对应的套接字就被加入了全局的tcp已连接（established）的表中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">tcp_v4_connect</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> sockaddr *uaddr, <span class="type">int</span> addr_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Socket identity is still unknown (sport may be zero).</span></span><br><span class="line"><span class="comment">     * However we set state to SYN-SENT and not releasing socket</span></span><br><span class="line"><span class="comment">     * lock select source port, enter ourselves into the hash tables and</span></span><br><span class="line"><span class="comment">     * complete initialization after this.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">tcp_set_state</span>(sk, TCP_SYN_SENT);</span><br><span class="line">    err = <span class="built_in">inet_hash_connect</span>(&amp;tcp_death_row, sk);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这句注释 <em>enter ourselves into the hash tables</em>，在<code>inet_hash_connect</code>函数中，<strong>socket在调用connect的时候就会把自己加入到establish hash表，虽然它此时连syn都还没有发送</strong>。确切的讲，应该是在它调用的<code>__inet_check_established</code>函数中。</p>
<p>当内核收到syn+ack报文时，内核是<strong>先在established表中查找，再进行listen表的查找</strong>。对于客户端来说，syn+ack报文必然可以在已连接表中匹配上对应的套接字。</p>
<h1 id="同时打开"><a href="#同时打开" class="headerlink" title="同时打开"></a>同时打开</h1><p>现在进入本文的重点</p>
<p>同时打开连接是指通信的双方在接收到对方的SYN包之前，都进行了主动打开的操作并发出了自己的SYN包。如之前所说一个四元组标识一个TCP连接，因此如果一个TCP连接要同时打开需要通信的双方知晓对方的IP和端口信息才行，这种场景在实际情况中很少发生(NAT穿透中可能会多一些)。同时打开的流程如下图</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="image.png"></p>
<h2 id="状态转移"><a href="#状态转移" class="headerlink" title="状态转移"></a>状态转移</h2><p>套接字有以下三种状态：</p>
<ul>
<li>在发送syn之后状态处于SYN_SENT状态；</li>
<li>SYN_RECV状态；</li>
<li>ESTABLISHED状态。</li>
</ul>
<p>在正常的连接过程中，客户端向服务器在监听的端口发起connect，第一次握手发送syn后进入SYN_SENT状态，服务器发回syn+ack之后进入ESTABLISHED状态，服务器处的端口处于SYN_RECV状态，并在第三次握手中发回ack后进入ESTABLISHED状态。</p>
<p>SYN_RECV状态还可以是：处于SYN_SENT状态的套接字接收到syn后会进入的状态。这个过程中，客户发送syn并收到syn，就是一个同时打开的过程（双方同时connect）。</p>
<p>假设两台设备双方均发送syn给对端，理想情况下，<strong>在发送syn之后状态处于SYN_SENT状态，此时双方均收到对端的发来的syn，则立即进入SYN_RECV状态，并且都向对端回复syn+ack，在收到syn+ack之后，连接从SYN_RECV状态切换到ESTABLISHED状态。</strong></p>
<p>在发送syn进入SYN_SENT状态之后，收到对端发来的syn包处理流程如下。如果收到syn，进入SYN_RECV状态。如果收到的是ack（syn+ack和ack两种），会进入另外的处理流程，稍后再说。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">tcp_rcv_synsent_state_process</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">const</span> <span class="keyword">struct</span> tcphdr *th)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    	<span class="keyword">struct</span> <span class="title class_">inet_connection_sock</span> *icsk = <span class="built_in">inet_csk</span>(sk);</span><br><span class="line">    	<span class="keyword">struct</span> <span class="title class_">tcp_sock</span> *tp = <span class="built_in">tcp_sk</span>(sk);</span><br><span class="line">    	<span class="keyword">struct</span> <span class="title class_">tcp_fastopen_cookie</span> foc = &#123; .len = <span class="number">-1</span> &#125;;</span><br><span class="line">    	<span class="type">int</span> saved_clamp = tp-&gt;rx_opt.mss_clamp;</span><br><span class="line">	...</span><br><span class="line">   	<span class="keyword">if</span> (th-&gt;ack) &#123;  <span class="comment">//包中带ACK标记，走此路径</span></span><br><span class="line">   	...<span class="comment">//另外的处理流程</span></span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="keyword">if</span> (th-&gt;syn) &#123;</span><br><span class="line">        <span class="comment">/* We see SYN without ACK. It is attempt of</span></span><br><span class="line"><span class="comment">         * simultaneous connect with crossed SYNs.</span></span><br><span class="line"><span class="comment">         * Particularly, it can be connect to self.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">tcp_set_state</span>(sk, TCP_SYN_RECV);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;rx_opt.saw_tstamp) &#123;</span><br><span class="line">            tp-&gt;rx_opt.tstamp_ok = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">tcp_store_ts_recent</span>(tp);</span><br><span class="line">            tp-&gt;tcp_header_len =</span><br><span class="line">                <span class="built_in">sizeof</span>(<span class="keyword">struct</span> tcphdr) + TCPOLEN_TSTAMP_ALIGNED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tp-&gt;tcp_header_len = <span class="built_in">sizeof</span>(<span class="keyword">struct</span> tcphdr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tp-&gt;rcv_nxt = <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;seq + <span class="number">1</span>;</span><br><span class="line">        tp-&gt;copied_seq = tp-&gt;rcv_nxt;</span><br><span class="line">        tp-&gt;rcv_wup = <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;seq + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* RFC1323: The window in SYN &amp; SYN/ACK segments is</span></span><br><span class="line"><span class="comment">         * never scaled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tp-&gt;snd_wnd    = <span class="built_in">ntohs</span>(th-&gt;window);</span><br><span class="line">        tp-&gt;snd_wl1    = <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;seq;</span><br><span class="line">        tp-&gt;max_window = tp-&gt;snd_wnd;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">tcp_ecn_rcv_syn</span>(tp, th);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">tcp_mtup_init</span>(sk);</span><br><span class="line">        <span class="built_in">tcp_sync_mss</span>(sk, icsk-&gt;icsk_pmtu_cookie);</span><br><span class="line">        <span class="built_in">tcp_initialize_rcv_mss</span>(sk);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">tcp_send_synack</span>(sk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个负责发送SYN+ACK的函数tcp_send_synack有些特殊：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">tcp_send_synack</span><span class="params">(<span class="keyword">struct</span> sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sk_buff</span> *skb;</span><br><span class="line"></span><br><span class="line">    skb = <span class="built_in">tcp_write_queue_head</span>(sk);</span><br><span class="line">    <span class="keyword">if</span> (skb == <span class="literal">NULL</span> || !(<span class="built_in">TCP_SKB_CB</span>(skb)-&gt;tcp_flags &amp; TCPHDR_SYN)) &#123;　<span class="comment">//包一定携带SYN标记</span></span><br><span class="line">        <span class="built_in">pr_debug</span>(<span class="string">&quot;%s: wrong queue state\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="built_in">TCP_SKB_CB</span>(skb)-&gt;tcp_flags &amp; TCPHDR_ACK)) &#123;　<span class="comment">//未携带ACK标记</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">skb_cloned</span>(skb)) &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">sk_buff</span> *nskb = <span class="built_in">skb_copy</span>(skb, GFP_ATOMIC);</span><br><span class="line">            <span class="keyword">if</span> (nskb == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">            <span class="built_in">tcp_unlink_write_queue</span>(skb, sk);</span><br><span class="line">            <span class="built_in">skb_header_release</span>(nskb);</span><br><span class="line">            __tcp_add_write_queue_head(sk, nskb);</span><br><span class="line">            <span class="built_in">sk_wmem_free_skb</span>(sk, skb);</span><br><span class="line">            sk-&gt;sk_wmem_queued += nskb-&gt;truesize;</span><br><span class="line">            <span class="built_in">sk_mem_charge</span>(sk, nskb-&gt;truesize);</span><br><span class="line">            skb = nskb;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;tcp_flags |= TCPHDR_ACK;　<span class="comment">//加上ACK标记</span></span><br><span class="line">        <span class="built_in">TCP_ECN_send_synack</span>(<span class="built_in">tcp_sk</span>(sk), skb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;when = tcp_time_stamp;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tcp_transmit_skb</span>(sk, skb, <span class="number">1</span>, GFP_ATOMIC);　<span class="comment">//发送出去</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在同时打开的情况下，发送队列中已经有一个SYN包等待确认。tcp_send_synack的基本功能是：将发送队列中的SYN包加上ACK标记位再发送。这样TCP收到SYN后发送的SYN+ACK的序列号与最开始发送的SYN包一致，ack的确认号是对方syn的序列号+1，连接就可以在收到对端的SYN+ACK后得以正常建立。</p>
<hr>
<p>在SYN_RECV状态收到对端发来的syn+ack包，则直接进入ESTABLISHED已连接状态：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">tcp_rcv_state_process</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> sk_buff *skb)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">         <span class="comment">/* step 5: check the ACK field */</span></span><br><span class="line">     acceptable = <span class="built_in">tcp_ack</span>(sk, skb, FLAG_SLOWPATH |</span><br><span class="line">                       FLAG_UPDATE_TS_RECENT) &gt; <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">switch</span> (sk-&gt;sk_state) &#123;</span><br><span class="line">     <span class="keyword">case</span> TCP_SYN_RECV:</span><br><span class="line"> </span><br><span class="line">         <span class="comment">/* ack处理失败 */</span></span><br><span class="line">         <span class="keyword">if</span> (!acceptable)</span><br><span class="line">             <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">/* RTT */</span></span><br><span class="line">         <span class="keyword">if</span> (!tp-&gt;srtt_us)</span><br><span class="line">             <span class="built_in">tcp_synack_rtt_meas</span>(sk, req);</span><br><span class="line"> </span><br><span class="line">         <span class="comment">/* Once we leave TCP_SYN_RECV, we no longer need req</span></span><br><span class="line"><span class="comment">          * so release it.</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         <span class="keyword">if</span> (req) &#123;</span><br><span class="line">             <span class="built_in">inet_csk</span>(sk)-&gt;icsk_retransmits = <span class="number">0</span>;</span><br><span class="line">             <span class="built_in">reqsk_fastopen_remove</span>(sk, req, <span class="literal">false</span>);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">/* Make sure socket is routed, for correct metrics. */</span></span><br><span class="line">             <span class="comment">/* 检查重建路由 */</span></span><br><span class="line">             icsk-&gt;icsk_af_ops-&gt;<span class="built_in">rebuild_header</span>(sk);</span><br><span class="line">             <span class="comment">/* 初始化拥塞邋控制 */</span></span><br><span class="line">             <span class="built_in">tcp_init_congestion_control</span>(sk);</span><br><span class="line">             <span class="comment">/* 路径mtu发现初始化 */</span></span><br><span class="line">             <span class="built_in">tcp_mtup_init</span>(sk);</span><br><span class="line">             <span class="comment">/* 用户待读取数据初始化 */</span></span><br><span class="line">             tp-&gt;copied_seq = tp-&gt;rcv_nxt;</span><br><span class="line">             <span class="comment">/* 调整接收发送缓存以及窗口等 */</span></span><br><span class="line">             <span class="built_in">tcp_init_buffer_space</span>(sk);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">smp_mb</span>();</span><br><span class="line"> </span><br><span class="line">         <span class="comment">/* 连接更新为已连接状态 */</span></span><br><span class="line">         <span class="built_in">tcp_set_state</span>(sk, TCP_ESTABLISHED);</span><br><span class="line">         sk-&gt;<span class="built_in">sk_state_change</span>(sk);</span><br><span class="line">                 <span class="comment">/* 省略了一些代码 */</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="序列号确认"><a href="#序列号确认" class="headerlink" title="序列号确认"></a>序列号确认</h2><p>如流程图所示，假设客户端A的syn序列号为x，B的syn序列号为y。双方收到对方的syn时，发送的syn+ack序列号为，A：<code>syn-x+ack-y+1</code>；B：<code>syn-y+ack-x+1</code>。</p>
<p>这样，A收到B的syn+ack时，A知道这个是B过来的（syn还是y）；并且知道B收到的就是自己的syn（ack确认号是x+1），至此双方序列号就完成了同步。</p>
<p>在这个过程中，有三种情况被其他客户端干扰：</p>
<ul>
<li>如果客户端C<strong>只</strong>伪造syn-z发给A，A发给B的syn-ack确认号就是z+1，B就知道不对了；</li>
<li>如果客户端C<strong>只</strong>伪造<code>syn-z+ack-n</code>发给了A，A看到syn是z而不是B的y就直接丢弃了。</li>
<li>如果客户端C两个报文都发给A，这样A查看syn+ack时发现syn是z，还要进一步查看ack，发现ack不是自己的x+1，就知道是错误了。</li>
</ul>
<h2 id="syn丢包"><a href="#syn丢包" class="headerlink" title="syn丢包"></a>syn丢包</h2><p>在双方交换四个数据包的过程中，可能会发生丢包。有四种情况：</p>
<ul>
<li>客户AB向对方发送syn，进入SYN_SEND状态，两个包都丢了，超时重传。</li>
</ul>
<hr>
<ul>
<li>客户AB向对方发送syn，但B的syn包丢了。这时AB都在SYN_SENT状态，B收到A的syn后进入SYN_RECV状态，然后发送syn+ack。<ul>
<li>A收到syn+ack时还在SYN_SENT状态，注意到源码中有另一条“ack”的处理路径。</li>
<li>实际上客户A在发送syn后收到syn+ack是与listen中的服务器正常建立连接的过程（第二次握手），A并不知道对方是服务器还是客户端，B发的<code>syn-y+ack-x+1</code>中的y在A看来就是服务器的初始序列号。此时A会返回ack并进入ESTABLISHED状态。其中ack的序列号是y+1。</li>
<li>B收到ack后发现没有syn，检查ack序列号正确，就知道是自己的syn包丢了，进入ESTABLISHED状态，连接建立完成。</li>
</ul>
</li>
<li>这个过程由于B的syn包丢了，所以实际上变成了client-server模型，退化为正常的三次握手。</li>
</ul>
<hr>
<ul>
<li>客户AB向对方发送syn都收到了，AB都进入SYN_RECV状态，发送syn+ack，如果两个包都丢了，超时重传。</li>
</ul>
<hr>
<ul>
<li>客户AB向对方发送syn都收到了，AB都进入SYN_RECV状态，发送syn+ack。<ul>
<li>假设B发送的包丢了，这时B收到syn+ack直接进入ESTABLISHED状态。</li>
<li>A一直在等待syn+ack，当超时时，A会猜测是自己的syn丢了（且syn+ack也丢了，因为syn+ack没丢的话就是第二种情况client-server）或是对方的syn+ack丢了。</li>
<li>此时如上所述，A在SYN_RECV状态超时会重传syn+ack，对于A来说，B没发回syn+ack可能有两种情况：<ul>
<li>如果B在ESTABLISHED状态，知道自己syn+ack丢了，发回syn+ack让A进入ESTABLISHED状态。</li>
<li>如果B根本就没收到syn（B知道自己发了syn），此时退化为client-server模型，发回ack。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>至此，连接建立完成。</strong></p>
<h1 id="同时关闭"><a href="#同时关闭" class="headerlink" title="同时关闭"></a>同时关闭</h1><p>同时关闭的流程和四次挥手差不多</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%90%8C%E6%97%B6%E5%85%B3%E9%97%AD2.jpg" alt="image.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>客户端在connect后在内核中会把套接字加入<code>已连接</code>哈希表，收到syn+ack报文先查<code>已连接哈希表</code>再查<code>listen半连接哈希表</code>。</li>
<li>客户端同时打开时，双方会进行syn、syn+ack四种报文的发送接收，在三种状态中转移：发送syn的SYN_SENT状态、接收syn发送syn+ack的SYN_RECV状态、接收syn+ack的ESTABLISHED状态。</li>
<li>序列号的同步中，syn发的序列号是随机初始序列号，syn+ack回复的序列号是syn的序列号（标识了该包是自己发的），确认号是对方syn序列号+1（标识了对方的包自己已经收到）。收到syn+ack后会检测序列号（该包是否是发syn的对方发来的）以及确认号（该包是否是自己想连接的发了syn过去的对方发来的）。</li>
<li>syn丢包中，如果有一个对方丢了syn包，就退化成client-server模型；如果有一个对方丢了syn+ack包，自己会重传syn+ack，对方要么重传syn+ack（对方的syn+ack丢了），要么重传ack（自己的syn丢了，退化为client-server模型）。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/10/22/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/22/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">函数模板问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-22 19:46:32 / 修改时间：20:00:50" itemprop="dateCreated datePublished" datetime="2022-10-22T19:46:32+08:00">2022-10-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>757</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>函数模板的声明和定义写在一个头文件里，因为这样在别的cpp（假设是main）里调用（相当于这个cpp就有定义）才能实例化。</p>
<p>否则main-cpp（只有声明没有定义）调用生成的obj文件会去这个头文件（函数模板的声明）对应的obj文件找相应的实例化的函数的二进制代码，但是那个obj文件对应的cpp只有定义而没有调用！而没有调用就没有实例化，所以对应的obj文件也没有实例化函数的二进制代码，这样链接就出事了。</p>
<hr>
<p>不能在函数模板中打算使用不同的case针对不同的类型进行操作（比如0对int，1对string），因为对于一个类型的函数模板调用就实例化了整个函数，这些case也会被实例在这个类型上，就会出现类型不匹配的错误（错误可不管你case几，因为调用首先要实例化，实例化就发现出错了，没有管参数是多少）。</p>
<p>比如用case0，并且实例化一个int，但是case1中也要根据int生成二进制代码，但人家是string类型，就出错了</p>
<p>这对if也是一样的。</p>
<p>比如这样，这些map对应不同的类型，就会出错。</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%981.png" alt="image-20221022195741403"></p>
<hr>
<p>上面说了case中采用不同的类型，实际上也不能在case中调用不同类型的模板函数。不要用函数模板（假设是1）调用多个函数模板（假设是2）。</p>
<p>比如一个函数模板1里switch调用不同的模板2，你只希望根据case和相应的参数来调用某个模板2，但是由于其他函数模板2也会根据这些参数的类型实例化，然而实例化很可能出错，因为你可能只考虑了某个case，而这些模板2是不同的实现。</p>
<p>比如这样，函数模板2根据map的参数和key的参数推导，但模板1只考虑了某个case和对应的key的类型，这会导致后面的case中出现map和key类型不匹配（因为map的类型1是和key类型共用的）</p>
<p><img src="https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%982.png" alt="image-20221022195831467"></p>
<p>还是那个问题，实例化考虑参数的类型，执行才考虑参数的值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/10/18/extern%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/18/extern%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">extern全局变量问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-18 23:35:46 / 修改时间：23:55:30" itemprop="dateCreated datePublished" datetime="2022-10-18T23:35:46+08:00">2022-10-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>645</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最好不要在头文件定义全局变量，很可能会出现重定义，即使使用了ifndef。</p>
<p>因为ifndef只是让预编译时头文件展开不包含重复的头文件，最后每个cpp文件的代码是包含了所有的include了的头文件的代码；</p>
<p>比如A.cpp包含了a.h，和b.h，a.h又包含了b.h，B.cpp包含了a.h；如果在b.h定义了一个全局变量，在编译时不会出错，在链接时就会出错了。</p>
<p>这是因为ifndef只是告诉A.cpp：a.h包含了b.h，不用再包含一次了；而B.cpp包含了ab两个头文件也可以编译成功，这样就cpp文件就生成了两个包含b.h的代码的obj文件，在链接时发现两个obj文件定义了同一个变量，就出现重定义错误了。</p>
<hr>
<p>因此<strong>头文件里最好只声明全局变量</strong>（可以成功是因为可能只被include一次），声明必须使用<code>extern T x;</code>，如果不用extern也视为定义只是没有初始化。</p>
<p>但需要在何处定义呢，只需要注意<strong>不能在其他头文件定义</strong>，这和前面说的是同样的道理。可以<strong>在任意的一个cpp文件里再定义一次</strong>，注意是定义不是赋值，定义要写上类型。但最好把**.h声明和.cpp定义关联起来**，因此不要随便找个cpp就定义。</p>
<p>其次，直接在cpp定义而不在.h文件声明是可行的，不过这会导致.h文件内依赖该变量的代码编译失败。但这些代码可以放到cpp内而解决这个错误，见仁见智了。</p>
<hr>
<p>总结：</p>
<ul>
<li>不要在头文件定义全局变量，声明必须使用extern</li>
<li>定义可以在任意一个cpp文件进行，但这个cpp文件最好和原来的.h文件关联起来，比较直观。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Jy</p>
  <div class="site-description" itemprop="description">Re：从零开始的写博客生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">359k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:26</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
