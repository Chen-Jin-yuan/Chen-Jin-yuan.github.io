<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jysama.cn","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="顶层设计 映射表（补：实际上可以用结构体减少映射，不过不够灵活） 线程池、任务 日志系统 聊天日志 同步非阻塞IO  为方便描述，我们做如下约定：  客户端主线程是命令行线程，另一个线程叫做接收线程 服务器主线程是接收命令线程，也叫命令线程，它只进行消息中转，命令解析与返回由线程池处理。该线程监听的端口由客户端主线程连接。 服务器另一个监听线程叫发送线程，监听的端口由客户端接收线程连接（这样服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="「orange」-server">
<meta property="og:url" content="https://jysama.cn/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="JySama">
<meta property="og:description" content="顶层设计 映射表（补：实际上可以用结构体减少映射，不过不够灵活） 线程池、任务 日志系统 聊天日志 同步非阻塞IO  为方便描述，我们做如下约定：  客户端主线程是命令行线程，另一个线程叫做接收线程 服务器主线程是接收命令线程，也叫命令线程，它只进行消息中转，命令解析与返回由线程池处理。该线程监听的端口由客户端主线程连接。 服务器另一个监听线程叫发送线程，监听的端口由客户端接收线程连接（这样服务器">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-12-18T13:02:33.502Z">
<meta property="article:modified_time" content="2022-12-18T09:33:31.881Z">
<meta property="article:author" content="Jy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jysama.cn/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>「orange」-server | JySama</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">JySama</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jysama.cn/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jy">
      <meta itemprop="description" content="Re：从零开始的写博客生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JySama">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          「orange」-server
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-18 21:02:33 / 修改时间：17:33:31" itemprop="dateCreated datePublished" datetime="2022-12-18T21:02:33+08:00">2022-12-18</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="顶层设计"><a href="#顶层设计" class="headerlink" title="顶层设计"></a>顶层设计</h1><ul>
<li>映射表（补：实际上可以用结构体减少映射，不过不够灵活）</li>
<li>线程池、任务</li>
<li>日志系统</li>
<li>聊天日志</li>
<li>同步非阻塞IO</li>
</ul>
<p>为方便描述，我们做如下约定：</p>
<ul>
<li>客户端主线程是命令行线程，另一个线程叫做接收线程</li>
<li>服务器主线程是接收命令线程，也叫命令线程，它只进行消息中转，命令解析与返回由线程池处理。该线程监听的端口由客户端主线程连接。</li>
<li>服务器另一个监听线程叫发送线程，监听的端口由客户端接收线程连接（这样服务器就能知道客户端两个连接分别属于哪个线程），信息的发送由线程池处理。</li>
</ul>
<h1 id="映射表"><a href="#映射表" class="headerlink" title="映射表"></a>映射表</h1><p>考虑一下用户在服务器里的映射信息：</p>
<ul>
<li>在连接的时候，服务器会获得套接字描述符connfd和客户端对应的ip地址和端口号；当客户端后续发信息过来时，epoll会得知事件，同时获取的是用户的套接字信息，因此用connfd会比较多。然后，用户有两个线程会与服务器的两个监听线程连接，唯一能得知这两个套接字是一个用户的方法就是使用ip。由此我们大概能设计如下映射：<ul>
<li>0）套接字1-&gt;ip地址：这个映射是通过客户端主线程连接到服务器命令线程；</li>
<li>1）ip地址-&gt;套接字2：这个映射是客户端接收线程连接到服务器发送线程，因为连接时间不可知，因此把映射保存下来；</li>
<li>2）套接字1-&gt;套接字2：这个映射通过上面的映射获取，套接字1找到ip然后找到套接字2，这样就建立好了服务器与客户端之间的映射，即能快速找到客户端两个套接字。<ul>
<li>本质上因为不知道套接字1先建立还是套接字2先建立，所以不能获得套接字1的映射就立马去找套接字2，最稳健的时机是用户登录时建立两个套接字之间的映射，因为用户能登录说明两个连接都建立完成，并且此时是阻塞返回的，消息发到主线程，不需要立即使用套接字2。</li>
</ul>
</li>
</ul>
</li>
<li>下面建立其他相关的映射：<ul>
<li>3）套接字1-&gt;sid：最初的sid是用户登录时的userid，因此这个映射在登录时建立，setsid可以更改。</li>
<li>4）套接字1-&gt;sname：最初的sname是用户登录时的userid，因此这个映射在登录时建立，setsname可以更改。这两个映射是为了一些请求命令需要让对方得知自己的sid和sname，能快速获取。</li>
<li>5）sid-&gt;套接字2：许多命令都是通过指定sid发送到对方的接收线程，这个映射在登录时建立。</li>
<li>6）sid-&gt;sname：通过搜索sid获取sname。</li>
<li>7）sid-&gt;客户状态：accept之类的命令通过sid检索对方状态。</li>
<li>8）套接字1-&gt;客户状态：本机的命令有时也需要与客户状态交互。</li>
</ul>
</li>
<li>chatting双方映射，在聊天的双方经常通过自己的套接字1发送到对方的套接字2，因此要建立该表。accept时服务器可以获取自己的套接字1和对方sid，此时可以建立：<ul>
<li>9）[本机套接字1]-&gt;[对方套接字2]，这个通过对方sid-&gt;套接字2获取。</li>
<li>[对方套接字1]-&gt;[本机套接字2]，这个通过本机套接字1-&gt;本机套接字2获取，对方的套接字1通过套接字2搜索映射表获取套接字1，这一步耗点时间，因为对方得知accept也需要时间，不会那么快发消息，所以可以搜索建立。</li>
<li>注意上面两个表本质是一样的，用一个表存储。</li>
</ul>
</li>
<li>补充：<ul>
<li>10）conn2-&gt;user：获取user</li>
<li>11）conn1-&gt;user：获取user</li>
<li>12）conn1_req_peer2：conn1发起chat或send请求，就在这个表记录对方的端口，这样conn1break时才能知道要向谁break</li>
</ul>
</li>
</ul>
<p>映射表也许还有很多，现在也无法想到底。由于映射表挺多的，可以使用一个类封装，像客户端的请求表一样。但是这个类包含了许多的表，设计就有多种方案了。在讨论这些方案之前，我们可以想到，这些表的操作肯定需要一些互斥处理。对于同一个表，插入查找删除肯定是需要互斥的，但是两个不同的表之间需要互斥吗？不需要，并且如果这被需要的话可能会严重损耗性能，因此一个表就对应一个互斥锁。现在我们来讨论表类的设计：</p>
<ul>
<li>第一种，小封装，直接暴露这些表，插入查找删除都由外部执行。评价是这个方案肯定是<strong>不行</strong>的，接口太难用了。</li>
<li>第二种，完全封装，但每个表配对一个函数，外部调用相应的函数执行。评价是<strong>代码冗余</strong>，<strong>代码重复</strong>，并且无法全部做到函数重载，接口质量太差了。</li>
<li>第三种，完全封装，使用模板编写函数，插入查找删除统一使用。但问题是无法得知对哪个表操作，或许可以使用一个顶层映射表，表id-&gt;表。但实际上这行不通，因为表的参数类型是不同的，并且这也无法通过模板来解决。<ul>
<li>可能使用函数模板通过传入表id操作不同的表吗？已尝试，这行不通，可以看我的博客<a href="https://jysama.cn/2022/10/22/%E5%87%BD%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%97%AE%E9%A2%98/">函数模板问题 | JySama</a>。</li>
</ul>
</li>
</ul>
<p>讨论到现在，实际上发现没什么值得封装的了。。。因此直接不封装好了，设计大概是这样子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//映射表</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_ip;<span class="comment">//id0，套接字1-&gt;ip，以下都用这样的命名方式</span></span><br><span class="line">unordered_map&lt;string, <span class="type">int</span>&gt; ip_conn2;<span class="comment">//id1</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_2;<span class="comment">//id2</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sid;<span class="comment">//id3	</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sname;<span class="comment">//id4</span></span><br><span class="line">unordered_map&lt;string, <span class="type">int</span>&gt; sid_conn2;<span class="comment">//id5</span></span><br><span class="line">unordered_map&lt;string, string&gt; sid_sname;<span class="comment">//id6</span></span><br><span class="line">unordered_map&lt;string, clientState&gt; sid_state;<span class="comment">//id7</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, clientState&gt; conn1_state;<span class="comment">//id8</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_peer2;<span class="comment">//id9</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn2_user;<span class="comment">//id10</span></span><br><span class="line">unordered_map&lt;<span class="type">int</span>, string&gt; conn1_user;<span class="comment">//id11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//每个表的互斥锁</span></span><br><span class="line">mutex mux_conn1_ip;</span><br><span class="line">mutex mux_ip_conn2;</span><br><span class="line">mutex mux_conn1_2;</span><br><span class="line">mutex mux_conn1_sid;</span><br><span class="line">mutex mux_conn1_sname;</span><br><span class="line">mutex mux_sid_conn2;</span><br><span class="line">mutex mux_sid_sname;</span><br><span class="line">mutex mux_sid_state;</span><br><span class="line">mutex mux_conn1_state;</span><br><span class="line">mutex mux_conn1_peer2;</span><br><span class="line">mutex mux_conn2_user;</span><br><span class="line">mutex mux_conn1_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入，包括直接修改</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">map[key] = value</span><br><span class="line">    </span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line">lock_guard&lt;mutex&gt; <span class="built_in">locker</span>(mux);</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">find</span>(key);</span><br><span class="line"><span class="keyword">if</span> (iter == map.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	map.<span class="built_in">erase</span>(iter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过key找value</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (iter == map.<span class="built_in">end</span>())<span class="comment">//这里返回是因为之前想写函数模板，直接调用就进行错误处理等</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">T2</span>();<span class="comment">//string的空构造是空字符串，int的空构造是0，clientState的空构造是noLogin</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过value找key</span></span><br><span class="line"><span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line"><span class="keyword">typename</span> unordered_map&lt;T1, T2&gt;::iterator iter = map.<span class="built_in">begin</span>();</span><br><span class="line"><span class="keyword">for</span> (; iter != map.<span class="built_in">end</span>(); iter++)</span><br><span class="line">	<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">		<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (iter == map.end())，否则一定找不到</span></span><br><span class="line"><span class="comment">////这里返回是因为之前想写函数模板，直接调用就进行错误处理等</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">T1</span>();<span class="comment">//string的空构造是空字符串，int的空构造是0，clientState的空构造是noLogin</span></span><br></pre></td></tr></table></figure>

<hr>
<p>写了后面一些内容，发现映射表使用太频繁了，因为没有封装，导致代码极速膨胀（因为每个操作都要互斥，一行语句会因为调用互斥加锁解锁展开成三四行），所以还是打算封装，每个表都配一系列函数好了，代码很多…不过后面调用就舒服很多。注：后面有些补充的表不会填上来。</p>
<p>state_c.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> STATE_C_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATE_C_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端状态机</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">clientState</span></span><br><span class="line">&#123;</span><br><span class="line">    noLogin = <span class="number">0</span>,<span class="comment">//未登录状态</span></span><br><span class="line">    cmdLine,<span class="comment">//命令行状态</span></span><br><span class="line">    isChatting,<span class="comment">//chat状态</span></span><br><span class="line">    isWaiting<span class="comment">//等待状态 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>usermap.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMAP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMAP_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;state_c.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserMap</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//映射表</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_ip;<span class="comment">//id0，套接字1-&gt;ip，以下都用这样的命名方式</span></span><br><span class="line">	unordered_map&lt;string, <span class="type">int</span>&gt; ip_conn2;<span class="comment">//id1</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_2;<span class="comment">//id2</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sid;<span class="comment">//id3	</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_sname;<span class="comment">//id4</span></span><br><span class="line">	unordered_map&lt;string, <span class="type">int</span>&gt; sid_conn2;<span class="comment">//id5</span></span><br><span class="line">	unordered_map&lt;string, string&gt; sid_sname;<span class="comment">//id6</span></span><br><span class="line">	unordered_map&lt;string, clientState&gt; sid_state;<span class="comment">//id7</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, clientState&gt; conn1_state;<span class="comment">//id8</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; conn1_peer2;<span class="comment">//id9</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn2_user;<span class="comment">//id10</span></span><br><span class="line">	unordered_map&lt;<span class="type">int</span>, string&gt; conn1_user;<span class="comment">//id11</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//每个表的互斥锁</span></span><br><span class="line">	mutex mux_conn1_ip;</span><br><span class="line">	mutex mux_ip_conn2;</span><br><span class="line">	mutex mux_conn1_2;</span><br><span class="line">	mutex mux_conn1_sid;</span><br><span class="line">	mutex mux_conn1_sname;</span><br><span class="line">	mutex mux_sid_conn2;</span><br><span class="line">	mutex mux_sid_sname;</span><br><span class="line">	mutex mux_sid_state;</span><br><span class="line">	mutex mux_conn1_state;</span><br><span class="line">	mutex mux_conn1_peer2;</span><br><span class="line">	mutex mux_conn2_user;</span><br><span class="line">	mutex mux_conn1_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//-----------------------------------------------------0</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_ip</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="comment">//不会通过ip找conn1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------1</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_ip_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_ip_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_ip_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="comment">//不会通过conn2找ip</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------2</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fkey_conn1_2</span><span class="params">(<span class="type">int</span> value)</span></span>;<span class="comment">//通过2找1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------3</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_sid</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fkey_conn1_sid</span><span class="params">(string value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------4</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_sname</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------5</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_sid_conn2</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fkey_sid_conn2</span><span class="params">(<span class="type">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------6</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_sname</span><span class="params">(string key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_sname</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_sid_sname</span><span class="params">(string key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------7</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_sid_state</span><span class="params">(string key, clientState value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_sid_state</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="function">clientState <span class="title">fvalue_sid_state</span><span class="params">(string key)</span></span>;</span><br><span class="line">	<span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------8</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_state</span><span class="params">(<span class="type">int</span> key, clientState value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">clientState <span class="title">fvalue_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="comment">//不可能通过state找key</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//-----------------------------------------------------9</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_peer2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">fvalue_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------10</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn2_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----------------------------------------------------11</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ins_conn1_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">del_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">	<span class="function">string <span class="title">fvalue_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermap.h&quot;</span></span></span><br><span class="line"><span class="comment">//---------------------------------------0</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_ip</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	conn1_ip[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_ip.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_ip.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_ip.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_ip</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_ip)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_ip.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_ip.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//---------------------------------------1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_ip_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	ip_conn2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_ip_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = ip_conn2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == ip_conn2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip_conn2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_ip_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_ip_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = ip_conn2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == ip_conn2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-----------------------------------------------------2</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	conn1_2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_conn1_2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fkey_conn1_2</span><span class="params">(<span class="type">int</span> value)</span><span class="comment">//通过2找1</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_2.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != conn1_2.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------3</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_sid</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	conn1_sid[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sid.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_sid.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_sid</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sid.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fkey_conn1_sid</span><span class="params">(string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sid)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sid.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != conn1_sid.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------4</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_sname</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	conn1_sname[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sname.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sname.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_sname.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_sname</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_sname.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_sname.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------5</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_conn2</span><span class="params">(string key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	sid_conn2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_conn2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_conn2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_sid_conn2</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_conn2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fkey_sid_conn2</span><span class="params">(<span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_conn2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, <span class="type">int</span>&gt;::iterator iter = sid_conn2.<span class="built_in">begin</span>();</span><br><span class="line">	<span class="keyword">for</span> (; iter != sid_conn2.<span class="built_in">end</span>(); iter++)</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;second == value)</span><br><span class="line">			<span class="keyword">return</span> iter-&gt;first;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------6</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_sname</span><span class="params">(string key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	sid_sname[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_sname</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, string&gt;::iterator iter = sid_sname.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_sname.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_sname.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_sid_sname</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_sname)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, string&gt;::iterator iter = sid_sname.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_sname.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------7</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_sid_state</span><span class="params">(string key, clientState value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	sid_state[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_sid_state</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, clientState&gt;::iterator iter = sid_state.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == sid_state.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sid_state.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">clientState <span class="title">UserMap::fvalue_sid_state</span><span class="params">(string key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_sid_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;string, clientState&gt;::iterator iter = sid_state.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == sid_state.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> clientState::noLogin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------8</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_state</span><span class="params">(<span class="type">int</span> key, clientState value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	conn1_state[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, clientState&gt;::iterator iter = conn1_state.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_state.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_state.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">clientState <span class="title">UserMap::fvalue_conn1_state</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_state)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, clientState&gt;::iterator iter = conn1_state.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_state.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> clientState::noLogin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不可能通过state找key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------9</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_peer2</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	conn1_peer2[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_peer2.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_peer2.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_peer2.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">UserMap::fvalue_conn1_peer2</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_peer2)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;::iterator iter = conn1_peer2.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_peer2.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------10</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn2_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	conn2_user[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn2_user.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn2_user.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn2_user.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn2_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn2_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn2_user.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn2_user.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------11</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::ins_conn1_user</span><span class="params">(<span class="type">int</span> key, string value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	conn1_user[key] = value;<span class="comment">//插入或修改</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserMap::del_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_user.<span class="built_in">find</span>(key);</span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_user.<span class="built_in">end</span>())<span class="comment">//不存在则直接不管</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		conn1_user.<span class="built_in">erase</span>(iter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">string <span class="title">UserMap::fvalue_conn1_user</span><span class="params">(<span class="type">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux_conn1_user)</span></span>;</span><br><span class="line">	<span class="keyword">typename</span> unordered_map&lt;<span class="type">int</span>, string&gt;::iterator iter = conn1_user.<span class="built_in">find</span>(key);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iter == conn1_user.<span class="built_in">end</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> iter-&gt;second;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用测试：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermap.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UserMap usermap;</span><br><span class="line">	usermap.<span class="built_in">ins_conn1_2</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(<span class="number">1</span>);</span><br><span class="line">	cout &lt;&lt; conn2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ip == <span class="string">&quot;&quot;</span>)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	usermap.<span class="built_in">ins_conn1_ip</span>(<span class="number">1</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">	ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(<span class="number">1</span>);</span><br><span class="line">	cout &lt;&lt; ip &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	clientState state = usermap.<span class="built_in">fvalue_conn1_state</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line">	usermap.<span class="built_in">ins_conn1_state</span>(<span class="number">1</span>,clientState::isChatting);</span><br><span class="line">	state = usermap.<span class="built_in">fvalue_conn1_state</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (state == clientState::noLogin)</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;none&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注册登录"><a href="#注册登录" class="headerlink" title="注册登录"></a>注册登录</h1><p>这里假设搞定了日志系统和数据库连接池先，数据库连接池代码放在这后面，然后把注册登录的处理函数写了（大概在markdown写一下，有bug后面再改）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">verify</span><span class="params">(<span class="type">int</span> conn1, <span class="type">int</span> isLogin, string userid, string password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MYSQL* sql;</span><br><span class="line">	<span class="function">SqlRAII <span class="title">myconn</span><span class="params">(&amp;sql,sqlpool,<span class="number">0</span>)</span></span>;<span class="comment">//获取一个sql连接句柄，0表示超时时间</span></span><br><span class="line">    string sendstr = <span class="string">&quot;Server busy!&quot;</span>;<span class="comment">//默认</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(sql==<span class="literal">nullptr</span>)<span class="comment">//如果没拿到，即超时了</span></span><br><span class="line">	&#123;</span><br><span class="line">    	<span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_FIELD *fields = <span class="literal">nullptr</span>;</span><br><span class="line">    	MYSQL_RES *res = <span class="literal">nullptr</span>;</span><br><span class="line">        string order = <span class="string">&quot;SELECT userid, password FROM user WHERE userid=&#x27;&quot;</span>+userid+<span class="string">&quot;&#x27;&quot;</span>;<span class="comment">//命令不用加分号</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//要么没有，要么只能查出一个</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(sql, order.<span class="built_in">c_str</span>())) <span class="comment">//执行语句，成功返回0，错误返回非0</span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">LOG_DEBUG</span>( <span class="string">&quot;Select error: %s&quot;</span>,order.<span class="built_in">c_str</span>());</span><br><span class="line">        	<span class="built_in">mysql_free_result</span>(res);<span class="comment">//错误的话释放结果集（无论成功与否，查询后总是释放）</span></span><br><span class="line">            <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送server busy</span></span><br><span class="line">        	<span class="keyword">return</span>; </span><br><span class="line">    	&#125;</span><br><span class="line">        res = <span class="built_in">mysql_store_result</span>(sql);<span class="comment">//完整的结果集</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res)) <span class="comment">//遍历行，没有对应的表项就进不来，进来就只有一行</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">string <span class="title">passwd</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">            <span class="comment">// 能select到说明又对应的username，看是登录还是注册</span></span><br><span class="line">        	<span class="keyword">if</span>(isLogin)<span class="comment">//登录</span></span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="keyword">if</span>(password == passwd) <span class="comment">//登录成功</span></span><br><span class="line">                &#123; </span><br><span class="line">                    sendstr = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">                    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">                    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login successfully with password: %s ip: %s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                    <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//添加映射</span></span><br><span class="line">                    <span class="built_in">login_addmap</span>(conn1,userid);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            	<span class="keyword">else</span> <span class="comment">//登录失败，这种情况是密码错误</span></span><br><span class="line">                &#123;</span><br><span class="line">                	sendstr = <span class="string">&quot;password error！&quot;</span>;</span><br><span class="line">                	<span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">                    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login unsuccessfully with password: %s ip: %s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                    <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            	&#125;</span><br><span class="line">        	&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">else</span><span class="comment">//注册，说明userid被使用了</span></span><br><span class="line">            &#123;</span><br><span class="line">                sendstr = <span class="string">&quot;the user id [&quot;</span>+userid+<span class="string">&quot;] is already in use&quot;</span>;</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">LOG_INFO</span>(<span class="string">&quot;register unsuccessfully, [%s] is already in use&quot;</span>,userid.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res);<span class="comment">//获取行完毕，释放结果集使用的内存</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">mysql_free_result</span>(res);<span class="comment">//释放结果集使用的内存</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//现在处理没有查找到的情况</span></span><br><span class="line">        <span class="keyword">if</span>(isLogin)<span class="comment">//登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            sendstr = <span class="string">&quot;user id [&quot;</span>+userid+<span class="string">&quot;] not found&quot;</span>;</span><br><span class="line">            <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">                    </span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s login but id not found&quot;</span>,userid.<span class="built_in">c_str</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//注册，这种情况可以注册</span></span><br><span class="line">        &#123;</span><br><span class="line">            string order_insert = <span class="string">&quot;INSERT INTO user(userid, password) VALUES(&#x27;&quot;</span>+userid+<span class="string">&quot;&#x27;,&#x27;&quot;</span>+password+<span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(sql, order_insert.<span class="built_in">c_str</span>())) </span><br><span class="line">            &#123; </span><br><span class="line">            	<span class="built_in">LOG_DEBUG</span>( <span class="string">&quot;Insert error: %s&quot;</span>,order_insert.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);<span class="comment">//发送server busy</span></span><br><span class="line">            	<span class="keyword">return</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sendstr = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">                <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),<span class="built_in">int</span>(sendstr.<span class="built_in">size</span>()),<span class="number">0</span>);</span><br><span class="line">				</span><br><span class="line">                string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">            	<span class="built_in">LOG_INFO</span>(<span class="string">&quot;register successfully with id: [%s] password: [%s] ip:%s&quot;</span>,userid.<span class="built_in">c_str</span>(),password.<span class="built_in">c_str</span>(),ip.<span class="built_in">c_str</span>());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">login_addmap</span><span class="params">(<span class="type">int</span> conn1,string userid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string ip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);            </span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_ip_conn2</span>(ip);</span><br><span class="line">   	</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_2</span>(conn1,conn2);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sid</span>(conn1,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sname</span>(conn1,userid);</span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_sid_conn2</span>(userid,conn2);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(userid,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(userid,clientState::cmdLine);</span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);</span><br><span class="line">    usermap.<span class="built_in">ins_conn2_user</span>(conn2,userid);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_user</span>(conn1,userid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><p>在之前的博客已经介绍过了，这里再介绍以下吧：</p>
<p>头文件<code>#include &lt;mysql/mysql.h&gt;</code></p>
<p>数据库的一个连接句柄的初始化有三步</p>
<ul>
<li>定义一个sql指针：<code>MYSQL *sql = nullptr;</code></li>
<li>用这个指针初始化一个sql结构体，返回一个指向这个结构体的指针：<code>sql = mysql_init(sql);</code></li>
<li>init后就connect，连接数据库，返回一个可用连接<code>sql = mysql_real_connect(sql, host,user, pwd,dbName, port, unix_socket, client_flag);</code><ul>
<li>host是主机名或IP，如果“host”是NULL或字符串”localhost”，连接将被视为与本地主机的连接。</li>
<li>如果unix_socket不是NULL，该字符串描述了应使用的套接字或命名管道。注意，“host”参数决定了连接的类型。</li>
<li>client_flag的值通常为0，其他标志可以实现特定的功能</li>
</ul>
</li>
</ul>
<p>然后这个sql句柄就可以用来执行语句了，最后在不使用的时候还需要调用<code>mysql_close(sql);</code>释放连接。并且，为了避免在使用库完成应用程序后发生内存泄漏(例如，在关闭与服务器的连接之后)，可以显式调用mysql_library_end()。这样可以执行内存 Management 以清理和释放库使用的资源。</p>
<p>上面就是一个连接的建立，对于多个连接，我们可以把多个连接初始化后放入一个队列里，这样就构成了一个连接池。对于这样一个共享的连接池，就需要互斥操作。而这一个队列又和阻塞队列不同，队列是可能空的但不可能会因为满而阻塞——可用的连接是一定的，push回去不会多。在阻塞队列中使用了两个条件变量管理了空&#x2F;满缓冲区的阻塞，这里只需要管理空，也即pop操作的阻塞。可以用一个条件变量，也可以用一个信号量。条件变量可以做超时处理，因此用条件变量（信号量就使用<code>sem_post(&amp;semId_)、sem_wait(&amp;semId_)、sem_init(&amp;semId_, 0, MAX_CONN_)</code>）。</p>
<p>当上层需要登录或注册时，会尝试获取一个连接，然后使用完后释放连接。这里的问题是，当没有连接可用时，是阻塞等待还是直接返回错误。或许使用折中会好一点，即用cond.wait_for()阻塞一段时间。当释放一个连接后就尝试唤醒一个阻塞的线程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SQLCONNPOOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQLCONNPOOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sqlconnpool</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    mutex mux;</span><br><span class="line">    condition_variable cond;</span><br><span class="line">    queue&lt;MYSQL*&gt; connque;</span><br><span class="line">    <span class="type">int</span> maxconn;</span><br><span class="line">    <span class="type">int</span> freecount;</span><br><span class="line">    <span class="built_in">Sqlconnpool</span>();</span><br><span class="line">    ~<span class="built_in">Sqlconnpool</span>()&#123;&#125;<span class="comment">//析构函数实际上和构造函数一样，可以private，因为本质上是成员函数调用</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Sqlconnpool</span>(<span class="type">const</span> Sqlconnpool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Sqlconnpool&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Sqlconnpool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Sqlconnpool*  <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">MYSQL* <span class="title">getconn</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">freeconn</span><span class="params">(MYSQL* conn)</span></span>;</span><br><span class="line">    <span class="comment">//无法使用构造函数传参，用init，默认参数写声明中</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host,<span class="type">int</span> port,<span class="type">const</span> <span class="type">char</span>* user,<span class="type">const</span> <span class="type">char</span>* pwd,<span class="type">const</span> <span class="type">char</span>* dbname,<span class="type">int</span> connsize=<span class="number">20</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">conncount</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sqlconnpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">Sqlconnpool::<span class="built_in">Sqlconnpool</span>()</span><br><span class="line">&#123;</span><br><span class="line">    maxconn = <span class="number">0</span>;</span><br><span class="line">    freecount = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Sqlconnpool* <span class="title">Sqlconnpool::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> Sqlconnpool instance;</span><br><span class="line">    <span class="keyword">return</span> &amp;instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MYSQL* <span class="title">Sqlconnpool::getconn</span><span class="params">(<span class="type">int</span> timeout = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(timeout&gt;=<span class="number">0</span>);<span class="comment">//</span></span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(connque.<span class="built_in">empty</span>())</span><br><span class="line">        <span class="keyword">if</span>(cond.<span class="built_in">wait_for</span>(locker, chrono::<span class="built_in">seconds</span>(timeout)) == std::cv_status::timeout)<span class="comment">//超时</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;Sqlconnpool busy&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">    MYSQL* sql = connque.<span class="built_in">front</span>();</span><br><span class="line">    connque.<span class="built_in">pop</span>();</span><br><span class="line">    freecount--;</span><br><span class="line">    <span class="keyword">return</span> sql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::freeconn</span><span class="params">(MYSQL* conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(conn);<span class="comment">//防止放入nullptr</span></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    connque.<span class="built_in">push</span>(conn);</span><br><span class="line">    freecount++;</span><br><span class="line">    cond.<span class="built_in">notify_one</span>();<span class="comment">//唤醒一个get线程</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Sqlconnpool::conncount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> maxconn-freecount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::init</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host,<span class="type">int</span> port,<span class="type">const</span> <span class="type">char</span>* user,<span class="type">const</span> <span class="type">char</span>* pwd,<span class="type">const</span> <span class="type">char</span>* dbname,<span class="type">int</span> connsize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(connsize&gt;<span class="number">0</span>);</span><br><span class="line">    maxconn = connsize;</span><br><span class="line">    freecount = connsize;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;maxconn;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//三步初始化</span></span><br><span class="line">        MYSQL* sql = <span class="literal">nullptr</span>;</span><br><span class="line">        sql = <span class="built_in">mysql_init</span>(sql);</span><br><span class="line">        <span class="keyword">if</span>(!sql)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;sql number %d init error&quot;</span>,i);</span><br><span class="line">            <span class="built_in">assert</span>(sql);<span class="comment">//终止报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        sql = <span class="built_in">mysql_real_connect</span>(sql,host,user,pwd,dbname,port,<span class="literal">nullptr</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!sql)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;sql number %d connect error&quot;</span>,i);</span><br><span class="line">            <span class="built_in">assert</span>(sql);<span class="comment">//终止报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        connque.<span class="built_in">push</span>(sql);<span class="comment">//放入的一定不是nullptr</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sqlconnpool::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">unique_lock&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(freecount != maxconn)<span class="comment">//必须要等待所有连接都放回来，直接close再执行查询程序会崩溃</span></span><br><span class="line">        cond.<span class="built_in">wait</span>(locker);<span class="comment">//每放回一个连接唤醒一次，然后判断</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(!connque.<span class="built_in">empty</span>())<span class="comment">//逐个关闭连接</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mysql_close</span>(connque.<span class="built_in">front</span>());</span><br><span class="line">        connque.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">mysql_library_end</span>();<span class="comment">//释放库的资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SQLRAII_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SQLRAII_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sqlconnpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlRAII</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MYSQL* conn;<span class="comment">//保存连接好的sql</span></span><br><span class="line">    Sqlconnpool* connpool;<span class="comment">//保存连接池</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SqlRAII</span>(MYSQL** sql,Sqlconnpool* sqlpool,<span class="type">int</span> timeout = <span class="number">0</span>)<span class="comment">//传入sql指针的地址，即&amp;sql，获取连接后传出去</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(sqlpool);<span class="comment">//必须先建好连接池</span></span><br><span class="line">        </span><br><span class="line">        *sql = sqlpool-&gt;<span class="built_in">getconn</span>(timeout);<span class="comment">//可能会超时</span></span><br><span class="line">        <span class="comment">//为了用户自行getconn和使用sqlraii的统一，这里统一让用户在上层处理sql为nullptr的情况</span></span><br><span class="line">        conn = *sql;</span><br><span class="line">        connpool = sqlpool;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">SqlRAII</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(conn)<span class="comment">//有连接就释放</span></span><br><span class="line">        	connpool-&gt;<span class="built_in">freeconn</span>(conn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h1 id="信息接收处理"><a href="#信息接收处理" class="headerlink" title="信息接收处理"></a>信息接收处理</h1><ul>
<li>对于聊天信息，只需要判断第一个字符是不是”~”即可，是的话通过映射表发送给对方</li>
<li>对于命令信息，客户端进行了很多处理了，发送过来的命令一定是正确的且不带@，且首尾没有空格，服务器需要做的就是再解析成向量形式</li>
<li>从客户端发来的信息都带有一个换行符，这是为了服务器刚好能使用客户端的解析函数，我们接着约定，服务器发给客户端的信息都不带有换行符。这样比如发来的聊天信息就要记得去尾部换行符。</li>
</ul>
<p>命令的映射如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> unordered_map&lt;string, <span class="type">int</span>&gt; cmdmap =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;register&quot;</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;login&quot;</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;search&quot;</span>,<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;accept&quot;</span>,<span class="number">4</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;reject&quot;</span>,<span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;break&quot;</span>,<span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;send&quot;</span>,<span class="number">7</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sendfile&quot;</span>,<span class="number">8</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptfile&quot;</span>,<span class="number">9</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectfile&quot;</span>,<span class="number">10</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getfile&quot;</span>,<span class="number">11</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;acceptget&quot;</span>,<span class="number">12</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;rejectget&quot;</span>,<span class="number">13</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsid&quot;</span>,<span class="number">14</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;setsname&quot;</span>,<span class="number">15</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;choosefile&quot;</span>,<span class="number">16</span>&#125;,<span class="comment">//服务器没有re命令，但是多了一个choosefile，通告选择的文件号码</span></span><br><span class="line">    &#123;<span class="string">&quot;exit&quot;</span>,<span class="number">17</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;hisir&quot;</span>,<span class="number">18</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;myresource&quot;</span>,<span class="number">19</span>&#125;,<span class="comment">//这个也不用</span></span><br><span class="line">    &#123;<span class="string">&quot;oyasumi&quot;</span>,<span class="number">20</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>工作函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">task</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//epoll响应conn1，指定工作函数从conn1处接收</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收，ET模式下要一次接收完，该函数在下篇博客epoll中作出。</span></span><br><span class="line">    string recvstr = <span class="built_in">recv_str</span>(conn1); </span><br><span class="line">    <span class="keyword">if</span>(recvstr == <span class="string">&quot;&quot;</span>)<span class="comment">//接收出错了</span></span><br><span class="line">    	<span class="keyword">return</span>;<span class="comment">//不给用户发错误信息，可能对方断开了，发过去有危险</span></span><br><span class="line">    <span class="keyword">if</span>(recvstr[<span class="number">0</span>]==<span class="string">&#x27;~&#x27;</span>)<span class="comment">//聊天内容</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">chatmsg</span>(conn1,recvstr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//命令</span></span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;string&gt; cmdvec = <span class="built_in">parse</span>(recvstr);</span><br><span class="line">        <span class="type">int</span> cmdvalue = cmdmap[cmdvec[<span class="number">0</span>]];<span class="comment">//客户端处理后命令一定存在</span></span><br><span class="line">        <span class="keyword">switch</span>(cmdvalue)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">verify</span>(conn1, <span class="number">0</span>, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">verify</span>(conn1, <span class="number">1</span>, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">search</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">chat</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">accept</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="built_in">reject</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                <span class="built_in">break_</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                <span class="built_in">send_</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="built_in">sendfile</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                <span class="built_in">acceptfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                <span class="built_in">rejectfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="built_in">getfile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="built_in">acceptget</span>(conn1, cmdvec[<span class="number">1</span>], cmdvec[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">                <span class="built_in">rejectget</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">                <span class="built_in">setsid</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">                <span class="built_in">setsname</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">                <span class="built_in">choosefile</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">                <span class="built_in">exit</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">                <span class="built_in">hisir</span>(conn1, cmdvec[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">                <span class="built_in">oyasumi</span>(conn1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这两句见下一篇博客</span></span><br><span class="line">    <span class="type">uint32_t</span> connEvent = CONNEVENT;<span class="comment">//因为是oneshot，每次重新注册</span></span><br><span class="line">    epoller.<span class="built_in">modFd</span>(conn1, connEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析命令函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string cmdstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//对于一个关键字的命令，无法用空格分割，考虑到最后一定有个\n是没用的，因此把\n改为空格，一举两得</span></span><br><span class="line">    cmdstr[cmdstr.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> pos1;</span><br><span class="line">    <span class="keyword">while</span> ((pos1 = cmdstr.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(cmdstr.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">        <span class="keyword">while</span> (cmdstr[pos1] == <span class="string">&#x27; &#x27;</span>)<span class="comment">//过滤空格</span></span><br><span class="line">            pos1++;</span><br><span class="line">        pos = pos1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;<span class="comment">//返回值是右值，外部vector会接收右值，调用移动构造</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="命令工作函数"><a href="#命令工作函数" class="headerlink" title="命令工作函数"></a>命令工作函数</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">chatmsg</span><span class="params">(<span class="type">int</span> conn1, string&amp; recvstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_peer2</span>(conn1);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s chatmsg error, can&#x27;t find peer!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line"></span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//获取发送方名字</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send [msg] to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="comment">//还要记录myuser的聊天日志</span></span><br><span class="line">    recvstr = recvstr.<span class="built_in">substr</span>(<span class="number">1</span>,recvstr.<span class="built_in">size</span>()<span class="number">-2</span>);<span class="comment">//去~和去\n</span></span><br><span class="line">    recvstr = mysname+<span class="string">&quot;: &quot;</span>+recvstr;</span><br><span class="line">    <span class="built_in">send</span>(conn2,recvstr.<span class="built_in">c_str</span>(),recvstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//记录日志，在下一篇博客中已完成该函数</span></span><br><span class="line">    <span class="comment">//前面的recvstr已经记录了发送方名字和发送内容，然后文件名包含了发送者id，因此再补上接收者id即可</span></span><br><span class="line">    recvstr = recvstr + <span class="string">&quot; [&quot;</span>+peeruser+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">msg_log</span>(myuser,recvstr))</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s open log falied!&quot;</span>, myuser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">search</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    string sname = usermap.<span class="built_in">fvalue_sid_sname</span>(sid);</span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [search] sid-%s&quot;</span>,myuser.<span class="built_in">c_str</span>(),sid.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span>(sname == <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isChatting)</span><br><span class="line">        sendstr = <span class="string">&quot;sid-[&quot;</span>+sid+<span class="string">&quot;]sname-[&quot;</span>+sname+<span class="string">&quot;]state-is chatting&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sendstr = <span class="string">&quot;sid-[&quot;</span>+sid+<span class="string">&quot;]sname-[&quot;</span>+sname+<span class="string">&quot;]state-isn&#x27;t chatting&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isChatting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer is chatting, you may wait for a long time...&quot;</span>;</span><br><span class="line">    	<span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;@#chatfrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [chat] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">accept_</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#chat accept&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isChatting);<span class="comment">//修改自己状态为chatting</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isChatting);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::isChatting);<span class="comment">//修改对方状态为chatting</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::isChatting);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        usermap.<span class="built_in">ins_conn1_peer2</span>(conn1,conn2);</span><br><span class="line">        usermap.<span class="built_in">ins_conn1_peer2</span>(peerconn1,myconn2);</span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [accept] the chat requestion for %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//对方已经退出了，或在accept到服务器前break了，或其他情况，让accept方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reject</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#chat reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [reject] the chat requestion for %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">break_</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//加下划线为了避免和break关键字重合，这里不close，在epoll里close</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_conn1_state</span>(conn1);<span class="comment">//获取自己状态</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_req_peer2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);<span class="comment">//修改自己状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//没有请求就不用管，否则要删除对方的请求表</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);<span class="comment">//删请求</span></span><br><span class="line">        sendstr = <span class="string">&quot;@#break &quot;</span>+mysid;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from waiting&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(state == clientState::cmdLine)<span class="comment">//在break到达前acceptfile了，让对方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//没有请求就不用管，reject会把请求删掉，这与accept区分开来</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);<span class="comment">//删请求</span></span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from cmdLine&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(state == clientState::isChatting)<span class="comment">//正在通信，或在break到达前accept了</span></span><br><span class="line">    &#123;</span><br><span class="line">        conn2 = usermap.<span class="built_in">fvalue_conn1_peer2</span>(conn1);<span class="comment">//找到正在通信的对方</span></span><br><span class="line">       </span><br><span class="line">        string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//获取自己的sid，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::cmdLine);<span class="comment">//修改自己状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [break] from chatting&quot;</span>,myuser.<span class="built_in">c_str</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//一般不会，可能有没考虑到的情况吧</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//让对方也退出</span></span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        string sid = usermap.<span class="built_in">fvalue_conn1_sid</span>(peerconn1);<span class="comment">//获取对方sid，修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//删除通信的映射</span></span><br><span class="line">        usermap.<span class="built_in">del_conn1_peer2</span>(conn1);</span><br><span class="line">        usermap.<span class="built_in">del_conn1_peer2</span>(peerconn1);</span><br><span class="line">        </span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">send_</span><span class="params">(<span class="type">int</span> conn1, string sid, string&amp; msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;sid-[&quot;</span>+mysid+<span class="string">&quot;] sname-[&quot;</span>+mysname+<span class="string">&quot;] send: &quot;</span>+msg;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [send] message to %s: %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>(),msg.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sendfile</span><span class="params">(<span class="type">int</span> conn1, string sid, string filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> pos = filename.<span class="built_in">find_last_not_of</span>(<span class="string">&quot;/&quot;</span>);<span class="comment">//发过来可能是完整路径，要把路径删掉</span></span><br><span class="line">    <span class="keyword">if</span>(pos != string::npos)</span><br><span class="line">    	filename = filename.<span class="built_in">substr</span>(pos+<span class="number">1</span>);</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendstr = <span class="string">&quot;@#sendfilefrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname+<span class="string">&quot; &quot;</span>+filename;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [sendfile] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">acceptfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">        sendstr = <span class="string">&quot;@#sendfile accept &quot;</span>+myip;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line"></span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [acceptfile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//对方已经退出了，或在accept到服务器前break了，或其他情况，让accept方退出</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#break now&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rejectfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#sendfile reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s  [rejectfile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">getfile</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    <span class="type">int</span> myconn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);<span class="comment">//获取自己的接收套接字</span></span><br><span class="line">    <span class="comment">//获取自己信息</span></span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    string mysname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">ins_conn1_state</span>(conn1,clientState::isWaiting);<span class="comment">//修改自己状态为waiting</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(mysid,clientState::isWaiting);<span class="comment">//改两次</span></span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span>(conn2 == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The peer does not exist, please break!&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(myconn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendstr = <span class="string">&quot;@#getfilefrom &quot;</span>+mysid+<span class="string">&quot; &quot;</span>+mysname;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_req_peer2</span>(conn1,conn2);<span class="comment">//添加一个请求映射</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s send a [getfile] requestion to %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">acceptget</span><span class="params">(<span class="type">int</span> conn1, string sid, string&amp; src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#getfile accept &quot;</span>+src;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line"></span><br><span class="line">     	</span><br><span class="line">        <span class="comment">//accept不删，为了在break到达前accept后还能找到对方，reject可以删，因为不用找对方</span></span><br><span class="line">        <span class="comment">//usermap.del_conn1_req_peer2(peerconn1);//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [acceptget] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于getfile不用管</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rejectget</span><span class="params">(<span class="type">int</span> conn1, string sid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(sid);<span class="comment">//获取对方状态</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(sid);<span class="comment">//获取对方接收套接字</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(state == clientState::isWaiting)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;@#getfile reject&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> peerconn1 = usermap.<span class="built_in">fkey_conn1_2</span>(conn2);<span class="comment">//获取对方套接字1，为了修改状态</span></span><br><span class="line">        usermap.<span class="built_in">ins_conn1_state</span>(peerconn1,clientState::cmdLine);<span class="comment">//修改对方状态为cmdLine</span></span><br><span class="line">        usermap.<span class="built_in">ins_sid_state</span>(sid,clientState::cmdLine);<span class="comment">//改两次</span></span><br><span class="line">       	</span><br><span class="line">        usermap.<span class="built_in">del_conn1_req_peer2</span>(peerconn1);<span class="comment">//把服务器保存的对方的请求删掉</span></span><br><span class="line">        </span><br><span class="line">        string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">        string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">        <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [rejectget] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他情况下对于reject不用管</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">choosefile</span><span class="params">(<span class="type">int</span> conn1, string number)</span><span class="comment">//服务器没有re命令，但是多了一个choosefile，通告选择的文件号码</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_req_peer2</span>(conn1);<span class="comment">//从getfile请求里获取对方的套接字</span></span><br><span class="line">    <span class="keyword">if</span>(conn2 == <span class="number">-1</span>)<span class="comment">//意外情况...</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;[choosefile] can&#x27;t find the file-sender&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">    string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);<span class="comment">//告知对方（发送方）本地ip地址</span></span><br><span class="line">    sendstr = <span class="string">&quot;@#choosefile &quot;</span>+number+<span class="string">&quot; &quot;</span>+myip;</span><br><span class="line">    <span class="built_in">send</span>(conn2,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给对方</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取发送方userid</span></span><br><span class="line">    string peeruser = usermap.<span class="built_in">fvalue_conn2_user</span>(conn2);<span class="comment">//获取对方userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [choosefile] from %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),peeruser.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setsid</span><span class="params">(<span class="type">int</span> conn1, string&amp; newsid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string oldsid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);<span class="comment">//先获取旧的sid</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(oldsid == newsid)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;Your old sid and new sid are the same&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> check = usermap.<span class="built_in">fvalue_sid_conn2</span>(newsid);<span class="comment">//查看是否已有该sid</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(check != <span class="number">-1</span>)<span class="comment">//该sid已注册</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;The newsid [&quot;</span>+newsid+<span class="string">&quot;] has been used, setsid failed&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//有些表sid是当key的，这里的修改原则是删除-&gt;重新插入</span></span><br><span class="line">    string sname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//获取sname，为了改sid_sname表</span></span><br><span class="line">    clientState state = usermap.<span class="built_in">fvalue_sid_state</span>(oldsid);<span class="comment">//获取state，为了改sid_state表</span></span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_sid_conn2</span>(oldsid);<span class="comment">//获取conn2，为了改sid_conn2表</span></span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sid</span>(conn1,newsid);<span class="comment">//修改</span></span><br><span class="line">    </span><br><span class="line">    usermap.<span class="built_in">del_sid_sname</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(newsid,sname);<span class="comment">//插入</span></span><br><span class="line">    usermap.<span class="built_in">del_sid_state</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_state</span>(newsid,state);<span class="comment">//插入</span></span><br><span class="line">    usermap.<span class="built_in">del_sid_conn2</span>(oldsid);<span class="comment">//删</span></span><br><span class="line">    usermap.<span class="built_in">ins_sid_conn2</span>(newsid,conn2);<span class="comment">//插入</span></span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;setsid successfullly, new sid is [&quot;</span>+newsid+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [setsid] from %s to [%s]&quot;</span>,myuser.<span class="built_in">c_str</span>(),oldsid.<span class="built_in">c_str</span>(),newsid.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setsname</span><span class="params">(<span class="type">int</span> conn1, string&amp; newsname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string oldsname = usermap.<span class="built_in">fvalue_conn1_sname</span>(conn1);<span class="comment">//先获取旧的sname</span></span><br><span class="line">    string sendstr;</span><br><span class="line">    <span class="keyword">if</span>(oldsname == newsname)</span><br><span class="line">    &#123;</span><br><span class="line">        sendstr = <span class="string">&quot;Your old sname and new sname are the same&quot;</span>;</span><br><span class="line">        <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string sid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    usermap.<span class="built_in">ins_conn1_sname</span>(conn1,newsname);</span><br><span class="line">    usermap.<span class="built_in">ins_sid_sname</span>(sid,newsname);</span><br><span class="line">    </span><br><span class="line">    sendstr = <span class="string">&quot;setsname successfullly, new sname is [&quot;</span>+newsname+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);<span class="comment">//发给自己</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [setsname] from %s to [%s]&quot;</span>,myuser.<span class="built_in">c_str</span>(),oldsname.<span class="built_in">c_str</span>(),newsname.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">exit_</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//退出相当于break+clean map+close</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">break_</span>(conn1);<span class="comment">//调用break，让会影响到的对方退出</span></span><br><span class="line">    <span class="comment">//break是没有关系的，因为如果普通情况下exit，请求表映射是空，那么break不会做事情</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [exit]&quot;</span>,myuser.<span class="built_in">c_str</span>());<span class="comment">//删之前记录一下</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cleanmap</span>(conn1);<span class="comment">//删表</span></span><br><span class="line">    epoller.<span class="built_in">delFd</span>(conn1);<span class="comment">//从epoll内删除事件</span></span><br><span class="line">    <span class="built_in">close</span>(conn1);<span class="comment">//关套接字</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cleanmap</span><span class="params">(<span class="type">int</span> conn1)</span><span class="comment">//删表，oyasumi和exit都可以使用</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string myip = usermap.<span class="built_in">fvalue_conn1_ip</span>(conn1);</span><br><span class="line">    string mysid = usermap.<span class="built_in">fvalue_conn1_sid</span>(conn1);</span><br><span class="line">    <span class="type">int</span> conn2 = usermap.<span class="built_in">fvalue_conn1_2</span>(conn1);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//13个表都删了</span></span><br><span class="line">    usermap.<span class="built_in">del_conn1_ip</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_ip_conn2</span>(myip);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_2</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_sid</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_sname</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_sid_conn2</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_sid_sname</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_sid_state</span>(mysid);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_state</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_peer2</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn2_user</span>(conn2);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_user</span>(conn1);</span><br><span class="line">    usermap.<span class="built_in">del_conn1_req_peer2</span>(conn1);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数库random"><a href="#随机数库random" class="headerlink" title="随机数库random"></a>随机数库random</h2><p>在命令<code>hisir</code>和<code>oyasumi</code>中，服务器会返回一句话，这句话实际上是随机的。理论上，设置一个全局变量每次调用命令就加一，这样在多个用户调用的情况下就能做到对单个用户来说比较随机了。</p>
<p>但是还是用点相对来说高级的东西，c语言的rand和srand就不用了，我们来学一下c++11新实现的库<code>&lt;random&gt;</code>。使用方法很简单：</p>
<ul>
<li>实例化一个随机数引擎</li>
<li>实例化一个统计分布（可选）</li>
<li>分布对象调用引擎对象即可返回随机数</li>
</ul>
<h3 id="伪随机数引擎"><a href="#伪随机数引擎" class="headerlink" title="伪随机数引擎"></a>伪随机数引擎</h3><p>random库提供了三种常用的随机数生成引擎，都以模版类的方式定义。分别是：</p>
<ul>
<li>linear_congruential_engine：线性同余生成引擎，是最常用也是速度最快的，但随机效果一般</li>
<li>mersenne_twister_engine：梅森旋转算法，随机效果最好。比较慢，占用存储空间较大，但是在参数设置合理的情况下，可生成最长的不重复序列，且具有良好的频谱特征。</li>
<li>subtract_with_carry_engine：滞后Fibonacci算法。速度最快，占用存储空间较大，频谱特性有时不佳。</li>
<li>default_random_engine：就是线性同余引擎，参考<a target="_blank" rel="noopener" href="https://cplusplus.com/reference/random/default_random_engine/">https://cplusplus.com/reference/random/default_random_engine/</a></li>
</ul>
<p>所有生成器引擎，或者经过adapter修饰后的类实例，都提供如下接口供使用</p>
<ul>
<li>min：返回最小值，静态函数</li>
<li>max：返回最大值，静态函数</li>
<li>seed：设置随机数生成的种子</li>
<li>operator()：产生随机数</li>
<li>void discard (unsigned long long z)：调用z次operator()函数</li>
</ul>
<p>另外，都定义了输入输出操作符和关系运算的非成员函数。随机数引擎接收一个整数作为种子，<strong>不提供就会使用默认值</strong>。</p>
<p>使用大概像这样子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> min,max;</span><br><span class="line"><span class="comment">//定义上下边界</span></span><br><span class="line"> </span><br><span class="line">default_random_engine e;</span><br><span class="line"><span class="comment">//创建引擎</span></span><br><span class="line"> </span><br><span class="line"><span class="function">uniform_int_distribution&lt;<span class="type">unsigned</span>&gt; <span class="title">u</span><span class="params">(min,max)</span></span>;</span><br><span class="line"><span class="comment">//创建取值范围</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> randNum=<span class="built_in">u</span>(e);</span><br><span class="line"><span class="comment">//获取伪随机数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以直接用引擎</span></span><br><span class="line"><span class="type">int</span> randNum=<span class="built_in">e</span>();</span><br></pre></td></tr></table></figure>

<h3 id="预定义算法"><a href="#预定义算法" class="headerlink" title="预定义算法"></a>预定义算法</h3><p>定义了算法的最佳实践，避免了参数的选择，可以直接选择引擎，即不用使用上面的引擎然后设置一些参数，可以直接用算法。</p>
<p>算法包括minstd_rand0、minstd_rand、mt19937（32位）、mt19937_64（产生64位随机数）、ranlux24_base、ranlux48_base等。 <code>mt19937</code>是目前 C++ 标准中最实用的引擎</p>
<h3 id="分布"><a href="#分布" class="headerlink" title="分布"></a>分布</h3><p>分布用于进一步加载引擎，使随机数具有分布性质，提供的分布有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//均匀分布：</span></span><br><span class="line">uniform_int_distribution           <span class="comment">//整数均匀分布</span></span><br><span class="line">uniform_real_distribution         <span class="comment">//浮点数均匀分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//伯努利类型分布</span></span><br><span class="line">bernoulli_distribution     <span class="comment">//伯努利分布</span></span><br><span class="line">binomial_distribution      <span class="comment">//二项分布</span></span><br><span class="line">geometry_distribution     <span class="comment">//几何分布</span></span><br><span class="line">negative_biomial_distribution   <span class="comment">//负二项分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rate-based distributions: </span></span><br><span class="line">poisson_distribution  <span class="comment">//泊松分布</span></span><br><span class="line">exponential_distribution <span class="comment">//指数分布</span></span><br><span class="line">gamma_distribution <span class="comment">//伽马分布</span></span><br><span class="line"> weibull_distribution <span class="comment">//威布尔分布</span></span><br><span class="line">extreme_value_distribution <span class="comment">//极值分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//正态分布相关：</span></span><br><span class="line">normal_distribution         <span class="comment">//正态分布</span></span><br><span class="line">chi_squared_distribution <span class="comment">//卡方分布</span></span><br><span class="line">cauchy_distribution        <span class="comment">//柯西分布</span></span><br><span class="line">fisher_f_distribution       <span class="comment">//费歇尔F分布</span></span><br><span class="line">student_t_distribution  <span class="comment">// t分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//分段分布相关：</span></span><br><span class="line">discrete_distribution <span class="comment">//离散分布</span></span><br><span class="line">piecewise_constant_distribution <span class="comment">//分段常数分布</span></span><br><span class="line">piecewise_linear_distribution <span class="comment">//分段线性分布</span></span><br></pre></td></tr></table></figure>

<h3 id="random-device"><a href="#random-device" class="headerlink" title="random_device"></a>random_device</h3><p><code>区别与其他生成算法的伪随机数，通过硬件生成真正的不确定随机数（如果硬件不支持，标准也允许使用伪随机生成方法实现此函数），返回一个unsigned int，通常作为前述引擎的seeds。</code></p>
<p>前面使用分布加载引擎后，如果不设置种子，每次运行的随机数序列都是一样的，因为：引擎使用默认值-&gt;引擎序列相同-&gt;分布产生的序列相同。</p>
<p>因此如果要每次运行都产生不一样的序列，就要用种子，以往的做法可以用time(NULL)，但这实际上是个糟糕的做法。这就可以用到random_device。</p>
<p>random_device一般只用来作为其他伪随机数算法的种子，参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiading/p/11653911.html">C++11随机数的正确打开方式 - 别再闹了 - 博客园 (cnblogs.com)</a>。大概就是说：</p>
<ul>
<li>random_device最大最小值不可以改</li>
<li>linux下是用熵池获取随机数的，当熵池用尽后，许多random_device的具体实现的性能会急速下降</li>
<li>多次调用random_device要花费比其他伪随机数算法更多的时间。在Linux中，每次调用random_device都需要读urandom这个文件再关闭，而在WIndom中我们需要调用操作系统的API，再销毁实例化对象，这个时间花费显然比设置好种子就能一直产生的其他伪随机数算法要慢得多。</li>
</ul>
<p>而作为种子：只调用一次，用于给引擎一个随机的初始值就完成了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> min = <span class="number">0</span>,max = <span class="number">100</span>;</span><br><span class="line">    random_device seed;<span class="comment">//硬件生成随机数种子</span></span><br><span class="line">    <span class="function">ranlux48 <span class="title">engine</span><span class="params">(seed())</span></span>;<span class="comment">//利用种子生成随机数引擎</span></span><br><span class="line">    <span class="function">uniform_int_distribution&lt;<span class="type">int</span>&gt; <span class="title">distrib</span><span class="params">(min, max)</span></span>;<span class="comment">//设置随机数范围，并为均匀分布</span></span><br><span class="line">    <span class="type">int</span> random = <span class="built_in">distrib</span>(engine);<span class="comment">//随机数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数考量"><a href="#随机数考量" class="headerlink" title="随机数考量"></a>随机数考量</h2><p>前面大概熟悉了一下随机数的生成，但还没想好用户怎么用随机数，是所有用户共享一个随机数分布呢？还是用户来了就创建分布对象然后只生成一个数字呢？还是一个用户对应一个分布对象呢？</p>
<ul>
<li>简单点就可以用第二种，因为这两个命令用的频率应该很少，缺点是多次调用hisir的话，随机得不够均匀；并且这种方法更耗时、耗内存，为了生成单个数字而完整地实例化了一个分布对象。</li>
<li>第一种的话也简单点，从统计的角度上看，这对于全体用户是均匀分布，但用户体验好肯定是对于单个用户来说均匀分布一些。</li>
<li>第三种貌似比较折中，但是就需要多一个映射表，挺麻烦的，映射表已经不想改了，否决否决。</li>
</ul>
<p>基本上是决定用第一种共享的方式，加一个互斥锁访问。因为如果从概率角度上看，每个用户访问时，每个随机数的概率都是相同的（均匀分布），这对用户来说就也都是均匀的了。当然，我也没研究底层的实现是基于统计的还是基于概率的。不过已经足够了。</p>
<p>严格来说，全局的方式都<strong>不用随机数种子</strong>，因为一直运行的话，也就不会有相同的序列了。因为有互斥锁，封装一下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Randint</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    mutex mux;<span class="comment">//因为引擎有序的关系，要互斥</span></span><br><span class="line">    random_device seed;<span class="comment">//硬件生成随机数种子</span></span><br><span class="line">    ranlux48 engine;<span class="comment">//利用种子生成随机数引擎</span></span><br><span class="line">    uniform_int_distribution&lt;<span class="type">int</span>&gt; distrib;<span class="comment">//设置随机数范围，并为均匀分布</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//hisir语录和oyasumi语录大小可能不一样，所以对应不一样的随即器</span></span><br><span class="line">    <span class="built_in">Randint</span>(<span class="type">int</span> min, <span class="type">int</span> max) :<span class="built_in">engine</span>(<span class="built_in">seed</span>()), <span class="built_in">distrib</span>(min, max)&#123;&#125;<span class="comment">//初始列表构造</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">locker</span><span class="params">(mux)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">distrib</span>(engine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span><span class="comment">//测试</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Randint <span class="title">rand_of_hisir</span><span class="params">(<span class="number">0</span>, <span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        cout &lt;&lt; <span class="built_in">rand_of_hisir</span>() &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>可以使用多个对象变成一个vector形式的随机化对象池，不过从分布来看没什么意义，因此就分别对两个命令各使用一个对象即可。</p>
<h2 id="语录对象"><a href="#语录对象" class="headerlink" title="语录对象"></a>语录对象</h2><p>语录对象使用const的<code>vector&lt;string&gt;</code>，通过下标访问，不用互斥。形式如下，具体就不在博客里放了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> vector&lt;string&gt; hisir_sentence = [...];</span><br><span class="line"><span class="type">const</span> vector&lt;string&gt; oyasumi_sentence = [...];</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">hisir</span><span class="params">(<span class="type">int</span> conn1, string&amp; msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr = hisir_sentence[<span class="built_in">rand_of_hisir</span>()];</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [hisir]: %s&quot;</span>,myuser.<span class="built_in">c_str</span>(),msg.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">oyasumi</span><span class="params">(<span class="type">int</span> conn1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string sendstr = oyasumi_sentence[<span class="built_in">rand_of_oyasumi</span>()];</span><br><span class="line">    <span class="built_in">send</span>(conn1,sendstr.<span class="built_in">c_str</span>(),sendstr.<span class="built_in">size</span>(),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">break_</span>(conn1);<span class="comment">//调用break，让会影响到的对方退出</span></span><br><span class="line">    </span><br><span class="line">    string myuser = usermap.<span class="built_in">fvalue_conn1_user</span>(conn1);<span class="comment">//获取userid</span></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [oyasumi]~&quot;</span>,myuser.<span class="built_in">c_str</span>());<span class="comment">//删之前记录一下</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cleanmap</span>(conn1);<span class="comment">//删表</span></span><br><span class="line">    <span class="built_in">close</span>(conn1);<span class="comment">//关套接字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h1><p>线程池就是传入task工作，可以参考之前的博客：<a href="https://jysama.cn/2022/09/28/websever%E6%A8%A1%E5%9D%97%E5%8C%96%E6%90%AD%E5%BB%BA/">WebServer模块单元测试 | JySama</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//threadpool.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> THREADPOOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADPOOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span><span class="comment">//使用assert函数</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadpool</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">pool</span><span class="comment">//封装三个资源</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::mutex mtx;<span class="comment">//互斥锁</span></span><br><span class="line">        std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; taskQueue;<span class="comment">//任务队列，无参数的function，调用时不用传参</span></span><br><span class="line">        std::condition_variable cond;<span class="comment">//条件变量</span></span><br><span class="line">        <span class="type">bool</span> isclose = <span class="literal">false</span>;<span class="comment">//默认值是false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    std::shared_ptr&lt;pool&gt; pool_;<span class="comment">//共享指针，pool_是一个指针指向pool结构体，这个指针用于线程池操作资源</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadpool</span>(<span class="type">int</span> threadnum = <span class="number">8</span>):<span class="built_in">pool_</span>(std::<span class="built_in">make_shared</span>&lt;pool&gt;())<span class="comment">//以make_shared的方式new一个对象给pool_指针</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(threadnum &gt; <span class="number">0</span>);<span class="comment">//没有线程就报错</span></span><br><span class="line">    	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;threadnum;i++)<span class="comment">//创建线程池</span></span><br><span class="line">    		std::<span class="built_in">thread</span>([<span class="type">pool_t</span> = pool_]&#123;<span class="comment">//现在要按值捕获，相当于拷贝构造共享指针，计数+1，且指向相同内容</span></span><br><span class="line">    			std::unique_lock&lt;std::mutex&gt; <span class="built_in">locker</span>(<span class="type">pool_t</span>-&gt;mtx);<span class="comment">//定义一个locker对象，现在已经锁住了</span></span><br><span class="line">                 <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">if</span>(!<span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">empty</span>())<span class="comment">//如果有任务</span></span><br><span class="line">                     &#123;</span><br><span class="line">                         <span class="keyword">auto</span> task = <span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">front</span>();</span><br><span class="line">                         <span class="type">pool_t</span>-&gt;taskQueue.<span class="built_in">pop</span>();</span><br><span class="line">                         locker.<span class="built_in">unlock</span>();</span><br><span class="line">                       	 <span class="comment">//解锁后再执行</span></span><br><span class="line">                         <span class="built_in">task</span>();</span><br><span class="line">                         <span class="comment">//执行完了，进入下一轮循环，注意要锁住</span></span><br><span class="line">                         locker.<span class="built_in">lock</span>();<span class="comment">//抢占锁</span></span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">else</span> <span class="keyword">if</span>(<span class="type">pool_t</span>-&gt;isclose)</span><br><span class="line">                         <span class="keyword">break</span>;</span><br><span class="line">                     <span class="keyword">else</span><span class="comment">//如果没有任务</span></span><br><span class="line">                         <span class="type">pool_t</span>-&gt;cond.<span class="built_in">wait</span>(locker);<span class="comment">//解锁并等待，唤醒后会抢占互斥锁</span></span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;).<span class="built_in">detach</span>();<span class="comment">//把thread分离，不用手动join，结束自动回收</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addTask</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">locker</span><span class="params">(pool_-&gt;mtx)</span></span>;<span class="comment">//定义一个locker对象</span></span><br><span class="line">        pool_-&gt;taskQueue.<span class="built_in">emplace</span>(task);<span class="comment">//这种方式，使用emplace和push没啥区别，task本身就是临时对象</span></span><br><span class="line">        <span class="comment">//如果要真正使用到emplace调用构造函数，还要配合std::forward完美转发，此时无论构造函数是不是explicit（不能隐式转换），都可以正常工作</span></span><br><span class="line">        pool_-&gt;cond.<span class="built_in">notify_one</span>();<span class="comment">//插入一个元素唤醒一个线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pool_-&gt;isclose = <span class="literal">true</span>;</span><br><span class="line">        pool_-&gt;cond.<span class="built_in">notify_all</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">threadpool</span>()<span class="comment">//析构函数</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h1 id="工作函数补充——内网穿透"><a href="#工作函数补充——内网穿透" class="headerlink" title="工作函数补充——内网穿透"></a>工作函数补充——内网穿透</h1><p>于2022&#x2F;12补充</p>
<p>当进行文件传输时，公网服务器在工作线程里顺便实现内网穿透（基于udp）服务即可，该部分的工作在这篇博客：<a href="https://jysama.cn/2022/11/26/udp_hole_punching/">UDP hole punching | JySama</a>。为了封装到项目中，使用命名空间。</p>
<p>为了简单，不考虑高并发的情况，默认连续的两个向服务器请求的内网主机就是要进行内网穿透的主机。</p>
<p>udp_hole_punch.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UDP_HOLE_PUNCHING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HOLE_PUNCHING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span><span class="comment">//in_addr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span><span class="comment">//close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">namespace</span> UDP_HP</span><br><span class="line">&#123;    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span>;</span><br><span class="line">    <span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span>;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">(<span class="type">int</span>&amp; listenudp)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>udp_hole_punch.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;udp_hole_punch.h&quot;</span></span></span><br><span class="line"><span class="keyword">namespace</span> UDP_HP</span><br><span class="line">&#123;    </span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">init_udp_Socket</span><span class="params">(<span class="type">int</span>&amp; listenfd, <span class="type">const</span> <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        listenfd = <span class="built_in">socket</span>(AF_INET,SOCK_DGRAM,IPPROTO_UDP);<span class="comment">//UDP</span></span><br><span class="line">        <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;create listen socket error, port-%d\n&quot;</span>,port);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr;</span><br><span class="line">        socketaddr.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">        socketaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Port reused</span></span><br><span class="line">        <span class="type">int</span> optval = <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">void</span>*)&amp;optval, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(listenfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//bind</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(<span class="keyword">struct</span> sockaddr *)&amp;socketaddr,<span class="built_in">sizeof</span>(socketaddr))==<span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(listenfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">udp_hole_punching</span><span class="params">(<span class="type">int</span> listenfd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> gateway;</span><br><span class="line">        <span class="type">socklen_t</span> addr_len = <span class="built_in">sizeof</span>(gateway);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;gateway, <span class="number">0</span>, <span class="built_in">sizeof</span>(gateway));</span><br><span class="line">        <span class="type">char</span> recvbuf[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = <span class="built_in">recvfrom</span>(listenfd, recvbuf, <span class="number">128</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;gateway, &amp;addr_len);</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp hole punching receive error!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            string ip = <span class="built_in">string</span>(<span class="built_in">inet_ntoa</span>(gateway.sin_addr));</span><br><span class="line">            string port = <span class="built_in">to_string</span>(<span class="built_in">ntohs</span>(gateway.sin_port));</span><br><span class="line"></span><br><span class="line">            string host = <span class="built_in">string</span>(recvbuf);</span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;udp hole punching  NAT ip: %s, port: %s; host:%s\n&quot;</span>,ip.<span class="built_in">c_str</span>(),port.<span class="built_in">c_str</span>(),host.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ip+<span class="string">&quot; &quot;</span>+port+<span class="string">&quot; &quot;</span>+host;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">parse</span><span class="params">(string str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        str = str + <span class="string">&quot; &quot;</span>;<span class="comment">//add a space</span></span><br><span class="line">        vector&lt;string&gt; res;</span><br><span class="line">        <span class="type">size_t</span> pos = <span class="number">0</span>;</span><br><span class="line">        <span class="type">size_t</span> pos1;</span><br><span class="line">        <span class="keyword">while</span> ((pos1 = str.<span class="built_in">find</span>(<span class="string">&#x27; &#x27;</span>, pos)) != string::npos)</span><br><span class="line">        &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(str.<span class="built_in">substr</span>(pos, pos1 - pos));</span><br><span class="line">            <span class="keyword">while</span> (str[pos1] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                pos1++;</span><br><span class="line">            pos = pos1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;<span class="comment">//move rvalue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">(<span class="type">int</span>&amp; listenudp)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string ip_port1 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">        string ip_port2 = <span class="built_in">udp_hole_punching</span>(listenudp);</span><br><span class="line">        <span class="keyword">if</span>(ip_port1 == <span class="string">&quot;&quot;</span> || ip_port2 == <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        vector&lt;string&gt; host1 = <span class="built_in">parse</span>(ip_port1);</span><br><span class="line">        vector&lt;string&gt; host2 = <span class="built_in">parse</span>(ip_port2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//The server sends back using a NAT ip</span></span><br><span class="line">        string ip1 = host1[<span class="number">0</span>];</span><br><span class="line">        string port1 = host1[<span class="number">1</span>];</span><br><span class="line">        string ip2 = host2[<span class="number">0</span>];</span><br><span class="line">        string port2 = host2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr1;</span><br><span class="line">        socketaddr1.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr1.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port1));</span><br><span class="line">        <span class="built_in">inet_pton</span>(AF_INET, ip1.<span class="built_in">c_str</span>(), &amp;socketaddr1.sin_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> socketaddr2;</span><br><span class="line">        socketaddr2.sin_family = AF_INET;<span class="comment">//ipv4</span></span><br><span class="line">        socketaddr2.sin_port = <span class="built_in">htons</span>(<span class="built_in">stoi</span>(port2));</span><br><span class="line">        <span class="built_in">inet_pton</span>(AF_INET, ip2.<span class="built_in">c_str</span>(), &amp;socketaddr2.sin_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ip1 != ip2) <span class="comment">//Different intranets</span></span><br><span class="line">        &#123;</span><br><span class="line">            ip_port1 = ip1 + <span class="string">&quot; &quot;</span> + port1;</span><br><span class="line">            ip_port2 = ip2 + <span class="string">&quot; &quot;</span> + port2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//In the same NAT</span></span><br><span class="line">        &#123;</span><br><span class="line">            ip_port1 = host1[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host1[<span class="number">3</span>];</span><br><span class="line">            ip_port2 = host2[<span class="number">2</span>] + <span class="string">&quot; &quot;</span> + host2[<span class="number">3</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = <span class="built_in">sendto</span>(listenudp, ip_port1.<span class="built_in">c_str</span>(), </span><br><span class="line">                      ip_port1.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr2, <span class="built_in">sizeof</span>(socketaddr2));</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">            <span class="comment">//exit(1);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = <span class="built_in">sendto</span>(listenudp, ip_port2.<span class="built_in">c_str</span>(), </span><br><span class="line">                         ip_port2.<span class="built_in">size</span>(), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;socketaddr1, <span class="built_in">sizeof</span>(socketaddr1));</span><br><span class="line">        <span class="keyword">if</span>(res &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_WARN</span>(<span class="string">&quot;udp sendto error!\n&quot;</span>);</span><br><span class="line">            <span class="comment">//exit(1);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="下一阶段"><a href="#下一阶段" class="headerlink" title="下一阶段"></a>下一阶段</h1><p>现在可以进入下一阶段了，见下一篇博客（这篇字数多太卡了）</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Jy
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://jysama.cn/2022/12/18/orange--%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" title="「orange」-server">https://jysama.cn/2022/12/18/orange--服务器开发/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/18/orange--%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="prev" title="「orange」">
      <i class="fa fa-chevron-left"></i> 「orange」
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%912/" rel="next" title="「orange」-server2">
      「orange」-server2 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81NjM2Ny8zMjgzMA=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B6%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.</span> <span class="nav-text">顶层设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%98%A0%E5%B0%84%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">映射表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95"><span class="nav-number">3.</span> <span class="nav-text">注册登录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-number">3.1.</span> <span class="nav-text">数据库连接池</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%8E%A5%E6%94%B6%E5%A4%84%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">信息接收处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E5%B7%A5%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">命令工作函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%BA%93random"><span class="nav-number">5.1.</span> <span class="nav-text">随机数库random</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%BC%95%E6%93%8E"><span class="nav-number">5.1.1.</span> <span class="nav-text">伪随机数引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E7%AE%97%E6%B3%95"><span class="nav-number">5.1.2.</span> <span class="nav-text">预定义算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83"><span class="nav-number">5.1.3.</span> <span class="nav-text">分布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#random-device"><span class="nav-number">5.1.4.</span> <span class="nav-text">random_device</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E8%80%83%E9%87%8F"><span class="nav-number">5.2.</span> <span class="nav-text">随机数考量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E5%BD%95%E5%AF%B9%E8%B1%A1"><span class="nav-number">5.3.</span> <span class="nav-text">语录对象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">6.</span> <span class="nav-text">线程池</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%87%BD%E6%95%B0%E8%A1%A5%E5%85%85%E2%80%94%E2%80%94%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="nav-number">7.</span> <span class="nav-text">工作函数补充——内网穿透</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8B%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-number">8.</span> <span class="nav-text">下一阶段</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Jy</p>
  <div class="site-description" itemprop="description">Re：从零开始的写博客生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">359k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:26</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
